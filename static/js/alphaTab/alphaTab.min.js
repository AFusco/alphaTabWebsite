/**
 * alphaTab v0.9.8 (private-develop, build 0)
 * 
 * Copyright Â© 2020, Daniel Kuschny and Contributors, All rights reserved.
 * 
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 * 
 * SoundFont loading and Audio Synthesis based on TinySoundFont (licensed under MIT)
 * Copyright (C) 2017, 2018 Bernhard Schelling (https://github.com/schellingb/TinySoundFont)
 * 
 * TinySoundFont is based on SFZero (licensed under MIT)
 * Copyright (C) 2012 Steve Folta (https://github.com/stevefolta/SFZero)
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).alphaTab={})}(this,(function(e){"use strict";class t extends Error{constructor(e,t){super(e),this.paramName=null!=t?t:""}}class s extends Error{constructor(e=""){super(e)}}class i{static get isRunningInWorker(){return"WorkerGlobalScope"in globalThis}static get supportsFontsApi(){return"fonts"in document&&"load"in document.fonts}static get supportsTextDecoder(){return"TextDecoder"in globalThis}static toString(e,t){if(i.supportsTextDecoder){let s=i.detectEncoding(e);return s&&(t=s),t||(t="utf-8"),new TextDecoder(t).decode(e)}{let t="",s=0;for(;s<e.length;){let i=e[s++];if(i<128){if(0===i)break;t+=String.fromCharCode(i)}else if(i<224)t+=String.fromCharCode((63&i)<<6|127&e[s++]);else if(i<240)t+=String.fromCharCode((31&i)<<12|(127&e[s++])<<6|127&e[s++]);else{let a=(15&i)<<18|(127&e[s++])<<12|(127&e[s++])<<6|127&e[s++];t+=String.fromCharCode(55232+(a>>18)),t+=String.fromCharCode(1023&a|56320)}}return t}}static stringToByteArray(e){let t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);return t}static newGuid(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+"-"+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+"-"+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+"-"+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+"-"+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}static toDouble(e){return new Float64Array(e.buffer)[0]}static toFloat(e){return new Float32Array(e.buffer)[0]}static throttle(e,t){let s=0;return()=>{window.clearTimeout(s),s=window.setTimeout(e,t)}}static isCharNumber(e,t=!0){return t&&45===e||e>=48&&e<=57}static isWhiteSpace(e){return 32===e||11===e||13===e||10===e||9===e}static isAlmostEqualTo(e,t){return Math.abs(e-t)<1e-5}static toHexString(e,t=0){let s="";do{s=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&e))+s,e>>=4}while(e>0);for(;s.length<t;)s="0"+s;return s}static detectEncoding(e){return e.length>2&&254===e[0]&&255===e[1]?"utf-16be":e.length>2&&255===e[0]&&254===e[1]?"utf-16le":e.length>4&&0===e[0]&&0===e[1]&&254===e[2]&&255===e[3]?"utf-32be":e.length>4&&255===e[0]&&254===e[1]&&0===e[2]&&0===e[3]?"utf-32le":null}}class a{constructor(e,t,s,i=255){this.raw=0,this.raw=0,this.raw=(255&i)<<24|(255&e)<<16|(255&t)<<8|255&s,this.updateRgba()}updateRgba(){255===this.a?this.rgba="#"+i.toHexString(this.r,2)+i.toHexString(this.g,2)+i.toHexString(this.b,2):this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}static random(e=100){return new a(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,e)}static fromJson(e){if(!e)return null;if(e instanceof a)return e;switch(typeof e){case"number":let t=new a(0,0,0,0);return t.raw=0|e,t.updateRgba(),t;case"string":if(e.startsWith("#")){if(4===e.length)return new a(17*parseInt(e.substring(1,1),16),17*parseInt(e.substring(2,1),16),17*parseInt(e.substring(3,1),16));if(5===e.length)return new a(17*parseInt(e.substring(1,1),16),17*parseInt(e.substring(2,1),16),17*parseInt(e.substring(3,1),16),17*parseInt(e.substring(4,1),16));if(7===e.length)return new a(parseInt(e.substring(1,2),16),parseInt(e.substring(3,2),16),parseInt(e.substring(5,2),16));if(9===e.length)return new a(parseInt(e.substring(1,2),16),parseInt(e.substring(3,2),16),parseInt(e.substring(5,2),16),parseInt(e.substring(7,2),16))}else if(e.startsWith("rgba")||e.startsWith("rgb")){const t=e.indexOf("("),i=e.lastIndexOf(")");if(-1===t||-1===i)throw new s("No values specified for rgb/rgba function");const r=e.substring(t+1,i-t-1).split(",");if(3===r.length)return new a(parseInt(r[0]),parseInt(r[1]),parseInt(r[2]));if(4===r.length)return new a(parseInt(r[0]),parseInt(r[1]),parseInt(r[2]),255*parseFloat(r[3]))}}throw new s("Unsupported format for color")}static toJson(e){return e.raw}}var r;a.BlackRgb="#000000",function(e){e[e.Plain=0]="Plain",e[e.Bold=1]="Bold",e[e.Italic=2]="Italic"}(r||(r={}));class n{constructor(e,t,s=r.Plain){this._cssScale=0,this.family=e,this.size=t,this.style=s,this._css=this.toCssString(1)}get isBold(){return 0!=(this.style&r.Bold)}get isItalic(){return 0!=(this.style&r.Italic)}clone(){return new n(this.family,this.size,this.style)}toCssString(e){if(!(this._css&&Math.abs(e-this._cssScale)<.01)){let t="";this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+=this.size*e,t+="px ",t+="'",t+=this.family,t+="'",this._css=t,this._cssScale=e}return this._css}static fromJson(e){if(!e)return null;if(e instanceof n)return e;if("object"==typeof e&&e.family)return new n(e.family,e.size,e.style);if("string"==typeof e&&!i.isRunningInWorker){let t=document.createElement("span");t.setAttribute("style","font: "+e);let s=t.style;s.fontFamily||(s.fontFamily="sans-serif");let i=s.fontFamily;(i.startsWith("'")&&i.endsWith("'")||i.startsWith('"')&&i.endsWith('"'))&&(i=i.substr(1,i.length-2));let a=s.fontSize.toLowerCase(),o=0;switch(a){case"xx-small":o=7;break;case"x-small":o=10;break;case"small":case"smaller":o=13;break;case"medium":o=16;break;case"large":case"larger":o=18;break;case"x-large":o=24;break;case"xx-large":o=32;break;default:try{o=a.endsWith("em")?16*parseFloat(a.substr(0,a.length-2)):a.endsWith("pt")?16*parseFloat(a.substr(0,a.length-2))/12:a.endsWith("px")?parseFloat(a.substr(0,a.length-2)):12}catch(e){o=12}}let h=r.Plain;switch("italic"===s.fontStyle&&(h|=r.Italic),s.fontWeight.toLowerCase()){case"normal":case"lighter":break;default:h|=r.Bold}return new n(i,o,h)}return null}static toJson(e){return{family:e.family,size:e.size,style:e.style}}}var o,h,l,d,c,u,p,g,f,m,y,b,S,_,w,B,v,T,k,x,N,P,F,C,L,M,E,D,I,R,O,A,G,V,H,W,z,U,X,Y,J,Q,q,j,K,$,Z,ee,te,se,ie,ae,re,ne,oe,he=function(e,t,s,i){var a,r=arguments.length,n=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,s,i);else for(var o=e.length-1;o>=0;o--)(a=e[o])&&(n=(r<3?a(n):r>3?a(t,s,n):a(t,s))||n);return r>3&&n&&Object.defineProperty(t,s,n),n};class le{constructor(){this.copyrightFont=new n(le.sansFont,12,r.Bold),this.titleFont=new n(le.serifFont,32,r.Plain),this.subTitleFont=new n(le.serifFont,20,r.Plain),this.wordsFont=new n(le.serifFont,15,r.Plain),this.effectFont=new n(le.serifFont,12,r.Italic),this.fretboardNumberFont=new n(le.sansFont,11,r.Plain),this.tablatureFont=new n(le.sansFont,13,r.Plain),this.graceFont=new n(le.sansFont,11,r.Plain),this.staffLineColor=new a(165,165,165,255),this.barSeparatorColor=new a(34,34,17,255),this.barNumberFont=new n(le.sansFont,11,r.Plain),this.barNumberColor=new a(200,0,0,255),this.fingeringFont=new n(le.serifFont,14,r.Plain),this.markerFont=new n(le.serifFont,14,r.Bold),this.mainGlyphColor=new a(0,0,0,255),this.secondaryGlyphColor=new a(0,0,0,100),this.scoreInfoColor=new a(0,0,0,255)}static toJson(e){var t={};return e.fillToJson(t),t}fillToJson(e){e.sansFont=this.sansFont,e.serifFont=this.serifFont,e.copyrightFont=n.toJson(this.copyrightFont),e.titleFont=n.toJson(this.titleFont),e.subTitleFont=n.toJson(this.subTitleFont),e.wordsFont=n.toJson(this.wordsFont),e.effectFont=n.toJson(this.effectFont),e.fretboardNumberFont=n.toJson(this.fretboardNumberFont),e.tablatureFont=n.toJson(this.tablatureFont),e.graceFont=n.toJson(this.graceFont),e.staffLineColor=a.toJson(this.staffLineColor),e.barSeparatorColor=a.toJson(this.barSeparatorColor),e.barNumberFont=n.toJson(this.barNumberFont),e.barNumberColor=a.toJson(this.barNumberColor),e.fingeringFont=n.toJson(this.fingeringFont),e.markerFont=n.toJson(this.markerFont),e.mainGlyphColor=a.toJson(this.mainGlyphColor),e.secondaryGlyphColor=a.toJson(this.secondaryGlyphColor),e.scoreInfoColor=a.toJson(this.scoreInfoColor)}static fromJson(e){if(!e)return null;var t=new le;return t.fillFromJson(e),t}fillFromJson(e){if(e)for(const t in e)this.setProperty(t.toLowerCase(),e[t])}setProperty(e,t){switch(e){case"sansfont":return this.sansFont=t,!0;case"seriffont":return this.serifFont=t,!0;case"copyrightfont":return this.copyrightFont=n.fromJson(t),!0;case"titlefont":return this.titleFont=n.fromJson(t),!0;case"subtitlefont":return this.subTitleFont=n.fromJson(t),!0;case"wordsfont":return this.wordsFont=n.fromJson(t),!0;case"effectfont":return this.effectFont=n.fromJson(t),!0;case"fretboardnumberfont":return this.fretboardNumberFont=n.fromJson(t),!0;case"tablaturefont":return this.tablatureFont=n.fromJson(t),!0;case"gracefont":return this.graceFont=n.fromJson(t),!0;case"stafflinecolor":return this.staffLineColor=a.fromJson(t),!0;case"barseparatorcolor":return this.barSeparatorColor=a.fromJson(t),!0;case"barnumberfont":return this.barNumberFont=n.fromJson(t),!0;case"barnumbercolor":return this.barNumberColor=a.fromJson(t),!0;case"fingeringfont":return this.fingeringFont=n.fromJson(t),!0;case"markerfont":return this.markerFont=n.fromJson(t),!0;case"mainglyphcolor":return this.mainGlyphColor=a.fromJson(t),!0;case"secondaryglyphcolor":return this.secondaryGlyphColor=a.fromJson(t),!0;case"scoreinfocolor":return this.scoreInfoColor=a.fromJson(t),!0}return!1}}le.sansFont="Arial",le.serifFont="Georgia",he([],le,"toJson",null),(o=e.StaveProfile||(e.StaveProfile={}))[o.Default=0]="Default",o[o.ScoreTab=1]="ScoreTab",o[o.Score=2]="Score",o[o.Tab=3]="Tab",o[o.TabMixed=4]="TabMixed",(h=e.LayoutMode||(e.LayoutMode={}))[h.Page=0]="Page",h[h.Horizontal=1]="Horizontal";class de{constructor(){this.scale=1,this.stretchForce=1,this.layoutMode=e.LayoutMode.Page,this.staveProfile=e.StaveProfile.Default,this.barsPerRow=-1,this.startBar=1,this.barCount=-1,this.barCountPerPartial=10,this.resources=new le,this.padding=null}static toJson(e){var t={};return e.fillToJson(t),t}fillToJson(e){e.scale=this.scale,e.stretchForce=this.stretchForce,e.layoutMode=this.layoutMode,e.staveProfile=this.staveProfile,e.barsPerRow=this.barsPerRow,e.startBar=this.startBar,e.barCount=this.barCount,e.barCountPerPartial=this.barCountPerPartial,e.resources?this.resources.fillToJson(e.resources):e.resources=le.toJson(this.resources),e.padding=this.padding?this.padding.slice():null}static fromJson(e){if(!e)return null;var t=new de;return t.fillFromJson(e),t}fillFromJson(e){if(e)for(const t in e)this.setProperty(t.toLowerCase(),e[t])}setProperty(t,s){switch(t){case"scale":return this.scale=s,!0;case"stretchforce":return this.stretchForce=s,!0;case"layoutmode":return this.layoutMode="string"==typeof s?e.LayoutMode[Object.keys(e.LayoutMode).find(e=>e.toLowerCase()===s.toLowerCase())]:s,!0;case"staveprofile":return this.staveProfile="string"==typeof s?e.StaveProfile[Object.keys(e.StaveProfile).find(e=>e.toLowerCase()===s.toLowerCase())]:s,!0;case"barsperrow":return this.barsPerRow=s,!0;case"startbar":return this.startBar=s,!0;case"barcount":return this.barCount=s,!0;case"barcountperpartial":return this.barCountPerPartial=s,!0;case"padding":return this.padding=s?s.slice():null,!0}if(["resources"].indexOf(t)>=0)return this.resources?this.resources.fillFromJson(s):this.resources=le.fromJson(s),!0;for(const e of["resources"])if(0===t.indexOf(e)&&(this.resources||(this.resources=new le),this.resources.setProperty(t.substring(e.length),s)))return!0;return!1}}class ce{static getValue(e){return ce._values||(ce._values=new Map),e=e.toLowerCase().split(" ").join(""),ce._values.has(e)?ce._values.get(e):0}static isPiano(e){return e<=7||e>=16&&e<=23}static isGuitar(e){return e>=24&&e<=39||105===e||43===e}}ce._values=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]);class ue{init(e,t){this.data=e,this.settings=t}}class pe extends Error{constructor(e="Unsupported format",t=null){super(e),this.inner=t}}!function(e){e[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Heavy=2]="Heavy"}(l||(l={})),function(e){e[e.Tempo=0]="Tempo",e[e.Volume=1]="Volume",e[e.Instrument=2]="Instrument",e[e.Balance=3]="Balance"}(d||(d={}));class ge{constructor(){this.isLinear=!1,this.type=d.Tempo,this.value=0,this.ratioPosition=0,this.text=""}static buildTempoAutomation(e,t,s,i){(i<1||i>5)&&(i=2);let a=new Float32Array([1,.5,1,1.5,2,3]),r=new ge;return r.type=d.Tempo,r.isLinear=e,r.ratioPosition=t,r.value=s*a[i],r}static copyTo(e,t){t.isLinear=e.isLinear,t.ratioPosition=e.ratioPosition,t.text=e.text,t.type=e.type,t.value=e.value}clone(){let e=new ge;return ge.copyTo(this,e),e}}!function(e){e[e.Neutral=0]="Neutral",e[e.C3=1]="C3",e[e.C4=2]="C4",e[e.F4=3]="F4",e[e.G2=4]="G2"}(c||(c={})),function(e){e[e._15ma=0]="_15ma",e[e._8va=1]="_8va",e[e.Regular=2]="Regular",e[e._8vb=3]="_8vb",e[e._15mb=4]="_15mb"}(u||(u={})),function(e){e[e.None=0]="None",e[e.Simple=1]="Simple",e[e.FirstOfDouble=2]="FirstOfDouble",e[e.SecondOfDouble=3]="SecondOfDouble"}(p||(p={}));class fe{constructor(){this.id=fe._globalBarId++,this.index=0,this.nextBar=null,this.previousBar=null,this.clef=c.G2,this.clefOttava=u.Regular,this.voices=[],this.simileMark=p.None}get masterBar(){return this.staff.track.score.masterBars[this.index]}get isEmpty(){for(let e=0,t=this.voices.length;e<t;e++)if(!this.voices[e].isEmpty)return!1;return!0}static copyTo(e,t){t.id=e.id,t.index=e.index,t.clef=e.clef,t.clefOttava=e.clefOttava,t.simileMark=e.simileMark}addVoice(e){e.bar=this,e.index=this.voices.length,this.voices.push(e)}finish(e){for(let t=0,s=this.voices.length;t<s;t++){this.voices[t].finish(e)}}calculateDuration(){let e=0;for(let t of this.voices){let s=t.calculateDuration();s>e&&(e=s)}return e}}fe._globalBarId=0;class me{static ticksToMillis(e,t){return e*(6e4/(t*me.QuarterTime))|0}static millisToTicks(e,t){return e/(6e4/(t*me.QuarterTime))|0}static toTicks(e){return me.valueToTicks(e)}static valueToTicks(e){let t=e;return t<0&&(t=1/-t),me.QuarterTime*(4/t)|0}static applyDot(e,t){return t?e+3*(e/4|0):e+(e/2|0)}static applyTuplet(e,t,s){return e*s/t|0}static removeTuplet(e,t,s){return e*t/s|0}static dynamicToVelocity(e){return me.MinVelocity+e*me.VelocityIncrement}}me.QuarterTime=960,me.MinVelocity=15,me.VelocityIncrement=16;class ye{constructor(e=0,t=0){this.offset=e,this.value=t}static copyTo(e,t){t.offset=e.offset,t.value=e.value}clone(){let e=new ye(0,0);return ye.copyTo(this,e),e}}ye.MaxPosition=60,ye.MaxValue=12,function(e){e[e.Default=0]="Default",e[e.Gradual=1]="Gradual",e[e.Fast=2]="Fast"}(g||(g={})),function(e){e[e.None=0]="None",e[e.Custom=1]="Custom",e[e.Bend=2]="Bend",e[e.Release=3]="Release",e[e.BendRelease=4]="BendRelease",e[e.Hold=5]="Hold",e[e.Prebend=6]="Prebend",e[e.PrebendBend=7]="PrebendBend",e[e.PrebendRelease=8]="PrebendRelease"}(f||(f={})),function(e){e[e.None=0]="None",e[e.BrushUp=1]="BrushUp",e[e.BrushDown=2]="BrushDown",e[e.ArpeggioUp=3]="ArpeggioUp",e[e.ArpeggioDown=4]="ArpeggioDown"}(m||(m={})),function(e){e[e.None=0]="None",e[e.Crescendo=1]="Crescendo",e[e.Decrescendo=2]="Decrescendo"}(y||(y={})),function(e){e[e.QuadrupleWhole=-4]="QuadrupleWhole",e[e.DoubleWhole=-2]="DoubleWhole",e[e.Whole=1]="Whole",e[e.Half=2]="Half",e[e.Quarter=4]="Quarter",e[e.Eighth=8]="Eighth",e[e.Sixteenth=16]="Sixteenth",e[e.ThirtySecond=32]="ThirtySecond",e[e.SixtyFourth=64]="SixtyFourth",e[e.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",e[e.TwoHundredFiftySixth=256]="TwoHundredFiftySixth"}(b||(b={})),function(e){e[e.PPP=0]="PPP",e[e.PP=1]="PP",e[e.P=2]="P",e[e.MP=3]="MP",e[e.MF=4]="MF",e[e.F=5]="F",e[e.FF=6]="FF",e[e.FFF=7]="FFF"}(S||(S={})),function(e){e[e.None=0]="None",e[e.OnBeat=1]="OnBeat",e[e.BeforeBeat=2]="BeforeBeat",e[e.BendGrace=3]="BendGrace"}(_||(_={})),function(e){e[e.Unknown=-2]="Unknown",e[e.NoOrDead=-1]="NoOrDead",e[e.Thumb=0]="Thumb",e[e.IndexFinger=1]="IndexFinger",e[e.MiddleFinger=2]="MiddleFinger",e[e.AnnularFinger=3]="AnnularFinger",e[e.LittleFinger=4]="LittleFinger"}(w||(w={})),function(e){e[e.None=0]="None",e[e.Natural=1]="Natural",e[e.Artificial=2]="Artificial",e[e.Pinch=3]="Pinch",e[e.Tap=4]="Tap",e[e.Semi=5]="Semi",e[e.Feedback=6]="Feedback"}(B||(B={})),function(e){e[e.Default=0]="Default",e[e.SwapAccidentals=1]="SwapAccidentals",e[e.ForceNatural=2]="ForceNatural",e[e.ForceSharp=3]="ForceSharp",e[e.ForceFlat=4]="ForceFlat"}(v||(v={})),function(e){e[e.None=0]="None",e[e.IntoFromBelow=1]="IntoFromBelow",e[e.IntoFromAbove=2]="IntoFromAbove"}(T||(T={})),function(e){e[e.None=0]="None",e[e.Shift=1]="Shift",e[e.Legato=2]="Legato",e[e.OutUp=3]="OutUp",e[e.OutDown=4]="OutDown",e[e.PickSlideDown=5]="PickSlideDown",e[e.PickSlideUp=6]="PickSlideUp"}(k||(k={})),function(e){e[e.None=0]="None",e[e.Slight=1]="Slight",e[e.Wide=2]="Wide"}(x||(x={})),(N=e.TabRhythmMode||(e.TabRhythmMode={}))[N.Hidden=0]="Hidden",N[N.ShowWithBeams=1]="ShowWithBeams",N[N.ShowWithBars=2]="ShowWithBars",(P=e.FingeringMode||(e.FingeringMode={}))[P.ScoreDefault=0]="ScoreDefault",P[P.ScoreForcePiano=1]="ScoreForcePiano",P[P.SingleNoteEffectBand=2]="SingleNoteEffectBand",P[P.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano",(F=e.NotationMode||(e.NotationMode={}))[F.GuitarPro=0]="GuitarPro",F[F.SongBook=1]="SongBook";class be{constructor(){this.notationMode=e.NotationMode.GuitarPro,this.fingeringMode=e.FingeringMode.ScoreDefault,this.hideInfo=!1,this.hideTuning=!1,this.hideTrackNames=!1,this.hideChordDiagrams=!1,this.rhythmMode=e.TabRhythmMode.Hidden,this.rhythmHeight=15,this.transpositionPitches=[],this.displayTranspositionPitches=[],this.smallGraceTabNotes=!0,this.extendBendArrowsOnTiedNotes=!0,this.showParenthesisForTiedBends=!0,this.showTabNoteOnTiedBend=!0,this.showZeroOnDiveWhammy=!1,this.extendLineEffectsToBeatEnd=!1,this.slurHeight=7}static toJson(e){var t={};return e.fillToJson(t),t}fillToJson(e){e.notationMode=this.notationMode,e.fingeringMode=this.fingeringMode,e.hideInfo=this.hideInfo,e.hideTuning=this.hideTuning,e.hideTrackNames=this.hideTrackNames,e.hideChordDiagrams=this.hideChordDiagrams,e.rhythmMode=this.rhythmMode,e.rhythmHeight=this.rhythmHeight,e.transpositionPitches=this.transpositionPitches.slice(),e.displayTranspositionPitches=this.displayTranspositionPitches.slice(),e.smallGraceTabNotes=this.smallGraceTabNotes,e.extendBendArrowsOnTiedNotes=this.extendBendArrowsOnTiedNotes,e.showParenthesisForTiedBends=this.showParenthesisForTiedBends,e.showTabNoteOnTiedBend=this.showTabNoteOnTiedBend,e.showZeroOnDiveWhammy=this.showZeroOnDiveWhammy,e.extendLineEffectsToBeatEnd=this.extendLineEffectsToBeatEnd,e.slurHeight=this.slurHeight}static fromJson(e){if(!e)return null;var t=new be;return t.fillFromJson(e),t}fillFromJson(e){if(e)for(const t in e)this.setProperty(t.toLowerCase(),e[t])}setProperty(t,s){switch(t){case"notationmode":return this.notationMode="string"==typeof s?e.NotationMode[Object.keys(e.NotationMode).find(e=>e.toLowerCase()===s.toLowerCase())]:s,!0;case"fingeringmode":return this.fingeringMode="string"==typeof s?e.FingeringMode[Object.keys(e.FingeringMode).find(e=>e.toLowerCase()===s.toLowerCase())]:s,!0;case"hideinfo":return this.hideInfo=s,!0;case"hidetuning":return this.hideTuning=s,!0;case"hidetracknames":return this.hideTrackNames=s,!0;case"hidechorddiagrams":return this.hideChordDiagrams=s,!0;case"rhythmmode":return this.rhythmMode="string"==typeof s?e.TabRhythmMode[Object.keys(e.TabRhythmMode).find(e=>e.toLowerCase()===s.toLowerCase())]:s,!0;case"rhythmheight":return this.rhythmHeight=s,!0;case"transpositionpitches":return this.transpositionPitches=s.slice(),!0;case"displaytranspositionpitches":return this.displayTranspositionPitches=s.slice(),!0;case"smallgracetabnotes":return this.smallGraceTabNotes=s,!0;case"extendbendarrowsontiednotes":return this.extendBendArrowsOnTiedNotes=s,!0;case"showparenthesisfortiedbends":return this.showParenthesisForTiedBends=s,!0;case"showtabnoteontiedbend":return this.showTabNoteOnTiedBend=s,!0;case"showzeroondivewhammy":return this.showZeroOnDiveWhammy=s,!0;case"extendlineeffectstobeatend":return this.extendLineEffectsToBeatEnd=s,!0;case"slurheight":return this.slurHeight=s,!0}return!1}}class Se{static midiFromElementVariation(e){return Se.ElementVariationToMidi[e.element][e.variation]}static mapNoteForDisplay(e){return 61===e||66===e||44===e?62:60===e||65===e?64:e>=35&&e<=36?65:41===e||64===e?67:43===e||62===e?69:45===e||63===e?71:47===e||54===e?74:48===e||56===e?76:50===e?77:42===e||46===e||e>=49&&e<=53||57===e||59===e?79:72}}Se.ElementVariationToMidi=[[35,35,35],[38,38,37],[56,56,56],[56,56,56],[56,56,56],[41,41,41],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[42,46,46],[44,44,44],[49,49,49],[57,57,57],[55,55,55],[51,59,53],[52,52,52]];class _e{constructor(e){this._value=void 0,this._factory=e}get value(){return void 0===this._value&&(this._value=this._factory()),this._value}}!function(e){e[e.None=0]="None",e[e.Debug=1]="Debug",e[e.Info=2]="Info",e[e.Warning=3]="Warning",e[e.Error=4]="Error"}(C||(C={}));class we{static format(e,t){return`[AlphaTab][${e}] ${t}`}static shouldLog(e){return we.logLevel!==C.None&&e>=we.logLevel}static debug(e,t,...s){we.shouldLog(C.Debug)&&console.debug(we.format(e,t),...s)}static warning(e,t,...s){we.shouldLog(C.Warning)&&console.warn(we.format(e,t),...s)}static info(e,t,...s){we.shouldLog(C.Info)&&console.info(we.format(e,t),...s)}static error(e,t,...s){we.shouldLog(C.Error)&&console.error(we.format(e,t),...s)}}we.logLevel=C.Info;class Be{constructor(){this.id=Be.GlobalNoteId++,this.index=0,this.accentuated=l.None,this.bendType=f.None,this.bendStyle=g.Default,this.bendOrigin=null,this.isContinuedBend=!1,this.bendPoints=[],this.maxBendPoint=null,this.fret=-1,this.string=-1,this.octave=-1,this.tone=-1,this.element=-1,this.variation=-1,this.isVisible=!0,this.isHammerPullOrigin=!1,this.hammerPullOrigin=null,this.hammerPullDestination=null,this.isSlurDestination=!1,this.slurOrigin=null,this.slurDestination=null,this.harmonicType=B.None,this.harmonicValue=0,this.isGhost=!1,this.isLetRing=!1,this.letRingDestination=null,this.isPalmMute=!1,this.palmMuteDestination=null,this.isDead=!1,this.isStaccato=!1,this.slideInType=T.None,this.slideOutType=k.None,this.slideTarget=null,this.vibrato=x.None,this.tieOrigin=null,this.tieDestination=null,this.isTieDestination=!1,this.leftHandFinger=w.Unknown,this.rightHandFinger=w.Unknown,this.isFingering=!1,this.trillValue=-1,this.trillSpeed=b.ThirtySecond,this.durationPercent=1,this.accidentalMode=v.Default,this.dynamics=S.F,this.isEffectSlurOrigin=!1,this.hasEffectSlur=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null}get hasBend(){return this.bendType!==f.None}get isStringed(){return this.string>=0}get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}get isPercussion(){return!this.isStringed&&this.element>=0&&this.variation>=0}get isHammerPullDestination(){return!!this.hammerPullOrigin}get isSlurOrigin(){return!!this.slurDestination}get isHarmonic(){return this.harmonicType!==B.None}get isTieOrigin(){return!!this.tieDestination}get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get stringTuning(){return this.beat.voice.bar.staff.capo+Be.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(e,t){return e.tuning.length>0?e.tuning[e.tuning.length-(t-1)-1]:0}get realValue(){return this.isPercussion?Se.midiFromElementVariation(this):this.isStringed?this.harmonicType===B.Natural?this.harmonicPitch+this.stringTuning-this.beat.voice.bar.staff.transpositionPitch:this.fret+this.stringTuning-this.beat.voice.bar.staff.transpositionPitch+this.harmonicPitch:this.isPiano?12*this.octave+this.tone-this.beat.voice.bar.staff.transpositionPitch:0}get harmonicPitch(){if(this.harmonicType===B.None||!this.isStringed)return 0;let e=this.harmonicValue;return i.isAlmostEqualTo(e,2.4)?36:i.isAlmostEqualTo(e,2.7)?34:e<3?0:e<=3.5?31:e<=4?28:e<=5?24:e<=6?34:e<=7?19:e<=8.5?36:e<=9?28:e<=10?34:e<=11?0:e<=12?12:e<14?0:e<=15?34:e<=16?28:e<=17?36:e<=18?0:e<=19?19:e<=21?0:e<=22?36:e<=24?24:0}get displayValue(){let e=this.displayValueWithoutBend;return this.hasBend?e+=this.bendPoints[0].value/2|0:this.bendOrigin?e+=this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2|0:this.isTieDestination&&this.tieOrigin.bendOrigin?e+=this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2|0:this.beat.hasWhammyBar?e+=this.beat.whammyBarPoints[0].value/2|0:this.beat.isContinuedWhammy&&(e+=this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2|0),e}get displayValueWithoutBend(){let e=this.realValue;switch(this.harmonicType!==B.Natural&&this.harmonicType!==B.None&&(e-=this.harmonicPitch),this.beat.ottava){case u._15ma:e-=24;break;case u._8va:e-=12;break;case u.Regular:break;case u._8vb:e+=12;break;case u._15mb:e+=24}switch(this.beat.voice.bar.clefOttava){case u._15ma:e-=24;break;case u._8va:e-=12;break;case u.Regular:break;case u._8vb:e+=12;break;case u._15mb:e+=24}return e-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}static copyTo(e,t){t.id=e.id,t.accentuated=e.accentuated,t.fret=e.fret,t.string=e.string,t.harmonicValue=e.harmonicValue,t.harmonicType=e.harmonicType,t.isGhost=e.isGhost,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.isDead=e.isDead,t.isStaccato=e.isStaccato,t.slideInType=e.slideInType,t.slideOutType=e.slideOutType,t.vibrato=e.vibrato,t.isTieDestination=e.isTieDestination,t.isSlurDestination=e.isSlurDestination,t.isHammerPullOrigin=e.isHammerPullOrigin,t.leftHandFinger=e.leftHandFinger,t.rightHandFinger=e.rightHandFinger,t.isFingering=e.isFingering,t.trillValue=e.trillValue,t.trillSpeed=e.trillSpeed,t.durationPercent=e.durationPercent,t.accidentalMode=e.accidentalMode,t.dynamics=e.dynamics,t.octave=e.octave,t.tone=e.tone,t.element=e.element,t.variation=e.variation,t.bendType=e.bendType,t.bendStyle=e.bendStyle,t.isContinuedBend=e.isContinuedBend,t.isVisible=e.isVisible}clone(){let e=new Be,t=e.id;Be.copyTo(this,e);for(let t=0,s=this.bendPoints.length;t<s;t++)e.addBendPoint(this.bendPoints[t].clone());return e.id=t,e}addBendPoint(e){this.bendPoints.push(e),(!this.maxBendPoint||e.value>this.maxBendPoint.value)&&(this.maxBendPoint=e),this.bendType===f.None&&(this.bendType=f.Custom)}finish(t){let s=new _e(()=>Be.nextNoteOnSameLine(this)),i=t&&t.notation.notationMode===e.NotationMode.SongBook;if(this.isTieDestination){if(this.tieOrigin)this.tieOrigin.tieDestination=this;else{let e=Be.findTieOrigin(this);e?(this.tieOrigin=e,this.tieOrigin.tieDestination=this,this.fret=this.tieOrigin.fret,this.octave=this.tieOrigin.octave,this.tone=this.tieOrigin.tone,this.tieOrigin.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}i&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)}switch(this.isLetRing&&(s.value&&s.value.isLetRing?this.letRingDestination=s.value:this.letRingDestination=this,i&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(s.value&&s.value.isPalmMute?this.palmMuteDestination=s.value:this.palmMuteDestination=this),this.isHammerPullOrigin&&(s.value?(this.hammerPullDestination=s.value,this.hammerPullDestination.hammerPullOrigin=this):this.isHammerPullOrigin=!1),this.slideOutType){case k.Shift:case k.Legato:this.slideTarget=s.value,this.slideTarget||(this.slideOutType=k.None)}let a=null;if(this.isHammerPullOrigin?a=this.hammerPullDestination:this.slideOutType===k.Legato&&this.slideTarget&&(a=this.slideTarget),a&&(this.hasEffectSlur=!0,this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=a,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=a,this.effectSlurDestination.effectSlurOrigin=this)),this.bendPoints.length>0&&this.bendType===f.Custom){let e=this.isContinuedBend=!!this.tieOrigin&&this.tieOrigin.hasBend;if(4===this.bendPoints.length){let t=this.bendPoints[0],s=this.bendPoints[1],i=this.bendPoints[2],a=this.bendPoints[3];s.value===i.value?a.value>t.value?s.value>a.value?this.bendType=f.BendRelease:!e&&t.value>0?(this.bendType=f.PrebendBend,this.bendPoints.splice(2,1),this.bendPoints.splice(1,1)):(this.bendType=f.Bend,this.bendPoints.splice(2,1),this.bendPoints.splice(1,1)):a.value<t.value?e?(this.bendType=f.Release,this.bendPoints.splice(2,1),this.bendPoints.splice(1,1)):(this.bendType=f.PrebendRelease,this.bendPoints.splice(2,1),this.bendPoints.splice(1,1)):s.value>t.value?this.bendType=f.BendRelease:t.value>0&&!e?(this.bendType=f.Prebend,this.bendPoints.splice(2,1),this.bendPoints.splice(1,1)):(this.bendType=f.Hold,this.bendPoints.splice(2,1),this.bendPoints.splice(1,1)):we.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(2===this.bendPoints.length){let t=this.bendPoints[0],s=this.bendPoints[1];s.value>t.value?!e&&t.value>0?this.bendType=f.PrebendBend:this.bendType=f.Bend:s.value<t.value?this.bendType=e?f.Release:f.PrebendRelease:this.bendType=f.Hold}}else 0===this.bendPoints.length&&(this.bendType=f.None)}static nextNoteOnSameLine(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+Be.MaxOffsetForSameLineSearch;){let s=t.getNoteOnString(e.string);if(s)return s;t=t.nextBeat}return null}static findTieOrigin(e){let t=e.beat.previousBeat;for(;t&&t.voice.bar.index>=e.beat.voice.bar.index-Be.MaxOffsetForSameLineSearch;){if(e.isStringed){let s=t.getNoteOnString(e.string);if(s)return s}else if(-1===e.octave&&-1===e.tone){if(e.index<t.notes.length)return t.notes[e.index]}else{let s=t.getNoteWithRealValue(e.realValue);if(s)return s}t=t.previousBeat}return null}}Be.GlobalNoteId=0,Be.MaxOffsetForSameLineSearch=3,function(e){e[e.None=0]="None",e[e.Up=1]="Up",e[e.Down=2]="Down"}(L||(L={}));class ve{constructor(e){this._isEqualLengthTuplet=!0,this.totalDuration=0,this.beats=[],this.isFull=!1,this.voice=e}check(e){if(0===this.beats.length)return this.beats.push(e),this.totalDuration+=e.playbackDuration,!0;if(e.graceType!==_.None)return!0;if(e.voice!==this.voice||this.isFull||e.tupletNumerator!==this.beats[0].tupletNumerator||e.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(e.playbackDuration!==this.beats[0].playbackDuration&&(this._isEqualLengthTuplet=!1),this.beats.push(e),this.totalDuration+=e.playbackDuration,this._isEqualLengthTuplet)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{let e=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(let t of ve.AllTicks)if(this.totalDuration===t*e){this.isFull=!0;break}}return!0}}ve.HalfTicks=1920,ve.QuarterTicks=960,ve.EighthTicks=480,ve.SixteenthTicks=240,ve.ThirtySecondTicks=120,ve.SixtyFourthTicks=60,ve.OneHundredTwentyEighthTicks=30,ve.TwoHundredFiftySixthTicks=15,ve.AllTicks=[ve.HalfTicks,ve.QuarterTicks,ve.EighthTicks,ve.SixteenthTicks,ve.ThirtySecondTicks,ve.SixtyFourthTicks,ve.OneHundredTwentyEighthTicks,ve.TwoHundredFiftySixthTicks],function(e){e[e.None=0]="None",e[e.Custom=1]="Custom",e[e.Dive=2]="Dive",e[e.Dip=3]="Dip",e[e.Hold=4]="Hold",e[e.Predive=5]="Predive",e[e.PrediveDive=6]="PrediveDive"}(M||(M={}));class Te{constructor(){this.id=Te._globalBeatId++,this.index=0,this.previousBeat=null,this.nextBeat=null,this.notes=[],this.noteStringLookup=new Map,this.noteValueLookup=new Map,this.isEmpty=!1,this.whammyStyle=g.Default,this.ottava=u.Regular,this.fermata=null,this.isLegatoOrigin=!1,this.minNote=null,this.maxNote=null,this.maxStringNote=null,this.minStringNote=null,this.duration=b.Quarter,this.isLetRing=!1,this.isPalmMute=!1,this.automations=[],this.dots=0,this.fadeIn=!1,this.lyrics=null,this.hasRasgueado=!1,this.pop=!1,this.slap=!1,this.tap=!1,this.text=null,this.brushType=m.None,this.brushDuration=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.tupletGroup=null,this.isContinuedWhammy=!1,this.whammyBarType=M.None,this.whammyBarPoints=[],this.maxWhammyPoint=null,this.minWhammyPoint=null,this.vibrato=x.None,this.chordId=null,this.graceType=_.None,this.pickStroke=L.None,this.tremoloSpeed=null,this.crescendo=y.None,this.displayStart=0,this.playbackStart=0,this.displayDuration=0,this.playbackDuration=0,this.dynamics=S.F,this.invertBeamDirection=!1,this.isEffectSlurOrigin=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null}get isLastOfVoice(){return this.index===this.voice.beats.length-1}get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}get isRest(){return this.isEmpty||0===this.notes.length}get hasTuplet(){return!(-1===this.tupletDenominator&&-1===this.tupletNumerator||1===this.tupletDenominator&&1===this.tupletNumerator)}get hasWhammyBar(){return this.whammyBarType!==M.None}get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.chords.get(this.chordId):null}get isTremolo(){return!!this.tremoloSpeed}get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}get isEffectSlurDestination(){return!!this.effectSlurOrigin}static copyTo(e,t){if(t.id=e.id,t.index=e.index,t.isEmpty=e.isEmpty,t.duration=e.duration,t.dots=e.dots,t.fadeIn=e.fadeIn,e.lyrics){t.lyrics=new Array(e.lyrics.length);for(let s=0;s<e.lyrics.length;s++)t.lyrics[s]=e.lyrics[s]}t.pop=e.pop,t.hasRasgueado=e.hasRasgueado,t.slap=e.slap,t.tap=e.tap,t.text=e.text,t.brushType=e.brushType,t.brushDuration=e.brushDuration,t.tupletDenominator=e.tupletDenominator,t.tupletNumerator=e.tupletNumerator,t.vibrato=e.vibrato,t.chordId=e.chordId,t.graceType=e.graceType,t.pickStroke=e.pickStroke,t.tremoloSpeed=e.tremoloSpeed,t.crescendo=e.crescendo,t.displayStart=e.displayStart,t.displayDuration=e.displayDuration,t.playbackStart=e.playbackStart,t.playbackDuration=e.playbackDuration,t.dynamics=e.dynamics,t.isLegatoOrigin=e.isLegatoOrigin,t.invertBeamDirection=e.invertBeamDirection,t.whammyBarType=e.whammyBarType,t.isContinuedWhammy=e.isContinuedWhammy,t.ottava=e.ottava,t.whammyStyle=e.whammyStyle}clone(){let e=new Te,t=e.id;for(const t of this.whammyBarPoints)e.addWhammyBarPoint(t.clone());for(const t of this.notes)e.addNoteInternal(t.clone(),t.realValue);Te.copyTo(this,e);for(const t of this.automations)e.automations.push(t.clone());return e.id=t,e}addWhammyBarPoint(e){this.whammyBarPoints.push(e),(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e),(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e),this.whammyBarType===M.None&&(this.whammyBarType=M.Custom)}removeWhammyBarPoint(e){if(e<0||e>=this.whammyBarPoints.length)return;this.whammyBarPoints.splice(e,1);let t=this.whammyBarPoints[e];if(t===this.maxWhammyPoint){this.maxWhammyPoint=null;for(let e of this.whammyBarPoints)(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e)}if(t===this.minWhammyPoint){this.minWhammyPoint=null;for(let e of this.whammyBarPoints)(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e)}}addNote(e){this.addNoteInternal(e,-1)}addNoteInternal(e,t=-1){e.beat=this,e.index=this.notes.length,this.notes.push(e),e.isStringed&&this.noteStringLookup.set(e.string,e),-1===t&&(t=e.realValue),this.noteValueLookup.set(t,e)}removeNote(e){let t=this.notes.indexOf(e);t>=0&&this.notes.splice(t,1)}getAutomation(e){for(let t=0,s=this.automations.length;t<s;t++){let s=this.automations[t];if(s.type===e)return s}return null}getNoteOnString(e){return this.noteStringLookup.has(e)?this.noteStringLookup.get(e):null}calculateDuration(){let e=me.toTicks(this.duration);return 2===this.dots?e=me.applyDot(e,!0):1===this.dots&&(e=me.applyDot(e,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(e=me.applyTuplet(e,this.tupletNumerator,this.tupletDenominator)),e}updateDurations(){let e=this.calculateDuration();switch(this.playbackDuration=e,this.displayDuration=e,this.graceType){case _.BeforeBeat:case _.OnBeat:switch(this.duration){case b.Sixteenth:this.playbackDuration=me.toTicks(b.SixtyFourth);break;case b.ThirtySecond:this.playbackDuration=me.toTicks(b.OneHundredTwentyEighth);break;default:this.playbackDuration=me.toTicks(b.ThirtySecond)}break;case _.BendGrace:this.playbackDuration/=2;break;default:let e=this.previousBeat;if(e&&e.graceType===_.BendGrace)this.playbackDuration=e.playbackDuration;else for(;e&&e.graceType===_.OnBeat;)this.playbackDuration-=e.playbackDuration,e=e.previousBeat}}finishTuplet(){let e=this.previousBeat,t=e?e.tupletGroup:null;(this.hasTuplet||this.graceType!==_.None&&t)&&(e&&t&&t.check(this)||(t=new ve(this.voice),t.check(this)),this.tupletGroup=t)}finish(t){let s=t?t.notation.notationMode:e.NotationMode.GuitarPro,i="grad"===this.text||"grad."===this.text;i&&s===e.NotationMode.SongBook&&(this.text="");let a=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let r=0,n=!1;for(let o=0,h=this.notes.length;o<h;o++){let h=this.notes[o];if(h.finish(t),h.isLetRing&&(this.isLetRing=!0),h.isPalmMute&&(this.isPalmMute=!0),s===e.NotationMode.SongBook&&h.hasBend&&this.graceType!==_.BendGrace){if(!h.isTieOrigin)switch(h.bendType){case f.Bend:case f.PrebendRelease:case f.PrebendBend:a=!0}i||h.bendStyle===g.Gradual?(i=!0,h.bendStyle=g.Gradual,a=!1):h.bendStyle=g.Fast}h.isVisible&&(r++,(!this.minNote||h.realValue<this.minNote.realValue)&&(this.minNote=h),(!this.maxNote||h.realValue>this.maxNote.realValue)&&(this.maxNote=h),(!this.minStringNote||h.string<this.minStringNote.string)&&(this.minStringNote=h),(!this.maxStringNote||h.string>this.maxStringNote.string)&&(this.maxStringNote=h),h.hasEffectSlur&&(n=!0))}if(n&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&0===r&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&t&&t.notation.notationMode===e.NotationMode.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));else{let e=this.previousBeat;for(;e&&e.isRest;)this.isLetRing||(e.isLetRing=!1),this.isPalmMute||(e.isPalmMute=!1),e=e.previousBeat}if(this.whammyBarPoints.length>0&&this.whammyBarType===M.Custom){s===e.NotationMode.SongBook&&(this.whammyStyle=i?g.Gradual:g.Fast);let t=!!this.previousBeat&&this.previousBeat.hasWhammyBar;if(this.isContinuedWhammy=t,4===this.whammyBarPoints.length){let i=this.whammyBarPoints[0],a=this.whammyBarPoints[1],r=this.whammyBarPoints[2],n=this.whammyBarPoints[3];a.value===r.value?i.value<a.value&&a.value<n.value||i.value>a.value&&a.value>n.value?(0===i.value||t?this.whammyBarType=M.Dive:this.whammyBarType=M.PrediveDive,this.whammyBarPoints.splice(2,1),this.whammyBarPoints.splice(1,1)):i.value>a.value&&a.value<n.value||i.value<a.value&&a.value>n.value?(this.whammyBarType=M.Dip,a.offset!==r.offset&&s!==e.NotationMode.SongBook||this.whammyBarPoints.splice(2,1)):i.value===a.value&&a.value===n.value?(0===i.value||t?this.whammyBarType=M.Hold:this.whammyBarType=M.Predive,this.whammyBarPoints.splice(2,1),this.whammyBarPoints.splice(1,1)):we.warning("Model","Unsupported whammy type detected, fallback to custom",null):we.warning("Model","Unsupported whammy type detected, fallback to custom",null)}}if(this.updateDurations(),a){let e=this.clone();e.id=Te._globalBeatId++;for(let t=0,s=e.notes.length;t<s;t++){let s=e.notes[t];s.bendType=f.None,s.maxBendPoint=null,s.bendPoints=[],s.bendStyle=g.Default,s.id=Be.GlobalNoteId++;let i=this.notes[t];if(i.hasBend&&i.isTieOrigin){let e=Be.nextNoteOnSameLine(i);if(e&&e.hasBend){s.bendType=f.Hold;let e=i.bendPoints[i.bendPoints.length-1];s.addBendPoint(new ye(0,e.value)),s.addBendPoint(new ye(ye.MaxPosition,e.value))}}s.isTieDestination=!0}this.graceType=_.BendGrace,this.updateDurations(),this.voice.insertBeat(this,e)}this.fermata=this.voice.bar.masterBar.getFermata(this)}isBefore(e){return this.voice.bar.index<e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index<e.index}isAfter(e){return this.voice.bar.index>e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index>e.index}hasNoteOnString(e){return this.noteStringLookup.has(e)}getNoteWithRealValue(e){return this.noteValueLookup.has(e)?this.noteValueLookup.get(e):null}}Te._globalBeatId=0;class ke{constructor(){this.name="",this.firstFret=1,this.strings=[],this.barreFrets=[],this.showName=!0,this.showDiagram=!0,this.showFingering=!0}static copyTo(e,t){t.firstFret=e.firstFret,t.name=e.name,t.strings=e.strings.slice(0),t.barreFrets=e.barreFrets.slice(0),t.showName=e.showName,t.showDiagram=e.showDiagram,t.showFingering=e.showFingering}}!function(e){e[e.IgnoreSpaces=0]="IgnoreSpaces",e[e.Begin=1]="Begin",e[e.Text=2]="Text",e[e.Comment=3]="Comment",e[e.Dash=4]="Dash"}(E||(E={}));class xe{constructor(){this.startBar=0,this.text=""}finish(){this.chunks=[],this.parse(this.text,0,this.chunks)}parse(e,t,s){if(!e)return;let i=E.Begin,a=E.Begin,r=!1,n=0;for(;t<e.length;){let o=e.charCodeAt(t);switch(i){case E.IgnoreSpaces:switch(o){case xe.CharCodeLF:case xe.CharCodeCR:case xe.CharCodeTab:break;case xe.CharCodeSpace:if(!r){i=a;continue}break;default:r=!1,i=a;continue}break;case E.Begin:switch(o){case xe.CharCodeBrackedOpen:i=E.Comment;break;default:n=t,i=E.Text;continue}break;case E.Comment:switch(o){case xe.CharCodeBrackedClose:i=E.Begin}break;case E.Text:switch(o){case xe.CharCodeDash:i=E.Dash;break;case xe.CharCodeCR:case xe.CharCodeLF:case xe.CharCodeSpace:let r=e.substr(n,t-n);s.push(this.prepareChunk(r)),i=E.IgnoreSpaces,a=E.Begin}break;case E.Dash:switch(o){case xe.CharCodeDash:break;default:let o=e.substr(n,t-n);s.push(this.prepareChunk(o)),r=!0,i=E.IgnoreSpaces,a=E.Begin;continue}}t++}i===E.Text&&t!==n&&s.push(e.substr(n,t-n))}prepareChunk(e){return e.split("+").join(" ")}}xe.CharCodeLF=10,xe.CharCodeTab=9,xe.CharCodeCR=13,xe.CharCodeSpace=32,xe.CharCodeBrackedClose=93,xe.CharCodeBrackedOpen=91,xe.CharCodeDash=45,function(e){e[e.Cb=-7]="Cb",e[e.Gb=-6]="Gb",e[e.Db=-5]="Db",e[e.Ab=-4]="Ab",e[e.Eb=-3]="Eb",e[e.Bb=-2]="Bb",e[e.F=-1]="F",e[e.C=0]="C",e[e.G=1]="G",e[e.D=2]="D",e[e.A=3]="A",e[e.E=4]="E",e[e.B=5]="B",e[e.FSharp=6]="FSharp",e[e.CSharp=7]="CSharp"}(D||(D={})),function(e){e[e.Major=0]="Major",e[e.Minor=1]="Minor"}(I||(I={})),function(e){e[e.NoTripletFeel=0]="NoTripletFeel",e[e.Triplet16th=1]="Triplet16th",e[e.Triplet8th=2]="Triplet8th",e[e.Dotted16th=3]="Dotted16th",e[e.Dotted8th=4]="Dotted8th",e[e.Scottish16th=5]="Scottish16th",e[e.Scottish8th=6]="Scottish8th"}(R||(R={}));class Ne{constructor(){this.alternateEndings=0,this.nextMasterBar=null,this.previousMasterBar=null,this.index=0,this.keySignature=D.C,this.keySignatureType=I.Major,this.isDoubleBar=!1,this.isRepeatStart=!1,this.repeatCount=0,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.timeSignatureCommon=!1,this.tripletFeel=R.NoTripletFeel,this.section=null,this.tempoAutomation=null,this.fermata=new Map,this.start=0,this.isAnacrusis=!1}get isRepeatEnd(){return this.repeatCount>0}get isSectionStart(){return!!this.section}static copyTo(e,t){t.isAnacrusis=e.isAnacrusis,t.alternateEndings=e.alternateEndings,t.index=e.index,t.keySignature=e.keySignature,t.keySignatureType=e.keySignatureType,t.isDoubleBar=e.isDoubleBar,t.isRepeatStart=e.isRepeatStart,t.repeatCount=e.repeatCount,t.timeSignatureNumerator=e.timeSignatureNumerator,t.timeSignatureDenominator=e.timeSignatureDenominator,t.timeSignatureCommon=e.timeSignatureCommon,t.tripletFeel=e.tripletFeel,t.start=e.start}calculateDuration(){if(this.isAnacrusis){let e=0;for(let t of this.score.tracks)for(let s of t.staves){let t=s.bars[0].calculateDuration();t>e&&(e=t)}return e}return this.timeSignatureNumerator*me.valueToTicks(this.timeSignatureDenominator)}addFermata(e,t){this.fermata.set(e,t)}getFermata(e){return this.fermata.has(e.playbackStart)?this.fermata.get(e.playbackStart):null}}Ne.MaxAlternateEndings=8;class Pe{constructor(){this.hideDynamics=!1}static copyTo(e,t){t.hideDynamics=e.hideDynamics}}class Fe{constructor(){this.masterBars=[],this.openings=[],this.closings=[],this.isOpened=!1,this.isClosed=!1}addMasterBar(e){0===this.openings.length&&this.openings.push(e),this.masterBars.push(e),e.repeatGroup=this,e.isRepeatEnd?(this.closings.push(e),this.isClosed=!0,this.isOpened||(this.masterBars[0].isRepeatStart=!0,this.isOpened=!0)):this.isClosed&&(this.isClosed=!1,this.openings.push(e))}}class Ce{constructor(){this._currentRepeatGroup=new Fe,this.album="",this.artist="",this.copyright="",this.instructions="",this.music="",this.notices="",this.subTitle="",this.title="",this.words="",this.tab="",this.tempo=120,this.tempoLabel="",this.masterBars=[],this.tracks=[],this.stylesheet=new Pe}static copyTo(e,t){t.album=e.album,t.artist=e.artist,t.copyright=e.copyright,t.instructions=e.instructions,t.music=e.music,t.notices=e.notices,t.subTitle=e.subTitle,t.title=e.title,t.words=e.words,t.tab=e.tab,t.tempo=e.tempo,t.tempoLabel=e.tempoLabel}rebuildRepeatGroups(){let e=new Fe;for(let t of this.masterBars)(t.isRepeatStart||this._currentRepeatGroup.isClosed&&t.alternateEndings<=0)&&(e=new Fe),e.addMasterBar(t)}addMasterBar(e){e.score=this,e.index=this.masterBars.length,0!==this.masterBars.length&&(e.previousMasterBar=this.masterBars[this.masterBars.length-1],e.previousMasterBar.nextMasterBar=e,e.start=e.previousMasterBar.start+e.previousMasterBar.calculateDuration()),(e.isRepeatStart||this._currentRepeatGroup.isClosed&&e.alternateEndings<=0)&&(this._currentRepeatGroup=new Fe),this._currentRepeatGroup.addMasterBar(e),this.masterBars.push(e)}addTrack(e){e.score=this,e.index=this.tracks.length,this.tracks.push(e)}finish(e){for(let t=0,s=this.tracks.length;t<s;t++)this.tracks[t].finish(e)}}class Le{constructor(){this.marker="",this.text=""}static copyTo(e,t){t.marker=e.marker,t.text=e.text}}class Me{constructor(){this.volume=15,this.balance=8,this.port=1,this.program=0,this.primaryChannel=0,this.secondaryChannel=0,this.isMute=!1,this.isSolo=!1}static copyTo(e,t){t.volume=e.volume,t.balance=e.balance,t.port=e.port,t.program=e.program,t.primaryChannel=e.primaryChannel,t.secondaryChannel=e.secondaryChannel,t.isMute=e.isMute,t.isSolo=e.isSolo}}class Ee{constructor(){this.index=0,this.bars=[],this.chords=new Map,this.capo=0,this.transpositionPitch=0,this.displayTranspositionPitch=0,this.tuning=[],this.tuningName="",this.showTablature=!0,this.showStandardNotation=!0,this.isPercussion=!1}get isStringed(){return this.tuning.length>0}static copyTo(e,t){t.capo=e.capo,t.index=e.index,t.tuning=e.tuning.slice(),t.transpositionPitch=e.transpositionPitch,t.displayTranspositionPitch=e.displayTranspositionPitch,t.showStandardNotation=e.showStandardNotation,t.showTablature=e.showTablature,t.isPercussion=e.isPercussion}finish(e){for(let t=0,s=this.bars.length;t<s;t++)this.bars[t].finish(e)}addChord(e,t){t.staff=this,this.chords.set(e,t)}addBar(e){let t=this.bars;e.staff=this,e.index=t.length,t.length>0&&(e.previousBar=t[t.length-1],e.previousBar.nextBar=e),t.push(e)}}class De{constructor(){this.index=0,this.staves=[],this.playbackInfo=new Me,this.color=new a(200,0,0,255),this.name="",this.shortName=""}ensureStaveCount(e){for(;this.staves.length<e;)this.addStaff(new Ee)}addStaff(e){e.index=this.staves.length,e.track=this,this.staves.push(e)}static copyTo(e,t){t.name=e.name,t.shortName=e.shortName,t.index=e.index,t.color.raw=e.color.raw,t.color.rgba=e.color.rgba}finish(e){this.shortName||(this.shortName=this.name,this.shortName.length>De.ShortNameMaxLength&&(this.shortName=this.shortName.substr(0,De.ShortNameMaxLength)));for(let t=0,s=this.staves.length;t<s;t++)this.staves[t].finish(e)}applyLyrics(e){for(let t of e)t.finish();let t=this.staves[0];for(let s=0;s<e.length;s++){let i=e[s];if(i.startBar>=0){let a=t.bars[i.startBar].voices[0].beats[0];for(let t=0;t<i.chunks.length&&a;t++){for(;a&&(a.isEmpty||a.isRest);)a=a.nextBeat;a&&(a.lyrics||(a.lyrics=new Array(e.length)),a.lyrics[s]=i.chunks[t],a=a.nextBeat)}}}}}De.ShortNameMaxLength=10;class Ie{constructor(e,t,s){this.isStandard=s,this.name=e,this.tunings=t}static getTextForTuning(e,t){let s=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"][e%12];return t&&(s+=(e/12|0)-1),s}static getDefaultTuningFor(e){return Ie._defaultTunings.has(e)?Ie._defaultTunings.get(e):null}static getPresetsFor(e){switch(e){case 7:return Ie._sevenStrings;case 6:return Ie._sixStrings;case 5:return Ie._fiveStrings;case 4:return Ie._fourStrings}return[]}static initialize(){Ie._defaultTunings.set(7,new Ie("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),Ie._sevenStrings.push(Ie._defaultTunings.get(7)),Ie._defaultTunings.set(6,new Ie("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),Ie._sixStrings.push(Ie._defaultTunings.get(6)),Ie._sixStrings.push(new Ie("Guitar Tune down Â½ step",[63,58,54,49,44,39],!1)),Ie._sixStrings.push(new Ie("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),Ie._sixStrings.push(new Ie("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),Ie._sixStrings.push(new Ie("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),Ie._sixStrings.push(new Ie("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),Ie._sixStrings.push(new Ie("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),Ie._sixStrings.push(new Ie("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),Ie._sixStrings.push(new Ie("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),Ie._sixStrings.push(new Ie("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),Ie._sixStrings.push(new Ie("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),Ie._sixStrings.push(new Ie("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),Ie._sixStrings.push(new Ie("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),Ie._sixStrings.push(new Ie("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),Ie._sixStrings.push(new Ie("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),Ie._sixStrings.push(new Ie("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),Ie._sixStrings.push(new Ie("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),Ie._sixStrings.push(new Ie("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),Ie._sixStrings.push(new Ie("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),Ie._sixStrings.push(new Ie("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),Ie._sixStrings.push(new Ie("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),Ie._sixStrings.push(new Ie("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),Ie._sixStrings.push(new Ie("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),Ie._sixStrings.push(new Ie("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),Ie._sixStrings.push(new Ie("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),Ie._sixStrings.push(new Ie("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),Ie._sixStrings.push(new Ie("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),Ie._sixStrings.push(new Ie("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),Ie._sixStrings.push(new Ie("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),Ie._sixStrings.push(new Ie("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),Ie._sixStrings.push(new Ie("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),Ie._defaultTunings.set(5,new Ie("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),Ie._fiveStrings.push(Ie._defaultTunings.get(5)),Ie._fiveStrings.push(new Ie("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),Ie._fiveStrings.push(new Ie("Banjo Open D Tuning",[62,57,54,50,69],!1)),Ie._fiveStrings.push(new Ie("Banjo Open G Tuning",[62,59,55,50,67],!1)),Ie._fiveStrings.push(new Ie("Banjo G Minor Tuning",[62,58,55,50,67],!1)),Ie._fiveStrings.push(new Ie("Banjo G Modal Tuning",[62,57,55,50,67],!1)),Ie._defaultTunings.set(4,new Ie("Bass Standard Tuning",[43,38,33,28],!0)),Ie._fourStrings.push(Ie._defaultTunings.get(4)),Ie._fourStrings.push(new Ie("Bass Tune down Â½ step",[42,37,32,27],!1)),Ie._fourStrings.push(new Ie("Bass Tune down 1 step",[41,36,31,26],!1)),Ie._fourStrings.push(new Ie("Bass Tune down 2 step",[39,34,29,24],!1)),Ie._fourStrings.push(new Ie("Bass Dropped D Tuning",[43,38,33,26],!1)),Ie._fourStrings.push(new Ie("Ukulele C Tuning",[45,40,36,43],!1)),Ie._fourStrings.push(new Ie("Ukulele G Tuning",[52,47,43,38],!1)),Ie._fourStrings.push(new Ie("Mandolin Standard Tuning",[64,57,50,43],!1)),Ie._fourStrings.push(new Ie("Mandolin or Violin Tuning",[76,69,62,55],!1)),Ie._fourStrings.push(new Ie("Viola Tuning",[69,62,55,48],!1)),Ie._fourStrings.push(new Ie("Cello Tuning",[57,50,43,36],!1))}static findTuning(e){let t=Ie.getPresetsFor(e.length);for(let s=0,i=t.length;s<i;s++){let i=t[s],a=!0;for(let t=0,s=e.length;t<s;t++)if(e[t]!==i.tunings[t]){a=!1;break}if(a)return i}return null}}Ie._sevenStrings=[],Ie._sixStrings=[],Ie._fiveStrings=[],Ie._fourStrings=[],Ie._defaultTunings=new Map,Ie.initialize();class Re{constructor(){this.index=0,this.beats=[],this.isEmpty=!0}static copyTo(e,t){t.index=e.index,t.isEmpty=e.isEmpty}insertBeat(e,t){t.nextBeat=e.nextBeat,t.nextBeat&&(t.nextBeat.previousBeat=t),t.previousBeat=e,t.voice=this,e.nextBeat=t,this.beats.splice(e.index+1,0,t)}addBeat(e){e.voice=this,e.index=this.beats.length,this.beats.push(e),e.isEmpty||(this.isEmpty=!1)}chain(e){if(this.bar)if(e.index<this.beats.length-1)e.nextBeat=this.beats[e.index+1],e.nextBeat.previousBeat=e;else if(e.isLastOfVoice&&e.voice.bar.nextBar){let t=this.bar.nextBar.voices[this.index];t.beats.length>0?(e.nextBeat=t.beats[0],e.nextBeat.previousBeat=e):e.nextBeat.previousBeat=e}}addGraceBeat(e){if(0===this.beats.length)return void this.addBeat(e);let t=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(e),this.addBeat(t),this.isEmpty=!1}getBeatAtDisplayStart(e){return this._beatLookup.has(e)?this._beatLookup.get(e):null}finish(e){this._beatLookup=new Map;for(let e=0;e<this.beats.length;e++){let t=this.beats[e];t.index=e,this.chain(t)}let t=0,s=0;for(let i=0;i<this.beats.length;i++){let a=this.beats[i];if(a.index=i,a.finish(e),a.graceType===_.None||a.graceType===_.BendGrace)a.displayStart=t,a.playbackStart=s,t+=a.displayDuration,s+=a.playbackDuration;else{if(!a.previousBeat||a.previousBeat.graceType===_.None){let e=a,r=0;for(;e&&e.graceType!==_.None;)e=e.nextBeat,r++;let n=b.Eighth,o=0;n=1===r?b.Eighth:2===r?b.Sixteenth:b.ThirtySecond,e&&e.updateDurations();let h=a.previousBeat?(a.previousBeat.displayDuration/4|0)/r|0:me.toTicks(b.ThirtySecond),l=this.beats[i];for(let e=0;e<r&&l;e++)l.duration=n,l.updateDurations(),l.displayStart=t-(r-e+1)*h,l.displayDuration=h,o+=l.playbackDuration,l=l.nextBeat;a.graceType===_.BeforeBeat?(a.previousBeat&&(a.previousBeat.playbackDuration-=o),s-=o):e&&a.graceType===_.OnBeat&&(e.playbackDuration-=o)}a.playbackStart=s,s=a.playbackStart+a.playbackDuration}a.finishTuplet(),this._beatLookup.set(a.displayStart,a)}}calculateDuration(){if(this.isEmpty||0===this.beats.length)return 0;let e=this.beats[this.beats.length-1];return e.playbackStart+e.playbackDuration}}class Oe{constructor(){this.note=null,this.noteValue=0,this.octave=0}get realValue(){return 12*this.octave+this.noteValue}}class Ae{static getIndex(e){return e<0?0:0|Math.log2(e)}static keySignatureIsFlat(e){return e<0}static keySignatureIsNatural(e){return 0===e}static keySignatureIsSharp(e){return e>0}static applyPitchOffsets(e,t){for(let s=0;s<t.tracks.length;s++){if(s<e.notation.displayTranspositionPitches.length)for(let i of t.tracks[s].staves)i.displayTranspositionPitch=-e.notation.displayTranspositionPitches[s];if(s<e.notation.transpositionPitches.length)for(let i of t.tracks[s].staves)i.transpositionPitch=-e.notation.transpositionPitches[s]}}static fingerToString(t,s,i,a){if(t.notation.fingeringMode===e.FingeringMode.ScoreForcePiano||t.notation.fingeringMode===e.FingeringMode.SingleNoteEffectBandForcePiano||ce.isPiano(s.voice.bar.staff.track.playbackInfo.program))switch(i){case w.Unknown:case w.NoOrDead:return null;case w.Thumb:return"1";case w.IndexFinger:return"2";case w.MiddleFinger:return"3";case w.AnnularFinger:return"4";case w.LittleFinger:return"5";default:return null}if(a)switch(i){case w.Unknown:case w.NoOrDead:return"0";case w.Thumb:return"T";case w.IndexFinger:return"1";case w.MiddleFinger:return"2";case w.AnnularFinger:return"3";case w.LittleFinger:return"4";default:return null}switch(i){case w.Unknown:case w.NoOrDead:return null;case w.Thumb:return"p";case w.IndexFinger:return"i";case w.MiddleFinger:return"m";case w.AnnularFinger:return"a";case w.LittleFinger:return"c";default:return null}}static isTuning(e){return!!Ae.parseTuning(e)}static parseTuning(e){let t="",s="";for(let a=0;a<e.length;a++){let r=e.charCodeAt(a);if(i.isCharNumber(r,!1)){if(!t)return null;s+=String.fromCharCode(r)}else{if(!(r>=65&&r<=90||r>=97&&r<=122||35===r))return null;t+=String.fromCharCode(r)}}if(!s||!t)return null;let a=new Oe;return a.octave=parseInt(s)+1,a.note=t.toLowerCase(),a.noteValue=Ae.getToneForText(a.note),a}static getTuningForText(e){let t=Ae.parseTuning(e);return t?t.realValue:-1}static getToneForText(e){let t=0;switch(e.toLowerCase()){case"c":t=0;break;case"c#":case"db":t=1;break;case"d":t=2;break;case"d#":case"eb":t=3;break;case"e":t=4;break;case"f":t=5;break;case"f#":case"gb":t=6;break;case"g":t=7;break;case"g#":case"ab":t=8;break;case"a":t=9;break;case"a#":case"bb":t=10;break;case"b":t=11;break;default:return 0}return t}}!function(e){e[e.No=0]="No",e[e.Eof=1]="Eof",e[e.Number=2]="Number",e[e.DoubleDot=3]="DoubleDot",e[e.Dot=4]="Dot",e[e.String=5]="String",e[e.Tuning=6]="Tuning",e[e.LParensis=7]="LParensis",e[e.RParensis=8]="RParensis",e[e.LBrace=9]="LBrace",e[e.RBrace=10]="RBrace",e[e.Pipe=11]="Pipe",e[e.MetaCommand=12]="MetaCommand",e[e.Multiply=13]="Multiply",e[e.LowerThan=14]="LowerThan",e[e.Property=15]="Property"}(O||(O={}));class Ge extends Error{constructor(e){super(e),this.position=0,this.nonTerm="",this.expected=O.No,this.symbol=O.No}static symbolError(e,t,s,i,a=null){let r;r=a?`MalFormed AlphaTex: @${e}: Error on block ${t}, invalid value: ${a}`:`MalFormed AlphaTex: @${e}: Error on block ${t}, expected a ${O[s]} found a ${O[i]}: '${a}'`;let n=new Ge(r);return n.position=e,n.nonTerm=t,n.expected=s,n.symbol=i,n.symbolData=a,n}static errorMessage(e,t){let s=new Ge(t="MalFormed AlphaTex: @"+e+": "+t);return s.position=e,s}}class Ve extends ue{constructor(){super(),this._trackChannel=0,this._ch=0,this._curChPos=0,this._sy=O.No,this._allowNegatives=!1,this._allowTuning=!1,this._currentDuration=b.QuadrupleWhole,this._currentDynamics=S.PPP,this._currentTuplet=0}get name(){return"AlphaTex"}readScore(){try{if(this._allowTuning=!0,this._lyrics=new Map,this.createDefaultScore(),this._curChPos=0,this._currentDuration=b.Quarter,this._currentDynamics=S.F,this._currentTuplet=1,this._ch=this.nextChar(),this._sy=this.newSy(),this._sy===O.LowerThan)throw new pe("Unknown start sign <");this.score(),this.consolidate(),this._score.finish(this.settings),this._score.rebuildRepeatGroups();for(let e of this._lyrics)this._score.tracks[e[0]].applyLyrics(e[1]);return this._score}catch(e){throw e instanceof Ge?new pe(e.message):e}}consolidate(){for(let e of this._score.tracks)for(let t of e.staves)for(;t.bars.length<this._score.masterBars.length;){let e=this.newBar(t),s=new Te;s.isEmpty=!0,e.voices[0].addBeat(s)}}error(e,t,s=!0){let i;throw i=s?Ge.symbolError(this._curChPos,e,t,this._sy,null):Ge.symbolError(this._curChPos,e,t,t,this._syData),we.error(this.name,i.message),i}errorMessage(e){let t=Ge.errorMessage(this._curChPos,e);throw we.error(this.name,t.message),t}createDefaultScore(){this._score=new Ce,this._score.tempo=120,this._score.tempoLabel="",this.newTrack()}newTrack(){this._currentTrack=new De,this._currentTrack.ensureStaveCount(1),this._currentTrack.playbackInfo.program=25,this._currentTrack.playbackInfo.primaryChannel=this._trackChannel++,this._currentTrack.playbackInfo.secondaryChannel=this._trackChannel++,this._currentStaff=this._currentTrack.staves[0],this._currentStaff.displayTranspositionPitch=-12,this._currentStaff.tuning=Ie.getDefaultTuningFor(6).tunings,this._score.addTrack(this._currentTrack),this._lyrics.set(this._currentTrack.index,[]),this._currentDynamics=S.F}parseClefFromString(e){switch(e.toLowerCase()){case"g2":case"treble":return c.G2;case"f4":case"bass":return c.F4;case"c3":case"tenor":return c.C3;case"c4":case"alto":return c.C4;case"n":case"neutral":return c.Neutral;default:return c.G2}}parseClefFromInt(e){switch(e){case 43:return c.G2;case 65:return c.F4;case 48:return c.C3;case 60:return c.C4;default:return c.G2}}parseTripletFeelFromString(e){switch(e.toLowerCase()){case"no":case"none":return R.NoTripletFeel;case"t16":case"triplet-16th":return R.Triplet16th;case"t8":case"triplet-8th":return R.Triplet8th;case"d16":case"dotted-16th":return R.Dotted16th;case"d8":case"dotted-8th":return R.Dotted8th;case"s16":case"scottish-16th":return R.Scottish16th;case"s8":case"scottish-8th":return R.Scottish8th;default:return R.NoTripletFeel}}parseTripletFeelFromInt(e){switch(e){case 0:return R.NoTripletFeel;case 1:return R.Triplet16th;case 2:return R.Triplet8th;case 3:return R.Dotted16th;case 4:return R.Dotted8th;case 5:return R.Scottish16th;case 6:return R.Scottish8th;default:return R.NoTripletFeel}}parseKeySignature(e){switch(e.toLowerCase()){case"cb":return-7;case"gb":return-6;case"db":return-5;case"ab":return-4;case"eb":return-3;case"bb":return-2;case"f":return-1;case"c":return 0;case"g":return 1;case"d":return 2;case"a":return 3;case"e":return 4;case"b":return 5;case"f#":return 6;case"c#":return 7;default:return 0}}nextChar(){let e=this.data.readByte();return-1===e?this._ch=0:(this._ch=e,this._curChPos++),this._ch}newSy(){this._sy=O.No;do{if(this._ch===Ve.Eof)this._sy=O.Eof;else if(i.isWhiteSpace(this._ch))this._ch=this.nextChar();else if(47===this._ch)if(this._ch=this.nextChar(),47===this._ch)for(;13!==this._ch&&10!==this._ch&&this._ch!==Ve.Eof;)this._ch=this.nextChar();else if(42===this._ch)for(;0!==this._ch;)if(42===this._ch){if(this._ch=this.nextChar(),47===this._ch){this._ch=this.nextChar();break}}else this._ch=this.nextChar();else this.error("symbol",O.String,!1);else if(34===this._ch||39===this._ch){let e=this._ch;this._ch=this.nextChar();let t="";for(this._sy=O.String;this._ch!==e&&this._ch!==Ve.Eof;)t+=String.fromCharCode(this._ch),this._ch=this.nextChar();this._syData=t,this._ch=this.nextChar()}else if(45===this._ch)if(this._allowNegatives&&this.isDigit(this._ch)){let e=this.readNumber();this._sy=O.Number,this._syData=e}else this._sy=O.String,this._syData=this.readName();else if(46===this._ch)this._sy=O.Dot,this._ch=this.nextChar();else if(58===this._ch)this._sy=O.DoubleDot,this._ch=this.nextChar();else if(40===this._ch)this._sy=O.LParensis,this._ch=this.nextChar();else if(92===this._ch){this._ch=this.nextChar();let e=this.readName();this._sy=O.MetaCommand,this._syData=e}else if(41===this._ch)this._sy=O.RParensis,this._ch=this.nextChar();else if(123===this._ch)this._sy=O.LBrace,this._ch=this.nextChar();else if(125===this._ch)this._sy=O.RBrace,this._ch=this.nextChar();else if(124===this._ch)this._sy=O.Pipe,this._ch=this.nextChar();else if(42===this._ch)this._sy=O.Multiply,this._ch=this.nextChar();else if(60===this._ch)this._sy=O.LowerThan,this._ch=this.nextChar();else if(this.isDigit(this._ch)){let e=this.readNumber();this._sy=O.Number,this._syData=e}else if(Ve.isLetter(this._ch)){let e=this.readName(),t=this._allowTuning?Ae.parseTuning(e):null;t?(this._sy=O.Tuning,this._syData=t):(this._sy=O.String,this._syData=e)}else this.error("symbol",O.String,!1)}while(this._sy===O.No);return this._sy}static isLetter(e){return!Ve.isTerminal(e)&&(e>=33&&e<=47||e>=58&&e<=126||e>128)}static isTerminal(e){return 46===e||123===e||125===e||91===e||93===e||40===e||41===e||124===e||39===e||34===e||92===e}isDigit(e){return e>=48&&e<=57||45===e&&this._allowNegatives}readName(){let e="";do{e+=String.fromCharCode(this._ch),this._ch=this.nextChar()}while(Ve.isLetter(this._ch)||this.isDigit(this._ch)||35===this._ch);return e}readNumber(){let e="";do{e+=String.fromCharCode(this._ch),this._ch=this.nextChar()}while(this.isDigit(this._ch));return parseInt(e)}score(){this.metaData(),this.bars()}metaData(){let e=!1,t=!0;for(;this._sy===O.MetaCommand&&t;){switch(this._syData.toLowerCase()){case"title":this._sy=this.newSy(),this._sy===O.String?this._score.title=this._syData:this.error("title",O.String,!0),this._sy=this.newSy(),e=!0;break;case"subtitle":this._sy=this.newSy(),this._sy===O.String?this._score.subTitle=this._syData:this.error("subtitle",O.String,!0),this._sy=this.newSy(),e=!0;break;case"artist":this._sy=this.newSy(),this._sy===O.String?this._score.artist=this._syData:this.error("artist",O.String,!0),this._sy=this.newSy(),e=!0;break;case"album":this._sy=this.newSy(),this._sy===O.String?this._score.album=this._syData:this.error("album",O.String,!0),this._sy=this.newSy(),e=!0;break;case"words":this._sy=this.newSy(),this._sy===O.String?this._score.words=this._syData:this.error("words",O.String,!0),this._sy=this.newSy(),e=!0;break;case"music":this._sy=this.newSy(),this._sy===O.String?this._score.music=this._syData:this.error("music",O.String,!0),this._sy=this.newSy(),e=!0;break;case"copyright":this._sy=this.newSy(),this._sy===O.String?this._score.copyright=this._syData:this.error("copyright",O.String,!0),this._sy=this.newSy(),e=!0;break;case"tempo":this._sy=this.newSy(),this._sy===O.Number?this._score.tempo=this._syData:this.error("tempo",O.Number,!0),this._sy=this.newSy(),e=!0;break;default:this.handleStaffMeta()?e=!0:e?this.error("metaDataTags",O.String,!1):t=!1}}e?(this._sy!==O.Dot&&this.error("song",O.Dot,!0),this._sy=this.newSy()):this._sy===O.Dot&&(this._sy=this.newSy())}handleStaffMeta(){switch(this._syData.toLowerCase()){case"capo":return this._sy=this.newSy(),this._sy===O.Number?this._currentStaff.capo=this._syData:this.error("capo",O.Number,!0),this._sy=this.newSy(),!0;case"tuning":this._sy=this.newSy();let e=this._currentStaff.tuning.length;switch(this._sy){case O.String:let e=this._syData.toLowerCase();"piano"===e||"none"===e||"voice"===e?this._currentStaff.tuning=[]:this.error("tuning",O.Tuning,!0),this._sy=this.newSy();break;case O.Tuning:let t=[];do{let e=this._syData;t.push(e.realValue),this._sy=this.newSy()}while(this._sy===O.Tuning);this._currentStaff.tuning=t;break;default:this.error("tuning",O.Tuning,!0)}return e!==this._currentStaff.tuning.length&&this._currentStaff.chords.size>0&&this.errorMessage("Tuning must be defined before any chord"),!0;case"instrument":if(this._sy=this.newSy(),this._sy===O.Number){let e=this._syData;e>=0&&e<=128?this._currentTrack.playbackInfo.program=this._syData:this.error("instrument",O.Number,!1)}else if(this._sy===O.String){let e=this._syData.toLowerCase();this._currentTrack.playbackInfo.program=ce.getValue(e)}else this.error("instrument",O.Number,!0);return this._currentStaff.displayTranspositionPitch=ce.isGuitar(this._currentTrack.playbackInfo.program)?-12:0,this._sy=this.newSy(),!0;case"lyrics":this._sy=this.newSy();let t=new xe;return t.startBar=0,t.text="",this._sy===O.Number&&(t.startBar=this._syData,this._sy=this.newSy()),this._sy===O.String?(t.text=this._syData,this._sy=this.newSy()):this.error("lyrics",O.String,!0),this._lyrics.get(this._currentTrack.index).push(t),!0;case"chord":this._sy=this.newSy();let s=new ke;this.chordProperties(s),this._sy===O.String?(s.name=this._syData,this._sy=this.newSy()):this.error("chord-name",O.Number,!0);for(let e=0;e<this._currentStaff.tuning.length;e++)this._sy===O.Number?s.strings.push(this._syData):this._sy===O.String&&"x"===this._syData.toLowerCase()&&s.strings.push(-1),this._sy=this.newSy();return this._currentStaff.addChord(s.name.toLowerCase(),s),!0;default:return!1}}chordProperties(e){if(this._sy===O.LBrace){for(this._sy=this.newSy();this._sy===O.String;)switch(this._syData.toLowerCase()){case"firstfret":switch(this._sy=this.newSy(),this._sy){case O.Number:e.firstFret=this._syData;break;default:this.error("chord-firstfret",O.Number,!0)}this._sy=this.newSy();break;case"showdiagram":switch(this._sy=this.newSy(),this._sy){case O.String:e.showDiagram="false"!==this._syData.toLowerCase();break;case O.Number:e.showDiagram=0!==this._syData;break;default:this.error("chord-showdiagram",O.String,!0)}this._sy=this.newSy();break;case"showfingering":switch(this._sy=this.newSy(),this._sy){case O.String:e.showDiagram="false"!==this._syData.toLowerCase();break;case O.Number:e.showFingering=0!==this._syData;break;default:this.error("chord-showfingering",O.String,!0)}this._sy=this.newSy();break;case"showname":switch(this._sy=this.newSy(),this._sy){case O.String:e.showName="false"!==this._syData.toLowerCase();break;case O.Number:e.showName=0!==this._syData;break;default:this.error("chord-showname",O.String,!0)}this._sy=this.newSy();break;case"barre":for(this._sy=this.newSy();this._sy===O.Number;)e.barreFrets.push(this._syData),this._sy=this.newSy();break;default:this.error("chord-properties",O.String,!1)}this._sy!==O.RBrace&&this.error("chord-properties",O.RBrace,!0),this._sy=this.newSy()}}bars(){for(this.bar();this._sy!==O.Eof;)if(this._sy===O.Pipe)this._sy=this.newSy(),this.bar();else{if(this._sy!==O.MetaCommand)break;this.bar()}}trackStaffMeta(){if(this._sy===O.MetaCommand){let e=this._syData.toLowerCase();"track"===e&&(this._sy=this.newSy(),this._score.masterBars.length>0&&this.newTrack(),this._sy===O.String&&(this._currentTrack.name=this._syData,this._sy=this.newSy()),this._sy===O.String&&(this._currentTrack.shortName=this._syData,this._sy=this.newSy())),this._sy===O.MetaCommand&&(e=this._syData.toLowerCase(),"staff"===e&&(this._sy=this.newSy(),this._currentTrack.staves[0].bars.length>0&&(this._currentTrack.ensureStaveCount(this._currentTrack.staves.length+1),this._currentStaff=this._currentTrack.staves[this._currentTrack.staves.length-1],this._currentDynamics=S.F),this.staffProperties()))}}staffProperties(){if(this._sy!==O.LBrace)return;this._sy=this.newSy();let e=!1,t=!1;for(;this._sy===O.String;)switch(this._syData.toLowerCase()){case"score":e=!0,this._sy=this.newSy();break;case"tabs":t=!0,this._sy=this.newSy();break;default:this.error("staff-properties",O.String,!1)}(e||t)&&(this._currentStaff.showStandardNotation=e,this._currentStaff.showTablature=t),this._sy!==O.RBrace&&this.error("staff-properties",O.RBrace,!0),this._sy=this.newSy()}bar(){this.trackStaffMeta();let e=this.newBar(this._currentStaff);if(this._currentStaff.bars.length>this._score.masterBars.length){let e=new Ne;this._score.addMasterBar(e),e.index>0&&(e.keySignature=e.previousMasterBar.keySignature,e.keySignatureType=e.previousMasterBar.keySignatureType,e.timeSignatureDenominator=e.previousMasterBar.timeSignatureDenominator,e.timeSignatureNumerator=e.previousMasterBar.timeSignatureNumerator,e.tripletFeel=e.previousMasterBar.tripletFeel)}this.barMeta(e);let t=e.voices[0];for(;this._sy!==O.Pipe&&this._sy!==O.Eof&&this.beat(t););if(0===t.beats.length){let e=new Te;e.isEmpty=!0,t.addBeat(e)}}newBar(e){let t=new fe;e.addBar(t),t.index>0&&(t.clef=t.previousBar.clef);let s=new Re;return t.addVoice(s),t}beat(e){this.beatDuration();let t=new Te;if(e.addBeat(t),e.bar.masterBar.tempoAutomation&&1===e.beats.length&&t.automations.push(e.bar.masterBar.tempoAutomation),this._sy===O.LParensis){for(this._sy=this.newSy(),this.note(t);this._sy!==O.RParensis&&this._sy!==O.Eof&&this.note(t););this._sy!==O.RParensis&&this.error("note-list",O.RParensis,!0),this._sy=this.newSy()}else if(this._sy===O.String&&"r"===this._syData.toLowerCase())this._sy=this.newSy();else if(!this.note(t))return e.beats.splice(e.beats.length-1,1),!1;this._sy===O.Dot&&(this._allowNegatives=!0,this._sy=this.newSy(),this._allowNegatives=!1,this._sy!==O.Number&&this.error("duration",O.Number,!0),this._currentDuration=this.parseDuration(this._syData),this._sy=this.newSy()),t.duration=this._currentDuration,t.dynamics=this._currentDynamics,1===this._currentTuplet||t.hasTuplet||this.applyTuplet(t,this._currentTuplet);let s=1;this._sy===O.Multiply&&(this._sy=this.newSy(),this._sy!==O.Number?this.error("multiplier",O.Number,!0):s=this._syData,this._sy=this.newSy()),this.beatEffects(t);for(let i=0;i<s-1;i++)e.addBeat(t.clone());return!0}beatDuration(){if(this._sy===O.DoubleDot&&(this._allowNegatives=!0,this._sy=this.newSy(),this._allowNegatives=!1,this._sy!==O.Number&&this.error("duration",O.Number,!0),this._currentDuration=this.parseDuration(this._syData),this._currentTuplet=1,this._sy=this.newSy(),this._sy===O.LBrace)){for(this._sy=this.newSy();this._sy===O.String;){switch(this._syData.toLowerCase()){case"tu":this._sy=this.newSy(),this._sy!==O.Number&&this.error("duration-tuplet",O.Number,!0),this._currentTuplet=this._syData,this._sy=this.newSy();break;default:this.error("beat-duration",O.String,!1)}}this._sy!==O.RBrace&&this.error("beat-duration",O.RBrace,!0),this._sy=this.newSy()}}beatEffects(e){if(this._sy===O.LBrace){for(this._sy=this.newSy();this._sy===O.String;)this._syData=this._syData.toLowerCase(),this.applyBeatEffect(e)||this.error("beat-effects",O.String,!1);this._sy!==O.RBrace&&this.error("beat-effects",O.RBrace,!0),this._sy=this.newSy()}}applyBeatEffect(e){let t=this._syData.toLowerCase();if("f"===t)return e.fadeIn=!0,this._sy=this.newSy(),!0;if("v"===t)return e.vibrato=x.Slight,this._sy=this.newSy(),!0;if("s"===t)return e.slap=!0,this._sy=this.newSy(),!0;if("p"===t)return e.pop=!0,this._sy=this.newSy(),!0;if("tt"===t)return e.tap=!0,this._sy=this.newSy(),!0;if("dd"===t)return e.dots=2,this._sy=this.newSy(),!0;if("d"===t)return e.dots=1,this._sy=this.newSy(),!0;if("su"===t)return e.pickStroke=L.Up,this._sy=this.newSy(),!0;if("sd"===t)return e.pickStroke=L.Down,this._sy=this.newSy(),!0;if("tu"===t)return this._sy=this.newSy(),this._sy!==O.Number?(this.error("tuplet",O.Number,!0),!1):(this.applyTuplet(e,this._syData),this._sy=this.newSy(),!0);if("tb"===t||"tbe"===t){let s="tbe"===t;if(this._sy=this.newSy(),this._sy!==O.LParensis)return this.error("tremolobar-effect",O.LParensis,!0),!1;for(this._allowNegatives=!0,this._sy=this.newSy();this._sy!==O.RParensis&&this._sy!==O.Eof;){let t=0,i=0;if(s){if(this._sy!==O.Number)return this.error("tremolobar-effect",O.Number,!0),!1;if(t=this._syData,this._sy=this.newSy(),this._sy!==O.Number)return this.error("tremolobar-effect",O.Number,!0),!1;i=this._syData}else{if(this._sy!==O.Number)return this.error("tremolobar-effect",O.Number,!0),!1;t=0,i=this._syData}e.addWhammyBarPoint(new ye(t,i)),this._sy=this.newSy()}for(;e.whammyBarPoints.length>60;)e.removeWhammyBarPoint(e.whammyBarPoints.length-1);if(s)e.whammyBarPoints.sort((e,t)=>e.offset-t.offset);else{let t=e.whammyBarPoints.length,s=60/t|0,i=0;for(;i<t;)e.whammyBarPoints[i].offset=Math.min(60,i*s),i++}return this._allowNegatives=!1,this._sy!==O.RParensis?(this.error("tremolobar-effect",O.RParensis,!0),!1):(this._sy=this.newSy(),!0)}if("ch"===t){this._sy=this.newSy();let t=this._syData,s=t.toLowerCase();if(!this._currentStaff.chords.has(s)){let e=new ke;e.showDiagram=!1,e.name=t,this._currentStaff.addChord(s,e)}return e.chordId=s,this._sy=this.newSy(),!0}if("gr"===t)return this._sy=this.newSy(),"ob"===this._syData.toLowerCase()?(e.graceType=_.OnBeat,this._sy=this.newSy()):"b"===this._syData.toLowerCase()?(e.graceType=_.BendGrace,this._sy=this.newSy()):e.graceType=_.BeforeBeat,!0;if("dy"===t){switch(this.newSy(),this._syData.toLowerCase()){case"ppp":e.dynamics=S.PPP;break;case"pp":e.dynamics=S.PP;break;case"p":e.dynamics=S.P;break;case"mp":e.dynamics=S.MP;break;case"mf":e.dynamics=S.MF;break;case"f":e.dynamics=S.F;break;case"ff":e.dynamics=S.FF;break;case"fff":e.dynamics=S.FFF}return this._currentDynamics=e.dynamics,this.newSy(),!0}if("cre"===t)return e.crescendo=y.Crescendo,this.newSy(),!0;if("dec"===t)return e.crescendo=y.Decrescendo,this.newSy(),!0;if("tp"===t){this._sy=this.newSy();let t=b.Eighth;if(this._sy===O.Number){switch(this._syData){case 8:t=b.Eighth;break;case 16:t=b.Sixteenth;break;case 32:t=b.ThirtySecond;break;default:t=b.Eighth}this._sy=this.newSy()}return e.tremoloSpeed=t,!0}return!1}applyTuplet(e,t){switch(t){case 3:e.tupletNumerator=3,e.tupletDenominator=2;break;case 5:e.tupletNumerator=5,e.tupletDenominator=4;break;case 6:e.tupletNumerator=6,e.tupletDenominator=4;break;case 7:e.tupletNumerator=7,e.tupletDenominator=4;break;case 9:e.tupletNumerator=9,e.tupletDenominator=8;break;case 10:e.tupletNumerator=10,e.tupletDenominator=8;break;case 11:e.tupletNumerator=11,e.tupletDenominator=8;break;case 12:e.tupletNumerator=12,e.tupletDenominator=8;break;default:e.tupletNumerator=1,e.tupletDenominator=1}}note(e){let t=!1,s=!1,i=-1,a=-1,r=-1;switch(this._sy){case O.Number:i=this._syData;break;case O.String:t="x"===this._syData,s="-"===this._syData,s||t?i=0:this.error("note-fret",O.Number,!0);break;case O.Tuning:let e=this._syData;a=e.octave,r=e.noteValue;break;default:return!1}this._sy=this.newSy();let n=-1===a&&this._currentStaff.tuning.length>0,o=-1;n&&(this._sy!==O.Dot&&this.error("note",O.Dot,!0),this._sy=this.newSy(),this._sy!==O.Number&&this.error("note-string",O.Number,!0),o=this._syData,(o<1||o>this._currentStaff.tuning.length)&&this.error("note-string",O.Number,!1),this._sy=this.newSy());let h=new Be;return n?(h.string=this._currentStaff.tuning.length-(o-1),h.isDead=t,h.isTieDestination=s,s||(h.fret=i)):(h.octave=a,h.tone=r,h.isTieDestination=s),e.addNote(h),this.noteEffects(h),!0}noteEffects(e){if(this._sy===O.LBrace){for(this._sy=this.newSy();this._sy===O.String;){let t=this._syData.toLowerCase();if(this._syData=t,"b"===t||"be"===t){let t="be"===this._syData;for(this._sy=this.newSy(),this._sy!==O.LParensis&&this.error("bend-effect",O.LParensis,!0),this._sy=this.newSy();this._sy!==O.RParensis&&this._sy!==O.Eof;){let s=0,i=0;t?(this._sy!==O.Number&&this.error("bend-effect-value",O.Number,!0),s=this._syData,this._sy=this.newSy(),this._sy!==O.Number&&this.error("bend-effect-value",O.Number,!0),i=this._syData):(this._sy!==O.Number&&this.error("bend-effect-value",O.Number,!0),i=this._syData),e.addBendPoint(new ye(s,i)),this._sy=this.newSy()}for(;e.bendPoints.length>60;)e.bendPoints.splice(e.bendPoints.length-1,1);if(t)e.bendPoints.sort((e,t)=>e.offset-t.offset);else{let t=e.bendPoints.length,s=60/(t-1)|0,i=0;for(;i<t;)e.bendPoints[i].offset=Math.min(60,i*s),i++}this._sy!==O.RParensis&&this.error("bend-effect",O.RParensis,!0),this._sy=this.newSy()}else if("nh"===t)e.harmonicType=B.Natural,this._sy=this.newSy();else if("ah"===t)e.harmonicType=B.Artificial,this._sy=this.newSy();else if("th"===t)e.harmonicType=B.Tap,this._sy=this.newSy();else if("ph"===t)e.harmonicType=B.Pinch,this._sy=this.newSy();else if("sh"===t)e.harmonicType=B.Semi,this._sy=this.newSy();else if("tr"===t){this._sy=this.newSy(),this._sy!==O.Number&&this.error("trill-effect",O.Number,!0);let t=this._syData;this._sy=this.newSy();let s=b.Sixteenth;if(this._sy===O.Number){switch(this._syData){case 16:s=b.Sixteenth;break;case 32:s=b.ThirtySecond;break;case 64:s=b.SixtyFourth;break;default:s=b.Sixteenth}this._sy=this.newSy()}e.trillValue=t+e.stringTuning,e.trillSpeed=s}else if("v"===t)this._sy=this.newSy(),e.vibrato=x.Slight;else if("sl"===t)this._sy=this.newSy(),e.slideOutType=k.Legato;else if("ss"===t)this._sy=this.newSy(),e.slideOutType=k.Shift;else if("sib"===t)this._sy=this.newSy(),e.slideInType=T.IntoFromBelow;else if("sia"===t)this._sy=this.newSy(),e.slideInType=T.IntoFromAbove;else if("sou"===t)this._sy=this.newSy(),e.slideOutType=k.OutUp;else if("sod"===t)this._sy=this.newSy(),e.slideOutType=k.OutDown;else if("psd"===t)this._sy=this.newSy(),e.slideOutType=k.PickSlideDown;else if("psu"===t)this._sy=this.newSy(),e.slideOutType=k.PickSlideUp;else if("h"===t)this._sy=this.newSy(),e.isHammerPullOrigin=!0;else if("g"===t)this._sy=this.newSy(),e.isGhost=!0;else if("ac"===t)this._sy=this.newSy(),e.accentuated=l.Normal;else if("hac"===t)this._sy=this.newSy(),e.accentuated=l.Heavy;else if("pm"===t)this._sy=this.newSy(),e.isPalmMute=!0;else if("st"===t)this._sy=this.newSy(),e.isStaccato=!0;else if("lr"===t)this._sy=this.newSy(),e.isLetRing=!0;else if("x"===t)this._sy=this.newSy(),e.fret=0,e.isDead=!0;else if("-"===t||"t"===t)this._sy=this.newSy(),e.isTieDestination=!0;else if("lf"===t){this._sy=this.newSy();let t=w.Thumb;this._sy===O.Number&&(t=this.toFinger(this._syData),this._sy=this.newSy()),e.leftHandFinger=t}else if("rf"===t){this._sy=this.newSy();let t=w.Thumb;this._sy===O.Number&&(t=this.toFinger(this._syData),this._sy=this.newSy()),e.rightHandFinger=t}else this.applyBeatEffect(e.beat)||this.error(t,O.String,!1)}this._sy!==O.RBrace&&this.error("note-effect",O.RBrace,!1),this._sy=this.newSy()}}toFinger(e){switch(e){case 1:return w.Thumb;case 2:return w.IndexFinger;case 3:return w.MiddleFinger;case 4:return w.AnnularFinger;case 5:return w.LittleFinger}return w.Thumb}parseDuration(e){switch(e){case-4:return b.QuadrupleWhole;case-2:return b.DoubleWhole;case 1:return b.Whole;case 2:return b.Half;case 4:return b.Quarter;case 8:return b.Eighth;case 16:return b.Sixteenth;case 32:return b.ThirtySecond;case 64:return b.SixtyFourth;case 128:return b.OneHundredTwentyEighth;default:return b.Quarter}}barMeta(e){let t=e.masterBar;for(;this._sy===O.MetaCommand;){let s=this._syData.toLowerCase();if("ts"===s)this._sy=this.newSy(),this._sy!==O.Number&&this.error("timesignature-numerator",O.Number,!0),t.timeSignatureNumerator=this._syData,this._sy=this.newSy(),this._sy!==O.Number&&this.error("timesignature-denominator",O.Number,!0),t.timeSignatureDenominator=this._syData,this._sy=this.newSy();else if("ro"===s)t.isRepeatStart=!0,this._sy=this.newSy();else if("rc"===s)this._sy=this.newSy(),this._sy!==O.Number&&this.error("repeatclose",O.Number,!0),t.repeatCount=this._syData,this._sy=this.newSy();else if("ks"===s)this._sy=this.newSy(),this._sy!==O.String&&this.error("keysignature",O.String,!0),t.keySignature=this.parseKeySignature(this._syData.toLowerCase()),this._sy=this.newSy();else if("clef"===s){switch(this._sy=this.newSy(),this._sy){case O.String:e.clef=this.parseClefFromString(this._syData.toLowerCase());break;case O.Number:e.clef=this.parseClefFromInt(this._syData);break;case O.Tuning:let t=this._syData;e.clef=this.parseClefFromInt(t.realValue);break;default:this.error("clef",O.String,!0)}this._sy=this.newSy()}else if("tempo"===s){this._sy=this.newSy(),this._sy!==O.Number&&this.error("tempo",O.Number,!0);let e=new ge;e.isLinear=!0,e.type=d.Tempo,e.value=this._syData,t.tempoAutomation=e,this._sy=this.newSy()}else if("section"===s){this._sy=this.newSy(),this._sy!==O.String&&this.error("section",O.String,!0);let e=this._syData;this._sy=this.newSy();let s="";this._sy===O.String&&(s=e,e=this._syData,this._sy=this.newSy());let i=new Le;i.marker=s,i.text=e,t.section=i}else if("tf"===s){switch(this._allowTuning=!1,this._sy=this.newSy(),this._allowTuning=!0,this._sy){case O.String:t.tripletFeel=this.parseTripletFeelFromString(this._syData.toLowerCase());break;case O.Number:t.tripletFeel=this.parseTripletFeelFromInt(this._syData);break;default:this.error("triplet-feel",O.String,!0)}this._sy=this.newSy()}else"ac"===s?(t.isAnacrusis=!0,this._sy=this.newSy()):0!==e.index||this.handleStaffMeta()||this.error("measure-effects",O.String,!1)}}}Ve.Eof=0;class He{static uint16ToInt16(e){return He._dataView.setUint16(0,e,!0),He._dataView.getInt16(0,!0)}static int16ToUint32(e){return He._dataView.setInt16(0,e,!0),He._dataView.getUint32(0,!0)}static int32ToUint16(e){return He._dataView.setInt32(0,e,!0),He._dataView.getUint16(0,!0)}static int32ToInt16(e){return He._dataView.setInt32(0,e,!0),He._dataView.getInt16(0,!0)}static int32ToUint32(e){return He._dataView.setInt32(0,e,!0),He._dataView.getUint32(0,!0)}static uint8ToInt8(e){return He._dataView.setUint8(0,e),He._dataView.getInt8(0)}}He._conversionBuffer=new ArrayBuffer(8),He._dataView=new DataView(He._conversionBuffer);class We{static readInt32BE(e){return e.readByte()<<24|e.readByte()<<16|e.readByte()<<8|e.readByte()}static readInt32LE(e){let t=e.readByte(),s=e.readByte(),i=e.readByte();return e.readByte()<<24|i<<16|s<<8|t}static readUInt32LE(e){let t=e.readByte(),s=e.readByte(),i=e.readByte();return e.readByte()<<24|i<<16|s<<8|t}static readUInt16LE(e){let t=e.readByte(),s=e.readByte();return He.int32ToUint16(s<<8|t)}static readInt16LE(e){let t=e.readByte(),s=e.readByte();return He.int32ToInt16(s<<8|t)}static readUInt32BE(e){let t=e.readByte(),s=e.readByte(),i=e.readByte(),a=e.readByte();return He.int32ToUint32(t<<24|s<<16|i<<8|a)}static readUInt16BE(e){let t=e.readByte(),s=e.readByte();return He.int32ToInt16(t<<8|s)}static readInt16BE(e){let t=e.readByte(),s=e.readByte();return He.int32ToInt16(t<<8|s)}static readByteArray(e,t){let s=new Uint8Array(t);return e.read(s,0,t),s}static read8BitChars(e,t){let s=new Uint8Array(t);return e.read(s,0,s.length),i.toString(s,"utf-8")}static read8BitString(e){let t="",s=e.readByte();for(;0!==s;)t+=String.fromCharCode(s),s=e.readByte();return t}static read8BitStringLength(e,t){let s="",i=-1;for(let a=0;a<t;a++){let t=e.readByte();0===t&&-1===i&&(i=a),s+=String.fromCharCode(t)}let a=s;return i>=0?a.substr(0,i):a}static readSInt8(e){let t=e.readByte();return-256*((255&t)>>7)+(255&t)}static readInt24(e,t){let s=e[t]|e[t+1]<<8|e[t+2]<<16;return 8388608==(8388608&s)&&(s|=255<<24),s}static readInt16(e,t){return He.int32ToInt16(e[t]|e[t+1]<<8)}}class ze extends ue{constructor(){super(),this._versionNumber=0,this._globalTripletFeel=R.NoTripletFeel,this._lyricsTrack=0,this._lyrics=[],this._barCount=0,this._trackCount=0,this._playbackInfos=[]}get name(){return"Guitar Pro 3-5"}readScore(){return this.readVersion(),this._score=new Ce,this.readScoreInformation(),this._versionNumber<500&&(this._globalTripletFeel=Ue.gpReadBool(this.data)?R.Triplet8th:R.NoTripletFeel),this._versionNumber>=400&&this.readLyrics(),this._versionNumber>=510&&this.data.skip(19),this._versionNumber>=500&&(this.readPageSetup(),this._score.tempoLabel=Ue.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this._score.tempo=We.readInt32LE(this.data),this._versionNumber>=510&&Ue.gpReadBool(this.data),We.readInt32LE(this.data),this._versionNumber>=400&&this.data.readByte(),this.readPlaybackInfos(),this._versionNumber>=500&&(this.data.skip(38),this.data.skip(4)),this._barCount=We.readInt32LE(this.data),this._trackCount=We.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this._score.finish(this.settings),this._lyrics&&this._lyricsTrack>=0&&this._score.tracks[this._lyricsTrack].applyLyrics(this._lyrics),this._score}readVersion(){let e=Ue.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!e.startsWith(ze.VersionString))throw new pe("Unsupported format");e=e.substr(ze.VersionString.length+1);let t=e.indexOf(String.fromCharCode(46));this._versionNumber=100*parseInt(e.substr(0,t))+parseInt(e.substr(t+1)),we.info(this.name,"Guitar Pro version "+e+" detected")}readScoreInformation(){var e;this._score.title=Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.subTitle=Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.artist=Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.album=Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.words=Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.music=this._versionNumber>=500?Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this._score.words,this._score.copyright=Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.tab=Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.instructions=Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding);let t=We.readInt32LE(this.data),s="";for(let i=0;i<t;i++)i>0&&(s+="\r\n"),s+=null===(e=Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding))||void 0===e?void 0:e.toString();this._score.notices=s}readLyrics(){this._lyrics=[],this._lyricsTrack=We.readInt32LE(this.data)-1;for(let e=0;e<5;e++){let e=new xe;e.startBar=We.readInt32LE(this.data)-1,e.text=Ue.gpReadStringInt(this.data,this.settings.importer.encoding),this._lyrics.push(e)}}readPageSetup(){this.data.skip(30);for(let e=0;e<10;e++)Ue.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this._playbackInfos=[];for(let e=0;e<64;e++){let t=new Me;t.primaryChannel=e,t.secondaryChannel=e,t.program=We.readInt32LE(this.data),t.volume=this.data.readByte(),t.balance=this.data.readByte(),this.data.skip(6),this._playbackInfos.push(t)}}readMasterBars(){for(let e=0;e<this._barCount;e++)this.readMasterBar()}readMasterBar(){let e=null;this._score.masterBars.length>0&&(e=this._score.masterBars[this._score.masterBars.length-1]);let t=new Ne,s=this.data.readByte();if(0!=(1&s)?t.timeSignatureNumerator=this.data.readByte():e&&(t.timeSignatureNumerator=e.timeSignatureNumerator),0!=(2&s)?t.timeSignatureDenominator=this.data.readByte():e&&(t.timeSignatureDenominator=e.timeSignatureDenominator),t.isRepeatStart=0!=(4&s),0!=(8&s)&&(t.repeatCount=this.data.readByte()+(this._versionNumber>=500?0:1)),0!=(16&s))if(this._versionNumber<500){let s=e,i=0;for(;s&&(!s.isRepeatEnd||s===e)&&!s.isRepeatStart;)i|=s.alternateEndings,s=s.previousMasterBar;let a=0,r=this.data.readByte();for(let e=0;e<8;e++){let t=1<<e;r>e&&0==(i&t)&&(a|=t)}t.alternateEndings=a}else t.alternateEndings=this.data.readByte();if(0!=(32&s)){let e=new Le;e.text=Ue.gpReadStringIntByte(this.data,this.settings.importer.encoding),e.marker="",Ue.gpReadColor(this.data,!1),t.section=e}if(0!=(64&s)?(t.keySignature=We.readSInt8(this.data),t.keySignatureType=this.data.readByte()):e&&(t.keySignature=e.keySignature,t.keySignatureType=e.keySignatureType),this._versionNumber>=500&&0!=(3&s)&&this.data.skip(4),this._versionNumber>=500&&0==(16&s)&&(t.alternateEndings=this.data.readByte()),this._versionNumber>=500){switch(this.data.readByte()){case 1:t.tripletFeel=R.Triplet8th;break;case 2:t.tripletFeel=R.Triplet16th}this.data.readByte()}else t.tripletFeel=this._globalTripletFeel;t.isDoubleBar=0!=(128&s),this._score.addMasterBar(t)}readTracks(){for(let e=0;e<this._trackCount;e++)this.readTrack()}readTrack(){let e=new De;e.ensureStaveCount(1),this._score.addTrack(e);let t=e.staves[0],s=this.data.readByte();e.name=Ue.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),0!=(1&s)&&(t.isPercussion=!0);let i=We.readInt32LE(this.data),a=[];for(let e=0;e<7;e++){let t=We.readInt32LE(this.data);i>e&&a.push(t)}t.tuning=a;let r=We.readInt32LE(this.data),n=We.readInt32LE(this.data)-1,o=We.readInt32LE(this.data)-1;if(this.data.skip(4),n>=0&&n<this._playbackInfos.length){let i=this._playbackInfos[n];i.port=r,i.isSolo=0!=(16&s),i.isMute=0!=(32&s),i.secondaryChannel=o,ce.isGuitar(i.program)&&(t.displayTranspositionPitch=-12),e.playbackInfo=i}t.capo=We.readInt32LE(this.data),e.color=Ue.gpReadColor(this.data,!1),this._versionNumber>=500&&(this.data.readByte(),this.data.readByte(),this.data.skip(43)),this._versionNumber>=510&&(this.data.skip(4),Ue.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ue.gpReadStringIntByte(this.data,this.settings.importer.encoding))}readBars(){for(let e=0;e<this._barCount;e++)for(let e=0;e<this._trackCount;e++)this.readBar(this._score.tracks[e])}readBar(e){let t=new fe,s=e.staves[0];s.isPercussion&&(t.clef=c.Neutral),s.addBar(t);let i=1;this._versionNumber>=500&&(this.data.readByte(),i=2);for(let s=0;s<i;s++)this.readVoice(e,t)}readVoice(e,t){let s=We.readInt32LE(this.data);if(0===s)return;let i=new Re;t.addVoice(i);for(let a=0;a<s;a++)this.readBeat(e,t,i)}readBeat(e,t,s){let i=new Te,a=this.data.readByte();if(0!=(1&a)&&(i.dots=1),0!=(64&a)){let e=this.data.readByte();i.isEmpty=0==(2&e)}switch(s.addBeat(i),We.readSInt8(this.data)){case-2:i.duration=b.Whole;break;case-1:i.duration=b.Half;break;case 0:i.duration=b.Quarter;break;case 1:i.duration=b.Eighth;break;case 2:i.duration=b.Sixteenth;break;case 3:i.duration=b.ThirtySecond;break;case 4:i.duration=b.SixtyFourth;break;default:i.duration=b.Quarter}if(0!=(32&a))switch(i.tupletNumerator=We.readInt32LE(this.data),i.tupletNumerator){case 1:i.tupletDenominator=1;break;case 3:i.tupletDenominator=2;break;case 5:case 6:case 7:i.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:i.tupletDenominator=8;break;case 2:case 4:case 8:break;default:i.tupletNumerator=1,i.tupletDenominator=1}0!=(2&a)&&this.readChord(i),0!=(4&a)&&(i.text=Ue.gpReadStringIntUnused(this.data,this.settings.importer.encoding)),0!=(8&a)&&this.readBeatEffects(i),0!=(16&a)&&this.readMixTableChange(i);let r=this.data.readByte();for(let a=6;a>=0;a--)0!=(r&1<<a)&&6-a<t.staff.tuning.length&&this.readNote(e,t,s,i,6-a);if(this._versionNumber>=500){this.data.readByte(),0!=(8&this.data.readByte())&&this.data.readByte()}}readChord(e){let t=new ke,s=i.newGuid();if(this._versionNumber>=500){this.data.skip(17),t.name=Ue.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=We.readInt32LE(this.data);for(let s=0;s<7;s++){let i=We.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(i)}let s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let e=0;e<s;e++)t.barreFrets.push(i[e]);this.data.skip(26)}else if(0!==this.data.readByte())if(this._versionNumber>=400){this.data.skip(16),t.name=Ue.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=We.readInt32LE(this.data);for(let s=0;s<7;s++){let i=We.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(i)}let s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let e=0;e<s;e++)t.barreFrets.push(i[e]);this.data.skip(26)}else{this.data.skip(25),t.name=Ue.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),t.firstFret=We.readInt32LE(this.data);for(let s=0;s<6;s++){let i=We.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(i)}this.data.skip(36)}else{let s=this._versionNumber>=406?7:6;if(t.name=Ue.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.firstFret=We.readInt32LE(this.data),t.firstFret>0)for(let i=0;i<s;i++){let s=We.readInt32LE(this.data);i<e.voice.bar.staff.tuning.length&&t.strings.push(s)}}t.name&&(e.chordId=s,e.voice.bar.staff.addChord(e.chordId,t))}readBeatEffects(e){let t=this.data.readByte(),s=0;if(this._versionNumber>=400&&(s=this.data.readByte()),e.fadeIn=0!=(16&t),(this._versionNumber<400&&0!=(1&t)||0!=(2&t))&&(e.vibrato=x.Slight),e.hasRasgueado=0!=(1&s),0!=(32&t)&&this._versionNumber>=400){switch(We.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0}}else if(0!=(32&t)){switch(We.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0}this.data.skip(4)}if(0!=(4&s)&&this.readTremoloBarEffect(e),0!=(64&t)){let t=0,s=0;this._versionNumber<500?(s=this.data.readByte(),t=this.data.readByte()):(t=this.data.readByte(),s=this.data.readByte()),t>0?(e.brushType=m.BrushUp,e.brushDuration=ze.toStrokeValue(t)):s>0&&(e.brushType=m.BrushDown,e.brushDuration=ze.toStrokeValue(s))}if(0!=(2&s))switch(We.readSInt8(this.data)){case 0:e.pickStroke=L.None;break;case 1:e.pickStroke=L.Up;break;case 2:e.pickStroke=L.Down}}readTremoloBarEffect(e){this.data.readByte(),We.readInt32LE(this.data);let t=We.readInt32LE(this.data);if(t>0)for(let s=0;s<t;s++){let t=new ye(0,0);t.offset=We.readInt32LE(this.data),t.value=We.readInt32LE(this.data)/ze.BendStep|0,Ue.gpReadBool(this.data),e.addWhammyBarPoint(t)}}static toStrokeValue(e){switch(e){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}readMixTableChange(e){let t=new Xe;t.instrument=We.readSInt8(this.data),this._versionNumber>=500&&this.data.skip(16),t.volume=We.readSInt8(this.data),t.balance=We.readSInt8(this.data);let s=We.readSInt8(this.data),i=We.readSInt8(this.data),a=We.readSInt8(this.data),r=We.readSInt8(this.data);if(this._versionNumber>=500&&(t.tempoName=Ue.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.tempo=We.readInt32LE(this.data),t.volume>=0&&this.data.readByte(),t.balance>=0&&this.data.readByte(),s>=0&&this.data.readByte(),i>=0&&this.data.readByte(),a>=0&&this.data.readByte(),r>=0&&this.data.readByte(),t.tempo>=0&&(t.duration=We.readSInt8(this.data),this._versionNumber>=510&&this.data.readByte()),this._versionNumber>=400&&this.data.readByte(),this._versionNumber>=500&&this.data.readByte(),this._versionNumber>=510&&(Ue.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ue.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.volume>=0){let s=new ge;s.isLinear=!0,s.type=d.Volume,s.value=t.volume,e.automations.push(s)}if(t.balance>=0){let s=new ge;s.isLinear=!0,s.type=d.Balance,s.value=t.balance,e.automations.push(s)}if(t.instrument>=0){let s=new ge;s.isLinear=!0,s.type=d.Instrument,s.value=t.instrument,e.automations.push(s)}if(t.tempo>=0){let s=new ge;s.isLinear=!0,s.type=d.Tempo,s.value=t.tempo,e.automations.push(s),e.voice.bar.masterBar.tempoAutomation=s}}readNote(e,t,s,i,a){let r=new Be;r.string=t.staff.tuning.length-a;let n=this.data.readByte();if(0!=(2&n)?r.accentuated=l.Heavy:0!=(64&n)&&(r.accentuated=l.Normal),r.isGhost=0!=(4&n),0!=(32&n)){let e=this.data.readByte();3===e?r.isDead=!0:2===e&&(r.isTieDestination=!0)}if(0!=(1&n)&&this._versionNumber<500&&(this.data.readByte(),this.data.readByte()),0!=(16&n)){let e=We.readSInt8(this.data);r.dynamics=this.toDynamicValue(e),i.dynamics=r.dynamics}if(0!=(32&n)&&(r.fret=We.readSInt8(this.data)),0!=(128&n)&&(r.leftHandFinger=We.readSInt8(this.data),r.rightHandFinger=We.readSInt8(this.data),r.isFingering=!0),this._versionNumber>=500){0!=(1&n)&&(r.durationPercent=Ue.gpReadDouble(this.data));let e=this.data.readByte();r.accidentalMode=0!=(2&e)?v.SwapAccidentals:v.Default}i.addNote(r),0!=(8&n)&&this.readNoteEffects(e,s,i,r)}toDynamicValue(e){switch(e){case 1:return S.PPP;case 2:return S.PP;case 3:return S.P;case 4:return S.MP;case 5:return S.MF;case 6:return S.F;case 7:return S.FF;case 8:return S.FFF;default:return S.F}}readNoteEffects(e,t,s,i){let a=this.data.readByte(),r=0;this._versionNumber>=400&&(r=this.data.readByte()),0!=(1&a)&&this.readBend(i),0!=(16&a)&&this.readGrace(t,i),0!=(4&r)&&this.readTremoloPicking(s),0!=(8&r)?this.readSlide(i):this._versionNumber<400&&0!=(4&a)&&(i.slideOutType=k.Shift),0!=(16&r)?this.readArtificialHarmonic(i):this._versionNumber<400&&(0!=(4&a)&&(i.harmonicType=B.Natural,i.harmonicValue=this.deltaFretToHarmonicValue(i.fret)),0!=(8&a)&&(i.harmonicType=B.Artificial)),0!=(32&r)&&this.readTrill(i),i.isLetRing=0!=(8&a),i.isHammerPullOrigin=0!=(2&a),0!=(64&r)&&(i.vibrato=x.Slight),i.isPalmMute=0!=(2&r),i.isStaccato=0!=(1&r)}readBend(e){this.data.readByte(),We.readInt32LE(this.data);let t=We.readInt32LE(this.data);if(t>0)for(let s=0;s<t;s++){let t=new ye(0,0);t.offset=We.readInt32LE(this.data),t.value=We.readInt32LE(this.data)/ze.BendStep|0,Ue.gpReadBool(this.data),e.addBendPoint(t)}}readGrace(e,t){let s=new Te,i=new Be;switch(i.string=t.string,i.fret=We.readSInt8(this.data),s.duration=b.ThirtySecond,s.dynamics=this.toDynamicValue(We.readSInt8(this.data)),We.readSInt8(this.data)){case 0:break;case 1:i.slideOutType=k.Legato,i.slideTarget=t;break;case 2:break;case 3:i.isHammerPullOrigin=!0}if(i.dynamics=s.dynamics,this.data.skip(1),this._versionNumber<500)s.graceType=_.BeforeBeat;else{let e=this.data.readByte();i.isDead=0!=(1&e),s.graceType=0!=(2&e)?_.OnBeat:_.BeforeBeat}e.addGraceBeat(s),s.addNote(i)}readTremoloPicking(e){switch(this.data.readByte()){case 1:e.tremoloSpeed=b.Eighth;break;case 2:e.tremoloSpeed=b.Sixteenth;break;case 3:e.tremoloSpeed=b.ThirtySecond}}readSlide(e){if(this._versionNumber>=500){let t=We.readSInt8(this.data);0!=(1&t)?e.slideOutType=k.Shift:0!=(2&t)?e.slideOutType=k.Legato:0!=(4&t)?e.slideOutType=k.OutDown:0!=(8&t)&&(e.slideOutType=k.OutUp),0!=(16&t)?e.slideInType=T.IntoFromBelow:0!=(32&t)&&(e.slideInType=T.IntoFromAbove)}else{switch(We.readSInt8(this.data)){case 1:e.slideOutType=k.Shift;break;case 2:e.slideOutType=k.Legato;break;case 3:e.slideOutType=k.OutDown;break;case 4:e.slideOutType=k.OutUp;break;case-1:e.slideInType=T.IntoFromBelow;break;case-2:e.slideInType=T.IntoFromAbove}}}readArtificialHarmonic(e){let t=this.data.readByte();if(this._versionNumber>=500)switch(t){case 1:e.harmonicType=B.Natural,e.harmonicValue=this.deltaFretToHarmonicValue(e.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),e.harmonicType=B.Artificial;break;case 3:e.harmonicType=B.Tap,e.harmonicValue=this.deltaFretToHarmonicValue(this.data.readByte());break;case 4:e.harmonicType=B.Pinch,e.harmonicValue=12;break;case 5:e.harmonicType=B.Semi,e.harmonicValue=12}else if(this._versionNumber>=400)switch(t){case 1:e.harmonicType=B.Natural;break;case 3:e.harmonicType=B.Tap;break;case 4:e.harmonicType=B.Pinch;break;case 5:e.harmonicType=B.Semi;break;case 15:case 17:case 22:e.harmonicType=B.Artificial}}deltaFretToHarmonicValue(e){switch(e){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return e;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}readTrill(e){switch(e.trillValue=this.data.readByte()+e.stringTuning,this.data.readByte()){case 1:e.trillSpeed=b.Sixteenth;break;case 2:e.trillSpeed=b.ThirtySecond;break;case 3:e.trillSpeed=b.SixtyFourth}}}ze.VersionString="FICHIER GUITAR PRO ",ze.BendStep=25;class Ue{static gpReadDouble(e){let t=new Uint8Array(8);return e.read(t,0,t.length),i.toDouble(t)}static gpReadFloat(e){let t=new Uint8Array(4);return t[3]=e.readByte(),t[2]=e.readByte(),t[2]=e.readByte(),t[1]=e.readByte(),i.toFloat(t)}static gpReadColor(e,t=!1){let s=e.readByte(),i=e.readByte(),r=e.readByte(),n=255;return t?n=e.readByte():e.skip(1),new a(s,i,r,n)}static gpReadBool(e){return 0!==e.readByte()}static gpReadStringIntUnused(e,t){return e.skip(4),Ue.gpReadString(e,e.readByte(),t)}static gpReadStringInt(e,t){return Ue.gpReadString(e,We.readInt32LE(e),t)}static gpReadStringIntByte(e,t){let s=We.readInt32LE(e)-1;return e.readByte(),Ue.gpReadString(e,s,t)}static gpReadString(e,t,s){let a=new Uint8Array(t);return e.read(a,0,a.length),i.toString(a,s)}static gpReadStringByteLength(e,t,s){let i=e.readByte(),a=Ue.gpReadString(e,i,s);return i<t&&e.skip(t-i),a}}class Xe{constructor(){this.volume=-1,this.balance=-1,this.instrument=-1,this.tempoName="",this.tempo=-1,this.duration=-1}}class Ye{constructor(){this._capacity=0,this.length=0,this.position=0}getBuffer(){return this._buffer}static empty(){return Ye.withCapactiy(0)}static withCapactiy(e){let t=new Ye;return t._buffer=new Uint8Array(e),t._capacity=e,t}static fromBuffer(e){let t=new Ye;return t._buffer=e,t._capacity=t.length=e.length,t}reset(){this.position=0}skip(e){this.position+=e}setCapacity(e){if(e!==this._capacity){if(e>0){let t=new Uint8Array(e);this.length>0&&t.set(this._buffer.subarray(0,0+this.length),0),this._buffer=t}this._capacity=e}}readByte(){return this.length-this.position<=0?-1:this._buffer[this.position++]}read(e,t,s){let i=this.length-this.position;if(i>s&&(i=s),i<=0)return 0;if(i<=8){let s=i;for(;--s>=0;)e[t+s]=this._buffer[this.position+s]}else e.set(this._buffer.subarray(this.position,this.position+i),t);return this.position+=i,i}writeByte(e){let t=new Uint8Array(1);t[0]=e,this.write(t,0,1)}write(e,t,s){let i=this.position+s;if(i>this.length&&(i>this._capacity&&this.ensureCapacity(i),this.length=i),s<=8&&e!==this._buffer){let i=s;for(;--i>=0;)this._buffer[this.position+i]=e[t+i]}else{let i=Math.min(s,e.length-t);this._buffer.set(e.subarray(t,t+i),this.position)}this.position=i}ensureCapacity(e){if(e>this._capacity){let t=e;t<256&&(t=256),t<2*this._capacity&&(t=2*this._capacity),this.setCapacity(t)}}readAll(){return this.toArray()}toArray(){let e=new Uint8Array(this.length);return e.set(this._buffer.subarray(0,0+this.length),0),e}}class Je{constructor(){this.x=0,this.y=0,this.w=0,this.h=0}}!function(e){e[e.Boolean=0]="Boolean",e[e.Integer=1]="Integer",e[e.Float=2]="Float",e[e.String=3]="String",e[e.Point=4]="Point",e[e.Size=5]="Size",e[e.Rectangle=6]="Rectangle",e[e.Color=7]="Color"}(A||(A={}));class Qe{constructor(e){this.raw=new Map;let t=Ye.fromBuffer(e),s=We.readInt32BE(t);for(let e=0;e<s;e++){let e=Ue.gpReadString(t,t.readByte(),"utf-8");switch(t.readByte()){case A.Boolean:let s=1===t.readByte();this.addValue(e,s);break;case A.Integer:let i=We.readInt32BE(t);this.addValue(e,i);break;case A.Float:let a=Ue.gpReadFloat(t);this.addValue(e,a);break;case A.String:let r=Ue.gpReadString(t,We.readInt16BE(t),"utf-8");this.addValue(e,r);break;case A.Point:let n=We.readInt32BE(t),o=We.readInt32BE(t);this.addValue(e,new ye(n,o));break;case A.Size:let h=We.readInt32BE(t),l=We.readInt32BE(t);this.addValue(e,new ye(h,l));break;case A.Rectangle:let d=new Je;d.x=We.readInt32BE(t),d.y=We.readInt32BE(t),d.w=We.readInt32BE(t),d.h=We.readInt32BE(t),this.addValue(e,d);break;case A.Color:let c=Ue.gpReadColor(t,!0);this.addValue(e,c)}}}apply(e){for(let t of this.raw)switch(t[0]){case"StandardNotation/hideDynamics":e.stylesheet.hideDynamics=t[1]}}addValue(e,t){this.raw.set(e,t)}}!function(e){e[e.Short=0]="Short",e[e.Medium=1]="Medium",e[e.Long=2]="Long"}(G||(G={}));class qe{constructor(){this.type=G.Short,this.length=0}static copyTo(e,t){t.type=e.type,t.length=e.length}}!function(e){e[e.None=0]="None",e[e.Element=1]="Element",e[e.Attribute=2]="Attribute",e[e.Text=3]="Text",e[e.CDATA=4]="CDATA",e[e.EntityReference=5]="EntityReference",e[e.Entity=6]="Entity",e[e.ProcessingInstruction=7]="ProcessingInstruction",e[e.Comment=8]="Comment",e[e.Document=9]="Document",e[e.DocumentType=10]="DocumentType",e[e.DocumentFragment=11]="DocumentFragment",e[e.Notation=12]="Notation",e[e.Whitespace=13]="Whitespace",e[e.SignificantWhitespace=14]="SignificantWhitespace",e[e.EndElement=15]="EndElement",e[e.EndEntity=16]="EndEntity",e[e.XmlDeclaration=17]="XmlDeclaration"}(V||(V={}));class je{constructor(){this.nodeType=V.None,this.localName=null,this.value=null,this.childNodes=[],this.attributes=new Map,this.firstChild=null,this.firstElement=null}addChild(e){this.childNodes.push(e),this.firstChild=e,e.nodeType===V.Element&&(this.firstElement=e)}getAttribute(e){return this.attributes.has(e)?this.attributes.get(e):""}getElementsByTagName(e,t=!1){let s=[];return this.searchElementsByTagName(this.childNodes,s,e,t),s}searchElementsByTagName(e,t,s,i=!1){for(let a of e)a&&a.nodeType===V.Element&&a.localName===s&&t.push(a),i&&this.searchElementsByTagName(a.childNodes,t,s,!0)}findChildElement(e){for(let t of this.childNodes)if(t&&t.nodeType===V.Element&&t.localName===e)return t;return null}get innerText(){var e,t;if(this.nodeType===V.Element||this.nodeType===V.Document){let t="";for(let s of this.childNodes)t+=null===(e=s.innerText)||void 0===e?void 0:e.toString();return t.trim()}return null!==(t=this.value)&&void 0!==t?t:""}}class Ke extends Error{constructor(e,t,s){super(e),this.pos=0,this.xml=t,this.pos=s}}!function(e){e[e.IgnoreSpaces=0]="IgnoreSpaces",e[e.Begin=1]="Begin",e[e.BeginNode=2]="BeginNode",e[e.TagName=3]="TagName",e[e.Body=4]="Body",e[e.AttribName=5]="AttribName",e[e.Equals=6]="Equals",e[e.AttvalBegin=7]="AttvalBegin",e[e.AttribVal=8]="AttribVal",e[e.Childs=9]="Childs",e[e.Close=10]="Close",e[e.WaitEnd=11]="WaitEnd",e[e.WaitEndRet=12]="WaitEndRet",e[e.Pcdata=13]="Pcdata",e[e.Header=14]="Header",e[e.Comment=15]="Comment",e[e.Doctype=16]="Doctype",e[e.Cdata=17]="Cdata",e[e.Escape=18]="Escape"}(H||(H={}));class $e{static parse(e,t,s){var i;let a=e.charCodeAt(t),r=H.Begin,n=H.Begin,o=0,h="",l=H.Begin,d=null,c=null,u=0,p=0;for(;t<e.length;){switch(a=e.charCodeAt(t),r){case H.IgnoreSpaces:switch(a){case $e.CharCodeLF:case $e.CharCodeCR:case $e.CharCodeTab:case $e.CharCodeSpace:break;default:r=n;continue}break;case H.Begin:switch(a){case $e.CharCodeLowerThan:r=H.IgnoreSpaces,n=H.BeginNode;break;default:o=t,r=H.Pcdata;continue}break;case H.Pcdata:if(a===$e.CharCodeLowerThan){h+=e.substr(o,t-o);let i=new je;i.nodeType=V.Text,i.value=h,h="",s.addChild(i),r=H.IgnoreSpaces,n=H.BeginNode}else a===$e.CharCodeAmp&&(h+=e.substr(o,t-o),r=H.Escape,l=H.Pcdata,o=t+1);break;case H.Cdata:if(a===$e.CharCodeBrackedClose&&e.charCodeAt(t+1)===$e.CharCodeBrackedClose&&e.charCodeAt(t+2)===$e.CharCodeGreaterThan){let i=new je;i.nodeType=V.CDATA,i.value=e.substr(o,t-o),s.addChild(i),t+=2,r=H.Begin}break;case H.BeginNode:switch(a){case $e.CharCodeExclamation:if(e.charCodeAt(t+1)===$e.CharCodeBrackedOpen){if(t+=2,"CDATA["!==e.substr(t,6).toUpperCase())throw new Ke("Expected <![CDATA[",e,t);t+=5,r=H.Cdata,o=t+1}else if(e.charCodeAt(t+1)===$e.CharCodeUpperD||e.charCodeAt(t+1)===$e.CharCodeLowerD){if("OCTYPE"!==e.substr(t+2,6).toUpperCase())throw new Ke("Expected <!DOCTYPE",e,t);t+=8,r=H.Doctype,o=t+1}else{if(e.charCodeAt(t+1)!==$e.CharCodeMinus||e.charCodeAt(t+2)!==$e.CharCodeMinus)throw new Ke("Expected \x3c!--",e,t);t+=2,r=H.Comment,o=t+1}break;case $e.CharCodeQuestion:r=H.Header,o=t;break;case $e.CharCodeSlash:if(!s)throw new Ke("Expected node name",e,t);o=t+1,r=H.IgnoreSpaces,n=H.Close;break;default:r=H.TagName,o=t;continue}break;case H.TagName:if(!$e.isValidChar(a)){if(t===o)throw new Ke("Expected node name",e,t);d=new je,d.nodeType=V.Element,d.localName=e.substr(o,t-o),s.addChild(d),r=H.IgnoreSpaces,n=H.Body;continue}break;case H.Body:switch(a){case $e.CharCodeSlash:r=H.WaitEnd;break;case $e.CharCodeGreaterThan:r=H.Childs;break;default:r=H.AttribName,o=t;continue}break;case H.AttribName:if(!$e.isValidChar(a)){if(o===t)throw new Ke("Expected attribute name",e,t);if(c=e.substr(o,t-o),d.attributes.has(c))throw new Ke(`Duplicate attribute [${c}]`,e,t);r=H.IgnoreSpaces,n=H.Equals;continue}break;case H.Equals:switch(a){case $e.CharCodeEquals:r=H.IgnoreSpaces,n=H.AttvalBegin;break;default:throw new Ke("Expected =",e,t)}break;case H.AttvalBegin:switch(a){case $e.CharCodeDoubleQuote:case $e.CharCodeSingleQuote:h="",r=H.AttribVal,o=t+1,p=a}break;case H.AttribVal:switch(a){case $e.CharCodeAmp:h+=e.substr(o,t-o),r=H.Escape,l=H.AttribVal,o=t+1;break;default:if(a===p){h+=e.substr(o,t-o);let s=h;h="",d.attributes.set(c,s),r=H.IgnoreSpaces,n=H.Body}}break;case H.Childs:o=t=$e.parse(e,t,d),r=H.Begin;break;case H.WaitEnd:switch(a){case $e.CharCodeGreaterThan:r=H.Begin;break;default:throw new Ke("Expected >",e,t)}break;case H.WaitEndRet:switch(a){case $e.CharCodeGreaterThan:return t;default:throw new Ke("Expected >",e,t)}case H.Close:if(!$e.isValidChar(a)){if(o===t)throw new Ke("Expected node name",e,t);if(e.substr(o,t-o)!==s.localName)throw new Ke("Expected </"+s.localName+">",e,t);r=H.IgnoreSpaces,n=H.WaitEndRet;continue}break;case H.Comment:a===$e.CharCodeMinus&&e.charCodeAt(t+1)===$e.CharCodeMinus&&e.charCodeAt(t+2)===$e.CharCodeGreaterThan&&(t+=2,r=H.Begin);break;case H.Doctype:if(a===$e.CharCodeBrackedOpen)u++;else if(a===$e.CharCodeBrackedClose)u--;else if(a===$e.CharCodeGreaterThan&&0===u){let i=new je;i.nodeType=V.DocumentType,i.value=e.substr(o,t-o),s.addChild(i),r=H.Begin}break;case H.Header:a===$e.CharCodeQuestion&&e.charCodeAt(t+1)===$e.CharCodeGreaterThan&&(t++,r=H.Begin);break;case H.Escape:if(a===$e.CharCodeSemi){let s=e.substr(o,t-o);if(s.charCodeAt(0)===$e.CharCodeSharp){let e=s.charCodeAt(1)===$e.CharCodeLowerX?parseInt("0"+s.substr(1,s.length-1)):parseInt(s.substr(1,s.length-1));h+=String.fromCharCode(e)}else $e.Escapes.has(s)?h+=$e.Escapes.get(s):h+=null===(i="&"+s+";")||void 0===i?void 0:i.toString();o=t+1,r=l}else $e.isValidChar(a)||a===$e.CharCodeSharp||(h+="&",h+=e.substr(o,t-o),o=--t+1,r=l)}t++}if(r===H.Begin&&(o=t,r=H.Pcdata),r===H.Pcdata){if(t!==o){h+=e.substr(o,t-o);let i=new je;i.nodeType=V.Text,i.value=h,s.addChild(i)}return t}if(r===H.Escape&&l===H.Pcdata){h+="&",h+=e.substr(o,t-o);let i=new je;return i.nodeType=V.Text,i.value=h,s.addChild(i),t}throw new Ke("Unexpected end",e,t)}static isValidChar(e){return e>=$e.CharCodeLowerA&&e<=$e.CharCodeLowerZ||e>=$e.CharCodeUpperA&&e<=$e.CharCodeUpperZ||e>=$e.CharCode0&&e<=$e.CharCode9||e===$e.CharCodeColon||e===$e.CharCodeDot||e===$e.CharCodeUnderscore||e===$e.CharCodeMinus}}$e.CharCodeLF=10,$e.CharCodeTab=9,$e.CharCodeCR=13,$e.CharCodeSpace=32,$e.CharCodeLowerThan=60,$e.CharCodeAmp=38,$e.CharCodeBrackedClose=93,$e.CharCodeBrackedOpen=91,$e.CharCodeGreaterThan=62,$e.CharCodeExclamation=33,$e.CharCodeUpperD=68,$e.CharCodeLowerD=100,$e.CharCodeMinus=45,$e.CharCodeQuestion=63,$e.CharCodeSlash=47,$e.CharCodeEquals=61,$e.CharCodeDoubleQuote=34,$e.CharCodeSingleQuote=39,$e.CharCodeSharp=35,$e.CharCodeLowerX=120,$e.CharCodeLowerA=97,$e.CharCodeLowerZ=122,$e.CharCodeUpperA=65,$e.CharCodeUpperZ=90,$e.CharCode0=48,$e.CharCode9=57,$e.CharCodeColon=58,$e.CharCodeDot=46,$e.CharCodeUnderscore=95,$e.CharCodeSemi=59,$e.Escapes=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);class Ze extends je{constructor(e){super(),this.documentElement=null,this.nodeType=V.Document,$e.parse(e,0,this);for(let e of this.childNodes)if(e.nodeType===V.Element){this.documentElement=e;break}}}class et{constructor(){this.dots=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.value=b.Quarter}}class tt{constructor(){this._hasAnacrusis=!1}parseXml(e,t){let s;this._masterTrackAutomations=new Map,this._tracksMapping=[],this._tracksById=new Map,this._masterBars=[],this._barsOfMasterBar=[],this._voicesOfBar=new Map,this._barsById=new Map,this._voiceById=new Map,this._beatsOfVoice=new Map,this._beatById=new Map,this._rhythmOfBeat=new Map,this._rhythmById=new Map,this._notesOfBeat=new Map,this._noteById=new Map,this._tappedNotes=new Map,this._lyricsByTrack=new Map;try{s=new Ze(e)}catch(e){throw new pe("Could not parse XML",e)}if(this.parseDom(s),this.buildModel(),this.score.finish(t),this._lyricsByTrack.size>0)for(let e of this._lyricsByTrack){this._tracksById.get(e[0]).applyLyrics(e[1])}}parseDom(e){let t=e.documentElement;if(t){if("GPIF"!==t.localName)throw new pe("Root node of XML was not GPIF");this.score=new Ce;for(let e of t.childNodes)if(e.nodeType===V.Element)switch(e.localName){case"Score":this.parseScoreNode(e);break;case"MasterTrack":this.parseMasterTrackNode(e);break;case"Tracks":this.parseTracksNode(e);break;case"MasterBars":this.parseMasterBarsNode(e);break;case"Bars":this.parseBars(e);break;case"Voices":this.parseVoices(e);break;case"Beats":this.parseBeats(e);break;case"Notes":this.parseNotes(e);break;case"Rhythms":this.parseRhythms(e)}}}parseScoreNode(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Title":this.score.title=t.firstChild.innerText;break;case"SubTitle":this.score.subTitle=t.firstChild.innerText;break;case"Artist":this.score.artist=t.firstChild.innerText;break;case"Album":this.score.album=t.firstChild.innerText;break;case"Words":this.score.words=t.firstChild.innerText;break;case"Music":this.score.music=t.firstChild.innerText;break;case"WordsAndMusic":if(t.firstChild&&""!==t.firstChild.innerText){let e=t.firstChild.innerText;e&&!this.score.words&&(this.score.words=e),e&&!this.score.music&&(this.score.music=e)}break;case"Copyright":this.score.copyright=t.firstChild.innerText;break;case"Tabber":this.score.tab=t.firstChild.innerText;break;case"Instructions":this.score.instructions=t.firstChild.innerText;break;case"Notices":this.score.notices=t.firstChild.innerText}}parseMasterTrackNode(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Automations":this.parseAutomations(t,this._masterTrackAutomations);break;case"Tracks":this._tracksMapping=t.innerText.split(" ");break;case"Anacrusis":this._hasAnacrusis=!0}}parseAutomations(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Automation":this.parseAutomation(s,t)}}parseAutomation(e,t){let s=null,i=!1,a=null,r=0,n=0,o=0,h=null;for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Type":s=t.innerText;break;case"Linear":i="true"===t.innerText.toLowerCase();break;case"Bar":a=t.innerText;break;case"Position":r=parseFloat(t.innerText);break;case"Value":let e=t.innerText.split(" ");n=parseFloat(e[0]),o=parseInt(e[1]);break;case"Text":h=t.innerText}if(!s)return;let l=null;switch(s){case"Tempo":l=ge.buildTempoAutomation(i,r,n,o)}l&&(h&&(l.text=h),a&&(t.has(a)||t.set(a,[]),t.get(a).push(l)))}parseTracksNode(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Track":this.parseTrack(t)}}parseTrack(e){let t=new De;t.ensureStaveCount(1),t.staves[0].showStandardNotation=!0;let s=e.getAttribute("id");for(let i of e.childNodes)if(i.nodeType===V.Element)switch(i.localName){case"Name":t.name=i.innerText;break;case"Color":let e=i.innerText.split(" ");if(e.length>=3){let s=parseInt(e[0]),i=parseInt(e[1]),r=parseInt(e[2]);t.color=new a(s,i,r,255)}break;case"Instrument":let r=i.getAttribute("ref");(r.endsWith("-gs")||r.endsWith("GrandStaff"))&&(t.ensureStaveCount(2),t.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this.parseInstrumentSet(t,i);break;case"ShortName":t.shortName=i.innerText;break;case"Lyrics":this.parseLyrics(s,i);break;case"Properties":this.parseTrackProperties(t,i);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this.parseGeneralMidi(t,i);break;case"Sounds":this.parseSounds(t,i);break;case"PlaybackState":let n=i.innerText;t.playbackInfo.isSolo="Solo"===n,t.playbackInfo.isMute="Mute"===n;break;case"PartSounding":this.parsePartSounding(t,i);break;case"Staves":this.parseStaves(t,i);break;case"Transpose":this.parseTranspose(t,i)}this._tracksById.set(s,t)}parseInstrumentSet(e,t){for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Type":switch(s.innerText){case"drumKit":for(let t of e.staves)t.isPercussion=!0}if("drumKit"===s.innerText)for(let t of e.staves)t.isPercussion=!0}}parseStaves(e,t){let s=0;for(let i of t.childNodes)if(i.nodeType===V.Element)switch(i.localName){case"Staff":e.ensureStaveCount(s+1);let t=e.staves[s];this.parseStaff(t,i),s++}}parseStaff(e,t){for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Properties":this.parseStaffProperties(e,s)}}parseStaffProperties(e,t){for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Property":this.parseStaffProperty(e,s)}}parseStaffProperty(e,t){switch(t.getAttribute("name")){case"Tuning":let s=t.findChildElement("Pitches").innerText.split(" "),i=new Array(s.length);for(let e=0;e<i.length;e++)i[i.length-1-e]=parseInt(s[e]);e.tuning=i,e.isPercussion||(e.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollection_Staff_XmlNode(e,t);break;case"CapoFret":let a=parseInt(t.findChildElement("Fret").innerText);e.capo=a}}parseLyrics(e,t){let s=[];for(let e of t.childNodes)if(e.nodeType===V.Element)switch(e.localName){case"Line":s.push(this.parseLyricsLine(e))}this._lyricsByTrack.set(e,s)}parseLyricsLine(e){let t=new xe;for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Offset":t.startBar=parseInt(s.innerText);break;case"Text":t.text=s.innerText}return t}parseDiagramCollection_Track_XmlNode(e,t){let s=t.findChildElement("Items");for(let t of s.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Item":this.parseDiagramItem_Track_XmlNode(e,t)}}parseDiagramCollection_Staff_XmlNode(e,t){let s=t.findChildElement("Items");for(let t of s.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Item":this.parseDiagramItem_Staff_XmlNode(e,t)}}parseDiagramItem_Track_XmlNode(e,t){let s=new ke,i=t.getAttribute("id");for(let t of e.staves)t.addChord(i,s);this.parseDiagramItem_Chord_XmlNode(s,t)}parseDiagramItem_Staff_XmlNode(e,t){let s=new ke,i=t.getAttribute("id");e.addChord(i,s),this.parseDiagramItem_Chord_XmlNode(s,t)}parseDiagramItem_Chord_XmlNode(e,t){e.name=t.getAttribute("name");let s=t.findChildElement("Diagram"),i=parseInt(s.getAttribute("stringCount")),a=parseInt(s.getAttribute("baseFret"));e.firstFret=a+1;for(let t=0;t<i;t++)e.strings.push(-1);for(let t of s.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Fret":let s=parseInt(t.getAttribute("string"));e.strings[i-s-1]=a+parseInt(t.getAttribute("fret"));break;case"Fingering":let r=new Map;for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Position":let t=w.Unknown,i=a+parseInt(s.getAttribute("fret"));switch(s.getAttribute("finger")){case"Index":t=w.IndexFinger;break;case"Middle":t=w.MiddleFinger;break;case"Rank":t=w.AnnularFinger;break;case"Pinky":t=w.LittleFinger;break;case"Thumb":t=w.Thumb}t!==w.Unknown&&(r.has(t)?e.barreFrets.push(i):r.set(t,!0))}break;case"Property":switch(t.getAttribute("name")){case"ShowName":e.showName="true"===t.getAttribute("value");break;case"ShowDiagram":e.showDiagram="true"===t.getAttribute("value");break;case"ShowFingering":e.showFingering="true"===t.getAttribute("value")}}}parseTrackProperties(e,t){for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Property":this.parseTrackProperty(e,s)}}parseTrackProperty(e,t){switch(t.getAttribute("name")){case"Tuning":let s=t.findChildElement("Pitches").innerText.split(" "),i=new Array(s.length);for(let e=0;e<i.length;e++)i[i.length-1-e]=parseInt(s[e]);for(let t of e.staves)t.tuning=i,t.showStandardNotation=!0,t.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollection_Track_XmlNode(e,t);break;case"CapoFret":let a=parseInt(t.findChildElement("Fret").innerText);for(let t of e.staves)t.capo=a}}parseGeneralMidi(e,t){for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Program":e.playbackInfo.program=parseInt(s.innerText);break;case"Port":e.playbackInfo.port=parseInt(s.innerText);break;case"PrimaryChannel":e.playbackInfo.primaryChannel=parseInt(s.innerText);break;case"SecondaryChannel":e.playbackInfo.secondaryChannel=parseInt(s.innerText)}if("Percussion"===t.getAttribute("table"))for(let t of e.staves)t.isPercussion=!0}parseSounds(e,t){for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Sound":this.parseSound(e,s)}}parseSound(e,t){for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"MIDI":this.parseSoundMidi(e,s)}}parseSoundMidi(e,t){for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Program":e.playbackInfo.program=parseInt(s.innerText)}}parsePartSounding(e,t){for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"TranspositionPitch":for(let t of e.staves)t.displayTranspositionPitch=parseInt(s.innerText)}}parseTranspose(e,t){let s=0,i=0;for(let e of t.childNodes)if(e.nodeType===V.Element)switch(e.localName){case"Chromatic":i=parseInt(e.innerText);break;case"Octave":s=parseInt(e.innerText)}for(let t of e.staves)t.displayTranspositionPitch=12*s+i}parseMasterBarsNode(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"MasterBar":this.parseMasterBar(t)}}parseMasterBar(e){let t=new Ne;0===this._masterBars.length&&this._hasAnacrusis&&(t.isAnacrusis=!0);for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Time":let e=s.innerText.split("/");t.timeSignatureNumerator=parseInt(e[0]),t.timeSignatureDenominator=parseInt(e[1]);break;case"DoubleBar":t.isDoubleBar=!0;break;case"Section":t.section=new Le,t.section.marker=s.findChildElement("Letter").innerText,t.section.text=s.findChildElement("Text").innerText;break;case"Repeat":"true"===s.getAttribute("start").toLowerCase()&&(t.isRepeatStart=!0),"true"===s.getAttribute("end").toLowerCase()&&s.getAttribute("count")&&(t.repeatCount=parseInt(s.getAttribute("count")));break;case"AlternateEndings":let i=s.innerText.split(" "),a=0;for(let e=0;e<i.length;e++)a|=1<<-1+parseInt(i[e]);t.alternateEndings=a;break;case"Bars":this._barsOfMasterBar.push(s.innerText.split(" "));break;case"TripletFeel":switch(s.innerText){case"NoTripletFeel":t.tripletFeel=R.NoTripletFeel;break;case"Triplet8th":t.tripletFeel=R.Triplet8th;break;case"Triplet16th":t.tripletFeel=R.Triplet16th;break;case"Dotted8th":t.tripletFeel=R.Dotted8th;break;case"Dotted16th":t.tripletFeel=R.Dotted16th;break;case"Scottish8th":t.tripletFeel=R.Scottish8th;break;case"Scottish16th":t.tripletFeel=R.Scottish16th}break;case"Key":t.keySignature=parseInt(s.findChildElement("AccidentalCount").innerText);let r=s.findChildElement("Mode");if(r)switch(r.innerText.toLowerCase()){case"major":t.keySignatureType=I.Major;break;case"minor":t.keySignatureType=I.Minor}break;case"Fermatas":this.parseFermatas(t,s)}this._masterBars.push(t)}parseFermatas(e,t){for(let s of t.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"Fermata":this.parseFermata(e,s)}}parseFermata(e,t){let s=0,i=new qe;for(let e of t.childNodes)if(e.nodeType===V.Element)switch(e.localName){case"Type":switch(e.innerText){case"Short":i.type=G.Short;break;case"Medium":i.type=G.Medium;break;case"Long":i.type=G.Long}break;case"Length":i.length=parseFloat(e.innerText);break;case"Offset":let t=e.innerText.split("/");if(2===t.length){s=parseInt(t[0])/parseInt(t[1])*me.QuarterTime|0}}e.addFermata(s,i)}parseBars(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Bar":this.parseBar(t)}}parseBar(e){let t=new fe,s=e.getAttribute("id");for(let i of e.childNodes)if(i.nodeType===V.Element)switch(i.localName){case"Voices":this._voicesOfBar.set(s,i.innerText.split(" "));break;case"Clef":switch(i.innerText){case"Neutral":t.clef=c.Neutral;break;case"G2":t.clef=c.G2;break;case"F4":t.clef=c.F4;break;case"C4":t.clef=c.C4;break;case"C3":t.clef=c.C3}break;case"Ottavia":switch(i.innerText){case"8va":t.clefOttava=u._8va;break;case"15ma":t.clefOttava=u._15ma;break;case"8vb":t.clefOttava=u._8vb;break;case"15mb":t.clefOttava=u._15mb}break;case"SimileMark":switch(i.innerText){case"Simple":t.simileMark=p.Simple;break;case"FirstOfDouble":t.simileMark=p.FirstOfDouble;break;case"SecondOfDouble":t.simileMark=p.SecondOfDouble}}this._barsById.set(s,t)}parseVoices(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Voice":this.parseVoice(t)}}parseVoice(e){let t=new Re,s=e.getAttribute("id");for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Beats":this._beatsOfVoice.set(s,t.innerText.split(" "))}this._voiceById.set(s,t)}parseBeats(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Beat":this.parseBeat(t)}}parseBeat(e){let t=new Te,s=e.getAttribute("id");for(let i of e.childNodes)if(i.nodeType===V.Element)switch(i.localName){case"Notes":this._notesOfBeat.set(s,i.innerText.split(" "));break;case"Rhythm":this._rhythmOfBeat.set(s,i.getAttribute("ref"));break;case"Fadding":"FadeIn"===i.innerText&&(t.fadeIn=!0);break;case"Tremolo":switch(i.innerText){case"1/2":t.tremoloSpeed=b.Eighth;break;case"1/4":t.tremoloSpeed=b.Sixteenth;break;case"1/8":t.tremoloSpeed=b.ThirtySecond}break;case"Chord":t.chordId=i.innerText;break;case"Hairpin":switch(i.innerText){case"Crescendo":t.crescendo=y.Crescendo;break;case"Decrescendo":t.crescendo=y.Decrescendo}break;case"Arpeggio":"Up"===i.innerText?t.brushType=m.ArpeggioUp:t.brushType=m.ArpeggioDown;break;case"Properties":this.parseBeatProperties(i,t);break;case"XProperties":this.parseBeatXProperties(i,t);break;case"FreeText":t.text=i.innerText;break;case"Dynamic":switch(i.innerText){case"PPP":t.dynamics=S.PPP;break;case"PP":t.dynamics=S.PP;break;case"P":t.dynamics=S.P;break;case"MP":t.dynamics=S.MP;break;case"MF":t.dynamics=S.MF;break;case"F":t.dynamics=S.F;break;case"FF":t.dynamics=S.FF;break;case"FFF":t.dynamics=S.FFF}break;case"GraceNotes":switch(i.innerText){case"OnBeat":t.graceType=_.OnBeat;break;case"BeforeBeat":t.graceType=_.BeforeBeat}break;case"Legato":"true"===i.getAttribute("origin")&&(t.isLegatoOrigin=!0);break;case"Whammy":let e=new ye(0,0);e.value=this.toBendValue(parseFloat(i.getAttribute("originValue"))),e.offset=this.toBendOffset(parseFloat(i.getAttribute("originOffset"))),t.addWhammyBarPoint(e);let a=new ye(0,0);a.value=this.toBendValue(parseFloat(i.getAttribute("middleValue"))),a.offset=this.toBendOffset(parseFloat(i.getAttribute("middleOffset1"))),t.addWhammyBarPoint(a);let r=new ye(0,0);r.value=this.toBendValue(parseFloat(i.getAttribute("middleValue"))),r.offset=this.toBendOffset(parseFloat(i.getAttribute("middleOffset2"))),t.addWhammyBarPoint(r);let n=new ye(0,0);n.value=this.toBendValue(parseFloat(i.getAttribute("destinationValue"))),n.offset=this.toBendOffset(parseFloat(i.getAttribute("destinationOffset"))),t.addWhammyBarPoint(n);break;case"Ottavia":switch(i.innerText){case"8va":t.ottava=u._8va;break;case"8vb":t.ottava=u._8vb;break;case"15ma":t.ottava=u._15ma;break;case"15mb":t.ottava=u._15mb}}this._beatById.set(s,t)}parseBeatXProperties(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"XProperty":let e=0;switch(s.getAttribute("id")){case"1124204545":e=parseInt(s.findChildElement("Int").innerText),t.invertBeamDirection=1===e;break;case"687935489":e=parseInt(s.findChildElement("Int").innerText),t.brushDuration=e}}}parseBeatProperties(e,t){let s=!1,i=null,a=null,r=null,n=null,o=null;for(let h of e.childNodes)if(h.nodeType===V.Element)switch(h.localName){case"Property":switch(h.getAttribute("name")){case"Brush":"Up"===h.findChildElement("Direction").innerText?t.brushType=m.BrushUp:t.brushType=m.BrushDown;break;case"PickStroke":"Up"===h.findChildElement("Direction").innerText?t.pickStroke=L.Up:t.pickStroke=L.Down;break;case"Slapped":h.findChildElement("Enable")&&(t.slap=!0);break;case"Popped":h.findChildElement("Enable")&&(t.pop=!0);break;case"VibratoWTremBar":switch(h.findChildElement("Strength").innerText){case"Wide":t.vibrato=x.Wide;break;case"Slight":t.vibrato=x.Slight}break;case"WhammyBar":s=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":i||(i=new ye(0,0)),i.value=this.toBendValue(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarOriginOffset":i||(i=new ye(0,0)),i.offset=this.toBendOffset(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarMiddleValue":a=this.toBendValue(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarMiddleOffset1":r=this.toBendOffset(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarMiddleOffset2":n=this.toBendOffset(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarDestinationValue":o||(o=new ye(ye.MaxPosition,0)),o.value=this.toBendValue(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarDestinationOffset":o||(o=new ye(0,0)),o.offset=this.toBendOffset(parseFloat(h.findChildElement("Float").innerText))}}s&&(i||(i=new ye(0,0)),o||(o=new ye(ye.MaxPosition,0)),t.addWhammyBarPoint(i),r&&a&&t.addWhammyBarPoint(new ye(r,a)),n&&a&&t.addWhammyBarPoint(new ye(n,a)),r||n||!a||t.addWhammyBarPoint(new ye(ye.MaxPosition/2|0,a)),t.addWhammyBarPoint(o))}parseNotes(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Note":this.parseNote(t)}}parseNote(e){let t=new Be,s=e.getAttribute("id");for(let i of e.childNodes)if(i.nodeType===V.Element)switch(i.localName){case"Properties":this.parseNoteProperties(i,t,s);break;case"AntiAccent":"normal"===i.innerText.toLowerCase()&&(t.isGhost=!0);break;case"LetRing":t.isLetRing=!0;break;case"Trill":t.trillValue=parseInt(i.innerText),t.trillSpeed=b.Sixteenth;break;case"Accent":let e=parseInt(i.innerText);0!=(1&e)&&(t.isStaccato=!0),0!=(4&e)&&(t.accentuated=l.Heavy),0!=(8&e)&&(t.accentuated=l.Normal);break;case"Tie":"true"===i.getAttribute("destination").toLowerCase()&&(t.isTieDestination=!0);break;case"Vibrato":switch(i.innerText){case"Slight":t.vibrato=x.Slight;break;case"Wide":t.vibrato=x.Wide}break;case"LeftFingering":switch(t.isFingering=!0,i.innerText){case"P":t.leftHandFinger=w.Thumb;break;case"I":t.leftHandFinger=w.IndexFinger;break;case"M":t.leftHandFinger=w.MiddleFinger;break;case"A":t.leftHandFinger=w.AnnularFinger;break;case"C":t.leftHandFinger=w.LittleFinger}break;case"RightFingering":switch(t.isFingering=!0,i.innerText){case"P":t.rightHandFinger=w.Thumb;break;case"I":t.rightHandFinger=w.IndexFinger;break;case"M":t.rightHandFinger=w.MiddleFinger;break;case"A":t.rightHandFinger=w.AnnularFinger;break;case"C":t.rightHandFinger=w.LittleFinger}}this._noteById.set(s,t)}parseNoteProperties(e,t,s){let i=!1,a=null,r=null,n=null,o=null,h=null;for(let l of e.childNodes)if(l.nodeType===V.Element)switch(l.localName){case"Property":switch(l.getAttribute("name")){case"String":t.string=parseInt(l.findChildElement("String").innerText)+1;break;case"Fret":t.fret=parseInt(l.findChildElement("Fret").innerText);break;case"Element":t.element=parseInt(l.findChildElement("Element").innerText);break;case"Variation":t.variation=parseInt(l.findChildElement("Variation").innerText);break;case"Tapped":this._tappedNotes.set(s,!0);break;case"HarmonicType":let e=l.findChildElement("HType");if(e)switch(e.innerText){case"NoHarmonic":t.harmonicType=B.None;break;case"Natural":t.harmonicType=B.Natural;break;case"Artificial":t.harmonicType=B.Artificial;break;case"Pinch":t.harmonicType=B.Pinch;break;case"Tap":t.harmonicType=B.Tap;break;case"Semi":t.harmonicType=B.Semi;break;case"Feedback":t.harmonicType=B.Feedback}break;case"HarmonicFret":let d=l.findChildElement("HFret");d&&(t.harmonicValue=parseFloat(d.innerText));break;case"Muted":l.findChildElement("Enable")&&(t.isDead=!0);break;case"PalmMuted":l.findChildElement("Enable")&&(t.isPalmMute=!0);break;case"Octave":t.octave=parseInt(l.findChildElement("Number").innerText);break;case"Tone":t.tone=parseInt(l.findChildElement("Step").innerText);break;case"Bended":i=!0;break;case"BendOriginValue":a||(a=new ye(0,0)),a.value=this.toBendValue(parseFloat(l.findChildElement("Float").innerText));break;case"BendOriginOffset":a||(a=new ye(0,0)),a.offset=this.toBendOffset(parseFloat(l.findChildElement("Float").innerText));break;case"BendMiddleValue":r=this.toBendValue(parseFloat(l.findChildElement("Float").innerText));break;case"BendMiddleOffset1":n=this.toBendOffset(parseFloat(l.findChildElement("Float").innerText));break;case"BendMiddleOffset2":o=this.toBendOffset(parseFloat(l.findChildElement("Float").innerText));break;case"BendDestinationValue":h||(h=new ye(ye.MaxPosition,0)),h.value=this.toBendValue(parseFloat(l.findChildElement("Float").innerText));break;case"BendDestinationOffset":h||(h=new ye(0,0)),h.offset=this.toBendOffset(parseFloat(l.findChildElement("Float").innerText));break;case"HopoOrigin":l.findChildElement("Enable")&&(t.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"Slide":let c=parseInt(l.findChildElement("Flags").innerText);0!=(1&c)?t.slideOutType=k.Shift:0!=(2&c)?t.slideOutType=k.Legato:0!=(4&c)?t.slideOutType=k.OutDown:0!=(8&c)&&(t.slideOutType=k.OutUp),0!=(16&c)?t.slideInType=T.IntoFromBelow:0!=(32&c)&&(t.slideInType=T.IntoFromAbove),0!=(64&c)?t.slideOutType=k.PickSlideDown:0!=(128&c)&&(t.slideOutType=k.PickSlideUp)}}i&&(a||(a=new ye(0,0)),h||(h=new ye(ye.MaxPosition,0)),t.addBendPoint(a),n&&r&&t.addBendPoint(new ye(n,r)),o&&r&&t.addBendPoint(new ye(o,r)),n||o||!r||t.addBendPoint(new ye(ye.MaxPosition/2|0,r)),t.addBendPoint(h))}toBendValue(e){return e*tt.BendPointValueFactor|0}toBendOffset(e){return e*tt.BendPointPositionFactor|0}parseRhythms(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"Rhythm":this.parseRhythm(t)}}parseRhythm(e){let t=new et,s=e.getAttribute("id");for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"NoteValue":switch(s.innerText){case"Long":t.value=b.QuadrupleWhole;break;case"DoubleWhole":t.value=b.DoubleWhole;break;case"Whole":t.value=b.Whole;break;case"Half":t.value=b.Half;break;case"Quarter":t.value=b.Quarter;break;case"Eighth":t.value=b.Eighth;break;case"16th":t.value=b.Sixteenth;break;case"32nd":t.value=b.ThirtySecond;break;case"64th":t.value=b.SixtyFourth;break;case"128th":t.value=b.OneHundredTwentyEighth;break;case"256th":t.value=b.TwoHundredFiftySixth}break;case"PrimaryTuplet":t.tupletNumerator=parseInt(s.getAttribute("num")),t.tupletDenominator=parseInt(s.getAttribute("den"));break;case"AugmentationDot":t.dots=parseInt(s.getAttribute("count"))}this._rhythmById.set(s,t)}buildModel(){for(let e=0,t=this._masterBars.length;e<t;e++){let t=this._masterBars[e];this.score.addMasterBar(t)}for(let e of this._tracksMapping){if(!e)continue;let t=this._tracksById.get(e);this.score.addTrack(t)}for(let e of this._barsOfMasterBar){let t=0;for(let s=0,i=0;s<e.length&&i<this.score.tracks.length;s++){let a=e[s];if(a!==tt.InvalidId){let e=this._barsById.get(a),s=this.score.tracks[i];if(s.staves[t].addBar(e),this._voicesOfBar.has(a))for(let t of this._voicesOfBar.get(a))if(t!==tt.InvalidId){let s=this._voiceById.get(t);if(e.addVoice(s),this._beatsOfVoice.has(t))for(let e of this._beatsOfVoice.get(t))if(e!==tt.InvalidId){let t=this._beatById.get(e).clone();s.addBeat(t);let i=this._rhythmOfBeat.get(e),a=this._rhythmById.get(i);if(t.duration=a.value,t.dots=a.dots,t.tupletNumerator=a.tupletNumerator,t.tupletDenominator=a.tupletDenominator,this._notesOfBeat.has(e))for(let s of this._notesOfBeat.get(e))s!==tt.InvalidId&&(t.addNote(this._noteById.get(s).clone()),this._tappedNotes.has(s)&&(t.tap=!0))}}else{let t=new Re;e.addVoice(t);let s=new Te;s.isEmpty=!0,s.duration=b.Quarter,t.addBeat(s)}t===s.staves.length-1?(i++,t=0):t++}else i++}}for(let e of this._masterTrackAutomations){let t=e[0],s=e[1],i=this.score.masterBars[parseInt(t)];for(let e=0,a=s.length;e<a;e++){let a=s[e];a.type===d.Tempo&&("0"===t&&(this.score.tempo=0|a.value,a.text&&(this.score.tempoLabel=a.text)),i.tempoAutomation=a)}}}}tt.InvalidId="-1",tt.BendPointPositionFactor=ye.MaxPosition/100,tt.BendPointValueFactor=.04;class st{constructor(){this.isVisible=!1,this.showSlash=!1,this.showStandardNotation=!1,this.showTablature=!1}}class it{constructor(){this.isMultiRest=!1,this.tracks=[]}}class at{constructor(e){this.parts=[],this.zoomLevel=0,this.layout=0;let t=Ye.fromBuffer(e),s=We.readInt32BE(t);for(let e=0;e<s;e++){let e=new it;this.parts.push(e),e.isMultiRest=Ue.gpReadBool(t);let s=We.readInt32BE(t);for(let i=0;i<s;i++){let s=t.readByte();0===s&&(s=1);let i=new st;i.showStandardNotation=0!=(1&s),i.showTablature=0!=(2&s),i.showSlash=0!=(4&s),e.tracks.push(i)}}}apply(e){let t=0,s=0;for(let i of this.parts)for(let a of i.tracks){if(s<e.tracks.length){let i=e.tracks[s];if(t<i.staves.length){let e=i.staves[t];e.showTablature=a.showTablature,e.showStandardNotation=a.showStandardNotation}}s++,s>=e.tracks.length&&(t++,s=0)}}}class rt{}class nt extends rt{constructor(e){super(),this.n=e}}class ot extends rt{constructor(e,t){super(),this.left=e,this.right=t}}class ht extends rt{constructor(e,t){super(),this.n=e,this.table=t}}class lt{static make(e,t,i,a){let r=[],n=[];if(a>32)throw new s("Invalid huffman");for(let e=0;e<a;e++)r.push(0),n.push(0);for(let n=0;n<i;n++){let i=e[n+t];if(i>=a)throw new s("Invalid huffman");r[i]++}let o=0;for(let e=1;e<a-1;e++)o=o+r[e]<<1,n[e]=o;let h=new Map;for(let s=0;s<i;s++){let i=e[s+t];if(0!==i){let e=n[i-1];n[i-1]=e+1,h.set(e<<5|i,s)}}return lt.treeCompress(new ot(lt.treeMake(h,a,0,1),lt.treeMake(h,a,1,1)))}static treeMake(e,t,i,a){if(a>t)throw new s("Invalid huffman");let r=i<<5|a;return e.has(r)?new nt(e.get(r)):(i<<=1,a+=1,new ot(lt.treeMake(e,t,i,a),lt.treeMake(e,t,1|i,a)))}static treeCompress(e){let t=lt.treeDepth(e);if(0===t)return e;if(1===t){if(e instanceof ot)return new ot(lt.treeCompress(e.left),lt.treeCompress(e.right));throw new s("assert")}let i=1<<t,a=[];for(let e=0;e<i;e++)a.push(new nt(-1));return lt.treeWalk(a,0,0,t,e),new ht(t,a)}static treeWalk(e,t,s,i,a){a instanceof ot&&i>0?(lt.treeWalk(e,t,s+1,i-1,a.left),lt.treeWalk(e,t|1<<s,s+1,i-1,a.right)):e[t]=lt.treeCompress(a)}static treeDepth(e){if(e instanceof nt)return 0;if(e instanceof ht)throw new s("assert");if(e instanceof ot){let t=lt.treeDepth(e.left),s=lt.treeDepth(e.right);return 1+(t<s?t:s)}return 0}}!function(e){e[e.Head=0]="Head",e[e.Block=1]="Block",e[e.CData=2]="CData",e[e.Flat=3]="Flat",e[e.Crc=4]="Crc",e[e.Dist=5]="Dist",e[e.DistOne=6]="DistOne",e[e.Done=7]="Done"}(W||(W={}));class dt{constructor(){this.buffer=new Uint8Array(dt.BufferSize),this.pos=0}slide(){let e=new Uint8Array(dt.BufferSize);this.pos-=dt.Size,e.set(this.buffer.subarray(dt.Size,dt.Size+this.pos),0),this.buffer=e}addBytes(e,t,s){this.pos+s>dt.BufferSize&&this.slide(),this.buffer.set(e.subarray(t,t+s),this.pos),this.pos+=s}addByte(e){this.pos===dt.BufferSize&&this.slide(),this.buffer[this.pos]=e,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}dt.Size=32768,dt.BufferSize=65536;class ct{constructor(e){this._nbits=0,this._bits=0,this._state=W.Block,this._isFinal=!1,this._huffman=ct._fixedHuffman,this._huffdist=null,this._len=0,this._dist=0,this._needed=0,this._output=null,this._outpos=0,this._lengths=[],this._window=new dt,this._input=e;for(let e=0;e<19;e++)this._lengths.push(-1)}static buildFixedHuffman(){let e=[];for(let t=0;t<288;t++)e.push(t<=143?8:t<=255?9:t<=279?7:8);return lt.make(e,0,288,10)}readBytes(e,t,s){if(this._needed=s,this._outpos=t,this._output=e,s>0)for(;this.inflateLoop(););return s-this._needed}inflateLoop(){switch(this._state){case W.Head:let e=this._input.readByte();if(8!==(15&e))throw new s("Invalid data");let t=this._input.readByte(),i=0!=(32&t);if(((e<<8)+t)%31!=0)throw new s("Invalid data");if(i)throw new s("Unsupported dictionary");return this._state=W.Block,!0;case W.Crc:return this._state=W.Done,!0;case W.Done:return!1;case W.Block:switch(this._isFinal=this.getBit(),this.getBits(2)){case 0:if(this._len=We.readUInt16LE(this._input),We.readUInt16LE(this._input)!==65535-this._len)throw new s("Invalid data");this._state=W.Flat;let e=this.inflateLoop();return this.resetBits(),e;case 1:return this._huffman=ct._fixedHuffman,this._huffdist=null,this._state=W.CData,!0;case 2:let t=this.getBits(5)+257,i=this.getBits(5)+1,a=this.getBits(4)+4;for(let e=0;e<a;e++)this._lengths[ct.CodeLengthsPos[e]]=this.getBits(3);for(let e=a;e<19;e++)this._lengths[ct.CodeLengthsPos[e]]=0;this._huffman=lt.make(this._lengths,0,19,8);let r=[];for(let e=0;e<t+i;e++)r.push(0);return this.inflateLengths(r,t+i),this._huffdist=lt.make(r,t,i,16),this._huffman=lt.make(r,0,t,16),this._state=W.CData,!0;default:throw new s("Invalid data")}case W.Flat:{let e=this._len<this._needed?this._len:this._needed,t=We.readByteArray(this._input,e);return this._len-=e,this.addBytes(t,0,e),0===this._len&&(this._state=this._isFinal?W.Crc:W.Block),this._needed>0}case W.DistOne:{let e=this._len<this._needed?this._len:this._needed;return this.addDistOne(e),this._len-=e,0===this._len&&(this._state=W.CData),this._needed>0}case W.Dist:for(;this._len>0&&this._needed>0;){let e=this._len<this._dist?this._len:this._dist,t=this._needed<e?this._needed:e;this.addDist(this._dist,t),this._len-=t}return 0===this._len&&(this._state=W.CData),this._needed>0;case W.CData:let a=this.applyHuffman(this._huffman);if(a<256)return this.addByte(a),this._needed>0;if(256===a)return this._state=this._isFinal?W.Crc:W.Block,!0;{a=a-257&255;let e=ct.LenExtraBitsTbl[a];if(-1===e)throw new s("Invalid data");this._len=ct.LenBaseValTbl[a]+this.getBits(e);let t=this._huffdist,i=t?this.applyHuffman(t):this.getRevBits(5);if(e=ct.DistExtraBitsTbl[i],-1===e)throw new s("Invalid data");if(this._dist=ct.DistBaseValTbl[i]+this.getBits(e),this._dist>this._window.available())throw new s("Invalid data");return this._state=1===this._dist?W.DistOne:W.Dist,!0}}return!1}addDistOne(e){let t=this._window.getLastChar();for(let s=0;s<e;s++)this.addByte(t)}addByte(e){this._window.addByte(e),this._output[this._outpos]=e,this._needed--,this._outpos++}addDist(e,t){this.addBytes(this._window.buffer,this._window.pos-e,t)}getBit(){0===this._nbits&&(this._nbits=8,this._bits=this._input.readByte());let e=1==(1&this._bits);return this._nbits--,this._bits=this._bits>>1,e}getBits(e){for(;this._nbits<e;)this._bits=this._bits|this._input.readByte()<<this._nbits,this._nbits+=8;let t=this._bits&(1<<e)-1;return this._nbits-=e,this._bits=this._bits>>e,t}getRevBits(e){return 0===e?0:this.getBit()?1<<e-1|this.getRevBits(e-1):this.getRevBits(e-1)}resetBits(){this._bits=0,this._nbits=0}addBytes(e,t,s){this._window.addBytes(e,t,s),this._output.set(e.subarray(t,t+s),this._outpos),this._needed-=s,this._outpos+=s}inflateLengths(e,t){let i=0,a=0;for(;i<t;){let r=this.applyHuffman(this._huffman);switch(r){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:a=r,e[i]=r,i++;break;case 16:let n=i+3+this.getBits(2);if(n>t)throw new s("Invalid data");for(;i<n;)e[i]=a,i++;break;case 17:if(i+=3+this.getBits(3),i>t)throw new s("Invalid data");break;case 18:if(i+=11+this.getBits(7),i>t)throw new s("Invalid data");break;default:throw new s("Invalid data")}}}applyHuffman(e){if(e instanceof nt)return e.n;if(e instanceof ot)return this.applyHuffman(this.getBit()?e.right:e.left);if(e instanceof ht)return this.applyHuffman(e.table[this.getBits(e.n)]);throw new s("Invalid data")}}ct.LenExtraBitsTbl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1],ct.LenBaseValTbl=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],ct.DistExtraBitsTbl=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1],ct.DistBaseValTbl=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],ct.CodeLengthsPos=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ct._fixedHuffman=ct.buildFixedHuffman();class ut{constructor(e,t){this.fullName=e;let s=e.lastIndexOf("/");this.fileName=-1===s||s===e.length-1?this.fullName:e.substr(s+1),this.data=t}}class pt{constructor(e){this._readable=e}read(){let e=[];for(;;){let t=this.readEntry();if(!t)break;e.push(t)}return e}readEntry(){let e=this._readable;if(We.readInt32LE(e)!==pt.LocalFileHeaderSignature)return null;We.readUInt16LE(e);let t=We.readUInt16LE(e),s=We.readUInt16LE(e),a=0!==s;if(a&&s!==pt.CompressionMethodDeflate)return null;We.readInt16LE(this._readable),We.readInt16LE(this._readable),We.readInt32LE(e),We.readInt32LE(e);let r,n=We.readInt32LE(e),o=We.readInt16LE(e),h=We.readInt16LE(e),l=i.toString(We.readByteArray(e,o),"utf-8");if(e.skip(h),a){let e=Ye.empty(),t=new ct(this._readable),s=new Uint8Array(65536);for(;;){let i=t.readBytes(s,0,s.length);if(e.write(s,0,i),i<s.length)break}r=e.toArray()}else r=We.readByteArray(this._readable,n);if(0!=(8&t)){We.readInt32LE(this._readable)===pt.OptionalDataDescriptorSignature&&We.readInt32LE(this._readable),We.readInt32LE(this._readable),We.readInt32LE(this._readable)}return new ut(l,r)}}pt.OptionalDataDescriptorSignature=134695760,pt.CompressionMethodDeflate=8,pt.LocalFileHeaderSignature=67324752;class gt extends ue{get name(){return"Guitar Pro 7"}constructor(){super()}readScore(){we.info(this.name,"Loading ZIP entries");let e,t=new pt(this.data);try{e=t.read()}catch(e){throw new pe("No Zip archive",e)}we.info(this.name,"Zip entries loaded");let s=null,a=null,r=null;for(let t of e)switch(t.fileName){case"score.gpif":s=i.toString(t.data,this.settings.importer.encoding);break;case"BinaryStylesheet":a=t.data;break;case"PartConfiguration":r=t.data}if(!s)throw new pe("No score.gpif found in zip archive");we.info(this.name,"Start Parsing score.gpif");let n=new tt;n.parseXml(s,this.settings),we.info(this.name,"score.gpif parsed");let o=n.score;if(a){we.info(this.name,"Start Parsing BinaryStylesheet"),new Qe(a).apply(o),we.info(this.name,"BinaryStylesheet parsed")}if(r){we.info(this.name,"Start Parsing Part Configuration"),new at(r).apply(o),we.info(this.name,"Part Configuration parsed")}return o}}class ft extends Error{constructor(){super("Unexpected end of data within reader")}}class mt{constructor(e){this._currentByte=0,this._position=mt.ByteSize,this._source=e}readByte(){return this.readBits(8)}readBytes(e){const t=new Uint8Array(e);for(let s=0;s<e;s++)t[s]=255&this.readByte();return t}readBits(e){let t=0,s=e-1;for(;s>=0;)t|=this.readBit()<<s,s--;return t}readBitsReversed(e){let t=0;for(let s=0;s<e;s++)t|=this.readBit()<<s;return t}readBit(){if(this._position>=8){if(this._currentByte=this._source.readByte(),-1===this._currentByte)throw new ft;this._position=0}const e=this._currentByte>>mt.ByteSize-this._position-1&1;return this._position++,e}readAll(){let e=Ye.empty();try{for(;;)e.writeByte(255&this.readByte())}catch(e){if(!(e instanceof ft))throw e}return e.toArray()}}mt.ByteSize=8;class yt{constructor(){this.fileName="",this.fileSize=0,this.data=null}}class bt{constructor(){this.files=[],this.files=[],this.fileFilter=e=>!0}load(e){let t=new mt(e);this.readBlock(t)}readHeader(e){return this.getString(e.readBytes(4),0,4)}decompress(e,t=!1){let s,i=Ye.empty(),a=this.getInteger(e.readBytes(4),0);try{for(;i.length<a;){if(1===e.readBits(1)){let t=e.readBits(4),a=e.readBitsReversed(t),r=e.readBitsReversed(t),n=i.length-a,o=Math.min(a,r);s=i.getBuffer(),i.write(s,n,o)}else{let t=e.readBitsReversed(2);for(let s=0;s<t;s++)i.writeByte(e.readByte())}}}catch(e){if(!(e instanceof ft))throw e}s=i.getBuffer();let r=t?4:0,n=i.length-r,o=new Uint8Array(n),h=n;return o.set(s.subarray(r,r+h),0),o}readBlock(e){let t=this.readHeader(e);if("BCFZ"===t)this.readUncompressedBlock(this.decompress(e,!0));else{if("BCFS"!==t)throw new pe("Unsupported format");this.readUncompressedBlock(e.readAll())}}readUncompressedBlock(e){let t=4096;for(;t+3<e.length;){if(2===this.getInteger(e,t)){let s=new yt;s.fileName=this.getString(e,t+4,127),s.fileSize=this.getInteger(e,t+140);let i=!this.fileFilter||this.fileFilter(s.fileName);i&&this.files.push(s);let a=t+148,r=0,n=0,o=i?Ye.withCapactiy(s.fileSize):null;for(;0!==(r=this.getInteger(e,a+4*n++));)t=4096*r,i&&o.write(e,t,4096);if(i){s.data=new Uint8Array(Math.min(s.fileSize,o.length));let e=o.toArray();s.data.set(e.subarray(0,0+s.data.length),0)}}t+=4096}}getString(e,t,s){let i="";for(let a=0;a<s;a++){let s=255&e[t+a];if(0===s)break;i+=String.fromCharCode(s)}return i}getInteger(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}}bt.HeaderBcFs="BCFS",bt.HeaderBcFz="BCFZ",bt.ScoreGpif="score.gpif",bt.BinaryStylesheet="BinaryStylesheet",bt.PartConfiguration="PartConfiguration";class St extends ue{get name(){return"Guitar Pro 6"}constructor(){super()}readScore(){we.info(this.name,"Loading GPX filesystem");let e=new bt;e.fileFilter=e=>e.endsWith("score.gpif")||e.endsWith("BinaryStylesheet")||e.endsWith("PartConfiguration"),e.load(this.data),we.info(this.name,"GPX filesystem loaded");let t=null,s=null,a=null;for(let r of e.files)switch(r.fileName){case"score.gpif":t=i.toString(r.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=r.data;break;case"PartConfiguration":a=r.data}if(!t)throw new pe("No score.gpif found in GPX");we.info(this.name,"Start Parsing score.gpif");let r=new tt;r.parseXml(t,this.settings),we.info(this.name,"score.gpif parsed");let n=r.score;if(s){we.info(this.name,"Start Parsing BinaryStylesheet"),new Qe(s).apply(n),we.info(this.name,"BinaryStylesheet parsed")}if(a){we.info(this.name,"Start Parsing Part Configuration"),new at(a).apply(n),we.info(this.name,"Part Configuration parsed")}return n}}class _t extends ue{constructor(){super(),this._currentPartGroup=null,this._trackFirstMeasureNumber=0,this._maxVoices=0,this._currentDirection=null,this._currentChord=null,this._divisionsPerQuarterNote=0,this._voiceOfStaff=new Map,this._isBeamContinue=!1,this._previousBeatWasPulled=!1,this._previousBeat=null}get name(){return"MusicXML"}readScore(){this._trackById=new Map,this._partGroups=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._slurStarts=new Map;let e,t=i.toString(this.data.readAll(),this.settings.importer.encoding);try{e=new Ze(t)}catch(e){throw new pe("Unsupported format")}return this._score=new Ce,this._score.tempo=120,this.parseDom(e),this.settings.importer.mergePartGroupsInMusicXml&&this.mergePartGroups(),this._score.finish(this.settings),this._score.rebuildRepeatGroups(),this._score}mergePartGroups(){let e=!1;for(let t of this._partGroups){let s=t[1];s.length>1&&(this.mergeGroup(s),e=!0)}if(e)for(let e=0;e<this._score.tracks.length;e++)this._score.tracks[e].index=e}mergeGroup(e){let t=e[0];for(let s=1;s<e.length;s++){let i=e[s];for(let e of i.staves)t.addStaff(e);let a=this._score.tracks.indexOf(i);this._score.tracks.splice(a,1)}}parseDom(e){let t=e.documentElement;if(!t)throw new pe("Unsupported format");switch(t.localName){case"score-partwise":this.parsePartwise(t);break;case"score-timewise":break;default:throw new pe("Unsupported format")}}parsePartwise(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"work":this.parseWork(t);break;case"movement-title":this._score.title=t.innerText;break;case"identification":this.parseIdentification(t);break;case"part-list":this.parsePartList(t);break;case"part":this.parsePart(t)}}parseWork(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"work-title":this._score.title=t.innerText}}parsePart(e){let t=e.getAttribute("id");if(!this._trackById.has(t)){if(1!==this._trackById.size)return;for(let e of this._trackById){let s=e[1];0!==s.staves.length&&0!==s.staves[0].bars.length||(t=e[0])}if(!this._trackById.has(t))return}let s=this._trackById.get(t),i=!0;this._maxVoices=0;for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"measure":this.parseMeasure(t,s,i)&&(i=!1)}for(let e of s.staves)for(let t of e.bars)this.ensureVoices(t)}parseMeasure(e,t,s){if("yes"===e.getAttribute("implicit")&&0===e.getElementsByTagName("note",!1).length)return!1;let i=0;if(s)this._divisionsPerQuarterNote=0,this._trackFirstMeasureNumber=parseInt(e.getAttribute("number")),this._trackFirstMeasureNumber||(this._trackFirstMeasureNumber=0),i=0;else{if(i=parseInt(e.getAttribute("number")),!i)return!1;i-=this._trackFirstMeasureNumber}if(s){let s=e.getElementsByTagName("attributes",!1);if(s.length>0){let e=s[0].getElementsByTagName("staves",!1);if(e.length>0){let s=parseInt(e[0].innerText);t.ensureStaveCount(s)}}}let a=new Array(t.staves.length),r=null;for(let e=t.staves[0].bars.length;e<=i;e++)for(let e=0;e<t.staves.length;e++){let s=a[e]=new fe;if(t.staves[e].bars.length>0){let i=t.staves[e].bars[t.staves[e].bars.length-1];s.clef=i.clef}r=this.getOrCreateMasterBar(i),t.staves[e].addBar(s),this.ensureVoices(s)}let n=!1;for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"note":this.parseNoteBeat(s,a);break;case"forward":this.parseForward(s,a);break;case"direction":this.parseDirection(s,r);break;case"attributes":n||(this.parseAttributes(s,a,r,t),n=!0);break;case"harmony":this.parseHarmony(s,t);break;case"sound":break;case"barline":this.parseBarline(s,r)}return!0}ensureVoices(e){for(;e.voices.length<this._maxVoices;){let t=new Re;e.addVoice(t);let s=new Te;s.isEmpty=!0,s.chordId=this._currentChord,t.addBeat(s)}}getOrCreateBeat(e,t,s){let i=0,a=e.getElementsByTagName("voice",!1);a.length>0&&(i=parseInt(a[0].innerText)-1);let r=this._previousBeatWasPulled;this._previousBeatWasPulled=!1;let n,o,h=e.getElementsByTagName("staff",!1),l=1;if(h.length>0){l=parseInt(h[0].innerText),(this._isBeamContinue||r)&&this._previousBeat.voice.bar.staff.index!==l-1&&(l=this._previousBeat.voice.bar.staff.index+1,this._previousBeatWasPulled=!0);let e=t[0].staff.track.index+"-"+l;this._voiceOfStaff.has(e)||this._voiceOfStaff.set(e,i)}l--,n=l<0?t[0]:l>=t.length?t[t.length-1]:t[l];let d=this.getOrCreateVoice(n,i);return s&&d.beats.length>0||1===d.beats.length&&d.isEmpty?o=d.beats[d.beats.length-1]:(o=new Te,o.isEmpty=!1,d.addBeat(o)),this._isBeamContinue=!1,this._previousBeat=o,o}parseForward(e,t){let s=this.getOrCreateBeat(e,t,!1),i=parseInt(e.findChildElement("duration").innerText)*b.Quarter/this._divisionsPerQuarterNote,a=[b.SixtyFourth,b.ThirtySecond,b.Sixteenth,b.Eighth,b.Quarter,b.Half,b.Whole];for(let e of a)if(i>=e){s.duration=e,i-=e;break}s.isEmpty=!1}parseStaffDetails(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"staff-lines":for(let e of t.staves)e.tuning=new Array(parseInt(s.innerText)).fill(0);break;case"staff-tuning":this.parseStaffTuning(s,t)}for(let e of t.staves)this.isEmptyTuning(e.tuning)&&(e.tuning=[])}parseStaffTuning(e,t){let s=parseInt(e.getAttribute("line")),i="C",a="",r=0;for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"tuning-step":i=t.innerText;break;case"tuning-alter":r=parseInt(t.innerText);break;case"tuning-octave":a=t.innerText}let n=Ae.getTuningForText(i+a)+r;for(let e of t.staves)e.tuning[e.tuning.length-s]=n}parseHarmony(e,t){let s=null,a="";for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"root":for(let e of t.childNodes)if(e.nodeType===V.Element)switch(e.localName){case"root-step":s=e.innerText;break;case"root-alter":switch(parseInt(t.innerText)){case-2:a=" bb";break;case-1:a=" b";break;case 0:a="";break;case 1:a=" #";break;case 2:a=" ##"}}}let r=new ke;r.name=s+a,this._currentChord=i.newGuid();for(let e of t.staves)e.addChord(this._currentChord,r)}parseBarline(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"repeat":this.parseRepeat(s,t);break;case"ending":this.parseEnding(s,t)}}parseEnding(e,t){let s=parseInt(e.getAttribute("number"));s>0&&(--s,t.alternateEndings|=1<<s&255)}parseRepeat(e,t){let s=e.getAttribute("direction"),i=parseInt(e.getAttribute("times"));(i<0||isNaN(i))&&(i=2),"backward"===s?t.repeatCount=i:"forward"===s&&(t.isRepeatStart=!0)}parseNoteBeat(e,t){let s=e.getElementsByTagName("chord",!1).length>0,i=this.getOrCreateBeat(e,t,s);!i.chordId&&this._currentChord&&(i.chordId=this._currentChord,this._currentChord=null),this._currentDirection&&(i.text=this._currentDirection,this._currentDirection=null);let a=new Be;i.voice.isEmpty=!1,i.isEmpty=!1,i.addNote(a),i.dots=0;for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"grace":i.graceType=_.BeforeBeat,i.duration=b.ThirtySecond;break;case"duration":if(i.isRest){switch(parseInt(t.innerText)){case 1:i.duration=b.Whole;break;case 2:i.duration=b.Half;break;case 4:i.duration=b.Quarter;break;case 8:i.duration=b.Eighth;break;case 16:i.duration=b.Sixteenth;break;case 32:i.duration=b.ThirtySecond;break;case 64:i.duration=b.SixtyFourth;break;default:i.duration=b.Quarter}}break;case"tie":this.parseTied(t,a);break;case"cue":case"instrument":break;case"type":i.duration=this.getDuration(t.innerText),i.graceType!==_.None&&i.duration<b.Sixteenth&&(i.duration=b.Eighth);break;case"dot":i.dots++;break;case"accidental":this.parseAccidental(t,a);break;case"time-modification":this.parseTimeModification(t,i);break;case"stem":break;case"notehead":"yes"===t.getAttribute("parentheses")&&(a.isGhost=!0);break;case"beam":"continue"===t.innerText&&(this._isBeamContinue=!0);break;case"notations":this.parseNotations(t,i,a);break;case"lyric":this.parseLyric(t,i);break;case"pitch":this.parsePitch(t,a);break;case"unpitched":this.parseUnpitched(t,a);break;case"rest":i.isEmpty=!1,i.notes=[]}if(a.isStringed)for(let e=0;e<i.notes.length;e++)if(i.notes[e].string===a.string&&i.notes[e]!==a){i.removeNote(a);break}}getDuration(e){switch(e){case"256th":case"128th":case"64th":return b.SixtyFourth;case"32nd":return b.ThirtySecond;case"16th":return b.Sixteenth;case"eighth":return b.Eighth;case"quarter":return b.Quarter;case"half":return b.Half;case"long":case"breve":case"whole":return b.Whole}return b.Quarter}parseLyric(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"text":t.text?t.text+=" "+s.innerText:t.text=s.innerText}}parseAccidental(e,t){switch(e.innerText){case"sharp":t.accidentalMode=v.ForceSharp;break;case"natural":t.accidentalMode=v.ForceNatural;break;case"flat":t.accidentalMode=v.ForceFlat}}parseTied(e,t){"start"===e.getAttribute("type")?this._tieStartIds.has(t.id)||(this._tieStartIds.set(t.id,!0),this._tieStarts.push(t)):"stop"===e.getAttribute("type")&&this._tieStarts.length>0&&!t.isTieDestination&&(t.isTieDestination=!0,t.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(t.id))}parseNotations(e,t,s){for(let i of e.childNodes)if(i.nodeType===V.Element)switch(i.localName){case"articulations":this.parseArticulations(i,s);break;case"tied":this.parseTied(i,s);break;case"slide":case"glissando":"start"===i.getAttribute("type")&&(s.slideOutType=k.Shift);break;case"dynamics":this.parseDynamics(i,t);break;case"technical":this.parseTechnical(i,s);break;case"ornaments":this.parseOrnaments(i,s);break;case"slur":let e=i.getAttribute("number");switch(e||(e="1"),i.getAttribute("type")){case"start":this._slurStarts.set(e,s);break;case"stop":if(this._slurStarts.has(e)){s.isSlurDestination=!0,this._slurStarts.get(e).slurDestination=s,s.slurOrigin=s}}}}parseOrnaments(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"tremolo":switch(parseInt(s.innerText)){case 1:t.beat.tremoloSpeed=b.Eighth;break;case 2:t.beat.tremoloSpeed=b.Sixteenth;break;case 3:t.beat.tremoloSpeed=b.ThirtySecond}}}parseTechnical(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"string":t.string=parseInt(s.innerText),-2147483648!==t.string&&(t.string=t.beat.voice.bar.staff.tuning.length-t.string+1);break;case"fret":t.fret=parseInt(s.innerText);break;case"down-bow":t.beat.pickStroke=L.Down;break;case"up-bow":t.beat.pickStroke=L.Up}-2147483648!==t.string&&-2147483648!==t.fret||(t.string=-1,t.fret=-1)}parseArticulations(e,t){for(let s of e.childNodes)switch(s.localName){case"accent":t.accentuated=l.Normal;break;case"strong-accent":t.accentuated=l.Heavy;break;case"staccato":case"detached-legato":t.isStaccato=!0}}parseDynamics(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"p":t.dynamics=S.P;break;case"pp":t.dynamics=S.PP;break;case"ppp":t.dynamics=S.PPP;break;case"f":t.dynamics=S.F;break;case"ff":t.dynamics=S.FF;break;case"fff":t.dynamics=S.FFF;break;case"mp":t.dynamics=S.MP;break;case"mf":t.dynamics=S.MF}}parseTimeModification(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"actual-notes":t.tupletNumerator=parseInt(s.innerText);break;case"normal-notes":t.tupletDenominator=parseInt(s.innerText)}}parseUnpitched(e,t){let s="",i=0,a=0;for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"display-step":s=t.innerText;break;case"display-alter":i=parseInt(t.innerText);break;case"display-octave":a=parseInt(t.innerText)}let r=12*a+Ae.getToneForText(s)+i;t.octave=r/12|0,t.tone=r-12*t.octave}parsePitch(e,t){let s="",i=0,a=0;for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"step":s=t.innerText;break;case"alter":i=parseFloat(t.innerText),isNaN(i)&&(i=0);break;case"octave":a=parseInt(t.innerText)+1}let r=12*a+Ae.getToneForText(s)+(0|i);t.octave=r/12|0,t.tone=r-12*t.octave}getOrCreateVoice(e,t){if(t<e.voices.length)return e.voices[t];for(let s=e.voices.length;s<=t;s++)e.addVoice(new Re);return this._maxVoices=Math.max(this._maxVoices,e.voices.length),e.voices[t]}parseDirection(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"sound":let e=s.getAttribute("tempo");if(e){let s=new ge;s.isLinear=!0,s.type=d.Tempo,s.value=parseInt(e),t.tempoAutomation=s}break;case"direction-type":let i=s.firstElement;switch(i.localName){case"words":this._currentDirection=i.innerText;break;case"metronome":this.parseMetronome(i,t)}}}parseMetronome(e,t){let s=b.Quarter,i=120;for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"beat-unit":s=this.getDuration(t.innerText);break;case"per-minute":i=parseInt(t.innerText)}let a=t.tempoAutomation=new ge;a.type=d.Tempo,a.value=i*(s/4|0)}parseAttributes(e,t,s,i){let a=0,r=!1;for(let n of e.childNodes)if(n.nodeType===V.Element)switch(n.localName){case"divisions":this._divisionsPerQuarterNote=parseInt(n.innerText);break;case"key":this.parseKey(n,s);break;case"time":this.parseTime(n,s),r=!0;break;case"clef":a=parseInt(n.getAttribute("number")),isNaN(a)&&(a=1),this.parseClef(n,t[a-1]);break;case"staff-details":this.parseStaffDetails(n,i);break;case"transpose":this.parseTranspose(n,i)}r||(s.timeSignatureCommon=!0)}parseTranspose(e,t){let s=0;for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"chromatic":s+=parseInt(t.innerText);break;case"octave-change":s+=12*parseInt(t.innerText)}for(let e of t.staves)e.transpositionPitch=s}parseClef(e,t){let s="s",i=0;for(let a of e.childNodes)if(a.nodeType===V.Element)switch(a.localName){case"sign":s=a.innerText.toLowerCase();break;case"line":i=parseInt(a.innerText);break;case"clef-octave-change":switch(parseInt(a.innerText)){case-2:t.clefOttava=u._15mb;break;case-1:t.clefOttava=u._8vb;break;case 1:t.clefOttava=u._8va;break;case 2:t.clefOttava=u._15mb}}switch(s){case"g":t.clef=c.G2;break;case"f":t.clef=c.F4;break;case"c":t.clef=3===i?c.C3:c.C4;break;case"percussion":t.clef=c.Neutral,t.staff.isPercussion=!0;break;case"tab":t.clef=c.G2,t.staff.showTablature=!0;break;default:t.clef=c.G2}}parseTime(e,t){"common"===e.getAttribute("symbol")&&(t.timeSignatureCommon=!0);let s=!1,i=!1;for(let a of e.childNodes)if(a.nodeType===V.Element){let e=a.innerText;switch(a.localName){case"beats":s||(-1===e.indexOf("+")?t.timeSignatureNumerator=parseInt(e):t.timeSignatureNumerator=4,s=!0);break;case"beat-type":i||(-1===e.indexOf("+")?t.timeSignatureDenominator=parseInt(e):t.timeSignatureDenominator=4,i=!0)}}}parseKey(e,t){let s=-2147483648,i="";for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"fifths":s=parseInt(t.innerText);break;case"key-step":case"key-alter":break;case"mode":i=t.innerText}t.keySignature=-7<=s&&s<=7?s:D.C,t.keySignatureType="minor"===i?I.Minor:I.Major}getOrCreateMasterBar(e){if(e<this._score.masterBars.length)return this._score.masterBars[e];for(let t=this._score.masterBars.length;t<=e;t++){let e=new Ne;if(this._score.masterBars.length>0){let t=this._score.masterBars[this._score.masterBars.length-1];e.timeSignatureDenominator=t.timeSignatureDenominator,e.timeSignatureNumerator=t.timeSignatureNumerator,e.keySignature=t.keySignature,e.keySignatureType=t.keySignatureType}this._score.addMasterBar(e)}return this._score.masterBars[e]}parseIdentification(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"creator":"composer"===t.getAttribute("type")&&(this._score.music=t.innerText);break;case"rights":this._score.copyright&&(this._score.copyright+="\n"),this._score.copyright+=t.innerText}}parsePartList(e){for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"part-group":this.parsePartGroup(t);break;case"score-part":this.parseScorePart(t)}}parsePartGroup(e){switch(e.getAttribute("type")){case"start":this._currentPartGroup=e.getAttribute("number"),this._partGroups.set(this._currentPartGroup,[]);break;case"stop":this._currentPartGroup=null}}parseScorePart(e){let t=e.getAttribute("id"),s=new De;s.ensureStaveCount(1),s.staves[0].showStandardNotation=!0,this._trackById.set(t,s),this._score.addTrack(s),this._currentPartGroup&&this._partGroups.get(this._currentPartGroup).push(s);for(let t of e.childNodes)if(t.nodeType===V.Element)switch(t.localName){case"part-name":s.name=t.innerText;break;case"part-abbreviation":s.shortName=t.innerText;break;case"midi-instrument":this.parseMidiInstrument(t,s)}this.isEmptyTuning(s.staves[0].tuning)&&(s.staves[0].tuning=[])}isEmptyTuning(e){if(!e)return!0;for(let t=0;t<e.length;t++)if(0!==e[t])return!1;return!0}parseMidiInstrument(e,t){for(let s of e.childNodes)if(s.nodeType===V.Element)switch(s.localName){case"midi-channel":t.playbackInfo.primaryChannel=parseInt(s.innerText);break;case"midi-program":t.playbackInfo.program=parseInt(s.innerText);break;case"midi-volume":t.playbackInfo.volume=parseInt(s.innerText)}}}!function(e){e[e.NoteOff=128]="NoteOff",e[e.NoteOn=144]="NoteOn",e[e.NoteAftertouch=160]="NoteAftertouch",e[e.Controller=176]="Controller",e[e.ProgramChange=192]="ProgramChange",e[e.ChannelAftertouch=208]="ChannelAftertouch",e[e.PitchBend=224]="PitchBend",e[e.Meta=255]="Meta"}(z||(z={}));class wt{constructor(e,t,s,i){this.tick=e,this.message=t|s<<8|i<<16}get channel(){return 15&this.message}get command(){return 240&this.message}get data1(){return(65280&this.message)>>8}set data1(e){this.message&=-65281,this.message|=e<<8}get data2(){return(16711680&this.message)>>16}set data2(e){this.message&=-16711681,this.message|=e<<16}writeTo(e){let t=new Uint8Array([this.message>>24&255,this.message>>16&255,this.message>>8&255,255&this.message]);e.write(t,0,t.length)}}!function(e){e[e.SequenceNumber=0]="SequenceNumber",e[e.TextEvent=1]="TextEvent",e[e.CopyrightNotice=2]="CopyrightNotice",e[e.SequenceOrTrackName=3]="SequenceOrTrackName",e[e.InstrumentName=4]="InstrumentName",e[e.LyricText=5]="LyricText",e[e.MarkerText=6]="MarkerText",e[e.CuePoint=7]="CuePoint",e[e.PatchName=8]="PatchName",e[e.PortName=9]="PortName",e[e.MidiChannel=32]="MidiChannel",e[e.MidiPort=33]="MidiPort",e[e.EndOfTrack=47]="EndOfTrack",e[e.Tempo=81]="Tempo",e[e.SmpteOffset=84]="SmpteOffset",e[e.TimeSignature=88]="TimeSignature",e[e.KeySignature=89]="KeySignature",e[e.SequencerSpecific=127]="SequencerSpecific"}(U||(U={}));class Bt extends wt{get channel(){return-1}get command(){return 255&this.message}get metaStatus(){return this.data1}constructor(e,t,s,i){super(e,t,s,i)}}class vt{constructor(e,t){this.isMetronome=!1,this.time=0,this.eventIndex=e,this.event=t}static newMetronomeEvent(e){const t=new vt(e,null);return t.isMetronome=!0,t}}class Tt{constructor(){this.id="",this.size=0}static load(e,t,s){if(e&&Tt.HeaderSize>e.size)return!1;if(s.position+Tt.HeaderSize>=s.length)return!1;if(t.id=We.read8BitStringLength(s,4),t.id.charCodeAt(0)<=32||t.id.charCodeAt(0)>=122)return!1;if(t.size=We.readUInt32LE(s),e&&Tt.HeaderSize+t.size>e.size)return!1;e&&(e.size-=Tt.HeaderSize+t.size);let i="RIFF"===t.id,a="LIST"===t.id;return(!i||!e)&&(!i&&!a||(t.id=We.read8BitStringLength(s,4),!(t.id.charCodeAt(0)<=32||t.id.charCodeAt(0)>=122)&&(t.size-=4,!0)))}}Tt.HeaderSize=8;class kt{constructor(){this.phdrs=[],this.pbags=[],this.pmods=[],this.pgens=[],this.insts=[],this.ibags=[],this.imods=[],this.igens=[],this.sHdrs=[],this.fontSamples=new Float32Array(0)}load(e){const t=new Tt,i=new Tt;if(!Tt.load(null,t,e)||"sfbk"!==t.id)throw new s("Soundfont is not a valid Soundfont2 file");for(;Tt.load(t,i,e);){let t=new Tt;if("pdta"===i.id)for(;Tt.load(i,t,e);)switch(t.id){case"phdr":for(let s=0,i=t.size/Mt.SizeInFile|0;s<i;s++)this.phdrs.push(new Mt(e));break;case"pbag":for(let s=0,i=t.size/Ct.SizeInFile|0;s<i;s++)this.pbags.push(new Ct(e));break;case"pmod":for(let s=0,i=t.size/Et.SizeInFile|0;s<i;s++)this.pmods.push(new Et(e));break;case"pgen":for(let s=0,i=t.size/Lt.SizeInFile|0;s<i;s++)this.pgens.push(new Lt(e));break;case"inst":for(let s=0,i=t.size/Ft.SizeInFile|0;s<i;s++)this.insts.push(new Ft(e));break;case"ibag":for(let s=0,i=t.size/xt.SizeInFile|0;s<i;s++)this.ibags.push(new xt(e));break;case"imod":for(let s=0,i=t.size/Nt.SizeInFile|0;s<i;s++)this.imods.push(new Nt(e));break;case"igen":for(let s=0,i=t.size/Pt.SizeInFile|0;s<i;s++)this.igens.push(new Pt(e));break;case"shdr":for(let s=0,i=t.size/Dt.SizeInFile|0;s<i;s++)this.sHdrs.push(new Dt(e));break;default:e.position+=t.size}else if("sdta"===i.id)for(;Tt.load(i,t,e);)switch(t.id){case"smpl":this.fontSamples=kt.loadSamples(t,e);break;default:e.position+=t.size}else e.position+=i.size}}static loadSamples(e,t){let s=e.size/2|0;const i=new Float32Array(s);let a=0;const r=new Uint8Array(2048),n=new Int16Array(r.length/2|0);for(;s>0;){let e=Math.min(s,r.length/2|0);t.read(r,0,2*e);for(let t=0;t<e;t++)n[t]=r[2*t+1]<<8|r[2*t],i[a+t]=n[t]/32767;s-=e,a+=e}return i}}class xt{constructor(e){this.instGenNdx=We.readUInt16LE(e),this.instModNdx=We.readUInt16LE(e)}}xt.SizeInFile=4;class Nt{constructor(e){this.modSrcOper=We.readUInt16LE(e),this.modDestOper=We.readUInt16LE(e),this.modAmount=We.readInt16LE(e),this.modAmtSrcOper=We.readUInt16LE(e),this.modTransOper=We.readUInt16LE(e)}}Nt.SizeInFile=10;class Pt{constructor(e){this.genOper=We.readUInt16LE(e),this.genAmount=new It(e)}}Pt.SizeInFile=4;class Ft{constructor(e){this.instName=We.read8BitStringLength(e,20),this.instBagNdx=We.readUInt16LE(e)}}Ft.SizeInFile=22;class Ct{constructor(e){this.genNdx=We.readUInt16LE(e),this.modNdx=We.readUInt16LE(e)}}Ct.SizeInFile=4;class Lt{constructor(e){this.genOper=We.readUInt16LE(e),this.genAmount=new It(e)}}Lt.SizeInFile=4,Lt.GenInstrument=41,Lt.GenKeyRange=43,Lt.GenVelRange=44,Lt.GenSampleId=53;class Mt{constructor(e){this.presetName=We.read8BitStringLength(e,20),this.preset=We.readUInt16LE(e),this.bank=We.readUInt16LE(e),this.presetBagNdx=We.readUInt16LE(e),this.library=We.readUInt32LE(e),this.genre=We.readUInt32LE(e),this.morphology=We.readUInt32LE(e)}}Mt.SizeInFile=38;class Et{constructor(e){this.modSrcOper=We.readUInt16LE(e),this.modDestOper=We.readUInt16LE(e),this.modAmount=We.readUInt16LE(e),this.modAmtSrcOper=We.readUInt16LE(e),this.modTransOper=We.readUInt16LE(e)}}Et.SizeInFile=10;class Dt{constructor(e){this.sampleName=We.read8BitStringLength(e,20),this.start=We.readUInt32LE(e),this.end=We.readUInt32LE(e),this.startLoop=We.readUInt32LE(e),this.endLoop=We.readUInt32LE(e),this.sampleRate=We.readUInt32LE(e),this.originalPitch=e.readByte(),this.pitchCorrection=We.readSInt8(e),this.sampleLink=We.readUInt16LE(e),this.sampleType=We.readUInt16LE(e)}}Dt.SizeInFile=46;class It{constructor(e){this.wordAmount=We.readUInt16LE(e)}get shortAmount(){return He.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}}class Rt{constructor(){this.presetIndex=0,this.bank=0,this.pitchWheel=0,this.midiPan=0,this.midiVolume=0,this.midiExpression=0,this.midiRpn=0,this.midiData=0,this.panOffset=0,this.gainDb=0,this.pitchRange=0,this.tuning=0,this.mixVolume=0,this.mute=!1,this.solo=!1}}class Ot{constructor(){this.activeChannel=0,this.channelList=[]}setupVoice(e,t){const s=this.channelList[this.activeChannel],i=t.region.pan+s.panOffset;t.playingChannel=this.activeChannel,t.mixVolume=s.mixVolume,t.noteGainDb+=s.gainDb,t.calcPitchRatio(8192===s.pitchWheel?s.tuning:s.pitchWheel/16383*s.pitchRange*2-s.pitchRange+s.tuning,e.outSampleRate),i<=-.5?(t.panFactorLeft=1,t.panFactorRight=0):i>=.5?(t.panFactorLeft=0,t.panFactorRight=1):(t.panFactorLeft=Math.sqrt(.5-i),t.panFactorRight=Math.sqrt(.5+i))}}!function(e){e[e.None=0]="None",e[e.Continuous=1]="Continuous",e[e.Sustain=2]="Sustain"}(X||(X={})),function(e){e[e.StereoInterleaved=0]="StereoInterleaved",e[e.StereoUnweaved=1]="StereoUnweaved",e[e.Mono=2]="Mono"}(Y||(Y={}));class At{constructor(){this.name="",this.presetNumber=0,this.bank=0,this.regions=null}}class Gt{static timecents2Secs(e){return Math.pow(2,e/1200)}static decibelsToGain(e){return e>-100?Math.pow(10,.05*e):0}static gainToDecibels(e){return e<=1e-5?-100:20*Math.log10(e)}static cents2Hertz(e){return 8.176*Math.pow(2,e/1200)}static clamp(e,t,s){return e<=t?t:e>=s?s:e}}class Vt{constructor(e){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0,e&&(this.delay=e.delay,this.attack=e.attack,this.hold=e.hold,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.keynumToHold=e.keynumToHold,this.keynumToDecay=e.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(e){this.delay=this.delay<-11950?0:Gt.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Gt.timecents2Secs(this.attack),this.release=this.release<-11950?0:Gt.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:Gt.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:Gt.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:this.sustain=e?Gt.decibelsToGain(-this.sustain/10):1-this.sustain/1e3}}!function(e){e[e.StartAddrsOffset=0]="StartAddrsOffset",e[e.EndAddrsOffset=1]="EndAddrsOffset",e[e.StartloopAddrsOffset=2]="StartloopAddrsOffset",e[e.EndloopAddrsOffset=3]="EndloopAddrsOffset",e[e.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",e[e.ModLfoToPitch=5]="ModLfoToPitch",e[e.VibLfoToPitch=6]="VibLfoToPitch",e[e.ModEnvToPitch=7]="ModEnvToPitch",e[e.InitialFilterFc=8]="InitialFilterFc",e[e.InitialFilterQ=9]="InitialFilterQ",e[e.ModLfoToFilterFc=10]="ModLfoToFilterFc",e[e.ModEnvToFilterFc=11]="ModEnvToFilterFc",e[e.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",e[e.ModLfoToVolume=13]="ModLfoToVolume",e[e.Unused1=14]="Unused1",e[e.ChorusEffectsSend=15]="ChorusEffectsSend",e[e.ReverbEffectsSend=16]="ReverbEffectsSend",e[e.Pan=17]="Pan",e[e.Unused2=18]="Unused2",e[e.Unused3=19]="Unused3",e[e.Unused4=20]="Unused4",e[e.DelayModLFO=21]="DelayModLFO",e[e.FreqModLFO=22]="FreqModLFO",e[e.DelayVibLFO=23]="DelayVibLFO",e[e.FreqVibLFO=24]="FreqVibLFO",e[e.DelayModEnv=25]="DelayModEnv",e[e.AttackModEnv=26]="AttackModEnv",e[e.HoldModEnv=27]="HoldModEnv",e[e.DecayModEnv=28]="DecayModEnv",e[e.SustainModEnv=29]="SustainModEnv",e[e.ReleaseModEnv=30]="ReleaseModEnv",e[e.KeynumToModEnvHold=31]="KeynumToModEnvHold",e[e.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",e[e.DelayVolEnv=33]="DelayVolEnv",e[e.AttackVolEnv=34]="AttackVolEnv",e[e.HoldVolEnv=35]="HoldVolEnv",e[e.DecayVolEnv=36]="DecayVolEnv",e[e.SustainVolEnv=37]="SustainVolEnv",e[e.ReleaseVolEnv=38]="ReleaseVolEnv",e[e.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",e[e.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",e[e.Instrument=41]="Instrument",e[e.Reserved1=42]="Reserved1",e[e.KeyRange=43]="KeyRange",e[e.VelRange=44]="VelRange",e[e.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",e[e.Keynum=46]="Keynum",e[e.Velocity=47]="Velocity",e[e.InitialAttenuation=48]="InitialAttenuation",e[e.Reserved2=49]="Reserved2",e[e.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",e[e.CoarseTune=51]="CoarseTune",e[e.FineTune=52]="FineTune",e[e.SampleID=53]="SampleID",e[e.SampleModes=54]="SampleModes",e[e.Reserved3=55]="Reserved3",e[e.ScaleTuning=56]="ScaleTuning",e[e.ExclusiveClass=57]="ExclusiveClass",e[e.OverridingRootKey=58]="OverridingRootKey",e[e.Unused5=59]="Unused5",e[e.EndOper=60]="EndOper"}(J||(J={}));class Ht{constructor(e){this.loopMode=X.None,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv=new Vt,this.modEnv=new Vt,this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,e&&(this.loopMode=e.loopMode,this.sampleRate=e.sampleRate,this.loKey=e.loKey,this.hiKey=e.hiKey,this.loVel=e.loVel,this.hiVel=e.hiVel,this.group=e.group,this.offset=e.offset,this.end=e.end,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.transpose=e.transpose,this.tune=e.tune,this.pitchKeyCenter=e.pitchKeyCenter,this.pitchKeyTrack=e.pitchKeyTrack,this.attenuation=e.attenuation,this.pan=e.pan,this.ampEnv=new Vt(e.ampEnv),this.modEnv=new Vt(e.modEnv),this.initialFilterQ=e.initialFilterQ,this.initialFilterFc=e.initialFilterFc,this.modEnvToPitch=e.modEnvToPitch,this.modEnvToFilterFc=e.modEnvToFilterFc,this.modLfoToFilterFc=e.modLfoToFilterFc,this.modLfoToVolume=e.modLfoToVolume,this.delayModLFO=e.delayModLFO,this.freqModLFO=e.freqModLFO,this.modLfoToPitch=e.modLfoToPitch,this.delayVibLFO=e.delayVibLFO,this.freqVibLFO=e.freqVibLFO,this.vibLfoToPitch=e.vibLfoToPitch)}clear(e){this.loopMode=0,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=this.hiVel=127,this.pitchKeyCenter=60,e||(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=this.ampEnv.attack=this.ampEnv.hold=this.ampEnv.decay=this.ampEnv.release=-12e3,this.modEnv.delay=this.modEnv.attack=this.modEnv.hold=this.modEnv.decay=this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(e,t){switch(e){case J.StartAddrsOffset:this.offset+=He.int16ToUint32(t.shortAmount);break;case J.EndAddrsOffset:this.end+=He.int16ToUint32(t.shortAmount);break;case J.StartloopAddrsOffset:this.loopStart+=He.int16ToUint32(t.shortAmount);break;case J.EndloopAddrsOffset:this.loopEnd+=He.int16ToUint32(t.shortAmount);break;case J.StartAddrsCoarseOffset:this.offset+=32768*He.int16ToUint32(t.shortAmount);break;case J.ModLfoToPitch:this.modLfoToPitch=t.shortAmount;break;case J.VibLfoToPitch:this.vibLfoToPitch=t.shortAmount;break;case J.ModEnvToPitch:this.modEnvToPitch=t.shortAmount;break;case J.InitialFilterFc:this.initialFilterFc=t.shortAmount;break;case J.InitialFilterQ:this.initialFilterQ=t.shortAmount;break;case J.ModLfoToFilterFc:this.modLfoToFilterFc=t.shortAmount;break;case J.ModEnvToFilterFc:this.modEnvToFilterFc=t.shortAmount;break;case J.EndAddrsCoarseOffset:this.end+=32768*He.int16ToUint32(t.shortAmount);break;case J.ModLfoToVolume:this.modLfoToVolume=t.shortAmount;break;case J.Pan:this.pan=t.shortAmount/1e3;break;case J.DelayModLFO:this.delayModLFO=t.shortAmount;break;case J.FreqModLFO:this.freqModLFO=t.shortAmount;break;case J.DelayVibLFO:this.delayVibLFO=t.shortAmount;break;case J.FreqVibLFO:this.freqVibLFO=t.shortAmount;break;case J.DelayModEnv:this.modEnv.delay=t.shortAmount;break;case J.AttackModEnv:this.modEnv.attack=t.shortAmount;break;case J.HoldModEnv:this.modEnv.hold=t.shortAmount;break;case J.DecayModEnv:this.modEnv.decay=t.shortAmount;break;case J.SustainModEnv:this.modEnv.sustain=t.shortAmount;break;case J.ReleaseModEnv:this.modEnv.release=t.shortAmount;break;case J.KeynumToModEnvHold:this.modEnv.keynumToHold=t.shortAmount;break;case J.KeynumToModEnvDecay:this.modEnv.keynumToDecay=t.shortAmount;break;case J.DelayVolEnv:this.ampEnv.delay=t.shortAmount;break;case J.AttackVolEnv:this.ampEnv.attack=t.shortAmount;break;case J.HoldVolEnv:this.ampEnv.hold=t.shortAmount;break;case J.DecayVolEnv:this.ampEnv.decay=t.shortAmount;break;case J.SustainVolEnv:this.ampEnv.sustain=t.shortAmount;break;case J.ReleaseVolEnv:this.ampEnv.release=t.shortAmount;break;case J.KeynumToVolEnvHold:this.ampEnv.keynumToHold=t.shortAmount;break;case J.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=t.shortAmount;break;case J.KeyRange:this.loKey=t.lowByteAmount,this.hiKey=t.highByteAmount;break;case J.VelRange:this.loVel=t.lowByteAmount,this.hiVel=t.highByteAmount;break;case J.StartloopAddrsCoarseOffset:this.loopStart+=32768*He.int16ToUint32(t.shortAmount);break;case J.InitialAttenuation:this.attenuation+=.1*t.shortAmount;break;case J.EndloopAddrsCoarseOffset:this.loopEnd+=32768*He.int16ToUint32(t.shortAmount);break;case J.CoarseTune:this.transpose+=t.shortAmount;break;case J.FineTune:this.tune+=t.shortAmount;break;case J.SampleModes:this.loopMode=3==(3&t.wordAmount)?X.Sustain:1==(3&t.wordAmount)?X.Continuous:X.None;break;case J.ScaleTuning:this.pitchKeyTrack=t.shortAmount;break;case J.ExclusiveClass:this.group=t.wordAmount;break;case J.OverridingRootKey:this.pitchKeyCenter=t.shortAmount}}}!function(e){e[e.None=0]="None",e[e.Delay=1]="Delay",e[e.Attack=2]="Attack",e[e.Hold=3]="Hold",e[e.Decay=4]="Decay",e[e.Sustain=5]="Sustain",e[e.Release=6]="Release",e[e.Done=7]="Done"}(Q||(Q={}));class Wt{constructor(){this.level=0,this.slope=0,this.samplesUntilNextSegment=0,this.segment=Q.None,this.midiVelocity=0,this.parameters=null,this.segmentIsExponential=!1,this.isAmpEnv=!1}nextSegment(e,t){if(this.parameters)for(;;)switch(e){case Q.None:if(this.samplesUntilNextSegment=this.parameters.delay*t|0,this.samplesUntilNextSegment>0)return this.segment=Q.Delay,this.segmentIsExponential=!1,this.level=0,void(this.slope=0);e=Q.Delay;break;case Q.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*t|0,this.samplesUntilNextSegment>0)return this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*t|0),this.segment=Q.Attack,this.segmentIsExponential=!1,this.level=0,void(this.slope=1/this.samplesUntilNextSegment);e=Q.Attack;break;case Q.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*t|0,this.samplesUntilNextSegment>0)return this.segment=Q.Hold,this.segmentIsExponential=!1,this.level=1,void(this.slope=0);e=Q.Hold;break;case Q.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*t|0,this.samplesUntilNextSegment>0){if(this.segment=Q.Decay,this.level=1,this.isAmpEnv){let e=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(e),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/e|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*t|0,this.segmentIsExponential=!1;return}e=Q.Decay;break;case Q.Decay:return this.segment=Q.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,void(this.segmentIsExponential=!1);case Q.Sustain:if(this.segment=Q.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?Wt.FastReleaseTime:this.parameters.release)*t|0,this.isAmpEnv){let e=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(e),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;case Q.Release:default:return this.segment=Q.Done,this.segmentIsExponential=!1,this.level=this.slope=0,void(this.samplesUntilNextSegment=134217727)}}setup(e,t,s,i,a){this.parameters=new Vt(e),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-t),this.parameters.hold=this.parameters.hold<-1e4?0:Gt.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-t),this.parameters.decay=this.parameters.decay<-1e4?0:Gt.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|s,this.isAmpEnv=i,this.nextSegment(Q.None,a)}process(e,t){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,e):this.level+=this.slope*e),(this.samplesUntilNextSegment-=e)<=0&&this.nextSegment(this.segment,t)}}Wt.FastReleaseTime=.01;class zt{constructor(){this.samplesUntil=0,this.level=0,this.delta=0}setup(e,t,s){this.samplesUntil=e*s|0,this.delta=4*Gt.cents2Hertz(t)/s,this.level=0}process(e){this.samplesUntil>e?this.samplesUntil-=e:(this.level+=this.delta*e,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level))}}class Ut{constructor(e){this.qInv=0,this.a0=0,this.a1=0,this.b1=0,this.b2=0,this.z1=0,this.z2=0,this.active=!1,e&&(this.qInv=e.qInv,this.a0=e.a0,this.a1=e.a1,this.b1=e.b1,this.b2=e.b2,this.z1=e.z1,this.z2=e.z2,this.active=e.active)}setup(e){let t=Math.tan(Math.PI*e),s=t*t,i=1/(1+t*this.qInv+s);this.a0=s*i,this.a1=2*this.a0,this.b1=2*(s-1)*i,this.b2=(1-t*this.qInv+s)*i}process(e){let t=e*this.a0+this.z1;return this.z1=e*this.a1+this.z2-this.b1*t,this.z2=e*this.a0-this.b2*t,t}}class Xt{constructor(){this.playingPreset=0,this.playingKey=0,this.playingChannel=0,this.region=null,this.pitchInputTimecents=0,this.pitchOutputFactor=0,this.sourceSamplePosition=0,this.noteGainDb=0,this.panFactorLeft=0,this.panFactorRight=0,this.playIndex=0,this.loopStart=0,this.loopEnd=0,this.ampEnv=new Wt,this.modEnv=new Wt,this.lowPass=new Ut,this.modLfo=new zt,this.vibLfo=new zt,this.mixVolume=0,this.mute=!1}calcPitchRatio(e,t){if(!this.region)return;const s=this.playingKey+this.region.transpose+this.region.tune/100;let i=this.region.pitchKeyCenter+(s-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);0!==e&&(i+=e),this.pitchInputTimecents=100*i,this.pitchOutputFactor=this.region.sampleRate/(Gt.timecents2Secs(100*this.region.pitchKeyCenter)*t)}end(e){this.region&&(this.ampEnv.nextSegment(Q.Sustain,e),this.modEnv.nextSegment(Q.Sustain,e),this.region.loopMode===X.Sustain&&(this.loopEnd=this.loopStart))}endQuick(e){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(Q.Sustain,e),this.modEnv.parameters.release=0,this.modEnv.nextSegment(Q.Sustain,e)}render(e,t,s,i,a){if(!this.region)return;let r=this.region,n=e.fontSamples,o=0,h=e.outputMode===Y.StereoUnweaved?i:-1,l=0!==r.modEnvToPitch||0!==r.modEnvToFilterFc,d=this.modLfo.delta>0&&(0!==r.modLfoToPitch||0!==r.modLfoToFilterFc||0!==r.modLfoToVolume),c=this.vibLfo.delta>0&&0!==r.vibLfoToPitch,u=this.loopStart<this.loopEnd,p=this.loopStart,g=this.loopEnd,f=r.end,m=g+1,y=this.sourceSamplePosition,b=new Ut(this.lowPass),S=0!==r.modLfoToFilterFc||0!==r.modEnvToFilterFc,_=0,w=0,B=0,v=0,T=0!==r.modLfoToPitch||0!==r.modEnvToPitch||0!==r.vibLfoToPitch,k=0,x=0,N=0,P=0,F=0!==r.modLfoToVolume,C=0,L=0;for(S?(_=e.outSampleRate,w=r.initialFilterFc,B=r.modLfoToFilterFc,v=r.modEnvToFilterFc):(_=0,w=0,B=0,v=0),T?(k=0,x=r.modLfoToPitch,N=r.vibLfoToPitch,P=r.modEnvToPitch):(k=Gt.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,x=0,N=0,P=0),F?L=.1*r.modLfoToVolume:(C=Gt.decibelsToGain(this.noteGainDb),L=0);i>0;){let r,M,E=0,D=i>Xt.RenderEffectSampleBLock?Xt.RenderEffectSampleBLock:i;if(i-=D,S){let e=w+this.modLfo.level*B+this.modEnv.level*v;b.active=e<=13500,b.active&&b.setup(Gt.cents2Hertz(e)/_)}switch(T&&(k=Gt.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*x+this.vibLfo.level*N+this.modEnv.level*P))*this.pitchOutputFactor),F&&(C=Gt.decibelsToGain(this.noteGainDb+this.modLfo.level*L)),r=C*this.ampEnv.level,a?r=0:r*=this.mixVolume,this.ampEnv.process(D,e.outSampleRate),l&&this.modEnv.process(D,e.outSampleRate),d&&this.modLfo.process(D),c&&this.vibLfo.process(D),e.outputMode){case Y.StereoInterleaved:for(M=r*this.panFactorLeft,E=r*this.panFactorRight;D-- >0&&y<f;){let e=0|y,i=e>=g&&u?p:e+1,a=y-e,r=n[e]*(1-a)+n[i]*a;b.active&&(r=b.process(r)),t[s+o]+=r*M,o++,t[s+o]+=r*E,o++,y+=k,y>=m&&u&&(y-=g-p+1)}break;case Y.StereoUnweaved:for(M=r*this.panFactorLeft,E=r*this.panFactorRight;D-- >0&&y<f;){let e=0|y,i=e>=g&&u?p:e+1,a=y-e,r=n[e]*(1-a)+n[i]*a;b.active&&(r=b.process(r)),t[s+o]+=r*M,o++,t[s+h]+=r*E,h++,y+=k,y>=m&&u&&(y-=g-p+1)}break;case Y.Mono:for(;D-- >0&&y<f;){let e=0|y,i=e>=g&&u?p:e+1,a=y-e,h=n[e]*(1-a)+n[i]*a;b.active&&(h=b.process(h)),t[s+o]=h*r,o++,y+=k,y>=m&&u&&(y-=g-p+1)}}if(y>=f||this.ampEnv.segment===Q.Done)return void this.kill()}this.sourceSamplePosition=y,(b.active||S)&&(this.lowPass=b)}kill(){this.playingPreset=-1}}Xt.RenderEffectSampleBLock=64;class Yt{}Yt.DefaultChannelCount=17,Yt.MetronomeChannel=Yt.DefaultChannelCount-1,Yt.AudioChannels=2,Yt.MinVolume=0,Yt.MaxVolume=1,Yt.MinProgram=0,Yt.MaxProgram=127,Yt.MinPlaybackSpeed=.125,Yt.MaxPlaybackSpeed=8;class Jt{constructor(e){this._midiEventQueue=[],this._midiEventCounts=new Int32Array(Jt.MicroBufferCount),this._mutedChannels=new Map,this._soloChannels=new Map,this._isAnySolo=!1,this._presets=null,this._voices=[],this._channels=null,this._voicePlayIndex=0,this.fontSamples=new Float32Array(0),this.outputMode=Y.StereoInterleaved,this.outSampleRate=0,this.globalGainDb=0,this.outSampleRate=e}synthesize(){return this.fillWorkingBuffer(!1)}synthesizeSilent(){this.fillWorkingBuffer(!0)}channelGetMixVolume(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].mixVolume:1}channelSetMixVolume(e,t){let s=this.channelInit(e);for(let s of this._voices)s.playingChannel===e&&-1!==s.playingPreset&&(s.mixVolume=t);s.mixVolume=t}channelSetMute(e,t){t?this._mutedChannels.set(e,!0):this._mutedChannels.delete(e)}channelSetSolo(e,t){t?this._soloChannels.set(e,!0):this._soloChannels.delete(e),this._isAnySolo=this._soloChannels.size>0}resetChannelStates(){this._mutedChannels=new Map,this._soloChannels=new Map,this._isAnySolo=!1}dispatchEvent(e,t){this._midiEventQueue.unshift(t),this._midiEventCounts[e]++}fillWorkingBuffer(e){const t=new Float32Array(Jt.MicroBufferSize*Jt.MicroBufferCount*Yt.AudioChannels);let s=0;const i=this._isAnySolo;for(let a=0;a<Jt.MicroBufferCount;a++){if(this._midiEventQueue.length>0)for(let e=0;e<this._midiEventCounts[a];e++){let e=this._midiEventQueue.pop();e&&(e.isMetronome?(this.channelNoteOff(Yt.MetronomeChannel,33),this.channelNoteOn(Yt.MetronomeChannel,33,95/127)):e.event&&this.processMidiMessage(e.event))}for(const a of this._voices)if(-1!==a.playingPreset){const r=a.playingChannel,n=this._mutedChannels.has(r)||i&&!this._soloChannels.has(r);e?a.kill():a.render(this,t,s,64,n)}s+=Jt.MicroBufferSize*Yt.AudioChannels}return this._midiEventCounts.fill(0),t}processMidiMessage(e){we.debug("Midi","Processing midi "+e.command);const t=e.command,s=e.channel,i=e.data1,a=e.data2;switch(t){case z.NoteOff:this.channelNoteOff(s,i);break;case z.NoteOn:this.channelNoteOn(s,i,a/127);break;case z.NoteAftertouch:break;case z.Controller:this.channelMidiControl(s,i,a);break;case z.ProgramChange:this.channelSetPresetNumber(s,i,9===s);break;case z.ChannelAftertouch:break;case z.PitchBend:this.channelSetPitchWheel(s,i|a<<8)}}get metronomeVolume(){return this.channelGetMixVolume(Yt.MetronomeChannel)}set metronomeVolume(e){this.channelSetMixVolume(Yt.MetronomeChannel,e)}setupMetronomeChannel(e){this.channelSetVolume(Yt.MetronomeChannel,1),this.channelSetMixVolume(Yt.MetronomeChannel,e),this.channelSetPresetNumber(Yt.MetronomeChannel,0,!0)}resetSoft(){for(const e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<Q.Release||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);if(this._channels)for(const e of this._channels.channelList)e.presetIndex=e.bank=0,e.pitchWheel=e.midiPan=8192,e.midiVolume=e.midiExpression=16383,e.midiRpn=65535,e.midiData=0,e.panOffset=0,e.gainDb=0,e.pitchRange=2,e.tuning=0}get presetCount(){var e,t;return null!==(t=null===(e=this._presets)||void 0===e?void 0:e.length)&&void 0!==t?t:0}reset(){for(let e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<Q.Release||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);this._channels=null}setOutput(e,t,s){this.outputMode=e,this.outSampleRate=t>=1?t:44100,this.globalGainDb=s}noteOn(e,t,s){if(!this._presets)return;const i=127*s|0;if(e<0||e>=this._presets.length)return;if(s<=0)return void this.noteOff(e,t);const a=this._voicePlayIndex++;for(const r of this._presets[e].regions){if(t<r.loKey||t>r.hiKey||i<r.loVel||i>r.hiVel)continue;let n=null;if(0!==r.group)for(const t of this._voices)t.playingPreset===e&&t.region.group===r.group?t.endQuick(this.outSampleRate):-1!==t.playingPreset||n||(n=t);else for(let e of this._voices)-1===e.playingPreset&&(n=e);if(!n){for(let e=0;e<4;e++){const e=new Xt;e.playingPreset=-1,this._voices.push(e)}n=this._voices[this._voices.length-4]}n.region=r,n.playingPreset=e,n.playingKey=t,n.playIndex=a,n.noteGainDb=this.globalGainDb-r.attenuation-Gt.gainToDecibels(1/s),this._channels?this._channels.setupVoice(this,n):(n.calcPitchRatio(0,this.outSampleRate),n.panFactorLeft=Math.sqrt(.5-r.pan),n.panFactorRight=Math.sqrt(.5+r.pan)),n.sourceSamplePosition=r.offset;const o=r.loopMode!==X.None&&r.loopStart<r.loopEnd;n.loopStart=o?r.loopStart:0,n.loopEnd=o?r.loopEnd:0,n.ampEnv.setup(r.ampEnv,t,i,!0,this.outSampleRate),n.modEnv.setup(r.modEnv,t,i,!1,this.outSampleRate);const h=r.initialFilterQ/10;n.lowPass.qInv=1/Math.pow(10,h/20),n.lowPass.z1=n.lowPass.z2=0,n.lowPass.active=r.initialFilterFc<=13500,n.lowPass.active&&n.lowPass.setup(Gt.cents2Hertz(r.initialFilterFc)/this.outSampleRate),n.modLfo.setup(r.delayModLFO,r.freqModLFO,this.outSampleRate),n.vibLfo.setup(r.delayVibLFO,r.freqVibLFO,this.outSampleRate)}}bankNoteOn(e,t,s,i){let a=this.getPresetIndex(e,t);return-1!==a&&(this.noteOn(a,s,i),!0)}noteOff(e,t){let s=null,i=null,a=[];for(let r of this._voices)r.playingPreset!==e||r.playingKey!==t||r.ampEnv.segment>=Q.Release||(!s||r.playIndex<s.playIndex?(s=r,i=r,a.push(r)):r.playIndex===s.playIndex&&(i=r,a.push(r)));if(s)for(const r of a)r!==s&&r!==i&&(r.playIndex!==s.playIndex||r.playingPreset!==e||r.playingKey!==t||r.ampEnv.segment>=Q.Release)||r.end(this.outSampleRate)}bankNoteOff(e,t,s){const i=this.getPresetIndex(e,t);return-1!==i&&(this.noteOff(i,s),!0)}noteOffAll(e){for(const t of this._voices)-1!==t.playingPreset&&t.ampEnv.segment<Q.Release&&(e?t.endQuick(this.outSampleRate):t.end(this.outSampleRate))}get activeVoiceCount(){let e=0;for(const t of this._voices)-1!==t.playingPreset&&e++;return e}channelInit(e){if(this._channels&&e<this._channels.channelList.length)return this._channels.channelList[e];this._channels||(this._channels=new Ot);for(let t=this._channels.channelList.length;t<=e;t++){let e=new Rt;e.presetIndex=e.bank=0,e.pitchWheel=e.midiPan=8192,e.midiVolume=e.midiExpression=16383,e.midiRpn=65535,e.midiData=0,e.panOffset=0,e.gainDb=0,e.pitchRange=2,e.tuning=0,e.mixVolume=1,this._channels.channelList.push(e)}return this._channels.channelList[e]}getPresetIndex(e,t){if(!this._presets)return-1;for(let s=0;s<this._presets.length;s++){let i=this._presets[s];if(i.presetNumber===t&&i.bank===e)return s}return-1}getPresetName(e){return this._presets?e<0||e>=this._presets.length?null:this._presets[e].name:null}bankGetPresetName(e,t){return this.getPresetName(this.getPresetIndex(e,t))}channelNoteOn(e,t,s){!this._channels||e>this._channels.channelList.length||(this._channels.activeChannel=e,this.noteOn(this._channels.channelList[e].presetIndex,t,s))}channelNoteOff(e,t){const s=[];let i=null,a=null;for(const r of this._voices)-1===r.playingPreset||r.playingChannel!==e||r.playingKey!==t||r.ampEnv.segment>=Q.Release||(!i||r.playIndex<i.playIndex?(i=a=r,s.push(r)):r.playIndex===i.playIndex&&(a=r,s.push(r)));if(i)for(const r of s)r!==i&&r!==a&&(r.playIndex!==i.playIndex||-1===r.playingPreset||r.playingChannel!==e||r.playingKey!==t||r.ampEnv.segment>=Q.Release)||r.end(this.outSampleRate)}channelNoteOffAll(e){for(const t of this._voices)-1!==t.playingPreset&&t.playingChannel===e&&t.ampEnv.segment<Q.Release&&t.end(this.outSampleRate)}channelSoundsOffAll(e){for(let t of this._voices)-1!==t.playingPreset&&t.playingChannel===e&&(t.ampEnv.segment<Q.Release||0===t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate)}channelSetPresetIndex(e,t){this.channelInit(e).presetIndex=He.int32ToUint16(t)}channelSetPresetNumber(e,t,s=!1){const i=this.channelInit(e);let a=0;return s?(a=this.getPresetIndex(128|32767&i.bank,t),-1===a&&(a=this.getPresetIndex(128,t)),-1===a&&(a=this.getPresetIndex(128,0)),-1===a&&(a=this.getPresetIndex(2047&i.bank,t))):a=this.getPresetIndex(2047&i.bank,t),-1===a&&(a=this.getPresetIndex(0,t)),-1!==a&&(i.presetIndex=a,!0)}channelSetBank(e,t){this.channelInit(e).bank=He.int32ToUint16(t)}channelSetBankPreset(e,t,s){const i=this.channelInit(e),a=this.getPresetIndex(t,s);return-1!==a&&(i.presetIndex=He.int32ToUint16(a),i.bank=He.int32ToUint16(t),!0)}channelSetPan(e,t){for(const s of this._voices)if(s.playingChannel===e&&-1!==s.playingPreset){let e=s.region.pan+t-.5;e<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):e>=.5?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-e),s.panFactorRight=Math.sqrt(.5+e))}this.channelInit(e).panOffset=t-.5}channelSetVolume(e,t){const s=this.channelInit(e),i=Gt.gainToDecibels(t),a=i-s.gainDb;if(0!==a){for(const t of this._voices)t.playingChannel===e&&-1!==t.playingPreset&&(t.noteGainDb+=a);s.gainDb=i}}channelSetPitchWheel(e,t){const s=this.channelInit(e);s.pitchWheel!==t&&(s.pitchWheel=He.int32ToUint16(t),this.channelApplyPitch(e,s))}channelApplyPitch(e,t){const s=8192===t.pitchWheel?t.tuning:t.pitchWheel/16383*t.pitchRange*2-t.pitchRange+t.tuning;for(const t of this._voices)t.playingChannel===e&&-1!==t.playingPreset&&t.calcPitchRatio(s,this.outSampleRate)}channelSetPitchRange(e,t){const s=this.channelInit(e);s.pitchRange!==t&&(s.pitchRange=t,8192!==s.pitchWheel&&this.channelApplyPitch(e,s))}channelSetTuning(e,t){const s=this.channelInit(e);s.tuning!==t&&(s.tuning=t,this.channelApplyPitch(e,s))}channelMidiControl(e,t,s){let i=this.channelInit(e);switch(t){case 5:case 96:case 97:case 64:case 65:case 66:case 122:case 124:case 125:case 126:case 127:return;case 38:return i.midiData=He.int32ToUint16(16256&i.midiData|s),void(0===i.midiRpn?this.channelSetPitchRange(e,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(e,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&this.channelSetTuning(e,s-64+(i.tuning-(0|i.tuning))));case 7:return i.midiVolume=He.int32ToUint16(127&i.midiVolume|s<<7),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 39:return i.midiVolume=He.int32ToUint16(16256&i.midiVolume|s),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 11:return i.midiExpression=He.int32ToUint16(127&i.midiExpression|s<<7),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 43:return i.midiExpression=He.int32ToUint16(16256&i.midiExpression|s),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case 10:return i.midiPan=He.int32ToUint16(127&i.midiPan|s<<7),void this.channelSetPan(e,i.midiPan/16383);case 42:return i.midiPan=He.int32ToUint16(16256&i.midiPan|s),void this.channelSetPan(e,i.midiPan/16383);case 6:return i.midiData=He.int32ToUint16(127&i.midiData|s<<7),void(0===i.midiRpn?this.channelSetPitchRange(e,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(e,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&6===t&&this.channelSetTuning(e,s-64+(i.tuning-(0|i.tuning))));case 0:return void(i.bank=He.int32ToUint16(32768|s));case 32:return void(i.bank=He.int32ToUint16((0!=(32768&i.bank)?(127&i.bank)<<7:0)|s));case 101:return void(i.midiRpn=He.int32ToUint16(127&(65535===i.midiRpn?0:i.midiRpn)|s<<7));case 100:return void(i.midiRpn=He.int32ToUint16(16256&(65535===i.midiRpn?0:i.midiRpn)|s));case 98:case 99:return void(i.midiRpn=65535);case 120:return void this.channelSoundsOffAll(e);case 123:return void this.channelNoteOffAll(e);case 121:return i.midiVolume=i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(e,1),this.channelSetPan(e,.5),void this.channelSetPitchRange(e,2)}}channelGetPresetIndex(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].presetIndex:0}channelGetPresetBank(e){return this._channels&&e<this._channels.channelList.length?32767&this._channels.channelList[e].bank:0}channelGetPan(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].panOffset-.5:.5}channelGetVolume(e){return this._channels&&e<this._channels.channelList.length?Gt.decibelsToGain(this._channels.channelList[e].gainDb):1}channelGetPitchWheel(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchWheel:8192}channelGetPitchRange(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchRange:2}channelGetTuning(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].tuning:0}loadPresets(e){this._presets=new Array(e.phdrs.length-1),this.fontSamples=e.fontSamples;for(let t=0;t<e.phdrs.length-1;t++){let s=0;const i=e.phdrs[t];for(let a=0;a<e.phdrs.length;a++){let r=e.phdrs[a];if(!(a===t||r.bank>i.bank))if(r.bank<i.bank)s++;else{if(r.preset>i.preset)continue;(r.preset<i.preset||a<t)&&s++}}let a=0;const r=this._presets[s]=new At;r.name=i.presetName,r.bank=i.bank,r.presetNumber=i.preset;let n=0;for(let s=i.presetBagNdx;s<e.phdrs[t+1].presetBagNdx;s++){let t=0,i=127,a=0,r=127;for(let o=e.pbags[s].genNdx;o<e.pbags[s+1].genNdx;o++){let s=e.pgens[o];if(s.genOper!==Lt.GenKeyRange)if(s.genOper!==Lt.GenVelRange){if(s.genOper===Lt.GenInstrument&&!(s.genAmount.wordAmount>=e.insts.length))for(let o=e.insts[s.genAmount.wordAmount].instBagNdx;o<e.insts[s.genAmount.wordAmount+1].instBagNdx;o++){let s=0,h=127,l=0,d=127;for(let c=e.ibags[o].instGenNdx;c<e.ibags[o+1].instGenNdx;c++){let o=e.igens[c];o.genOper!==Lt.GenKeyRange?o.genOper!==Lt.GenVelRange?53===o.genOper&&h>=t&&s<=i&&d>=a&&l<=r&&n++:(l=o.genAmount.lowByteAmount,d=o.genAmount.highByteAmount):(s=o.genAmount.lowByteAmount,h=o.genAmount.highByteAmount)}}}else a=s.genAmount.lowByteAmount,r=s.genAmount.highByteAmount;else t=s.genAmount.lowByteAmount,i=s.genAmount.highByteAmount}}r.regions=new Array(n);let o=new Ht;o.clear(!0);for(let s=i.presetBagNdx;s<e.phdrs[t+1].presetBagNdx;s++){const t=e.pbags[s],n=new Ht(o);let h=!1;for(let i=t.genNdx;i<e.pbags[s+1].genNdx;i++){const t=e.pgens[i];if(t.genOper===Lt.GenInstrument){let s=t.genAmount.wordAmount;if(s>=e.insts.length)continue;let i=new Ht;i.clear(!1);let o=e.insts[s];for(let t=o.instBagNdx;t<e.insts[s+1].instBagNdx;t++){let s=e.ibags[t],h=new Ht(i),l=!1;for(let i=s.instGenNdx;i<e.ibags[t+1].instGenNdx;i++){let t=e.igens[i];if(t.genOper===Lt.GenSampleId){if(h.hiKey<n.loKey||h.loKey>n.hiKey)continue;if(h.hiVel<n.loVel||h.loVel>n.hiVel)continue;n.loKey>h.loKey&&(h.loKey=n.loKey),n.hiKey<h.hiKey&&(h.hiKey=n.hiKey),n.loVel>h.loVel&&(h.loVel=n.loVel),n.hiVel<h.hiVel&&(h.hiVel=n.hiVel),h.offset+=n.offset,h.end+=n.end,h.loopStart+=n.loopStart,h.loopEnd+=n.loopEnd,h.transpose+=n.transpose,h.tune+=n.tune,h.pitchKeyTrack+=n.pitchKeyTrack,h.attenuation+=n.attenuation,h.pan+=n.pan,h.ampEnv.delay+=n.ampEnv.delay,h.ampEnv.attack+=n.ampEnv.attack,h.ampEnv.hold+=n.ampEnv.hold,h.ampEnv.decay+=n.ampEnv.decay,h.ampEnv.sustain+=n.ampEnv.sustain,h.ampEnv.release+=n.ampEnv.release,h.modEnv.delay+=n.modEnv.delay,h.modEnv.attack+=n.modEnv.attack,h.modEnv.hold+=n.modEnv.hold,h.modEnv.decay+=n.modEnv.decay,h.modEnv.sustain+=n.modEnv.sustain,h.modEnv.release+=n.modEnv.release,h.initialFilterQ+=n.initialFilterQ,h.initialFilterFc+=n.initialFilterFc,h.modEnvToPitch+=n.modEnvToPitch,h.modEnvToFilterFc+=n.modEnvToFilterFc,h.delayModLFO+=n.delayModLFO,h.freqModLFO+=n.freqModLFO,h.modLfoToPitch+=n.modLfoToPitch,h.modLfoToFilterFc+=n.modLfoToFilterFc,h.modLfoToVolume+=n.modLfoToVolume,h.delayVibLFO+=n.delayVibLFO,h.freqVibLFO+=n.freqVibLFO,h.vibLfoToPitch+=n.vibLfoToPitch,h.ampEnv.envToSecs(!0),h.modEnv.envToSecs(!1),h.delayModLFO=h.delayModLFO<-11950?0:Gt.timecents2Secs(h.delayModLFO),h.delayVibLFO=h.delayVibLFO<-11950?0:Gt.timecents2Secs(h.delayVibLFO),h.pan<-.5?h.pan=-.5:h.pan>.5&&(h.pan=.5),(h.initialFilterQ<1500||h.initialFilterQ>13500)&&(h.initialFilterQ=0);let s=e.sHdrs[t.genAmount.wordAmount];h.offset+=s.start,h.end+=s.end,h.loopStart+=s.startLoop,h.loopEnd+=s.endLoop,s.endLoop>0&&(h.loopEnd-=1),-1===h.pitchKeyCenter&&(h.pitchKeyCenter=s.originalPitch),h.tune+=s.pitchCorrection,h.sampleRate=s.sampleRate,0!==h.end&&h.end<this.fontSamples.length?h.end++:h.end=this.fontSamples.length,r.regions[a]=new Ht(h),a++,l=!0}else h.operator(t.genOper,t.genAmount)}s!==e.ibags[o.instBagNdx]||l||(i=new Ht(h))}h=!0}else n.operator(t.genOper,t.genAmount)}t!==e.pbags[i.presetBagNdx]||h||(o=n)}}}}Jt.MicroBufferCount=32,Jt.MicroBufferSize=64;class Qt{constructor(){this._listeners=[]}on(e){this._listeners.push(e)}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(){for(const e of this._listeners)e()}}class qt{constructor(){this._listeners=[]}on(e){this._listeners.push(e)}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(e){for(const t of this._listeners)t(e)}}class jt{constructor(e,t,s){this.bpm=e,this.ticks=t,this.time=s}}class Kt{constructor(e){this._tempoChanges=[],this._firstProgramEventPerChannel=new Map,this._synthData=[],this._division=0,this._eventIndex=0,this._currentTime=0,this._playbackRange=null,this._playbackRangeStartTime=0,this._playbackRangeEndTime=0,this._endTime=0,this.isLooping=!1,this.endTick=0,this.playbackSpeed=1,this.finished=new Qt,this._synthesizer=e}get playbackRange(){return this._playbackRange}set playbackRange(e){this._playbackRange=e,e&&(this._playbackRangeStartTime=this.tickPositionToTimePositionWithSpeed(e.startTick,1),this._playbackRangeEndTime=this.tickPositionToTimePositionWithSpeed(e.endTick,1))}get endTime(){return this._endTime/this.playbackSpeed}seek(e){if(e*=this.playbackSpeed,this.playbackRange&&(e<this._playbackRangeStartTime?e=this._playbackRangeStartTime:e>this._playbackRangeEndTime&&(e=this._playbackRangeEndTime)),(e-=25)<0&&(e=0),e>this._currentTime)this.silentProcess(e-this._currentTime);else if(e<this._currentTime){this._currentTime=0,this._eventIndex=0;let t=this._synthesizer.metronomeVolume;this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(t),this.silentProcess(e)}}silentProcess(e){if(e<=0)return;let t=Date.now(),s=this._currentTime+e;for(;this._currentTime<s;)this.fillMidiEventQueueLimited(s-this._currentTime)&&this._synthesizer.synthesizeSilent();let i=Date.now()-t;we.debug("Sequencer","Silent seek finished in "+i+"ms")}loadMidi(e){this._tempoChanges=[],this._division=e.division,this._eventIndex=0,this._currentTime=0,this._synthData=[];let t=120,s=0,i=0,a=0,r=0,n=0,o=0;for(let h of e.events){let l=new vt(this._synthData.length,h);this._synthData.push(l);let d=h.tick-o;if(s+=d,i+=d*(6e4/(t*e.division)),l.time=i,o=h.tick,h.command===z.Meta&&h.data1===U.Tempo){t=6e7/h.value,this._tempoChanges.push(new jt(t,s,i))}else if(h.command===z.Meta&&h.data1===U.TimeSignature){let e=h,t=Math.pow(2,e.data[1]);a=this._division*(4/t)|0}else if(h.command===z.ProgramChange){let e=h.channel;this._firstProgramEventPerChannel.has(e)||this._firstProgramEventPerChannel.set(e,l)}if(a>0)for(;r<s;){let s=vt.newMetronomeEvent(this._synthData.length);this._synthData.push(s),s.time=n,r+=a,n+=a*(6e4/(t*e.division))}}this._synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),this._endTime=i,this.endTick=s}fillMidiEventQueue(){return this.fillMidiEventQueueLimited(-1)}fillMidiEventQueueLimited(e){let t=Jt.MicroBufferSize/this._synthesizer.outSampleRate*1e3*this.playbackSpeed;e>0&&e<t&&(t=e);let s=!1,i=this.internalEndTime;for(let e=0;e<Jt.MicroBufferCount;e++)for(this._currentTime+=t;this._eventIndex<this._synthData.length&&this._synthData[this._eventIndex].time<this._currentTime&&this._currentTime<i;)this._synthesizer.dispatchEvent(e,this._synthData[this._eventIndex]),this._eventIndex++,s=!0;return s}tickPositionToTimePosition(e){return this.tickPositionToTimePositionWithSpeed(e,this.playbackSpeed)}timePositionToTickPosition(e){return this.timePositionToTickPositionWithSpeed(e,this.playbackSpeed)}tickPositionToTimePositionWithSpeed(e,t){let s=0,i=120,a=0;for(const t of this._tempoChanges){if(e<t.ticks)break;s=t.time,i=t.bpm,a=t.ticks}return s+=(e-=a)*(6e4/(i*this._division)),s/t}timePositionToTickPositionWithSpeed(e,t){e*=t;let s=0,i=120,a=0;for(const t of this._tempoChanges){if(e<t.time)break;s=t.ticks,i=t.bpm,a=t.time}return s+=(e-=a)/(6e4/(i*this._division))|0,s+1}get internalEndTime(){return this.playbackRange?this._playbackRangeEndTime:this._endTime}checkForStop(){if(this._currentTime>=this.internalEndTime){let e=this._synthesizer.metronomeVolume;this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(e),this.finished.trigger()}}stop(){this.playbackRange?this.playbackRange&&(this._currentTime=this.playbackRange.startTick,this._eventIndex=0):(this._currentTime=0,this._eventIndex=0)}setChannelProgram(e,t){this._firstProgramEventPerChannel.has(e)&&(this._firstProgramEventPerChannel.get(e).event.data1=t)}}!function(e){e[e.Paused=0]="Paused",e[e.Playing=1]="Playing"}(q||(q={}));class $t{constructor(e,t){this.state=e,this.stopped=t}}class Zt{constructor(e,t,s,i){this.currentTime=e,this.endTime=t,this.currentTick=s,this.endTick=i}}class es{constructor(e){this._isSoundFontLoaded=!1,this._isMidiLoaded=!1,this._tickPosition=0,this._timePosition=0,this._metronomeVolume=0,this.isReady=!1,this.state=q.Paused,this.ready=new Qt,this.readyForPlayback=new Qt,this.finished=new Qt,this.soundFontLoaded=new Qt,this.soundFontLoadFailed=new qt,this.midiLoaded=new Qt,this.midiLoadFailed=new qt,this.stateChanged=new qt,this.positionChanged=new qt,we.debug("AlphaSynth","Initializing player"),this.state=q.Paused,we.debug("AlphaSynth","Creating output"),this.output=e,this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this.checkReadyForPlayback()}),this.output.finished.on(()=>{this.stop(),we.debug("AlphaSynth","Finished playback"),this.finished.trigger(),this._sequencer.isLooping&&this.play()}),this.output.sampleRequest.on(()=>{this._sequencer.fillMidiEventQueue();let e=this._synthesizer.synthesize();this.output.addSamples(e),this._sequencer.checkForStop()}),this.output.samplesPlayed.on(this.onSamplesPlayed.bind(this)),we.debug("AlphaSynth","Creating synthesizer"),this._synthesizer=new Jt(this.output.sampleRate),this._sequencer=new Kt(this._synthesizer),this._sequencer.finished.on(this.output.sequencerFinished.bind(this.output)),we.debug("AlphaSynth","Opening output"),this.output.open()}get isReadyForPlayback(){return this.isReady&&this._isSoundFontLoaded&&this._isMidiLoaded}get logLevel(){return we.logLevel}set logLevel(e){we.logLevel=e}get masterVolume(){return this._synthesizer.globalGainDb}set masterVolume(e){e=Gt.clamp(e,Yt.MinVolume,Yt.MaxVolume),this._synthesizer.globalGainDb=e}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Gt.clamp(e,Yt.MinVolume,Yt.MaxVolume),this._metronomeVolume=e,this._synthesizer.metronomeVolume=e}get playbackSpeed(){return this._sequencer.playbackSpeed}set playbackSpeed(e){e=Gt.clamp(e,Yt.MinPlaybackSpeed,Yt.MaxPlaybackSpeed);let t=this._sequencer.playbackSpeed;this._sequencer.playbackSpeed=e,this.updateTimePosition(this._timePosition*(t/e))}get tickPosition(){return this._tickPosition}set tickPosition(e){this.timePosition=this._sequencer.tickPositionToTimePosition(e)}get timePosition(){return this._timePosition}set timePosition(e){we.debug("AlphaSynth",`Seeking to position ${e}ms`),this._sequencer.seek(e),this.updateTimePosition(e),this.output.resetSamples()}get playbackRange(){return this._sequencer.playbackRange}set playbackRange(e){this._sequencer.playbackRange=e,e&&(this.tickPosition=e.startTick)}get isLooping(){return this._sequencer.isLooping}set isLooping(e){this._sequencer.isLooping=e}destroy(){we.debug("AlphaSynth","Destroying player"),this.stop()}play(){return!(this.state===q.Playing||!this.isReadyForPlayback)&&(this.output.activate(),this._synthesizer.setupMetronomeChannel(this.metronomeVolume),we.debug("AlphaSynth","Starting playback"),this.state=q.Playing,this.stateChanged.trigger(new $t(this.state,!1)),this.output.play(),!0)}pause(){this.state!==q.Paused&&this.isReadyForPlayback&&(we.debug("AlphaSynth","Pausing playback"),this.state=q.Paused,this.stateChanged.trigger(new $t(this.state,!1)),this.output.pause(),this._synthesizer.noteOffAll(!1))}playPause(){this.state!==q.Playing&&this.isReadyForPlayback?this.play():this.pause()}stop(){this.isReadyForPlayback&&(we.debug("AlphaSynth","Stopping playback"),this.state=q.Paused,this.output.pause(),this._sequencer.stop(),this._synthesizer.noteOffAll(!0),this.tickPosition=this._sequencer.playbackRange?this._sequencer.playbackRange.startTick:0,this.stateChanged.trigger(new $t(this.state,!0)))}loadSoundFont(e){this.pause();let t=Ye.fromBuffer(e);try{we.info("AlphaSynth","Loading soundfont from bytes");let e=new kt;e.load(t),this._synthesizer.loadPresets(e),this._isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),we.info("AlphaSynth","soundFont successfully loaded"),this.checkReadyForPlayback()}catch(e){we.error("AlphaSynth","Could not load soundfont from bytes "+e),this.soundFontLoadFailed.trigger(e)}}checkReadyForPlayback(){this.isReadyForPlayback&&(this._synthesizer.setupMetronomeChannel(this.metronomeVolume),this.readyForPlayback.trigger())}loadMidiFile(e){this.stop();try{we.info("AlphaSynth","Loading midi from model"),this._sequencer.loadMidi(e),this._isMidiLoaded=!0,this.midiLoaded.trigger(),we.info("AlphaSynth","Midi successfully loaded"),this.checkReadyForPlayback(),this.tickPosition=0}catch(e){we.error("AlphaSynth","Could not load midi from model "+e),this.midiLoadFailed.trigger(e)}}setChannelMute(e,t){this._synthesizer.channelSetMute(e,t)}resetChannelStates(){this._synthesizer.resetChannelStates()}setChannelSolo(e,t){this._synthesizer.channelSetSolo(e,t)}setChannelVolume(e,t){t=Gt.clamp(t,Yt.MinVolume,Yt.MaxVolume),this._synthesizer.channelSetMixVolume(e,t)}setChannelProgram(e,t){t=Gt.clamp(t,Yt.MinProgram,Yt.MaxProgram),this._sequencer.setChannelProgram(e,t),this._synthesizer.channelSetPresetNumber(e,t,!1)}onSamplesPlayed(e){let t=e/this._synthesizer.outSampleRate*1e3;this.updateTimePosition(this._timePosition+t)}updateTimePosition(e){const t=this._timePosition=e,s=this._tickPosition=this._sequencer.timePositionToTickPosition(t),i=this._sequencer.endTime,a=this._sequencer.endTick;we.debug("AlphaSynth",`Position changed: (time: ${t}/${i}, tick: ${s}/${i}, Active Voices: ${this._synthesizer.activeVoiceCount}`),this.positionChanged.trigger(new Zt(t,i,s,a))}}class ts{constructor(){this.division=me.QuarterTime,this.events=[]}addEvent(e){if(0===this.events.length)this.events.push(e);else{let t=this.events.length;for(;t>0;){if(!(this.events[t-1].tick>e.tick))break;t--}this.events.splice(t,0,e)}}toBinary(){let e=Ye.empty();return this.writeTo(e),e.toArray()}writeTo(e){let t=new Uint8Array([77,84,104,100]);e.write(t,0,t.length),t=new Uint8Array([0,0,0,6]),e.write(t,0,t.length),t=new Uint8Array([0,0]),e.write(t,0,t.length);let s=1;t=new Uint8Array([s>>8&255,255&s]),e.write(t,0,t.length),s=this.division,t=new Uint8Array([s>>8&255,255&s]),e.write(t,0,t.length);let i=Ye.empty(),a=0;for(let e of this.events){let t=e.tick-a;ts.writeVariableInt(i,t),e.writeTo(i),a=e.tick}t=new Uint8Array([77,84,114,107]),e.write(t,0,t.length);let r=i.toArray(),n=r.length;t=new Uint8Array([n>>24&255,n>>16&255,n>>8&255,255&n]),e.write(t,0,t.length),e.write(r,0,r.length)}static writeVariableInt(e,t){let s=new Uint8Array(4),i=0;do{s[i++]=127&t,t>>=7}while(t>0);for(;i>0;)i--,i>0?e.writeByte(128|s[i]):e.writeByte(s[i])}}class ss extends Bt{constructor(e,t,s,i){super(e,t,s,0),this.data=i}writeTo(e){e.writeByte(255),e.writeByte(this.metaStatus);let t=this.data.length;ts.writeVariableInt(e,t),e.write(this.data,0,this.data.length)}}class is extends Bt{constructor(e,t,s,i){super(e,t,s,0),this.value=i}writeTo(e){e.writeByte(255),e.writeByte(this.metaStatus),ts.writeVariableInt(e,3);let t=new Uint8Array([this.value>>16&255,this.value>>8&255,255&this.value]);e.write(t,0,t.length)}}!function(e){e[e.SystemExclusive=240]="SystemExclusive",e[e.MtcQuarterFrame=241]="MtcQuarterFrame",e[e.SongPosition=242]="SongPosition",e[e.SongSelect=243]="SongSelect",e[e.TuneRequest=246]="TuneRequest",e[e.SystemExclusive2=247]="SystemExclusive2"}(j||(j={}));class as extends wt{get channel(){return-1}get command(){return 255&this.message}constructor(e,t,s,i){super(e,t,s,i)}}class rs extends as{constructor(e,t,s,i){super(e,t,255&s,s>>8&255),this.data=i}get manufacturerId(){return this.message>>8}writeTo(e){e.writeByte(240);let t=this.data.length+2;e.writeByte(this.manufacturerId);let s=new Uint8Array([t>>24&255,t>>16&255,t>>8&255,255&t]);e.write(s,0,s.length),e.writeByte(247)}}class ns{constructor(){this.encoding="utf-8",this.mergePartGroupsInMusicXml=!1}static toJson(e){var t={};return e.fillToJson(t),t}fillToJson(e){e.encoding=this.encoding,e.mergePartGroupsInMusicXml=this.mergePartGroupsInMusicXml}static fromJson(e){if(!e)return null;var t=new ns;return t.fillFromJson(e),t}fillFromJson(e){if(e)for(const t in e)this.setProperty(t.toLowerCase(),e[t])}setProperty(e,t){switch(e){case"encoding":return this.encoding=t,!0;case"mergepartgroupsinmusicxml":return this.mergePartGroupsInMusicXml=t,!0}return!1}}(K=e.ScrollMode||(e.ScrollMode={}))[K.Off=0]="Off",K[K.Continuous=1]="Continuous",K[K.OffScreen=2]="OffScreen";class os{constructor(){this.noteWideLength=480,this.noteWideAmplitude=2,this.noteSlightLength=480,this.noteSlightAmplitude=2,this.beatWideLength=240,this.beatWideAmplitude=3,this.beatSlightLength=240,this.beatSlightAmplitude=3}static toJson(e){var t={};return e.fillToJson(t),t}fillToJson(e){e.noteWideLength=this.noteWideLength,e.noteWideAmplitude=this.noteWideAmplitude,e.noteSlightLength=this.noteSlightLength,e.noteSlightAmplitude=this.noteSlightAmplitude,e.beatWideLength=this.beatWideLength,e.beatWideAmplitude=this.beatWideAmplitude,e.beatSlightLength=this.beatSlightLength,e.beatSlightAmplitude=this.beatSlightAmplitude}static fromJson(e){if(!e)return null;var t=new os;return t.fillFromJson(e),t}fillFromJson(e){if(e)for(const t in e)this.setProperty(t.toLowerCase(),e[t])}setProperty(e,t){switch(e){case"notewidelength":return this.noteWideLength=t,!0;case"notewideamplitude":return this.noteWideAmplitude=t,!0;case"noteslightlength":return this.noteSlightLength=t,!0;case"noteslightamplitude":return this.noteSlightAmplitude=t,!0;case"beatwidelength":return this.beatWideLength=t,!0;case"beatwideamplitude":return this.beatWideAmplitude=t,!0;case"beatslightlength":return this.beatSlightLength=t,!0;case"beatslightamplitude":return this.beatSlightAmplitude=t,!0}return!1}}class hs{constructor(){this.soundFont=null,this.scrollElement="html,body",this.enablePlayer=!1,this.enableCursor=!0,this.enableUserInteraction=!0,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollMode=e.ScrollMode.Continuous,this.scrollSpeed=300,this.songBookBendDuration=75,this.songBookDipDuration=150,this.vibrato=new os,this.playTripletFeel=!0}static toJson(e){var t={};return e.fillToJson(t),t}fillToJson(e){e.soundFont=this.soundFont,e.scrollElement=this.scrollElement,e.enablePlayer=this.enablePlayer,e.enableCursor=this.enableCursor,e.enableUserInteraction=this.enableUserInteraction,e.scrollOffsetX=this.scrollOffsetX,e.scrollOffsetY=this.scrollOffsetY,e.scrollMode=this.scrollMode,e.scrollSpeed=this.scrollSpeed,e.songBookBendDuration=this.songBookBendDuration,e.songBookDipDuration=this.songBookDipDuration,e.vibrato?this.vibrato.fillToJson(e.vibrato):e.vibrato=os.toJson(this.vibrato),e.playTripletFeel=this.playTripletFeel}static fromJson(e){if(!e)return null;var t=new hs;return t.fillFromJson(e),t}fillFromJson(e){if(e)for(const t in e)this.setProperty(t.toLowerCase(),e[t])}setProperty(t,s){switch(t){case"soundfont":return this.soundFont=s,!0;case"scrollelement":return this.scrollElement=s,!0;case"enableplayer":return this.enablePlayer=s,!0;case"enablecursor":return this.enableCursor=s,!0;case"enableuserinteraction":return this.enableUserInteraction=s,!0;case"scrolloffsetx":return this.scrollOffsetX=s,!0;case"scrolloffsety":return this.scrollOffsetY=s,!0;case"scrollmode":return this.scrollMode="string"==typeof s?e.ScrollMode[Object.keys(e.ScrollMode).find(e=>e.toLowerCase()===s.toLowerCase())]:s,!0;case"scrollspeed":return this.scrollSpeed=s,!0;case"songbookbendduration":return this.songBookBendDuration=s,!0;case"songbookdipduration":return this.songBookDipDuration=s,!0;case"playtripletfeel":return this.playTripletFeel=s,!0}if(["vibrato"].indexOf(t)>=0)return this.vibrato?this.vibrato.fillFromJson(s):this.vibrato=os.fromJson(s),!0;for(const e of["vibrato"])if(0===t.indexOf(e)&&(this.vibrato||(this.vibrato=new os),this.vibrato.setProperty(t.substring(e.length),s)))return!0;return!1}}class ls{constructor(){this.core=new Dr,this.display=new de,this.notation=new be,this.importer=new ns,this.player=new hs}fillFromDataAttributes(e){for(let t of e)this.setProperty(t[0].toLowerCase(),t[1])}setSongBookModeSettings(){this.notation.notationMode=e.NotationMode.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=e.FingeringMode.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.showParenthesisForTiedBends=!1,this.notation.showTabNoteOnTiedBend=!1,this.notation.showZeroOnDiveWhammy=!0}static get songBook(){let e=new ls;return e.setSongBookModeSettings(),e}static toJson(e){var t={};return e.fillToJson(t),t}fillToJson(e){e.core?this.core.fillToJson(e.core):e.core=Dr.toJson(this.core),e.display?this.display.fillToJson(e.display):e.display=de.toJson(this.display),e.notation?this.notation.fillToJson(e.notation):e.notation=be.toJson(this.notation),e.importer?this.importer.fillToJson(e.importer):e.importer=ns.toJson(this.importer),e.player?this.player.fillToJson(e.player):e.player=hs.toJson(this.player)}static fromJson(e){if(!e)return null;var t=new ls;return t.fillFromJson(e),t}fillFromJson(e){if(e)for(const t in e)this.setProperty(t.toLowerCase(),e[t])}setProperty(e,t){if(["core",""].indexOf(e)>=0)return this.core?this.core.fillFromJson(t):this.core=Dr.fromJson(t),!0;for(const s of["core",""])if(0===e.indexOf(s)&&(this.core||(this.core=new Dr),this.core.setProperty(e.substring(s.length),t)))return!0;if(["display",""].indexOf(e)>=0)return this.display?this.display.fillFromJson(t):this.display=de.fromJson(t),!0;for(const s of["display",""])if(0===e.indexOf(s)&&(this.display||(this.display=new de),this.display.setProperty(e.substring(s.length),t)))return!0;if(["notation"].indexOf(e)>=0)return this.notation?this.notation.fillFromJson(t):this.notation=be.fromJson(t),!0;for(const s of["notation"])if(0===e.indexOf(s)&&(this.notation||(this.notation=new be),this.notation.setProperty(e.substring(s.length),t)))return!0;if(["importer"].indexOf(e)>=0)return this.importer?this.importer.fillFromJson(t):this.importer=ns.fromJson(t),!0;for(const s of["importer"])if(0===e.indexOf(s)&&(this.importer||(this.importer=new ns),this.importer.setProperty(e.substring(s.length),t)))return!0;if(["player"].indexOf(e)>=0)return this.player?this.player.fillFromJson(t):this.player=hs.fromJson(t),!0;for(const s of["player"])if(0===e.indexOf(s)&&(this.player||(this.player=new hs),this.player.setProperty(e.substring(s.length),t)))return!0;return!1}}class ds{static scoreToJson(e){let t=ds.scoreToJsObject(e);return JSON.stringify(t,(e,t)=>ArrayBuffer.isView(t)?Array.apply([],[t]):t)}static scoreToJsObject(e){let t={};return Ce.copyTo(e,t),t.masterBars=[],t.tracks=[],t.stylesheet={},Pe.copyTo(e.stylesheet,t.stylesheet),ds.masterBarsToJsObject(e,t),ds.tracksToJsObject(e,t),t}static tracksToJsObject(e,t){for(let s=0;s<e.tracks.length;s++){let i=e.tracks[s],a={color:{}};De.copyTo(i,a),a.playbackInfo={},Me.copyTo(i.playbackInfo,a.playbackInfo),ds.stavesToJsObject(i,a),t.tracks.push(a)}}static stavesToJsObject(e,t){t.staves=[];for(let s=0;s<e.staves.length;s++){let i=e.staves[s],a={};Ee.copyTo(i,a),a.chords=new Map;for(let e of i.chords){let t=e[1],s={};ke.copyTo(t,s),a.chords.set(e[0],s)}ds.barsToJsObject(i,a),t.staves.push(a)}}static barsToJsObject(e,t){t.bars=[];for(let s=0;s<e.bars.length;s++){let i=e.bars[s],a={};fe.copyTo(i,a),ds.voicesToJsObject(i,a),t.bars.push(a)}}static voicesToJsObject(e,t){t.voices=[];for(let s=0;s<e.voices.length;s++){let i=e.voices[s],a={};Re.copyTo(i,a),ds.beatsToJsObject(i,a),t.voices.push(a)}}static beatsToJsObject(e,t){t.beats=[];for(let s=0;s<e.beats.length;s++){let i=e.beats[s],a={};Te.copyTo(i,a),a.automations=[];for(let e=0;e<i.automations.length;e++){let t={};ge.copyTo(i.automations[e],t),a.automations.push(t)}a.whammyBarPoints=[];for(let e=0;e<i.whammyBarPoints.length;e++){let t={};ye.copyTo(i.whammyBarPoints[e],t),a.whammyBarPoints.push(t)}ds.notesToJsObject(i,a),t.beats.push(a)}}static notesToJsObject(e,t){t.notes=[];for(let s=0;s<e.notes.length;s++){let i=e.notes[s],a={},r=a;Be.copyTo(i,r),i.isTieDestination&&(a.tieOriginId=i.tieOrigin.id),i.isTieOrigin&&(a.tieDestinationId=i.tieDestination.id),i.isSlurDestination&&(a.slurOriginId=i.slurOrigin.id),i.isSlurOrigin&&(a.slurDestinationId=i.slurDestination.id),i.isHammerPullDestination&&(a.hammerPullOriginId=i.hammerPullOrigin.id),i.isHammerPullOrigin&&(a.hammerPullDestinationId=i.hammerPullDestination.id),r.bendPoints=[];for(let e=0;e<i.bendPoints.length;e++){let t={};ye.copyTo(i.bendPoints[e],t),r.bendPoints.push(t)}t.notes.push(r)}}static masterBarsToJsObject(e,t){for(let s=0;s<e.masterBars.length;s++){let i=e.masterBars[s],a={};Ne.copyTo(i,a),i.tempoAutomation&&(a.tempoAutomation={},ge.copyTo(i.tempoAutomation,a.tempoAutomation)),i.section&&(a.section={},Le.copyTo(i.section,a.section)),a.fermata={};for(let e of i.fermata){let t=e[1],s={};a.fermata.set(e[0],s),qe.copyTo(t,s)}t.masterBars.push(a)}}static jsonToScore(e,t){return ds.jsObjectToScore(ds.jsObjectToScore(JSON.parse(e),t),t)}static jsObjectToScore(e,t){let s=e,i=new Ce;Ce.copyTo(s,i),Pe.copyTo(s.stylesheet,i.stylesheet);let a=new Map,r=[];ds.jsObjectToMasterBars(s,i),ds.jsObjectToTracks(s,i,a,r);for(let e of r){let t=e;void 0!==t.tieOriginId&&(e.tieOrigin=a.get(t.tieOriginId)),void 0!==t.tieDestinationId&&(e.tieDestination=a.get(t.tieDestinationId)),void 0!==t.slurOriginId&&(e.slurOrigin=a.get(t.slurOriginId)),void 0!==t.slurDestinationId&&(e.slurDestination=a.get(t.slurDestinationId)),void 0!==t.hammerPullOriginId&&(e.hammerPullOrigin=a.get(t.hammerPullOriginId)),void 0!==t.hammerPullDestinationId&&(e.hammerPullDestination=a.get(t.hammerPullDestinationId))}return i.finish(null!=t?t:new ls),i}static jsObjectToTracks(e,t,s,i){for(let a=0;a<e.tracks.length;a++){let r=e.tracks[a],n=new De;n.ensureStaveCount(r.staves.length),De.copyTo(r,n),t.addTrack(n),Me.copyTo(r.playbackInfo,n.playbackInfo),ds.jsObjectToStaves(r,n,s,i)}}static jsObjectToStaves(e,t,s,i){for(let a=0;a<e.staves.length;a++){let r=e.staves[a],n=t.staves[a];Ee.copyTo(r,n);for(let e of r.chords){let t=e[1],s=new ke;ke.copyTo(t,s),n.addChord(e[0],s)}ds.jsObjectToBars(r,n,s,i)}}static jsObjectToBars(e,t,s,i){for(let a=0;a<e.bars.length;a++){let r=e.bars[a],n=new fe;fe.copyTo(r,n),t.addBar(n),ds.jsObjectToVoices(r,n,s,i)}}static jsObjectToVoices(e,t,s,i){for(let a=0;a<e.voices.length;a++){let r=e.voices[a],n=new Re;Re.copyTo(r,n),t.addVoice(n),ds.jsObjectToBeats(r,n,s,i)}}static jsObjectToBeats(e,t,s,i){for(let a=0;a<e.beats.length;a++){let r=e.beats[a],n=new Te;Te.copyTo(r,n),t.addBeat(n);for(let e=0;e<r.automations.length;e++){let t=new ge;ge.copyTo(r.automations[e],t),n.automations.push(t)}for(let e=0;e<r.whammyBarPoints.length;e++){let t=new ye(0,0);ye.copyTo(r.whammyBarPoints[e],t),n.addWhammyBarPoint(t)}ds.jsObjectToNotes(r,n,s,i)}}static jsObjectToNotes(e,t,s,i){for(let a=0;a<e.notes.length;a++){let r=e.notes[a],n=new Be;Be.copyTo(r,n),t.addNote(n),s.set(n.id,n);let o=r,h=n;void 0!==o.tieOriginId&&(h.tieOriginId=o.tieOriginId,i.push(n)),void 0!==o.tieDestinationId&&(h.tieDestinationId=o.tieDestinationId,i.push(n)),void 0!==o.slurOriginId&&(h.slurOriginId=o.slurOriginId,i.push(n)),void 0!==o.slurDestinationId&&(h.slurDestinationId=o.slurDestinationId,i.push(n)),void 0!==o.hammerPullOriginId&&(h.hammerPullOriginId=o.hammerPullOriginId,i.push(n)),void 0!==o.hammerPullDestinationId&&(h.hammerPullDestinationId=o.hammerPullDestinationId,i.push(n));for(let e=0;e<r.bendPoints.length;e++){let t=new ye(0,0);ye.copyTo(r.bendPoints[e],t),n.addBendPoint(t)}}}static jsObjectToMasterBars(e,t){for(let s=0;s<e.masterBars.length;s++){let i=e.masterBars[s],a=new Ne;Ne.copyTo(i,a),i.tempoAutomation&&(a.tempoAutomation=new ge,ge.copyTo(i.tempoAutomation,a.tempoAutomation)),i.section&&(a.section=new Le,Le.copyTo(i.section,a.section));for(let e of Object.keys(i.fermata)){let t=i.fermata[e],s=new qe;qe.copyTo(t,s),a.addFermata(parseInt(e),s)}t.addMasterBar(a)}}static jsObjectToMidiFile(e){let t=new ts;t.division=e.division;let s=e.events;for(let e of s){let s,i=e.tick,a=e.message;switch(e.type){case"SystemExclusiveEvent":s=new rs(i,0,0,e.data),s.message=a;break;case"MetaDataEvent":s=new ss(i,0,0,e.data),s.message=a;break;case"MetaNumberEvent":s=new is(i,0,0,e.value),s.message=a;break;default:s=new wt(i,0,0,0),s.message=a}t.events.push(s)}return t}static midiFileToJsObject(e){let t={};t.division=e.division;let s=[];t.events=s;for(let t of e.events){let e={};s.push(e),e.tick=t.tick,e.message=t.message,t instanceof rs?(e.type="SystemExclusiveEvent",e.data=t.data):t instanceof ss?(e.type="MetaDataEvent",e.data=t.data):t instanceof is&&(e.type="MetaNumberEvent",e.value=t.value)}return t}}class cs{constructor(){this.ready=new Qt,this.samplesPlayed=new qt,this.sampleRequest=new Qt,this.finished=new Qt}get sampleRate(){return cs.preferredSampleRate}open(){we.debug("AlphaSynth","Initializing webworker worker"),this._worker=globalThis,this._worker.addEventListener("message",this.handleMessage.bind(this)),this.ready.trigger()}handleMessage(e){let t=e.data;switch(t.cmd){case cs.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case cs.CmdOutputFinished:this.finished.trigger();break;case cs.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(t.samples)}}sequencerFinished(){this._worker.postMessage({cmd:"alphaSynth.output.sequencerFinished"})}addSamples(e){this._worker.postMessage({cmd:"alphaSynth.output.addSamples",samples:e})}play(){this._worker.postMessage({cmd:"alphaSynth.output.play"})}pause(){this._worker.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this._worker.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}}cs.CmdOutputPrefix="alphaSynth.output.",cs.CmdOutputSequencerFinished=cs.CmdOutputPrefix+"sequencerFinished",cs.CmdOutputAddSamples=cs.CmdOutputPrefix+"addSamples",cs.CmdOutputPlay=cs.CmdOutputPrefix+"play",cs.CmdOutputPause=cs.CmdOutputPrefix+"pause",cs.CmdOutputResetSamples=cs.CmdOutputPrefix+"resetSamples",cs.CmdOutputSampleRequest=cs.CmdOutputPrefix+"sampleRequest",cs.CmdOutputFinished=cs.CmdOutputPrefix+"finished",cs.CmdOutputSamplesPlayed=cs.CmdOutputPrefix+"samplesPlayed",cs.preferredSampleRate=0;class us{constructor(e){this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this)),this._player=new es(new cs),this._player.positionChanged.on(this.onPositionChanged.bind(this)),this._player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this._player.finished.on(this.onFinished.bind(this)),this._player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.midiLoaded.on(this.onMidiLoaded.bind(this)),this._player.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this._player.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this._main.postMessage({cmd:"alphaSynth.ready"})}static init(){let e=globalThis;e.addEventListener("message",t=>{let s=t.data;switch(s.cmd){case"alphaSynth.initialize":cs.preferredSampleRate=s.sampleRate,we.logLevel=s.logLevel,globalThis.alphaSynthWebWorker=new us(e)}})}handleMessage(e){let t=e.data;switch(t.cmd){case"alphaSynth.setLogLevel":we.logLevel=t.value;break;case"alphaSynth.setMasterVolume":this._player.masterVolume=t.value;break;case"alphaSynth.setMetronomeVolume":this._player.metronomeVolume=t.value;break;case"alphaSynth.setPlaybackSpeed":this._player.playbackSpeed=t.value;break;case"alphaSynth.setTickPosition":this._player.tickPosition=t.value;break;case"alphaSynth.setTimePosition":this._player.timePosition=t.value;break;case"alphaSynth.setPlaybackRange":this._player.playbackRange=t.value;break;case"alphaSynth.setIsLooping":this._player.isLooping=t.value;break;case"alphaSynth.play":this._player.play();break;case"alphaSynth.pause":this._player.pause();break;case"alphaSynth.playPause":this._player.playPause();break;case"alphaSynth.stop":this._player.stop();break;case"alphaSynth.loadSoundFontBytes":this._player.loadSoundFont(t.data);break;case"alphaSynth.loadMidi":this._player.loadMidiFile(ds.jsObjectToMidiFile(t.midi));break;case"alphaSynth.setChannelMute":this._player.setChannelMute(t.channel,t.mute);break;case"alphaSynth.setChannelSolo":this._player.setChannelSolo(t.channel,t.solo);break;case"alphaSynth.setChannelVolume":this._player.setChannelVolume(t.channel,t.volume);break;case"alphaSynth.setChannelProgram":this._player.setChannelProgram(t.channel,t.program);break;case"alphaSynth.resetChannelStates":this._player.resetChannelStates()}}onPositionChanged(e){this._main.postMessage({cmd:"alphaSynth.positionChanged",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick})}onPlayerStateChanged(e){this._main.postMessage({cmd:"alphaSynth.playerStateChanged",state:e.state,stopped:e.stopped})}onFinished(){this._main.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this._main.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this.serializeException(e)})}serializeException(e){let t=JSON.parse(JSON.stringify(e));return e.message&&(t.message=e.message),e.stack&&(t.stack=e.stack),e.constructor&&e.constructor.name&&(t.type=e.constructor.name),t}onMidiLoaded(){this._main.postMessage({cmd:"alphaSynth.midiLoaded"})}onMidiLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",error:this.serializeException(e)})}onReadyForPlayback(){this._main.postMessage({cmd:"alphaSynth.readyForPlayback"})}}us.CmdPrefix="alphaSynth.",us.CmdInitialize=us.CmdPrefix+"initialize",us.CmdSetLogLevel=us.CmdPrefix+"setLogLevel",us.CmdSetMasterVolume=us.CmdPrefix+"setMasterVolume",us.CmdSetMetronomeVolume=us.CmdPrefix+"setMetronomeVolume",us.CmdSetPlaybackSpeed=us.CmdPrefix+"setPlaybackSpeed",us.CmdSetTickPosition=us.CmdPrefix+"setTickPosition",us.CmdSetTimePosition=us.CmdPrefix+"setTimePosition",us.CmdSetPlaybackRange=us.CmdPrefix+"setPlaybackRange",us.CmdSetIsLooping=us.CmdPrefix+"setIsLooping",us.CmdPlay=us.CmdPrefix+"play",us.CmdPause=us.CmdPrefix+"pause",us.CmdPlayPause=us.CmdPrefix+"playPause",us.CmdStop=us.CmdPrefix+"stop",us.CmdLoadSoundFontBytes=us.CmdPrefix+"loadSoundFontBytes",us.CmdLoadMidi=us.CmdPrefix+"loadMidi",us.CmdSetChannelMute=us.CmdPrefix+"setChannelMute",us.CmdSetChannelSolo=us.CmdPrefix+"setChannelSolo",us.CmdSetChannelVolume=us.CmdPrefix+"setChannelVolume",us.CmdSetChannelProgram=us.CmdPrefix+"setChannelProgram",us.CmdResetChannelStates=us.CmdPrefix+"resetChannelStates",us.CmdReady=us.CmdPrefix+"ready",us.CmdReadyForPlayback=us.CmdPrefix+"readyForPlayback",us.CmdPositionChanged=us.CmdPrefix+"positionChanged",us.CmdPlayerStateChanged=us.CmdPrefix+"playerStateChanged",us.CmdFinished=us.CmdPrefix+"finished",us.CmdSoundFontLoaded=us.CmdPrefix+"soundFontLoaded",us.CmdSoundFontLoadFailed=us.CmdPrefix+"soundFontLoadFailed",us.CmdMidiLoaded=us.CmdPrefix+"midiLoaded",us.CmdMidiLoadFailed=us.CmdPrefix+"midiLoadFailed",us.CmdLog=us.CmdPrefix+"log";class ps{static generateFontLookup(e){if(!ps.FontSizeLookupTables.has(e))if(i.isRunningInWorker)ps.FontSizeLookupTables.set(e,new Uint8Array([8]));else{let t=document.createElement("canvas").getContext("2d");t.font="11px "+e;let s=[];for(let e=32;e<255;e++){let i=String.fromCharCode(e);s.push(t.measureText(i).width)}let i=new Uint8Array(s);ps.FontSizeLookupTables.set(e,i)}}static measureString(e,t,s,i){let a;ps.FontSizeLookupTables.has(t)||ps.generateFontLookup(t),a=ps.FontSizeLookupTables.get(t);let n=1;0!=(i&r.Italic)&&(n*=1.2),0!=(i&r.Bold)&&(n*=1.2);let o=0;for(let t=0;t<e.length;t++){let i=Math.min(a.length-1,e.charCodeAt(t)-32);i>=0&&(o+=a[i]*s/11)}return o*n}}ps.Georgia=new Uint8Array([3,4,5,7,7,9,8,2,4,4,5,7,3,4,3,5,7,5,6,6,6,6,6,6,7,6,3,3,7,7,7,5,10,7,7,7,8,7,7,8,9,4,6,8,7,10,8,8,7,8,8,6,7,8,7,11,8,7,7,4,5,4,7,7,6,6,6,5,6,5,4,6,6,3,3,6,3,10,6,6,6,6,5,5,4,6,5,8,6,5,5,5,4,5,7,6,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,3,4,6,7,6,7,4,6,6,10,6,6,7,0,10,7,5,7,6,6,6,6,6,3,6,6,6,6,12,12,12,5,7,7,7,7,7,7,11,7,7,7,7,7,4,4,4,4,8,8,8,8,8,8,8,7,8,8,8,8,8,7,7,6,6,6,6,6,6,6,8,5,5,5,5,5,3,3,3,3,6,6,6,6,6,6,6,7,6,6,6,6,6,5,6]),ps.Arial=new Uint8Array([3,3,4,6,6,10,7,2,4,4,4,6,3,4,3,3,6,6,6,6,6,6,6,6,6,6,3,3,6,6,6,6,11,7,7,8,8,7,7,9,8,3,6,7,6,9,8,9,7,9,8,7,7,8,7,10,7,7,7,3,3,3,5,6,4,6,6,6,6,6,3,6,6,2,2,6,2,9,6,6,6,6,4,6,3,6,6,8,6,6,6,4,3,4,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,4,6,6,6,6,3,6,4,8,4,6,6,0,8,6,4,6,4,4,4,6,6,4,4,4,4,6,9,9,9,7,7,7,7,7,7,7,11,8,7,7,7,7,3,3,3,3,8,8,9,9,9,9,9,6,9,8,8,8,8,7,7,7,6,6,6,6,6,6,10,6,6,6,6,6,3,3,3,3,6,6,6,6,6,6,6,6,7,6,6,6,6,6,6]),ps.FontSizeLookupTables=new Map([["Arial",ps.Arial],["'Arial'",ps.Arial],['"Arial"',ps.Arial],["Georgia",ps.Georgia],["'Georgia'",ps.Georgia],['"Georgia"',ps.Georgia]]),ps.ControlChars=32;class gs{constructor(){this.width=0,this.height=0,this.totalWidth=0,this.totalHeight=0,this.firstMasterBarIndex=0,this.lastMasterBarIndex=0,this.renderResult=null}}class fs{constructor(){this.beats=[]}addBeat(e){e.barBounds=this,this.beats.push(e),this.masterBarBounds.addBeat(e)}findBeatAtPos(e){let t=null;for(let s of this.beats)if(!t||s.realBounds.x<e)t=s;else if(s.realBounds.x>e)break;return t}}class ms{constructor(){this.notes=null}addNote(e){this.notes||(this.notes=[]),this.notes.push(e)}findNoteAtPos(e,t){if(!this.notes)return null;for(let s of this.notes){let i=s.noteHeadBounds.y+s.noteHeadBounds.h,a=s.noteHeadBounds.x+s.noteHeadBounds.w;if(s.noteHeadBounds.x>=e&&s.noteHeadBounds.y>=t&&e<=a&&t<=i)return s.note}return null}}class ys{constructor(){this.index=0,this.isFirstOfLine=!1,this.bars=[]}addBar(e){e.masterBarBounds=this,this.bars.push(e)}findBeatAtPos(e,t){let s=null;for(let t of this.bars){let i=t.findBeatAtPos(e);i&&(!s||s.realBounds.x<i.realBounds.x)&&(s=i)}return s?s.beat:null}finish(){this.bars.sort((e,t)=>e.realBounds.y<t.realBounds.y?-1:e.realBounds.y>t.realBounds.y?1:e.realBounds.x<t.realBounds.x?-1:e.realBounds.x>t.realBounds.x?1:0)}addBeat(e){this.staveGroupBounds.boundsLookup.addBeat(e)}}class bs{}class Ss{constructor(){this.index=0,this.bars=[]}finish(){for(let e of this.bars)e.finish()}addBar(e){this.boundsLookup.addMasterBar(e),e.staveGroupBounds=this,this.bars.push(e)}findBarAtPos(e){let t=null;for(let s of this.bars)if(!t||s.realBounds.x<e)t=s;else if(e>s.realBounds.x+s.realBounds.w)break;return t}}class _s{constructor(){this._beatLookup=new Map,this._masterBarLookup=new Map,this._currentStaveGroup=null,this.staveGroups=[],this.isFinished=!1}toJson(){let e={},t=[];e.staveGroups=t;for(let e of this.staveGroups){let s={};s.visualBounds=this.boundsToJson(e.visualBounds),s.realBounds=this.boundsToJson(e.realBounds),s.bars=[];for(let t of e.bars){let e={};e.lineAlignedBounds=this.boundsToJson(t.lineAlignedBounds),e.visualBounds=this.boundsToJson(t.visualBounds),e.realBounds=this.boundsToJson(t.realBounds),e.index=t.index,e.bars=[];for(let s of t.bars){let t={};t.visualBounds=this.boundsToJson(s.visualBounds),t.realBounds=this.boundsToJson(s.realBounds),t.beats=[];for(let e of s.beats){let s={};s.visualBounds=this.boundsToJson(e.visualBounds),s.realBounds=this.boundsToJson(e.realBounds);let i=s;if(i.beatIndex=e.beat.index,i.voiceIndex=e.beat.voice.index,i.barIndex=e.beat.voice.bar.index,i.staffIndex=e.beat.voice.bar.staff.index,i.trackIndex=e.beat.voice.bar.staff.track.index,e.notes){let t=s.notes=[];for(let s of e.notes){let e={};e.index=s.note.index,e.noteHeadBounds=this.boundsToJson(s.noteHeadBounds),t.push(e)}}t.beats.push(s)}e.bars.push(t)}s.bars.push(e)}t.push(s)}return e}static fromJson(e,t){let s=new _s,i=e.staveGroups;for(let e of i){let i=new Ss;i.visualBounds=e.visualBounds,i.realBounds=e.realBounds,s.addStaveGroup(i);for(let s of e.bars){let e=new ys;e.index=s.index,e.isFirstOfLine=s.isFirstOfLine,e.lineAlignedBounds=s.lineAlignedBounds,e.visualBounds=s.visualBounds,e.realBounds=s.realBounds,i.addBar(e);for(let i of s.bars){let s=new fs;s.visualBounds=i.visualBounds,s.realBounds=i.realBounds,e.addBar(s);for(let e of i.beats){let i=new ms;i.visualBounds=e.visualBounds,i.realBounds=e.realBounds;let a=e;if(i.beat=t.tracks[a.trackIndex].staves[a.staffIndex].bars[a.barIndex].voices[a.voiceIndex].beats[a.beatIndex],e.notes){i.notes=[];for(let t of e.notes){let e=new bs,s=t;e.note=i.beat.notes[s.index],e.noteHeadBounds=t.noteHeadBounds,i.addNote(e)}}s.addBeat(i)}}}}return s}boundsToJson(e){let t={};return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}finish(){for(let e of this.staveGroups)e.finish();this.isFinished=!0}addNote(e){this.findBeat(e.note.beat).addNote(e)}addStaveGroup(e){e.index=this.staveGroups.length,e.boundsLookup=this,this.staveGroups.push(e),this._currentStaveGroup=e}addMasterBar(e){e.staveGroupBounds?this._masterBarLookup.set(e.index,e):(e.staveGroupBounds=this._currentStaveGroup,this._masterBarLookup.set(e.index,e),this._currentStaveGroup.addBar(e))}addBeat(e){this._beatLookup.set(e.beat.id,e)}findMasterBarByIndex(e){return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findMasterBar(e){let t=e.index;return this._masterBarLookup.has(t)?this._masterBarLookup.get(t):null}findBeat(e){let t=e.id;return this._beatLookup.has(t)?this._beatLookup.get(t):null}getBeatAtPos(e,t){let s=0,i=this.staveGroups.length-1,a=-1;for(;s<=i;){let e=(i+s)/2|0,r=this.staveGroups[e];if(t>=r.realBounds.y&&t<=r.realBounds.y+r.realBounds.h){a=e;break}t<r.realBounds.y?i=e-1:s=e+1}if(-1===a)return null;let r=this.staveGroups[a].findBarAtPos(e);return r?r.findBeatAtPos(e,t):null}getNoteAtPos(e,t,s){let i=this.findBeat(e);return i?(t-=i.barBounds.masterBarBounds.staveGroupBounds.realBounds.x,s-=i.barBounds.masterBarBounds.staveGroupBounds.realBounds.y,i.findNoteAtPos(t,s)):null}}class ws{constructor(t){this._currentLayoutMode=e.LayoutMode.Page,this._currentRenderEngine=null,this._renderedTracks=null,this.canvas=null,this.score=null,this.tracks=null,this.layout=null,this.boundsLookup=null,this.width=0,this.preRender=new qt,this.renderFinished=new qt,this.partialRenderFinished=new qt,this.postRenderFinished=new Qt,this.error=new qt,this.settings=t,this.recreateCanvas(),this.recreateLayout()}destroy(){this.score=null,this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}recreateCanvas(){return this._currentRenderEngine!==this.settings.core.engine&&(this.canvas=Er.getRenderEngineFactory(this.settings).createCanvas(),this._currentRenderEngine=this.settings.core.engine,!0)}recreateLayout(){return(!this.layout||this._currentLayoutMode!==this.settings.display.layoutMode)&&(this.layout=Er.getLayoutEngineFactory(this.settings).createLayout(this),this._currentLayoutMode=this.settings.display.layoutMode,!0)}renderScore(e,t){try{let s;if(this.score=e,t){s=[];for(let i of t)i>=0&&i<e.tracks.length&&s.push(e.tracks[i])}else s=e.tracks.slice(0);0===s.length&&e.tracks.length>0&&s.push(e.tracks[0]),this.tracks=s,this.render()}catch(e){this.error.trigger(e)}}renderTracks(e){0===e.length?this.score=null:this.score=e[0].score,this.tracks=e,this.render()}updateSettings(e){this.settings=e}render(){if(0!==this.width){if(this.boundsLookup=new _s,this.tracks&&0!==this.tracks.length){this.recreateCanvas(),this.canvas.lineWidth=this.settings.display.scale,this.canvas.settings=this.settings,we.info("Rendering","Rendering "+this.tracks.length+" tracks");for(let e=0;e<this.tracks.length;e++){let t=this.tracks[e];we.info("Rendering","Track "+e+": "+t.name)}this.preRender.trigger(!1),this.recreateLayout(),this.layoutAndRender(),this._renderedTracks=this.tracks,we.info("Rendering","Rendering finished")}}else we.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null)}resizeRender(){this.recreateLayout()||this.recreateCanvas()||this._renderedTracks!==this.tracks||!this.tracks?(we.info("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(we.info("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new _s,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this.layout.renderAnnotation(),this.onRenderFinished(),this.postRenderFinished.trigger()):we.warning("Rendering","Current layout does not support dynamic resizing, nothing was done",null),we.debug("Rendering","Resize finished")}layoutAndRender(){we.info("Rendering","Rendering at scale "+this.settings.display.scale+" with layout "+this.layout.name,null),this.layout.layoutAndRender(),this.layout.renderAnnotation(),this.onRenderFinished(),this.postRenderFinished.trigger()}onRenderFinished(){const e=new gs;e.totalHeight=this.layout.height,e.totalWidth=this.layout.width,e.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(e)}}class Bs{constructor(e){this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this),!1)}static init(){globalThis.alphaTabWebWorker=new Bs(globalThis)}handleMessage(e){let t=e.data;switch(t?t.cmd:""){case"alphaTab.initialize":let e=new ls;e.fillFromJson(t.settings),we.logLevel=e.core.logLevel,this._renderer=new ws(e),this._renderer.partialRenderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialRenderFinished",result:e})}),this._renderer.renderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.renderFinished",result:e})}),this._renderer.postRenderFinished.on(()=>{var e,t;this._main.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:null!==(t=null===(e=this._renderer.boundsLookup)||void 0===e?void 0:e.toJson())&&void 0!==t?t:null})}),this._renderer.preRender.on(e=>{this._main.postMessage({cmd:"alphaTab.preRender",resize:e})}),this._renderer.error.on(this.error.bind(this));break;case"alphaTab.invalidate":this._renderer.render();break;case"alphaTab.resizeRender":this._renderer.resizeRender();break;case"alphaTab.setWidth":this._renderer.width=t.width;break;case"alphaTab.renderScore":this.updateFontSizes(t.fontSizes);let s=ds.jsObjectToScore(t.score,this._renderer.settings);this.renderMultiple(s,t.trackIndexes);break;case"alphaTab.updateSettings":this.updateSettings(t.settings)}}updateFontSizes(e){if(e){ps.FontSizeLookupTables||(ps.FontSizeLookupTables=new Map);for(let t in e)ps.FontSizeLookupTables.set(t,e[t])}}updateSettings(e){this._renderer.settings.fillFromJson(e)}renderMultiple(e,t){try{this._renderer.renderScore(e,t)}catch(e){this.error(e)}}error(e){we.error("Worker","An unexpected error occurred in worker",e),this._main.postMessage({cmd:"alphaTab.error",error:e})}}!function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}($||($={})),function(e){e[e.Top=0]="Top",e[e.Middle=1]="Middle",e[e.Bottom=2]="Bottom"}(Z||(Z={})),function(e){e[e.None=-1]="None",e[e.ClefG=57424]="ClefG",e[e.ClefC=57436]="ClefC",e[e.ClefF=57442]="ClefF",e[e.ClefNeutral=57449]="ClefNeutral",e[e.ClefTab=57453]="ClefTab",e[e.ClefTabSmall=57454]="ClefTabSmall",e[e.RestQuadrupleWhole=58593]="RestQuadrupleWhole",e[e.RestDoubleWhole=58594]="RestDoubleWhole",e[e.RestWhole=58595]="RestWhole",e[e.RestHalf=58596]="RestHalf",e[e.RestQuarter=58597]="RestQuarter",e[e.RestEighth=58598]="RestEighth",e[e.RestSixteenth=58599]="RestSixteenth",e[e.RestThirtySecond=58600]="RestThirtySecond",e[e.RestSixtyFourth=58601]="RestSixtyFourth",e[e.RestOneHundredTwentyEighth=58602]="RestOneHundredTwentyEighth",e[e.RestTwoHundredFiftySixth=58603]="RestTwoHundredFiftySixth",e[e.Trill=58726]="Trill",e[e.Num0=57472]="Num0",e[e.Num1=57473]="Num1",e[e.Num2=57474]="Num2",e[e.Num3=57475]="Num3",e[e.Num4=57476]="Num4",e[e.Num5=57477]="Num5",e[e.Num6=57478]="Num6",e[e.Num7=57479]="Num7",e[e.Num8=57480]="Num8",e[e.Num9=57481]="Num9",e[e.TimeSignatureCommon=57482]="TimeSignatureCommon",e[e.TimeSignatureCutCommon=57483]="TimeSignatureCutCommon",e[e.NoteQuadrupleWhole=57505]="NoteQuadrupleWhole",e[e.NoteDoubleWhole=57504]="NoteDoubleWhole",e[e.NoteWhole=57506]="NoteWhole",e[e.NoteHalf=57507]="NoteHalf",e[e.NoteQuarter=57508]="NoteQuarter",e[e.NoteDead=57514]="NoteDead",e[e.NoteHarmonic=57564]="NoteHarmonic",e[e.NoteHarmonicWhole=57566]="NoteHarmonicWhole",e[e.NoteHiHat=57523]="NoteHiHat",e[e.NoteSideStick=57513]="NoteSideStick",e[e.NoteHiHatHalf=57591]="NoteHiHatHalf",e[e.NoteChineseCymbal=57593]="NoteChineseCymbal",e[e.FooterUpEighth=57920]="FooterUpEighth",e[e.FooterDownEighth=57921]="FooterDownEighth",e[e.FooterUpSixteenth=57922]="FooterUpSixteenth",e[e.FooterDownSixteenth=57923]="FooterDownSixteenth",e[e.FooterUpThirtySecond=57924]="FooterUpThirtySecond",e[e.FooterDownThirtySecond=57925]="FooterDownThirtySecond",e[e.FooterUpSixtyFourth=57926]="FooterUpSixtyFourth",e[e.FooterDownSixtyFourth=57927]="FooterDownSixtyFourth",e[e.FooterUpOneHundredTwentyEighth=57928]="FooterUpOneHundredTwentyEighth",e[e.FooterDownOneHundredTwentyEighth=57929]="FooterDownOneHundredTwentyEighth",e[e.FooterUpTwoHundredFiftySixth=57930]="FooterUpTwoHundredFiftySixth",e[e.FooterDownTwoHundredFiftySixth=57931]="FooterDownTwoHundredFiftySixth",e[e.DynamicPPP=58666]="DynamicPPP",e[e.DynamicPP=58667]="DynamicPP",e[e.DynamicP=58656]="DynamicP",e[e.DynamicMP=58668]="DynamicMP",e[e.DynamicMF=58669]="DynamicMF",e[e.DynamicF=58658]="DynamicF",e[e.DynamicFF=58671]="DynamicFF",e[e.DynamicFFF=58672]="DynamicFFF",e[e.Accentuation=58528]="Accentuation",e[e.HeavyAccentuation=58540]="HeavyAccentuation",e[e.WaveHorizontalSlight=60068]="WaveHorizontalSlight",e[e.WaveHorizontalWide=60126]="WaveHorizontalWide",e[e.PickStrokeDown=58896]="PickStrokeDown",e[e.PickStrokeUp=58898]="PickStrokeUp",e[e.TremoloPickingThirtySecond=57890]="TremoloPickingThirtySecond",e[e.TremoloPickingSixteenth=57889]="TremoloPickingSixteenth",e[e.TremoloPickingEighth=57888]="TremoloPickingEighth",e[e.Tempo=57813]="Tempo",e[e.NoteEighth=57815]="NoteEighth",e[e.AccidentalFlat=57952]="AccidentalFlat",e[e.AccidentalNatural=57953]="AccidentalNatural",e[e.AccidentalSharp=57954]="AccidentalSharp",e[e.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",e[e.AccidentalQuarterToneSharpArrowUp=57972]="AccidentalQuarterToneSharpArrowUp",e[e.AccidentalQuarterToneNaturalArrowUp=57970]="AccidentalQuarterToneNaturalArrowUp",e[e.Ottava8=58640]="Ottava8",e[e.Ottava8va=58641]="Ottava8va",e[e.Ottava8vb=58652]="Ottava8vb",e[e.Ottava15=58644]="Ottava15",e[e.Ottava15ma=58645]="Ottava15ma",e[e.OttavaMBaseline=60565]="OttavaMBaseline",e[e.OttavaBBaseline=60563]="OttavaBBaseline",e[e.SimileMarkSimple=58624]="SimileMarkSimple",e[e.SimileMarkDouble=58625]="SimileMarkDouble",e[e.FermataMedium=58560]="FermataMedium",e[e.FermataShort=58564]="FermataShort",e[e.FermataLong=58566]="FermataLong",e[e.FretboardX=59481]="FretboardX",e[e.FretboardO=59482]="FretboardO"}(ee||(ee={}));class vs{constructor(){this._canvas=null,this._color=new a(0,0,0,255),this._font=new n("Arial",10,r.Plain),this._lineWidth=0;let e=document.createElement("span");e.classList.add("at"),document.body.appendChild(e);let t=window.getComputedStyle(e),s=t.fontFamily;(s.startsWith('"')||s.startsWith("'"))&&(s=s.substr(1,s.length-2)),this._musicFont=new n(s,parseFloat(t.fontSize),r.Plain),this._measureCanvas=document.createElement("canvas"),this._measureCanvas.width=10,this._measureCanvas.height=10,this._measureCanvas.style.width="10px",this._measureCanvas.style.height="10px",this._measureContext=this._measureCanvas.getContext("2d"),this._measureContext.textBaseline="hanging"}onRenderFinished(){return null}beginRender(e,t){this._canvas=document.createElement("canvas"),this._canvas.width=0|e,this._canvas.height=0|t,this._canvas.style.width=e+"px",this._canvas.style.height=t+"px",this._context=this._canvas.getContext("2d"),this._context.textBaseline="hanging",this._context.lineWidth=this._lineWidth}endRender(){let e=this._canvas;return this._canvas=null,e}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._context.strokeStyle=e.rgba,this._context.fillStyle=e.rgba)}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._context&&(this._context.lineWidth=e)}fillRect(e,t,s,i){s>0&&this._context.fillRect(0|e,0|t,s,i)}strokeRect(e,t,s,i){this._context.strokeRect(0|e,0|t,s,i)}beginPath(){this._context.beginPath()}closePath(){this._context.closePath()}moveTo(e,t){this._context.moveTo(0|e,0|t)}lineTo(e,t){this._context.lineTo(0|e,0|t)}quadraticCurveTo(e,t,s,i){this._context.quadraticCurveTo(e,t,s,i)}bezierCurveTo(e,t,s,i,a,r){this._context.bezierCurveTo(e,t,s,i,a,r)}fillCircle(e,t,s){this._context.beginPath(),this._context.arc(0|e,0|t,s,0,2*Math.PI,!0),this.fill()}fill(){this._context.fill()}stroke(){this._context.stroke()}get font(){return this._font}set font(e){this._font=e,this._context&&(this._context.font=e.toCssString(this.settings.display.scale)),this._measureContext.font=e.toCssString(this.settings.display.scale)}get textAlign(){switch(this._context.textAlign){case"left":return $.Left;case"center":return $.Center;case"right":return $.Right;default:return $.Left}}set textAlign(e){switch(e){case $.Left:this._context.textAlign="left";break;case $.Center:this._context.textAlign="center";break;case $.Right:this._context.textAlign="right"}}get textBaseline(){switch(this._context.textBaseline){case"hanging":return Z.Top;case"middle":return Z.Middle;case"bottom":return Z.Bottom;default:return Z.Top}}set textBaseline(e){switch(e){case Z.Top:this._context.textBaseline="hanging";break;case Z.Middle:this._context.textBaseline="middle";break;case Z.Bottom:this._context.textBaseline="bottom"}}beginGroup(e){}endGroup(){}fillText(e,t,s){this._context.fillText(e,0|t,0|s)}measureText(e){return this._measureContext.measureText(e).width}fillMusicFontSymbol(e,t,s,i,a=!1){i!==ee.None&&this.fillMusicFontSymbolText(e,t,s,String.fromCharCode(i),a)}fillMusicFontSymbols(e,t,s,i,a=!1){let r="";for(let e of i)e!==ee.None&&(r+=String.fromCharCode(e));this.fillMusicFontSymbolText(e,t,s,r,a)}fillMusicFontSymbolText(e,t,s,i,a=!1){let r=this._context.textAlign,n=this._context.textBaseline,o=this._context.font;this._context.font=this._musicFont.toCssString(s),this._context.textBaseline="middle",a&&(this._context.textAlign="center"),this._context.fillText(i,0|e,0|t),this._context.textBaseline=n,this._context.font=o,this._context.textAlign=r}beginRotate(e,t,s){this._context.save(),this._context.translate(e,t),this._context.rotate(s*Math.PI/180)}endRotate(){this._context.restore()}}class Ts{constructor(e){this._midiFile=e}addTimeSignature(e,t,s){let i=0;for(;(s>>=1)>0;)i++;const a=new ss(e,255,U.TimeSignature,new Uint8Array([255&t,255&i,48,8]));this._midiFile.addEvent(a)}addRest(e,t,s){const i=new rs(t,j.SystemExclusive,0,new Uint8Array([255]));this._midiFile.addEvent(i)}addNote(e,t,s,i,a,r){const n=me.dynamicToVelocity(a),o=new wt(t,this.makeCommand(z.NoteOn,r),Ts.fixValue(i),Ts.fixValue(n));this._midiFile.addEvent(o);const h=new wt(t+s,this.makeCommand(z.NoteOff,r),Ts.fixValue(i),Ts.fixValue(n));this._midiFile.addEvent(h)}makeCommand(e,t){return 240&e|15&t}static fixValue(e){return e>127?127:e<0?0:e}addControlChange(e,t,s,i,a){const r=new wt(t,this.makeCommand(z.Controller,s),Ts.fixValue(i),Ts.fixValue(a));this._midiFile.addEvent(r)}addProgramChange(e,t,s,i){const a=new wt(t,this.makeCommand(z.ProgramChange,s),Ts.fixValue(i),0);this._midiFile.addEvent(a)}addTempo(e,t){const s=6e7/t|0,i=new is(e,255,U.Tempo,s);this._midiFile.addEvent(i)}addBend(e,t,s,i){const a=new wt(t,this.makeCommand(z.PitchBend,s),0,Ts.fixValue(i));this._midiFile.addEvent(a)}finishTrack(e,t){const s=new ss(t,255,U.EndOfTrack,new Uint8Array(0));this._midiFile.addEvent(s)}}class ks{constructor(){this._highlightedBeats=new Map,this.start=0,this.end=0,this.isEmptyBar=!1,this.beatsToHighlight=[]}highlightBeat(e){this._highlightedBeats.has(e.id)||(this._highlightedBeats.set(e.id,!0),this.beatsToHighlight.push(e))}}!function(e){e[e.BankSelectCoarse=0]="BankSelectCoarse",e[e.ModulationCoarse=1]="ModulationCoarse",e[e.DataEntryCoarse=6]="DataEntryCoarse",e[e.VolumeCoarse=7]="VolumeCoarse",e[e.PanCoarse=10]="PanCoarse",e[e.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",e[e.ModulationFine=33]="ModulationFine",e[e.DataEntryFine=38]="DataEntryFine",e[e.VolumeFine=39]="VolumeFine",e[e.PanFine=42]="PanFine",e[e.ExpressionControllerFine=43]="ExpressionControllerFine",e[e.HoldPedal=64]="HoldPedal",e[e.LegatoPedal=68]="LegatoPedal",e[e.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",e[e.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",e[e.RegisteredParameterFine=100]="RegisteredParameterFine",e[e.RegisteredParameterCourse=101]="RegisteredParameterCourse",e[e.ResetControllers=121]="ResetControllers",e[e.AllNotesOff=123]="AllNotesOff"}(te||(te={}));class xs{constructor(e){this._repeatStartIndex=0,this._repeatNumber=0,this._repeatOpen=!1,this.shouldPlay=!0,this.index=0,this.currentTick=0,this._score=e}get finished(){return this.index>=this._score.masterBars.length}processCurrent(){const e=this._score.masterBars[this.index],t=e.alternateEndings;e.repeatGroup.isClosed||e.repeatGroup.openings[e.repeatGroup.openings.length-1]!==e||(this._repeatNumber=0,this._repeatOpen=!1),!e.isRepeatStart&&0!==e.index||0!==this._repeatNumber?e.isRepeatStart&&(this.shouldPlay=!0):(this._repeatStartIndex=this.index,this._repeatOpen=!0),this._repeatOpen&&t>0&&(0==(t&1<<this._repeatNumber)?this.shouldPlay=!1:this.shouldPlay=!0),this.shouldPlay&&(this.currentTick+=e.calculateDuration())}moveNext(){const e=this._score.masterBars[this.index].repeatCount-1;this._repeatOpen&&e>0?this._repeatNumber<e?(this.index=this._repeatStartIndex,this._repeatNumber++):(this._repeatNumber=0,this._repeatOpen=!1,this.shouldPlay=!0,this.index++):this.index++}}class Ns{constructor(){this.start=0,this.end=0,this.tempo=0,this.beats=[],this.nextMasterBar=null}finish(){this.beats.sort((e,t)=>e.start-t.start)}addBeat(e){this.beats.push(e)}}class Ps{constructor(){this.nextBeat=null,this.duration=0}}class Fs{constructor(){this._currentMasterBar=null,this.masterBarLookup=new Map,this.masterBars=[]}finish(){let e=null,t=[];for(let s of this.masterBars){s.finish(),e&&(e.nextMasterBar=s);for(const e of s.beats){const s=[];for(let i of t)i.end>e.start&&(s.push(i),e.highlightBeat(i.beat),e.start<=i.start&&i.highlightBeat(e.beat));s.push(e),t=s}e=s}}findBeat(e,t){const s=this.findMasterBar(t);if(!s)return null;const i=new Map;for(const t of e)i.set(t.index,!0);let a=null,r=0,n=s.beats;for(let e=0;e<n.length;e++){let s=n[e];if(i.has(s.beat.voice.bar.staff.track.index))if(s.start<=t&&t<s.end)(!a||a.start<s.start)&&(a=n[e],r=e);else if(s.end>t)break}if(!a)return null;let o=null;for(let e=r+1;e<n.length;e++){const t=n[e];if(t.beat.graceType===_.None&&t.start>a.start&&i.has(t.beat.voice.bar.staff.track.index)){o=t;break}}if(!o&&s.nextMasterBar){n=s.nextMasterBar.beats;for(let e=0;e<n.length;e++){const t=n[e];if(t.beat.graceType===_.None&&i.has(t.beat.voice.bar.staff.track.index)){o=t;break}}}const h=new Ps;return h.currentBeat=a.beat,h.nextBeat=o?o.beat:null,h.duration=o?me.ticksToMillis(o.start-a.start,s.tempo):me.ticksToMillis(a.end-a.start,s.tempo),h.beatsToHighlight=a.beatsToHighlight,h}findMasterBar(e){const t=this.masterBars;let s=0,i=t.length-1;for(;s<=i;){const a=(i+s)/2|0,r=t[a];if(e>=r.start&&e<r.end)return r;e<r.start?i=a-1:s=a+1}return null}getMasterBar(e){if(!this.masterBarLookup.has(e.index)){const t=new Ns;return t.masterBar=e,t}return this.masterBarLookup.get(e.index)}getMasterBarStart(e){return this.masterBarLookup.has(e.index)?this.masterBarLookup.get(e.index).start:0}addMasterBar(e){this.masterBars.push(e),this._currentMasterBar=e,this.masterBarLookup.has(e.masterBar.index)||this.masterBarLookup.set(e.masterBar.index,e)}addBeat(e){var t;null===(t=this._currentMasterBar)||void 0===t||t.addBeat(e)}}class Cs{constructor(){this.noteOnly=0,this.untilTieEnd=0,this.letRingEnd=0}}class Ls{constructor(){this.firstBeatDuration=0,this.secondBeatStartOffset=0,this.secondBeatDuration=0}}class Ms{constructor(e,t,s){this._currentTempo=0,this._currentBarRepeatLookup=null,this.tickLookup=new Fs,this._currentTripletFeel=null,this._score=e,this._settings=t||new ls,this._currentTempo=this._score.tempo,this._handler=s}generate(){for(const e of this._score.tracks)this.generateTrack(e);we.info("Midi","Begin midi generation");const e=new xs(this._score);let t=null;for(;!e.finished;){const s=e.index,i=this._score.masterBars[s],a=e.currentTick;if(e.processCurrent(),e.shouldPlay){this.generateMasterBar(i,t,a);for(const e of this._score.tracks)for(const t of e.staves)s<t.bars.length&&this.generateBar(t.bars[s],a)}e.moveNext(),t=i}for(const t of this._score.tracks)this._handler.finishTrack(t.index,e.currentTick);this.tickLookup.finish(),we.info("Midi","Midi generation done")}generateTrack(e){this.generateChannel(e,e.playbackInfo.primaryChannel,e.playbackInfo),e.playbackInfo.primaryChannel!==e.playbackInfo.secondaryChannel&&this.generateChannel(e,e.playbackInfo.secondaryChannel,e.playbackInfo)}generateChannel(e,t,s){let i=Ms.toChannelShort(s.volume),a=Ms.toChannelShort(s.balance);this._handler.addControlChange(e.index,0,t,te.VolumeCoarse,i),this._handler.addControlChange(e.index,0,t,te.PanCoarse,a),this._handler.addControlChange(e.index,0,t,te.ExpressionControllerCoarse,127),this._handler.addControlChange(e.index,0,t,te.RegisteredParameterFine,0),this._handler.addControlChange(e.index,0,t,te.RegisteredParameterCourse,0),this._handler.addControlChange(e.index,0,t,te.DataEntryFine,0),this._handler.addControlChange(e.index,0,t,te.DataEntryCoarse,12),this._handler.addProgramChange(e.index,0,t,s.program)}static toChannelShort(e){const t=Math.max(-32768,Math.min(32767,8*e-1));return Math.max(t,-1)+1}generateMasterBar(e,t,s){t&&t.timeSignatureDenominator===e.timeSignatureDenominator&&t.timeSignatureNumerator===e.timeSignatureNumerator||this._handler.addTimeSignature(s,e.timeSignatureNumerator,e.timeSignatureDenominator),t?e.tempoAutomation&&(this._handler.addTempo(s,e.tempoAutomation.value),this._currentTempo=e.tempoAutomation.value):(this._handler.addTempo(s,e.score.tempo),this._currentTempo=e.score.tempo);const i=new Ns;i.masterBar=e,i.start=s,i.tempo=this._currentTempo,i.end=i.start+e.calculateDuration(),this.tickLookup.addMasterBar(i)}generateBar(e,t){let s=this.getPlaybackBar(e);this._currentBarRepeatLookup=null;for(const i of s.voices)this.generateVoice(i,t,e)}getPlaybackBar(e){switch(e.simileMark){case p.Simple:e.previousBar&&(e=this.getPlaybackBar(e.previousBar));break;case p.FirstOfDouble:case p.SecondOfDouble:e.previousBar&&e.previousBar.previousBar&&(e=this.getPlaybackBar(e.previousBar.previousBar))}return e}generateVoice(e,t,s){if(!e.isEmpty||e.bar.isEmpty&&0===e.index)for(const i of e.beats)this.generateBeat(i,t,s)}generateBeat(e,t,s){let i=e.playbackStart,a=e.playbackDuration;e.voice.bar.isEmpty?a=e.voice.bar.masterBar.calculateDuration():e.voice.bar.masterBar.tripletFeel!==R.NoTripletFeel&&this._settings.player.playTripletFeel&&(this._currentTripletFeel?(i-=this._currentTripletFeel.secondBeatStartOffset,a=this._currentTripletFeel.secondBeatDuration,this._currentTripletFeel=null):(this._currentTripletFeel=Ms.calculateTripletFeelInfo(i,a,e),this._currentTripletFeel&&(a=this._currentTripletFeel.firstBeatDuration)));const r=new ks;r.start=t+i;const n=e.nextBeat?e.nextBeat.absolutePlaybackStart-e.absolutePlaybackStart:a;r.end=t+i,r.highlightBeat(e),r.end+=n>a?n:a,s===e.voice.bar?(r.beat=e,this.tickLookup.addBeat(r)):(r.isEmptyBar=!0,r.beat=s.voices[0].beats[0],this._currentBarRepeatLookup?this._currentBarRepeatLookup.end=r.end:(this._currentBarRepeatLookup=r,this.tickLookup.addBeat(this._currentBarRepeatLookup)));const o=e.voice.bar.staff.track;for(const s of e.automations)this.generateAutomation(e,s,t);if(e.isRest)this._handler.addRest(o.index,t+i,o.playbackInfo.primaryChannel);else{let s=this.getBrushInfo(e);for(const r of e.notes)this.generateNote(r,t+i,a,s)}if(e.vibrato!==x.None){let s=240,a=3;switch(e.vibrato){case x.Slight:s=this._settings.player.vibrato.beatSlightLength,a=this._settings.player.vibrato.beatSlightAmplitude;break;case x.Wide:s=this._settings.player.vibrato.beatWideLength,a=this._settings.player.vibrato.beatWideAmplitude}this.generateVibratorWithParams(e.voice.bar.staff.track,t+i,e.playbackDuration,s,a,o.playbackInfo.secondaryChannel)}}static calculateTripletFeelInfo(e,t,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case R.Triplet8th:case R.Dotted8th:case R.Scottish8th:i=b.Eighth;break;case R.Triplet16th:case R.Dotted16th:case R.Scottish16th:i=b.Sixteenth;break;default:return null}const a=me.toTicks(i);if(t!==a)return null;if(e%a!=0)return null;if(!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==a)return null;const r=new Ls;switch(s.voice.bar.masterBar.tripletFeel){case R.Triplet8th:r.firstBeatDuration=me.applyTuplet(me.toTicks(b.Quarter),3,2),r.secondBeatDuration=me.applyTuplet(me.toTicks(b.Eighth),3,2);break;case R.Dotted8th:r.firstBeatDuration=me.applyDot(me.toTicks(b.Eighth),!1),r.secondBeatDuration=me.toTicks(b.Sixteenth);break;case R.Scottish8th:r.firstBeatDuration=me.toTicks(b.Sixteenth),r.secondBeatDuration=me.applyDot(me.toTicks(b.Eighth),!1);break;case R.Triplet16th:r.firstBeatDuration=me.applyTuplet(me.toTicks(b.Eighth),3,2),r.secondBeatDuration=me.applyTuplet(me.toTicks(b.Sixteenth),3,2);break;case R.Dotted16th:r.firstBeatDuration=me.applyDot(me.toTicks(b.Sixteenth),!1),r.secondBeatDuration=me.toTicks(b.ThirtySecond);break;case R.Scottish16th:r.firstBeatDuration=me.toTicks(b.ThirtySecond),r.secondBeatDuration=me.applyDot(me.toTicks(b.Sixteenth),!1)}return r.secondBeatStartOffset=t-r.firstBeatDuration,r}generateNote(e,t,s,i){const a=e.beat.voice.bar.staff.track,r=e.beat.voice.bar.staff,n=e.realValue,o=e.isStringed&&e.string<=i.length?i[e.string-1]:0,h=t+o,l=this.getNoteDuration(e,s);l.untilTieEnd-=o,l.noteOnly-=o,l.letRingEnd-=o;const d=Ms.getDynamicValue(e),c=e.hasBend||e.beat.hasWhammyBar||e.beat.vibrato!==x.None?a.playbackInfo.secondaryChannel:a.playbackInfo.primaryChannel;let u=Ms.DefaultBend;if(e.hasBend?u+=Math.round(e.bendPoints[0].value*Ms.DefaultBendSemitone):e.beat.hasWhammyBar?u+=Math.round(e.beat.whammyBarPoints[0].value*Ms.DefaultBendSemitone):e.isTieDestination&&(u=0),u>0&&this._handler.addBend(a.index,h,c,u),e.beat.fadeIn&&this.generateFadeIn(e,h,l),!e.isTrill||r.isPercussion){if(e.beat.isTremolo)this.generateTremoloPicking(e,h,l,n,d,c);else if(e.hasBend?this.generateBend(e,h,l,c):e.beat.hasWhammyBar&&0===e.index?this.generateWhammy(e.beat,h,l,c):e.slideInType!==T.None||e.slideOutType!==k.None||e.vibrato!==x.None&&this.generateVibrato(e,h,l,c),!e.isTieDestination){let e=Math.max(l.untilTieEnd,l.letRingEnd);this._handler.addNote(a.index,h,e,n,d,c)}}else this.generateTrill(e,h,l,n,d,c)}getNoteDuration(t,s){const i=new Cs;if(i.noteOnly=s,i.untilTieEnd=s,i.letRingEnd=s,t.isDead)return i.noteOnly=this.applyStaticDuration(Ms.DefaultDurationDead,s),i.untilTieEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isPalmMute)return i.noteOnly=this.applyStaticDuration(Ms.DefaultDurationPalmMute,s),i.untilTieEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isStaccato)return i.noteOnly=s/2|0,i.untilTieEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isTieOrigin){const e=t.tieDestination;if(e)if(t.isTieDestination){const t=this.getNoteDuration(e,e.beat.playbackDuration);i.untilTieEnd=s+t.untilTieEnd}else{const s=t.beat.absolutePlaybackStart,a=this.getNoteDuration(e,e.beat.playbackDuration),r=e.beat.absolutePlaybackStart+a.untilTieEnd;i.untilTieEnd=r-s}}if(t.isLetRing&&this._settings.notation.notationMode===e.NotationMode.GuitarPro){let e=t.beat,a=0;const r=t.beat.voice.bar.masterBar.calculateDuration();for(;e.nextBeat;){let s=e.nextBeat;if(s.isRest)break;if(t.isStringed&&s.hasNoteOnString(t.string))break;if(e=e.nextBeat,a=e.absolutePlaybackStart-t.beat.absolutePlaybackStart+e.playbackDuration,a>r){a=r;break}}e===t.beat?i.letRingEnd=s:i.letRingEnd=a}else i.letRingEnd=i.untilTieEnd;return i}applyStaticDuration(e,t){const s=this._currentTempo*e/ye.MaxPosition|0;return Math.min(s,t)}static getDynamicValue(e){let t=e.dynamics;switch(!e.beat.voice.bar.staff.isPercussion&&e.hammerPullOrigin&&t--,e.isGhost&&t--,e.accentuated){case l.Normal:t++;break;case l.Heavy:t+=2}return t}generateFadeIn(e,t,s){const i=e.beat.voice.bar.staff.track,a=Ms.toChannelShort(i.playbackInfo.volume)/s.noteOnly,r=s.noteOnly/120|0,n=t+s.noteOnly;for(let e=r-1;e>=0;e--){const s=n-120*e,o=(s-t)*a;e===r-1&&(this._handler.addControlChange(i.index,t,i.playbackInfo.primaryChannel,te.VolumeCoarse,o),this._handler.addControlChange(i.index,t,i.playbackInfo.secondaryChannel,te.VolumeCoarse,o)),this._handler.addControlChange(i.index,s,i.playbackInfo.primaryChannel,te.VolumeCoarse,o),this._handler.addControlChange(i.index,s,i.playbackInfo.secondaryChannel,te.VolumeCoarse,o)}}generateVibrato(e,t,s,i){let a=0,r=0;switch(e.vibrato){case x.Slight:a=this._settings.player.vibrato.noteSlightLength,r=this._settings.player.vibrato.noteSlightAmplitude;break;case x.Wide:a=this._settings.player.vibrato.noteWideLength,r=this._settings.player.vibrato.noteWideAmplitude;break;default:return}const n=e.beat.voice.bar.staff.track;this.generateVibratorWithParams(n,t,s.noteOnly,a,r,i)}generateVibratorWithParams(e,t,s,i,a,r){const n=i/2|0,o=(t+=i)+s;for(;t<o;){let s=0;const h=t+i<o?i:o-t;for(;s<h;){let i=a*Math.sin(s*Math.PI/n);this._handler.addBend(e.index,t+s|0,r,Ms.DefaultBend+i),s+=16}t+=i}}generateBend(e,t,s,i){let a,r=e.bendPoints,n=e.beat.voice.bar.staff.track,o=null;if(e.isTieOrigin&&this._settings.notation.extendBendArrowsOnTiedNotes){let t=e;for(;t.isTieOrigin&&!t.tieDestination.hasBend;)t=t.tieDestination;a=t.beat.absolutePlaybackStart-e.beat.absolutePlaybackStart+this.getNoteDuration(t,t.beat.playbackDuration).noteOnly}else if(e.isTieOrigin&&e.beat.graceType!==_.None){switch(e.tieDestination.bendType){case f.Bend:case f.BendRelease:case f.PrebendBend:o=e.tieDestination.bendPoints[1].value;break;case f.Prebend:case f.PrebendRelease:o=e.tieDestination.bendPoints[0].value}a=Math.max(s.noteOnly,me.millisToTicks(this._settings.player.songBookBendDuration,this._currentTempo))}else a=s.noteOnly;r[0].value>0&&!e.isContinuedBend&&t--;const h=Math.min(a,me.millisToTicks(this._settings.player.songBookBendDuration,this._currentTempo));let l=[];switch(e.bendType){case f.Custom:l=r;break;case f.Bend:case f.Release:switch(e.bendStyle){case g.Default:l=r;break;case g.Gradual:l.push(new ye(0,e.bendPoints[0].value)),(!o||o<e.bendPoints[1].value)&&(o=e.bendPoints[1].value),l.push(new ye(ye.MaxPosition,o));break;case g.Fast:return(!o||o<e.bendPoints[1].value)&&(o=e.bendPoints[1].value),void(e.beat.graceType===_.BendGrace?this.generateSongBookWhammyOrBend(t,i,a,n,!0,[e.bendPoints[0].value,o],h):this.generateSongBookWhammyOrBend(t,i,a,n,!1,[e.bendPoints[0].value,o],h))}break;case f.BendRelease:switch(e.bendStyle){case g.Default:l=r;break;case g.Gradual:l.push(new ye(0,e.bendPoints[0].value)),l.push(new ye(ye.MaxPosition/2|0,e.bendPoints[1].value)),l.push(new ye(ye.MaxPosition,e.bendPoints[2].value));break;case g.Fast:return void this.generateSongBookWhammyOrBend(t,i,a,n,!1,[e.bendPoints[0].value,e.bendPoints[1].value,e.bendPoints[2].value],h)}break;case f.Hold:case f.Prebend:l=r;break;case f.PrebendBend:switch(e.bendStyle){case g.Default:l=r;break;case g.Gradual:l.push(new ye(0,e.bendPoints[0].value)),l.push(new ye(ye.MaxPosition,e.bendPoints[1].value));break;case g.Fast:const s=Ms.DefaultBend+e.bendPoints[0].value*Ms.DefaultBendSemitone;return this._handler.addBend(n.index,t,i,0|s),(!o||o<e.bendPoints[1].value)&&(o=e.bendPoints[1].value),void this.generateSongBookWhammyOrBend(t,i,a,n,!1,[e.bendPoints[0].value,o],h)}break;case f.PrebendRelease:switch(e.bendStyle){case g.Default:l=r;break;case g.Gradual:l.push(new ye(0,e.bendPoints[0].value)),l.push(new ye(ye.MaxPosition,e.bendPoints[1].value));break;case g.Fast:const s=Ms.DefaultBend+e.bendPoints[0].value*Ms.DefaultBendSemitone;return this._handler.addBend(n.index,t,i,0|s),void this.generateSongBookWhammyOrBend(t,i,a,n,!1,[e.bendPoints[0].value,e.bendPoints[1].value],h)}}this.generateWhammyOrBend(t,i,a,l,n)}generateSongBookWhammyOrBend(e,t,s,i,a,r,n){const o=a?e:e+s-n,h=n/(r.length-1);for(let e=0;e<r.length-1;e++){const s=Ms.DefaultBend+r[e]*Ms.DefaultBendSemitone,a=Ms.DefaultBend+r[e+1]*Ms.DefaultBendSemitone,n=o+h*e;this.generateBendValues(n,t,i,h,s,a)}}generateWhammy(e,t,s,i){const a=e.whammyBarPoints,r=e.voice.bar.staff.track,n=s.noteOnly;a[0].value>0&&!e.isContinuedWhammy&&t--;let o=[];switch(e.whammyBarType){case M.Custom:o=a;break;case M.Dive:switch(e.whammyStyle){case g.Default:o=a;break;case g.Gradual:o.push(new ye(0,a[0].value)),o.push(new ye(ye.MaxPosition,a[1].value));break;case g.Fast:const e=Math.min(n,me.millisToTicks(this._settings.player.songBookBendDuration,this._currentTempo));return void this.generateSongBookWhammyOrBend(t,i,n,r,!1,[a[0].value,a[1].value],e)}break;case M.Dip:switch(e.whammyStyle){case g.Default:o=a;break;case g.Gradual:o.push(new ye(0,a[0].value)),o.push(new ye(ye.MaxPosition/2|0,a[1].value)),o.push(new ye(ye.MaxPosition,a[2].value));break;case g.Fast:const e=Math.min(n,me.millisToTicks(this._settings.player.songBookDipDuration,this._currentTempo));return void this.generateSongBookWhammyOrBend(t,i,n,r,!0,[a[0].value,a[1].value,a[2].value],e)}break;case M.Hold:case M.Predive:o=a;break;case M.PrediveDive:switch(e.whammyStyle){case g.Default:o=a;break;case g.Gradual:o.push(new ye(0,a[0].value)),o.push(new ye(ye.MaxPosition/2|0,a[0].value)),o.push(new ye(ye.MaxPosition,a[1].value));break;case g.Fast:const e=Ms.DefaultBend+a[0].value*Ms.DefaultBendSemitone;this._handler.addBend(r.index,t,i,0|e);const s=Math.min(n,me.millisToTicks(this._settings.player.songBookBendDuration,this._currentTempo));return void this.generateSongBookWhammyOrBend(t,i,n,r,!1,[a[0].value,a[1].value],s)}}this.generateWhammyOrBend(t,i,n,o,r)}generateWhammyOrBend(e,t,s,i,a){const r=s/ye.MaxPosition;for(let s=0;s<i.length-1;s++){const n=i[s],o=i[s+1],h=Ms.DefaultBend+n.value*Ms.DefaultBendSemitone,l=Ms.DefaultBend+o.value*Ms.DefaultBendSemitone,d=r*(o.offset-n.offset),c=e+r*n.offset;this.generateBendValues(c,t,a,d,h,l)}}generateBendValues(e,t,s,i,a,r){const n=i/Math.abs(r-a);if(a<r)for(;a<=r;)this._handler.addBend(s.index,0|e,t,Math.round(a)),a++,e+=n;else if(a>r)for(;a>=r;)this._handler.addBend(s.index,0|e,t,Math.round(a)),a--,e+=n;else this._handler.addBend(s.index,0|e,t,Math.round(a))}generateTrill(e,t,s,i,a,r){const n=e.beat.voice.bar.staff.track,o=e.stringTuning+e.trillFret;let h=me.toTicks(e.trillSpeed),l=!0,d=t,c=t+s.untilTieEnd;for(;d+10<c;)d+h>=c&&(h=c-d),this._handler.addNote(n.index,d,h,l?o:i,a,r),l=!l,d+=h}generateTremoloPicking(e,t,s,i,a,r){const n=e.beat.voice.bar.staff.track;let o=me.toTicks(e.beat.tremoloSpeed),h=t;const l=t+s.untilTieEnd;for(;h+10<l;)h+o>=l&&(o=l-h),this._handler.addNote(n.index,h,o,i,a,r),h+=o}getBrushInfo(e){const t=new Int32Array(e.voice.bar.staff.tuning.length);if(e.brushType!==m.None){let s=0,i=0;for(const t of e.notes)t.isTieDestination||(s|=1<<t.string-1,i++);if(e.notes.length>0){let a=0;const r=e.brushDuration/(i-1)|0;for(let i=0;i<e.voice.bar.staff.tuning.length;i++){let n=e.brushType===m.ArpeggioDown||e.brushType===m.BrushDown?i:t.length-1-i;0!=(s&1<<n)&&(t[n]=a,a+=r)}}}return t}generateAutomation(e,t,s){switch(t.type){case d.Instrument:this._handler.addProgramChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,255&(0|t.value)),this._handler.addProgramChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,255&(0|t.value));break;case d.Balance:let i=Ms.toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,te.PanCoarse,i),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,te.PanCoarse,i);break;case d.Volume:let a=Ms.toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,te.VolumeCoarse,a),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,te.VolumeCoarse,a)}}}Ms.DefaultDurationDead=30,Ms.DefaultDurationPalmMute=80,Ms.DefaultBend=32,Ms.DefaultBendSemitone=2.75;class Es{constructor(){this.startTick=0,this.endTick=0}}class Ds{constructor(e=0,t=0){this.x=0,this.y=0,this.width=0,this.x=e,this.y=t}get scale(){return this.renderer.scale}doLayout(){}paint(e,t,s){}}class Is extends Ds{constructor(e,t){super(0,0),this.ties=[],this.minWidth=0,this.beat=e,this.ties=[],this.voiceContainer=t}get onTimeX(){return this.onNotes.x+this.onNotes.centerX}registerLayoutingInfo(e){let t=this.onTimeX,s=0;for(let e of this.ties)e.width>s&&(s=e.width);s+=this.onNotes.x+(this.onNotes.width-this.onNotes.centerX),e.addBeatSpring(this.beat,t,s),e.setPreBeatSize(this.beat,this.preNotes.width),e.setOnBeatSize(this.beat,this.onNotes.width),e.setBeatCenterX(this.beat,this.onNotes.centerX)}applyLayoutingInfo(e){let t=e.getBeatCenterX(this.beat)-this.onNotes.centerX;this.preNotes.x=t,this.preNotes.width=e.getPreBeatSize(this.beat),this.onNotes.width=e.getOnBeatSize(this.beat),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.updateBeamingHelper()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout();let e=this.beat.notes.length-1;for(;e>=0;)this.createTies(this.beat.notes[e--]);this.updateWidth()}updateWidth(){if(this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest)if(1===this.onNotes.beamingHelper.beats.length)this.beat.duration>=b.Eighth&&(this.minWidth+=20*this.scale);else switch(this.beat.duration){case b.OneHundredTwentyEighth:case b.TwoHundredFiftySixth:this.minWidth+=10*this.scale}let e=0;for(let t of this.ties)t.width>e&&(e=t.width);this.minWidth+=e,this.width=this.minWidth}scaleToWidth(e){for(let e of this.ties)e.doLayout();this.onNotes.updateBeamingHelper(),this.width=e}createTies(e){}static getGroupId(e){return"b"+e.id}paint(e,t,s){if(this.beat.voice.isEmpty)return;if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&0===this.ties.length)return;s.beginGroup(Is.getGroupId(this.beat)),this.preNotes.paint(e+this.x,t+this.y,s),this.onNotes.paint(e+this.x,t+this.y,s);let i=e-this.voiceContainer.x-this.renderer.x,a=t-this.voiceContainer.y-this.renderer.y;for(let e=0,t=this.ties.length;e<t;e++){let t=this.ties[e];t.renderer=this.renderer,t.paint(i,a,s)}s.endGroup()}}class Rs{constructor(){this.oldWidth=0,this.newWidth=0,this.settings=null}core(){return this.settings&&this.causeIssue()?this.settings.core:new Dr}causeIssue(){return this.settings=null,!0}}class Os{constructor(e){this.bounds=null,this.beat=e}}class As extends Error{constructor(e,t){super(e),this.xhr=t}}class Gs extends Error{constructor(){super("No compatible importer found")}}class Vs{static loadScoreAsync(e,t,s,i){let a=new XMLHttpRequest;if(a.open("GET",e,!0,null,null),a.responseType="arraybuffer",a.onreadystatechange=()=>{if(a.readyState===XMLHttpRequest.DONE){let e=a.response;if(200===a.status||0===a.status&&e)try{let e=a.response,s=new Uint8Array(e),r=Vs.loadScoreFromBytes(s,i);t(r)}catch(e){s(e)}else 0===a.status?s(new As("You are offline!!\n Please Check Your Network.",a)):404===a.status?s(new As("Requested URL not found.",a)):500===a.status?s(new As("Internel Server Error.",a)):"parsererror"===a.statusText?s(new As("Error.\nParsing JSON Request failed.",a)):"timeout"===a.statusText?s(new As("Request Time out.",a)):s(new As("Unknow Error: "+a.responseText,a))}},"arraybuffer"!==a.responseType){let s=VbAjaxLoader("GET",e).toArray(),a="",r=0;for(;r<s.length-1;)a+=s[r].toString(),r++;let n=Vs.getBytesFromString(a),o=Vs.loadScoreFromBytes(n,i);t(o)}a.send()}static getBytesFromString(e){let t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);return t}static loadScoreFromBytes(e,t){t||(t=new ls);let s=Er.buildImporters();we.info("ScoreLoader","Loading score from "+e.length+" bytes using "+s.length+" importers",null);let i=null,a=Ye.fromBuffer(e);for(let e of s){a.reset();try{we.info("ScoreLoader","Importing using importer "+e.name),e.init(a,t),i=e.readScore(),we.info("ScoreLoader","Score imported using "+e.name);break}catch(t){if(!(t instanceof pe))throw we.info("ScoreLoader","Score import failed due to unexpected error: "+t,null),t;we.info("ScoreLoader",e.name+" does not support the file")}}if(i)return i;throw we.error("ScoreLoader","No compatible importer found for file"),new Gs}}class Hs{constructor(e){this.mouseEvent=e}get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(e){let t=e.element,s=t.getBoundingClientRect().left+t.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-s}getY(e){let t=e.element,s=t.getBoundingClientRect().top+t.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-s}preventDefault(){this.mouseEvent.preventDefault()}}class Ws{constructor(e){this.element=e,this.mouseDown={on:e=>{this.element.addEventListener("mousedown",t=>{e(new Hs(t))},!0)},off:e=>{}},this.mouseUp={on:e=>{this.element.addEventListener("mouseup",t=>{e(new Hs(t))},!0)},off:e=>{}},this.mouseMove={on:e=>{this.element.addEventListener("mousemove",t=>{e(new Hs(t))},!0)},off:e=>{}},this.scroll={on:e=>{window.addEventListener("scroll",e,!0)},off:e=>{window.removeEventListener("scroll",e,!0)}},this.resize={on:e=>{window.addEventListener("resize",e,!0)},off:e=>{window.removeEventListener("resize",e,!0)}}}get top(){return parseFloat(this.element.style.top)}set top(e){this.element.style.top=e+"px"}get left(){return parseFloat(this.element.style.top)}set left(e){this.element.style.left=e+"px"}get width(){return this.element.offsetWidth}set width(e){this.element.style.width=e+"px"}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(e){this.element.scrollTop=e}get scrollTop(){return this.element.scrollLeft}set scrollTop(e){this.element.scrollTop=e}get height(){return this.element.offsetHeight}set height(e){this.element.style.height=e>=0?e+"px":"100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}stopAnimation(){this.element.style.transition="none"}transitionToX(e,t){this.element.style.transition="all 0s linear",this.element.style.transitionDuration=e+"ms",this.element.style.left=t+"px"}appendChild(e){this.element.appendChild(e.element)}clear(){this.element.innerHTML=""}}class zs{constructor(e,t="BESbwy"){this._isStarted=!1,this.isFontLoaded=!1,this.fontLoaded=new qt,this._family=e,this._fallbackText=t}checkForFontAvailability(){if(i.isRunningInWorker)return void(this.isFontLoaded=!1);if(this._isStarted)return;this._isStarted=!0;let e=0,t=window.setInterval(()=>{e++,we.warning("Rendering",`Could not load font '${this._family}' within ${5*e} seconds`,null)},5e3);if(we.debug("Font","Start checking for font availablility: "+this._family),i.supportsFontsApi){we.debug("Font",`[${this._family}] Font API available`);let e=()=>{document.fonts.load("1em "+this._family).then(()=>(we.debug("Font",`[${this._family}] Font API signaled loaded`),document.fonts.check("1em "+this._family)?(we.info("Rendering",`[${this._family}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(t),this.fontLoaded.trigger(this._family)):(we.debug("Font",`[${this._family}] Font API loaded reported, but font not available, checking later again`,null),window.setTimeout(()=>{e()},250)),!0))};e()}else{let e,s,i;we.debug("Font",`[${this._family}] Font API not available, using resize trick`,null);let a=-1,r=-1,n=-1,o=()=>{e||(e=this.createCheckerElement("sans-serif"),s=this.createCheckerElement("serif"),i=this.createCheckerElement("monospace"),document.body.appendChild(e),document.body.appendChild(s),document.body.appendChild(i),a=e.offsetWidth,r=s.offsetWidth,n=i.offsetWidth,e.style.fontFamily=`'${this._family}',sans-serif`,s.style.fontFamily=`'${this._family}',serif`,i.style.fontFamily=`'${this._family}',monospace`);let h=e.offsetWidth,l=s.offsetWidth,d=i.offsetWidth;(h!==a&&l!==r||h!==a&&d!==n||l!==r&&d!==n)&&(h===l||h===d||l===d)?(document.body.removeChild(e),document.body.removeChild(s),document.body.removeChild(i),this.isFontLoaded=!0,window.clearInterval(t),this.fontLoaded.trigger(this._family)):window.setTimeout(o,250)};window.addEventListener("DOMContentLoaded",()=>{o()})}}createCheckerElement(e){let t=document.createElement("span");return t.style.display="inline-block",t.style.position="absolute",t.style.overflow="hidden",t.style.top="-1000px",t.style.fontSize="100px",t.style.fontFamily=e,t.innerHTML=this._fallbackText,document.body.appendChild(t),t}}class Us{constructor(e){this._writePosition=0,this._readPosition=0,this.count=0,this._buffer=new Float32Array(e)}clear(){this._readPosition=0,this._writePosition=0,this.count=0,this._buffer=new Float32Array(this._buffer.length)}write(e,t,s){let i=0;s>this._buffer.length-this.count&&(s=this._buffer.length-this.count);const a=Math.min(this._buffer.length-this._writePosition,s);return this._buffer.set(e.subarray(t,t+a),this._writePosition),this._writePosition+=a,this._writePosition%=this._buffer.length,i+=a,i<s&&(this._buffer.set(e.subarray(t+i,t+i+s-i),this._writePosition),this._writePosition+=s-i,i=s),this.count+=i,i}read(e,t,s){s>this.count&&(s=this.count);let i=0;const a=Math.min(this._buffer.length-this._readPosition,s);return e.set(this._buffer.subarray(this._readPosition,this._readPosition+a),t),i+=a,this._readPosition+=a,this._readPosition%=this._buffer.length,i<s&&(e.set(this._buffer.subarray(this._readPosition,this._readPosition+s-i),t+i),this._readPosition+=s-i,i=s),this.count-=i,i}}class Xs{constructor(){this._context=null,this._buffer=null,this._source=null,this._audioNode=null,this._finished=!1,this.ready=new Qt,this.samplesPlayed=new qt,this.sampleRequest=new Qt,this.finished=new Qt}get sampleRate(){return this._context?this._context.sampleRate:Xs.PreferredSampleRate}open(){this._finished=!1,this.patchIosSampleRate(),this._circularBuffer=new Us(Xs.BufferSize*Xs.BufferCount),this._context=new AudioContext;let e=this._context;if("suspended"===e.state){let t=()=>{e.resume(),window.setTimeout(()=>{"running"===e.state&&(document.body.removeEventListener("touchend",t,!1),document.body.removeEventListener("click",t,!1))},0)};document.body.addEventListener("touchend",t,!1),document.body.addEventListener("click",t,!1)}this.ready.trigger()}activate(){if(this._context){this._context.resume()}}patchIosSampleRate(){let e=navigator.userAgent;if(-1!==e.indexOf("iPhone")||0!==e.indexOf("iPad")){let e=new AudioContext,t=e.createBuffer(1,1,Xs.PreferredSampleRate),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start(0),s.disconnect(0),e.close()}}play(){let e=this._context;e&&("suspended"!==e.state&&"interrupted"!==e.state||e.resume(),this._buffer=e.createBuffer(2,4096,e.sampleRate),this._audioNode=e.createScriptProcessor(4096,0,2),this._audioNode.onaudioprocess=this.generateSound.bind(this),this._circularBuffer.clear(),this.requestBuffers(),this._finished=!1,this._source=e.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0,this._source.connect(this._audioNode,0,0),this._source.start(0),this._audioNode.connect(e.destination,0,0))}pause(){this._source&&(this._source.stop(0),this._source.disconnect(0)),this._source=null,this._audioNode&&this._audioNode.disconnect(0),this._audioNode=null}sequencerFinished(){this._finished=!0}addSamples(e){this._circularBuffer.write(e,0,e.length)}resetSamples(){this._circularBuffer.clear()}requestBuffers(){if(this._circularBuffer.count<20480&&this.sampleRequest)for(let e=0;e<5;e++)this.sampleRequest.trigger()}generateSound(e){let t=e.outputBuffer.getChannelData(0),s=e.outputBuffer.getChannelData(1),i=t.length+s.length;if(this._circularBuffer.count<i)this._finished&&this.finished.trigger();else{let e=new Float32Array(i);this._circularBuffer.read(e,0,e.length);let a=0;for(let i=0;i<t.length;i++)t[i]=e[a++],s[i]=e[a++];this.samplesPlayed.trigger(t.length)}this._finished||this.requestBuffers()}}Xs.BufferSize=4096,Xs.BufferCount=10,Xs.PreferredSampleRate=44100;class Ys{constructor(e,t){this.loaded=e,this.total=t}}class Js{constructor(e,t,s){this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=q.Paused,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._tickPosition=0,this._timePosition=0,this._isLooping=!1,this._playbackRange=null,this.ready=new Qt,this.readyForPlayback=new Qt,this.finished=new Qt,this.soundFontLoaded=new Qt,this.soundFontLoadFailed=new qt,this.midiLoaded=new Qt,this.midiLoadFailed=new qt,this.stateChanged=new qt,this.positionChanged=new qt,this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=q.Paused,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._tickPosition=0,this._timePosition=0,this._isLooping=!1,this._playbackRange=null,this._output=e,this._output.ready.on(this.onOutputReady.bind(this)),this._output.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this._output.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this._output.finished.on(this.onOutputFinished.bind(this)),this._output.open();try{let e=new Blob(["importScripts('"+t+"')"]);this._synth=new Worker(URL.createObjectURL(e))}catch(e){try{this._synth=new Worker(t)}catch(e){return void we.error("AlphaSynth","Failed to create WebWorker: "+e)}}this._synth.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this._synth.postMessage({cmd:"alphaSynth.initialize",sampleRate:this._output.sampleRate,logLevel:s}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}get isReady(){return this._workerIsReady&&this._outputIsReady}get isReadyForPlayback(){return this._workerIsReadyForPlayback}get state(){return this._state}get logLevel(){return we.logLevel}set logLevel(e){we.logLevel=e,this._synth.postMessage({cmd:"alphaSynth.setLogLevel",value:e})}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Gt.clamp(e,Yt.MinVolume,Yt.MaxVolume),this._masterVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMasterVolume",value:e})}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Gt.clamp(e,Yt.MinVolume,Yt.MaxVolume),this._metronomeVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:e})}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){e=Gt.clamp(e,Yt.MinPlaybackSpeed,Yt.MaxPlaybackSpeed),this._playbackSpeed=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:e})}get tickPosition(){return this._tickPosition}set tickPosition(e){e<0&&(e=0),this._tickPosition=e,this._synth.postMessage({cmd:"alphaSynth.setTickPosition",value:e})}get timePosition(){return this._timePosition}set timePosition(e){e<0&&(e=0),this._timePosition=e,this._synth.postMessage({cmd:"alphaSynth.setTimePosition",value:e})}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._synth.postMessage({cmd:"alphaSynth.setIsLooping",value:e})}get playbackRange(){return this._playbackRange}set playbackRange(e){e&&(e.startTick<0&&(e.startTick=0),e.endTick<0&&(e.endTick=0)),this._playbackRange=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackRange",value:e})}destroy(){this._synth.terminate()}play(){return!(this.state===q.Playing||!this.isReadyForPlayback)&&(this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.play"}),!0)}pause(){this._synth.postMessage({cmd:"alphaSynth.pause"})}playPause(){this._synth.postMessage({cmd:"alphaSynth.playPause"})}stop(){this._synth.postMessage({cmd:"alphaSynth.stop"})}loadSoundFont(e){this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:e})}loadSoundFontFromUrl(e,t){we.info("AlphaSynth","Start loading Soundfont from url "+e);let s=new XMLHttpRequest;s.open("GET",e,!0,null,null),s.responseType="arraybuffer",s.onload=e=>{let t=new Uint8Array(s.response);this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:t})},s.onerror=e=>{we.error("AlphaSynth","Loading failed: "+e.message),this.soundFontLoadFailed.trigger(new As(e.message,s))},s.onprogress=e=>{we.debug("AlphaSynth",`Soundfont downloading: ${e.loaded}/${e.total} bytes`),t(new Ys(e.loaded,e.total))},s.send()}loadMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.loadMidi",midi:ds.midiFileToJsObject(e)})}setChannelMute(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelMute",channel:e,mute:t})}resetChannelStates(){this._synth.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelSolo",channel:e,solo:t})}setChannelVolume(e,t){t=Gt.clamp(t,Yt.MinVolume,Yt.MaxVolume),this._synth.postMessage({cmd:"alphaSynth.setChannelVolume",channel:e,volume:t})}setChannelProgram(e,t){t=Gt.clamp(t,Yt.MinProgram,Yt.MaxProgram),this._synth.postMessage({cmd:"alphaSynth.setChannelProgram",channel:e,program:t})}handleWorkerMessage(e){let t=e.data;switch(t.cmd){case"alphaSynth.ready":this._workerIsReady=!0,this.checkReady();break;case"alphaSynth.readyForPlayback":this._workerIsReadyForPlayback=!0,this.checkReadyForPlayback();break;case"alphaSynth.positionChanged":this._timePosition=t.currentTime,this._tickPosition=t.currentTick,this.positionChanged.trigger(new Zt(t.currentTime,t.endTime,t.currentTick,t.endTick));break;case"alphaSynth.playerStateChanged":this._state=t.state,this.stateChanged.trigger(new $t(t.state,t.stopped));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(t.error);break;case"alphaSynth.midiLoaded":this.checkReadyForPlayback(),this.midiLoaded.trigger();break;case"alphaSynth.midiLoadFailed":this.checkReadyForPlayback(),this.midiLoadFailed.trigger(t.error);break;case"alphaSynth.output.sequencerFinished":this._output.sequencerFinished();break;case"alphaSynth.output.addSamples":this._output.addSamples(t.samples);break;case"alphaSynth.output.play":this._output.play();break;case"alphaSynth.output.pause":this._output.pause();break;case"alphaSynth.output.resetSamples":this._output.resetSamples()}}checkReady(){this.isReady&&this.ready.trigger()}checkReadyForPlayback(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}onOutputSampleRequest(){this._synth.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputFinished(){this._synth.postMessage({cmd:"alphaSynth.output.finished"})}onOutputSamplesPlayed(e){this._synth.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:e})}onOutputReady(){this._outputIsReady=!0,this.checkReady()}}class Qs{constructor(e,t){if(this._width=0,this.boundsLookup=null,this.preRender=new qt,this.partialRenderFinished=new qt,this.renderFinished=new qt,this.postRenderFinished=new Qt,this.error=new qt,this._api=e,t.core.scriptFile){try{let e=`importScripts('${t.core.scriptFile}')`,s=new Blob([e]);this._worker=new Worker(URL.createObjectURL(s))}catch(e){try{this._worker=new Worker(t.core.scriptFile)}catch(t){return void we.error("Rendering","Failed to create WebWorker: "+e)}}this._worker.postMessage({cmd:"alphaTab.initialize",settings:this.serializeSettingsForWorker(t)}),this._worker.addEventListener("message",this.handleWorkerMessage.bind(this))}else we.error("Rendering","Could not detect alphaTab script file, cannot initialize renderer")}destroy(){this._worker.terminate()}updateSettings(e){this._worker.postMessage({cmd:"alphaTab.updateSettings",settings:this.serializeSettingsForWorker(e)})}serializeSettingsForWorker(e){let t=ls.toJson(e);return t.player=null,t}render(){this._worker.postMessage({cmd:"alphaTab.render"})}resizeRender(){this._worker.postMessage({cmd:"alphaTab.resizeRender"})}get width(){return this._width}set width(e){this._width=e,this._worker.postMessage({cmd:"alphaTab.setWidth",width:e})}handleWorkerMessage(e){let t=e.data;switch(t.cmd){case"alphaTab.preRender":this.preRender.trigger(t.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(t.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(t.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=_s.fromJson(t.boundsLookup,this._api.score),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(t.error)}}renderScore(e,t){let s=ds.scoreToJsObject(e);this._worker.postMessage({cmd:"alphaTab.renderScore",score:s,trackIndexes:t,fontSizes:ps.FontSizeLookupTables})}}class qs{constructor(e,t,s,i){this.cursorWrapper=e,this.barCursor=t,this.beatCursor=s,this.selectionWrapper=i}}class js{constructor(e){this._fontCheckers=new Map,this._contents=null,this._file=null,this._visibilityCheckIntervalId=0,this._visibilityCheckInterval=0,this._totalResultCount=0,this._initialTrackIndexes=null,this._rootContainerBecameVisible=new Qt,this.canRenderChanged=new Qt,e.classList.add("alphaTab"),this.rootContainer=new Ws(e),this.areWorkersSupported="Worker"in window,Er.bravuraFontChecker.fontLoaded.on(this.onFontLoaded.bind(this)),this.rootContainerBecameVisible={on:e=>{this.rootContainer.isVisible?e():(this._rootContainerBecameVisible.on(e),0===this._visibilityCheckIntervalId&&(this._visibilityCheckIntervalId=window.setInterval(()=>{this._api.container.isVisible&&(window.clearInterval(this._visibilityCheckIntervalId),this._visibilityCheckIntervalId=0,this._rootContainerBecameVisible.trigger())},this._visibilityCheckInterval)))},off:e=>{this._rootContainerBecameVisible.off(e)}}}get resizeThrottle(){return 10}get canRender(){return this.areAllFontsLoaded()}areAllFontsLoaded(){if(Er.bravuraFontChecker.checkForFontAvailability(),!Er.bravuraFontChecker.isFontLoaded)return!1;for(let e of this._fontCheckers){if(!e[1].isFontLoaded)return!1}return we.debug("Font","All fonts loaded: "+this._fontCheckers.size),!0}onFontLoaded(e){ps.generateFontLookup(e),this.areAllFontsLoaded()&&this.canRenderChanged.trigger()}createWorkerRenderer(){return new Qs(this._api,this._api.settings)}initialize(t,s){this._api=t;let i=new ls;i.fillFromJson(s);let a,r=this.getDataAttributes();i.fillFromDataAttributes(r),i.notation.notationMode===e.NotationMode.SongBook&&i.setSongBookModeSettings(),t.settings=i,"default"!==i.core.engine&&"svg"!==i.core.engine||(t.container.scroll.on(this.showSvgsInViewPort.bind(this)),t.container.resize.on(this.showSvgsInViewPort.bind(this))),this.setupFontCheckers(i);let n=s;a=n&&n.tracks?n.tracks:r.has("tracks")?r.get("tracks"):0,this._initialTrackIndexes=this.parseTracks(a),this._contents="";let o=t.container;r.has("tex")&&o.element.innerText&&(this._contents=o.element.innerHTML,o.element.innerHTML=""),this.createStyleElement(i),n&&n.file?this._file=n.file:r.has("file")&&(this._file=r.get("file")),this._visibilityCheckInterval=500,n&&n.visibilityCheckInterval&&(this._visibilityCheckInterval=n.visibilityCheckInterval)}setupFontCheckers(e){this.registerFontChecker(e.display.resources.copyrightFont),this.registerFontChecker(e.display.resources.effectFont),this.registerFontChecker(e.display.resources.fingeringFont),this.registerFontChecker(e.display.resources.graceFont),this.registerFontChecker(e.display.resources.markerFont),this.registerFontChecker(e.display.resources.tablatureFont),this.registerFontChecker(e.display.resources.titleFont),this.registerFontChecker(e.display.resources.wordsFont),this.registerFontChecker(e.display.resources.barNumberFont),this.registerFontChecker(e.display.resources.fretboardNumberFont),this.registerFontChecker(e.display.resources.subTitleFont)}registerFontChecker(e){if(!this._fontCheckers.has(e.family)){let t=new zs(e.family);this._fontCheckers.set(e.family,t),t.fontLoaded.on(this.onFontLoaded.bind(this)),t.checkForFontAvailability()}}destroy(){this.rootContainer.element.innerHTML=""}createCanvasElement(){let e=document.createElement("div");return e.className="at-surface",e.style.fontSize="0",e.style.overflow="hidden",e.style.lineHeight="0",new Ws(e)}triggerEvent(e,t,s=null,i){let a=e.element;t="alphaTab."+t;let r=document.createEvent("CustomEvent"),n=i?i.mouseEvent:null;if(r.initCustomEvent(t,!1,!1,s),n&&(r.originalEvent=n),a.dispatchEvent(r),window&&"jQuery"in window){let e=window.jQuery,i=[];i.push(s),n&&i.push(n),e(a).trigger(t,i)}}load(e,t,s){if(e instanceof Ce)return t(e),!0;if(e instanceof ArrayBuffer){let s=new Uint8Array(e);return t(Vs.loadScoreFromBytes(s,this._api.settings)),!0}return e instanceof Uint8Array?(t(Vs.loadScoreFromBytes(e,this._api.settings)),!0):"string"==typeof e&&(Vs.loadScoreAsync(e,t,s,this._api.settings),!0)}loadSoundFont(e){return!!this._api.player&&(e instanceof ArrayBuffer?(this._api.player.loadSoundFont(new Uint8Array(e)),!0):e instanceof Uint8Array?(this._api.player.loadSoundFont(e),!0):"string"==typeof e&&(this._api.loadSoundFontFromUrl(e),!0))}initialRender(){this._api.renderer.preRender.on(e=>{this._totalResultCount=0}),this.rootContainerBecameVisible.on(()=>{this._api.renderer.width=0|this.rootContainer.width,this._api.renderer.updateSettings(this._api.settings),this._contents?this._api.tex(this._contents):this._file&&Vs.loadScoreAsync(this._file,e=>{var t;this._api.renderScore(e,null!==(t=this._initialTrackIndexes)&&void 0!==t?t:void 0),this._initialTrackIndexes=null},e=>{this._api.onError(e)},this._api.settings)})}showSvgsInViewPort(){let e=this._api.canvasElement.element.querySelectorAll("[data-lazy=true]");for(let t=0;t<e.length;t++){let s=e.item(t);this.isElementInViewPort(s)&&(s.outerHTML=s.svg)}}isElementInViewPort(e){let t=e.getBoundingClientRect();return t.top+t.height>=0&&t.top<=window.innerHeight&&t.left+t.width>=0&&t.left<=window.innerWidth}createStyleElement(e){let t=this._api.container.element.ownerDocument;Er.createStyleElement(t,e.core.fontDirectory)}parseTracks(e){if(!e)return[];let t=[];if("string"==typeof e)try{if("all"===e)return[-1];e=JSON.parse(e)}catch(t){e=[0]}if("number"==typeof e)t.push(e);else if("length"in e){let s=e.length,i=e;for(let e=0;e<s;e++){let s=i[e],a=0;a="number"==typeof s?s:"index"in s?s.index:parseInt(s.toString()),a>=0&&t.push(a)}}else"index"in e&&t.push(e.index);return t}getDataAttributes(){let e=new Map,t=this._api.container.element;if(t.dataset)for(let s of Object.keys(t.dataset)){let i=t.dataset[s];try{let e=i;i=JSON.parse(e)}catch(e){""===i&&(i=null)}e.set(s,i)}else for(let s=0;s<t.attributes.length;s++){let i=t.attributes.item(s),a=i.nodeName;if(a.startsWith("data-")){let t=a.substr(5).split("-"),s=t[0];for(let e=1;e<t.length;e++)s+=t[e].substr(0,1).toUpperCase()+t[e].substr(1);let r=i.nodeValue;try{r=JSON.parse(r)}catch(e){""===r&&(r=null)}e.set(s,r)}}return e}beginAppendRenderResults(e){window.setTimeout(()=>{let t=this._api.canvasElement.element;if(e){let s=e.renderResult;if("string"==typeof s){let i;this._totalResultCount<t.childElementCount?i=t.childNodes.item(this._totalResultCount):(i=document.createElement("div"),t.appendChild(i)),i.style.width=e.width+"px",i.style.height=e.height+"px",i.style.display="inline-block",this.isElementInViewPort(i)||!this._api.settings.core.enableLazyLoading?i.outerHTML=s:(i.svg=s,i.setAttribute("data-lazy","true"))}else this._totalResultCount<t.childElementCount?t.replaceChild(e.renderResult,t.childNodes.item(this._totalResultCount)):t.appendChild(e.renderResult);this._totalResultCount++}else{for(;t.childElementCount>this._totalResultCount;)t.removeChild(t.lastChild);this._api.settings.core.enableLazyLoading&&this.showSvgsInViewPort()}},1)}createWorkerPlayer(){let e="ScriptProcessorNode"in window,t=Er.scriptFile;if(!t)return we.error("Player","alphaTab script file could not be detected, player cannot initialize"),null;let s=null;return e&&(we.info("Player","Will use webworkers for synthesizing and web audio api for playback"),s=new Js(new Xs,t,this._api.settings.core.logLevel)),s?s.ready.on(()=>{this._api.settings.player.soundFont&&this._api.loadSoundFontFromUrl(this._api.settings.player.soundFont)}):we.error("Player","Player requires webworkers and web audio api, browser unsupported",null),s}beginInvoke(e){window.requestAnimationFrame(()=>{e()})}highlightElements(e){let t=this._api.container.element.getElementsByClassName(e);for(let e=0;e<t.length;e++)t.item(e).classList.add("at-highlight")}removeHighlights(){let e=this._api.container.element.getElementsByClassName("at-highlight");for(;e.length>0;)e.item(0).classList.remove("at-highlight")}destroyCursors(){let e=this._api.container.element,t=e.querySelector(".at-cursors");e.removeChild(t)}createCursors(){let e=this._api.container.element,t=document.createElement("div");t.classList.add("at-cursors");let s=document.createElement("div");s.classList.add("at-selection");let i=document.createElement("div");i.classList.add("at-cursor-bar");let a=document.createElement("div");return a.classList.add("at-cursor-beat"),e.style.position="relative",e.style.textAlign="left",t.style.position="absolute",t.style.zIndex="1000",t.style.display="inline",t.style.pointerEvents="none",s.style.position="absolute",i.style.position="absolute",a.style.position="absolute",a.style.transition="all 0s linear",e.insertBefore(t,e.firstChild),t.appendChild(s),t.appendChild(i),t.appendChild(a),new qs(new Ws(t),new Ws(i),new Ws(a),new Ws(s))}getOffset(e,t){let s=t.element,i=s.getBoundingClientRect(),a=i.top+s.ownerDocument.defaultView.pageYOffset,r=i.left+s.ownerDocument.defaultView.pageXOffset;if(e){let t=e.element,s=t.nodeName.toLowerCase();if("html"!==s&&"body"!==s){let s=this.getOffset(null,e);a=a+t.scrollTop-s.y,r=r+t.scrollLeft-s.x}}let n=new Je;return n.x=r,n.y=a,n.w=i.width,n.h=i.height,n}getScrollContainer(){let e="string"==typeof this._api.settings.player.scrollElement?document.querySelector(this._api.settings.player.scrollElement):this._api.settings.player.scrollElement,t=e.nodeName.toLowerCase();if("html"===t||"body"===t){e=navigator.userAgent.match("((iPod|iPhone|iPad|Android))")?document.body:document.documentElement}return new Ws(e)}createSelectionElement(){let e=document.createElement("div");return e.style.position="absolute",new Ws(e)}scrollToY(e,t,s){this.internalScrollToY(e.element,t,s)}scrollToX(e,t,s){this.internalScrollToX(e.element,t,s)}internalScrollToY(e,t,s){let i=e.scrollTop,a=t-i,r=0,n=t=>{0===r&&(r=t);let o=t-r,h=Math.min(o/s,1);e.scrollTop=i+a*h|0,o<s&&window.requestAnimationFrame(n)};window.requestAnimationFrame(n)}internalScrollToX(e,t,s){let i=e.scrollLeft,a=t-i,r=0,n=t=>{0===r&&(r=t);let o=t-r,h=Math.min(o/s,1);e.scrollLeft=i+a*h|0,o<s&&window.requestAnimationFrame(n)};window.requestAnimationFrame(n)}}class Ks extends class{constructor(e,t){this._startTime=0,this._trackIndexes=null,this.score=null,this.tracks=[],this._tickCache=null,this.player=null,this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null,this._previousTick=0,this._playerState=q.Paused,this._currentBeat=null,this._previousStateForCursor=q.Paused,this._previousCursorCache=null,this._lastScroll=0,this.playedBeatChanged=new qt,this._beatMouseDown=!1,this._selectionStart=null,this._selectionEnd=null,this.beatMouseDown=new qt,this.beatMouseMove=new qt,this.beatMouseUp=new qt,this.loaded=new qt,this.resize=new qt,this.renderStarted=new qt,this.renderFinished=new Qt,this.postRenderFinished=new Qt,this.error=new qt,this.readyForPlayback=new Qt,this.playerFinished=new Qt,this.soundFontLoaded=new Qt,this.midiLoaded=new Qt,this.playerStateChanged=new qt,this.playerPositionChanged=new qt,this.uiFacade=e,this.container=e.rootContainer,e.initialize(this,t),we.logLevel=this.settings.core.logLevel,this.canvasElement=e.createCanvasElement(),this.container.appendChild(this.canvasElement),this.container.resize.on(i.throttle(()=>{this.container.width!==this.renderer.width&&this.triggerResize()},e.resizeThrottle)),this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&Er.getRenderEngineFactory(this.settings).supportsWorkers?this.renderer=this.uiFacade.createWorkerRenderer():this.renderer=new ws(this.settings);let s=new Rs;s.oldWidth=this.renderer.width,s.newWidth=0|this.container.width,s.settings=this.settings,this.onResize(s),this.renderer.preRender.on(this.onRenderStarted.bind(this)),this.renderer.renderFinished.on(e=>{this.onRenderFinished()}),this.renderer.postRenderFinished.on(()=>{let e=Date.now()-this._startTime;we.info("rendering","Rendering completed in "+e+"ms"),this.onPostRenderFinished()}),this.renderer.preRender.on(e=>{this._startTime=Date.now()}),this.renderer.partialRenderFinished.on(this.appendRenderResult.bind(this)),this.renderer.renderFinished.on(e=>{this.appendRenderResult(e),this.appendRenderResult(null)}),this.renderer.error.on(this.onError.bind(this)),this.settings.player.enablePlayer&&this.setupPlayer(),this.setupClickHandling(),this.uiFacade.initialRender()}destroy(){this.player&&this.player.destroy(),this.uiFacade.destroy(),this.renderer.destroy()}updateSettings(){this.renderer.updateSettings(this.settings),this.settings.player.enablePlayer?this.setupPlayer():this.destroyPlayer()}load(e,t){try{return this.uiFacade.load(e,e=>{this.renderScore(e,t)},e=>{this.onError(e)})}catch(e){return this.onError(e),!1}}renderScore(e,t){let s=[];if(t)if(0===t.length)e.tracks.length>0&&s.push(e.tracks[0]);else if(1===t.length&&-1===t[0])for(let t of e.tracks)s.push(t);else for(let i of t)i>=0&&i<=e.tracks.length&&s.push(e.tracks[i]);else e.tracks.length>0&&s.push(e.tracks[0]);this.internalRenderTracks(e,s)}renderTracks(e){if(e.length>0){let s=e[0].score;for(let i of e)if(i.score!==s)return void this.onError(new t("All rendered tracks must belong to the same score.","tracks"));this.internalRenderTracks(s,e)}}internalRenderTracks(e,t){if(e!==this.score){Ae.applyPitchOffsets(this.settings,e),this.score=e,this.tracks=t,this._trackIndexes=[];for(let e of t)this._trackIndexes.push(e.index);this.onLoaded(e),this.loadMidiForScore(),this.render()}else{this.tracks=t,this._trackIndexes=[];for(let e of t)this._trackIndexes.push(e.index);this.render()}}triggerResize(){if(this.container.isVisible){let e=new Rs;e.oldWidth=this.renderer.width,e.newWidth=this.container.width,e.settings=this.settings,this.onResize(e),this.renderer.updateSettings(this.settings),this.renderer.width=this.container.width,this.renderer.resizeRender()}else we.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{we.info("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()})}appendRenderResult(e){e&&(this.canvasElement.width=e.totalWidth,this.canvasElement.height=e.totalHeight,this._cursorWrapper&&(this._cursorWrapper.width=e.totalWidth,this._cursorWrapper.height=e.totalHeight)),e&&!e.renderResult||this.uiFacade.beginAppendRenderResults(e)}tex(e,t){try{let s=new Ve,a=Ye.fromBuffer(i.stringToByteArray(e));s.init(a,this.settings);let r=s.readScore();this.renderScore(r,t)}catch(e){this.onError(e)}}loadSoundFont(e){return!!this.player&&this.uiFacade.loadSoundFont(e)}render(){this.renderer&&(this.uiFacade.canRender?(this.renderer.width=this.container.width,this.renderer.renderScore(this.score,this._trackIndexes)):this.uiFacade.canRenderChanged.on(()=>this.render()))}get isReadyForPlayback(){return!!this.player&&this.player.isReadyForPlayback}get playerState(){return this.player?this.player.state:q.Paused}get masterVolume(){return this.player?this.player.masterVolume:0}set masterVolume(e){this.player&&(this.player.masterVolume=e)}get metronomeVolume(){return this.player?this.player.metronomeVolume:0}set metronomeVolume(e){this.player&&(this.player.metronomeVolume=e)}get tickPosition(){return this.player?this.player.tickPosition:0}set tickPosition(e){this.player&&(this.player.tickPosition=e)}get timePosition(){return this.player?this.player.timePosition:0}set timePosition(e){this.player&&(this.player.timePosition=e)}get playbackRange(){return this.player?this.player.playbackRange:null}set playbackRange(e){this.player&&(this.player.playbackRange=e)}get playbackSpeed(){return this.player?this.player.playbackSpeed:0}set playbackSpeed(e){this.player&&(this.player.playbackSpeed=e)}get isLooping(){return!!this.player&&this.player.isLooping}set isLooping(e){this.player&&(this.player.isLooping=e)}destroyPlayer(){this.player&&(this.player.destroy(),this.player=null,this.destroyCursors())}setupPlayer(){this.player||(this.player=this.uiFacade.createWorkerPlayer(),this.player&&(this.player.ready.on(()=>{this.loadMidiForScore()}),this.player.readyForPlayback.on(()=>{if(this.onReadyForPlayback(),this.tracks)for(let e of this.tracks){let t=e.playbackInfo.volume/16;this.player.setChannelVolume(e.playbackInfo.primaryChannel,t),this.player.setChannelVolume(e.playbackInfo.secondaryChannel,t)}}),this.player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this.player.soundFontLoadFailed.on(e=>{this.onError(e)}),this.player.midiLoaded.on(this.onMidiLoaded.bind(this)),this.player.midiLoadFailed.on(e=>{this.onError(e)}),this.player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this.player.positionChanged.on(this.onPlayerPositionChanged.bind(this)),this.player.finished.on(this.onPlayerFinished.bind(this)),this.settings.player.enableCursor?this.setupCursors():this.destroyCursors()))}loadMidiForScore(){if(!this.player||!this.score||!this.player.isReady)return;we.info("AlphaTab","Generating Midi");let e=new ts,t=new Ts(e),s=new Ms(this.score,this.settings,t);s.generate(),this._tickCache=s.tickLookup,this.player.loadMidiFile(e)}changeTrackVolume(e,t){if(this.player)for(let s of e)this.player.setChannelVolume(s.playbackInfo.primaryChannel,t),this.player.setChannelVolume(s.playbackInfo.secondaryChannel,t)}changeTrackSolo(e,t){if(this.player)for(let s of e)this.player.setChannelSolo(s.playbackInfo.primaryChannel,t),this.player.setChannelSolo(s.playbackInfo.secondaryChannel,t)}changeTrackMute(e,t){if(this.player)for(let s of e)this.player.setChannelMute(s.playbackInfo.primaryChannel,t),this.player.setChannelMute(s.playbackInfo.secondaryChannel,t)}play(){return!!this.player&&this.player.play()}pause(){this.player&&this.player.pause()}playPause(){this.player&&this.player.playPause()}stop(){this.player&&this.player.stop()}destroyCursors(){this._cursorWrapper&&(this.uiFacade.destroyCursors(),this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null,this._previousTick=0,this._playerState=q.Paused)}setupCursors(){let e=this.uiFacade.createCursors();e&&(this._cursorWrapper=e.cursorWrapper,this._barCursor=e.barCursor,this._beatCursor=e.beatCursor,this._selectionWrapper=e.selectionWrapper,this._previousTick=0,this._playerState=q.Paused,this.renderer.postRenderFinished.on(()=>{this.cursorUpdateTick(this._previousTick,!1)}),this.player&&(this.player.positionChanged.on(e=>{this._previousTick=e.currentTick,this.uiFacade.beginInvoke(()=>{this.cursorUpdateTick(e.currentTick,!1)})}),this.player.stateChanged.on(e=>{if(this._playerState=e.state,!e.stopped&&e.state===q.Paused){let e=this._currentBeat,t=this._tickCache;e&&t&&(this.player.tickPosition=t.getMasterBarStart(e.voice.bar.masterBar)+e.playbackStart)}})))}cursorUpdateTick(e,t=!1){this.uiFacade.beginInvoke(()=>{let s=this._tickCache;if(s){let i=this.tracks;if(i.length>0){let a=s.findBeat(i,e);a&&this.cursorUpdateBeat(a.currentBeat,a.nextBeat,a.duration,t,a.beatsToHighlight)}}})}cursorUpdateBeat(t,s,i,a,r=null){if(!t)return;let n=this.renderer.boundsLookup;if(!n)return;let o=this._currentBeat,h=this._previousCursorCache,l=this._previousStateForCursor;if(this._currentBeat=t,this._previousCursorCache=n,this._previousStateForCursor=this._playerState,t===o&&n===h&&l===this._playerState)return;let d=this._barCursor,c=this._beatCursor,u=n.findBeat(t);if(!u)return;let p=u.barBounds.masterBarBounds,g=p.visualBounds;if(d&&(d.top=g.y,d.left=g.x,d.width=g.w,d.height=g.h),c&&(c.stopAnimation(),c.top=g.y,c.left=u.visualBounds.x,c.height=g.h),this.uiFacade.removeHighlights(),this._playerState===q.Playing||a){if(i/=this.playbackSpeed,!a){if(r)for(let e of r){let t=Is.getGroupId(e);this.uiFacade.highlightElements(t)}let e=p.visualBounds.x+p.visualBounds.w;if(s&&(s.voice.bar.index===t.voice.bar.index||s.voice.bar.index===t.voice.bar.index+1)){let t=n.findBeat(s);t&&t.barBounds.masterBarBounds.staveGroupBounds===p.staveGroupBounds&&(e=t.visualBounds.x)}c&&this.uiFacade.beginInvoke(()=>{c.transitionToX(i,e)})}if(!this._beatMouseDown&&this.settings.player.scrollMode!==e.ScrollMode.Off){let t=this.uiFacade.getScrollContainer(),s=Er.getLayoutEngineFactory(this.settings).vertical,i=this.settings.player.scrollMode,a=this.uiFacade.getOffset(t,this.container);if(s)switch(i){case e.ScrollMode.Continuous:let s=a.y+p.realBounds.y+this.settings.player.scrollOffsetY;s!==this._lastScroll&&(this._lastScroll=s,this.uiFacade.scrollToY(t,s,this.settings.player.scrollSpeed));break;case e.ScrollMode.OffScreen:let i=t.scrollTop+this.uiFacade.getOffset(null,t).h;if(p.visualBounds.y+p.visualBounds.h>=i||p.visualBounds.y<t.scrollTop){let e=p.realBounds.y+this.settings.player.scrollOffsetY;this._lastScroll=p.visualBounds.x,this.uiFacade.scrollToY(t,e,this.settings.player.scrollSpeed)}}else switch(i){case e.ScrollMode.Continuous:if(p.visualBounds.x!==this._lastScroll){let e=p.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=p.visualBounds.x,this.uiFacade.scrollToX(t,e,this.settings.player.scrollSpeed)}break;case e.ScrollMode.OffScreen:let s=t.scrollLeft+this.uiFacade.getOffset(null,t).w;if(p.visualBounds.x+p.visualBounds.w>=s||p.visualBounds.x<t.scrollLeft){let e=p.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=p.visualBounds.x,this.uiFacade.scrollToX(t,e,this.settings.player.scrollSpeed)}}}this.onPlayedBeatChanged(t)}}addPlayedBeatChanged(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.playedBeatChanged.on(e)}removePlayedBeatChanged(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.playedBeatChanged.off(e)}onPlayedBeatChanged(e){this.playedBeatChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",e)}addBeatMouseDown(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.beatMouseDown.on(e)}removeBeatMouseDown(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.beatMouseDown.off(e)}addBeatMouseMove(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.beatMouseMove.on(e)}removeBeatMouseMove(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.beatMouseMove.off(e)}addBeatMouseUp(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.beatMouseUp.on(e)}removeBeatMouseUp(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.beatMouseUp.off(e)}onBeatMouseDown(e,t){this.settings.player.enablePlayer&&this.settings.player.enableCursor&&this.settings.player.enableUserInteraction&&(this._selectionStart=new Os(t),this._selectionEnd=null),this._beatMouseDown=!0,this.beatMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseDown",t,e)}onBeatMouseMove(e,t){this.settings.player.enableUserInteraction&&(this._selectionEnd&&this._selectionEnd.beat===t||(this._selectionEnd=new Os(t),this.cursorSelectRange(this._selectionStart,this._selectionEnd))),this.beatMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseMove",t,e)}onBeatMouseUp(e,t){if(this.settings.player.enableUserInteraction){if(this._selectionEnd){let e=this._selectionStart.beat.absoluteDisplayStart;if(this._selectionStart.beat.absoluteDisplayStart<e){let e=this._selectionStart;this._selectionStart=this._selectionEnd,this._selectionEnd=e}}if(this._selectionStart&&this._tickCache){let e=this._tickCache,t=e.getMasterBarStart(this._selectionStart.beat.voice.bar.masterBar);if(this.cursorUpdateBeat(this._selectionStart.beat,null,0,!1,null),this.tickPosition=t+this._selectionStart.beat.playbackStart,this._selectionEnd&&this._selectionStart.beat!==this._selectionEnd.beat){let s=e.getMasterBarStart(this._selectionEnd.beat.voice.bar.masterBar),i=new Es;i.startTick=t+this._selectionStart.beat.playbackStart,i.endTick=s+this._selectionEnd.beat.playbackStart+this._selectionEnd.beat.playbackDuration-50,this.playbackRange=i}else this._selectionStart=null,this.playbackRange=null,this.cursorSelectRange(this._selectionStart,this._selectionEnd)}}this.beatMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseUp",t,e),this._beatMouseDown=!1}setupClickHandling(){this.canvasElement.mouseDown.on(e=>{var t,s;if(!e.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&e.preventDefault();let i=e.getX(this.canvasElement),a=e.getY(this.canvasElement),r=null!==(s=null===(t=this.renderer.boundsLookup)||void 0===t?void 0:t.getBeatAtPos(i,a))&&void 0!==s?s:null;r&&this.onBeatMouseDown(e,r)}),this.canvasElement.mouseMove.on(e=>{var t,s;if(!this._beatMouseDown)return;let i=e.getX(this.canvasElement),a=e.getY(this.canvasElement),r=null!==(s=null===(t=this.renderer.boundsLookup)||void 0===t?void 0:t.getBeatAtPos(i,a))&&void 0!==s?s:null;r&&this.onBeatMouseMove(e,r)}),this.canvasElement.mouseUp.on(e=>{var t,s;if(!this._beatMouseDown)return;this.settings.player.enableUserInteraction&&e.preventDefault();let i=e.getX(this.canvasElement),a=e.getY(this.canvasElement),r=null!==(s=null===(t=this.renderer.boundsLookup)||void 0===t?void 0:t.getBeatAtPos(i,a))&&void 0!==s?s:null;this.onBeatMouseUp(e,r)}),this.renderer.postRenderFinished.on(()=>{this._selectionStart&&this.settings.player.enablePlayer&&this.settings.player.enableCursor&&this.settings.player.enableUserInteraction&&this.cursorSelectRange(this._selectionStart,this._selectionEnd)})}cursorSelectRange(e,t){let s=this.renderer.boundsLookup;if(!s)return;let i=this._selectionWrapper;if(!i||!e||!t||e.beat===t.beat)return;i.clear(),e.bounds||(e.bounds=s.findBeat(e.beat)),t.bounds||(t.bounds=s.findBeat(t.beat));let a=e.beat.absolutePlaybackStart;if(t.beat.absolutePlaybackStart<a){let s=e;e=t,t=s}let r=e.bounds.realBounds.x,n=t.bounds.realBounds.x+t.bounds.realBounds.w;if(t.beat.index===t.beat.voice.beats.length-1&&(n=t.bounds.barBounds.masterBarBounds.realBounds.x+t.bounds.barBounds.masterBarBounds.realBounds.w),e.bounds.barBounds.masterBarBounds.staveGroupBounds!==t.bounds.barBounds.masterBarBounds.staveGroupBounds){let a=e.bounds.barBounds.masterBarBounds.staveGroupBounds.visualBounds.x,o=e.bounds.barBounds.masterBarBounds.staveGroupBounds.visualBounds.x+e.bounds.barBounds.masterBarBounds.staveGroupBounds.visualBounds.w,h=this.uiFacade.createSelectionElement();h.top=e.bounds.barBounds.masterBarBounds.visualBounds.y,h.left=r,h.width=o-r,h.height=e.bounds.barBounds.masterBarBounds.visualBounds.h,i.appendChild(h);let l=e.bounds.barBounds.masterBarBounds.staveGroupBounds.index+1,d=t.bounds.barBounds.masterBarBounds.staveGroupBounds.index;for(let e=l;e<d;e++){let t=s.staveGroups[e],r=this.uiFacade.createSelectionElement();r.top=t.visualBounds.y,r.left=a,r.width=o-a,r.height=t.visualBounds.h,i.appendChild(r)}let c=this.uiFacade.createSelectionElement();c.top=t.bounds.barBounds.masterBarBounds.visualBounds.y,c.left=a,c.width=n-a,c.height=t.bounds.barBounds.masterBarBounds.visualBounds.h,i.appendChild(c)}else{let t=this.uiFacade.createSelectionElement();t.top=e.bounds.barBounds.masterBarBounds.visualBounds.y,t.left=r,t.width=n-r,t.height=e.bounds.barBounds.masterBarBounds.visualBounds.h,i.appendChild(t)}}addLoaded(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.loaded.on(e)}removeLoaded(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.loaded.off(e)}onLoaded(e){this.loaded.trigger(e),this.uiFacade.triggerEvent(this.container,"loaded",e)}addResize(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.resize.on(e)}removeResize(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.resize.off(e)}onResize(e){this.resize.trigger(e),this.uiFacade.triggerEvent(this.container,"resize",e)}addRenderStarted(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.renderStarted.on(e)}removeRenderStarted(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.renderStarted.off(e)}onRenderStarted(e){this.renderStarted.trigger(e),this.uiFacade.triggerEvent(this.container,"render",e)}addRenderFinished(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.renderFinished.on(e)}removeRenderFinished(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.renderFinished.off(e)}onRenderFinished(){this.renderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"rendered",null)}addPostRenderFinished(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.postRenderFinished.on(e)}removePostRenderFinished(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.postRenderFinished.off(e)}onPostRenderFinished(){this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRendered",null)}addError(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.error.on(e)}removeError(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.error.off(e)}onError(e){we.error("API","An unexpected error occurred",e),this.error.trigger(e),this.uiFacade.triggerEvent(this.container,"error",e)}addReadyForPlayback(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.readyForPlayback.on(e)}removeReadyForPlayback(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.readyForPlayback.off(e)}onReadyForPlayback(){this.readyForPlayback.trigger(),this.uiFacade.triggerEvent(this.container,"playerReady",null)}addPlayerFinished(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.playerFinished.on(e)}removePlayerFinished(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.playerFinished.off(e)}onPlayerFinished(){this.playerFinished.trigger(),this.uiFacade.triggerEvent(this.container,"finished",null)}addSoundFontLoaded(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.soundFontLoaded.on(e)}removeSoundFontLoaded(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.soundFontLoaded.off(e)}onSoundFontLoaded(){this.soundFontLoaded.trigger(),this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}addMidiLoaded(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.midiLoaded.on(e)}removeMidiLoaded(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.midiLoaded.off(e)}onMidiLoaded(){this.midiLoaded.trigger(),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",null)}addPlayerStateChanged(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.playerStateChanged.on(e)}removePlayerStateChanged(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.playerStateChanged.off(e)}onPlayerStateChanged(e){this.playerStateChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playerStateChanged",e)}addPlayerPositionChanged(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.playerPositionChanged.on(e)}removePlayerPositionChanged(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.playerPositionChanged.off(e)}onPlayerPositionChanged(e){this.playerPositionChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"positionChanged",e)}}{constructor(e,t){super(new js(e),t),this.soundFontLoad=new qt}tex(e,t){let s=this.uiFacade;super.tex(e,s.parseTracks(t))}print(t){let s=window.open("","","width=0,height=0"),i=s.document.createElement("div");t?i.style.width=t:this.settings.display.layoutMode===e.LayoutMode.Horizontal?i.style.width="297mm":i.style.width="210mm",s.document.write("<!DOCTYPE html><html></head><body></body></html>"),s.document.body.appendChild(i);let a=void 0!==window.screenLeft?window.screenLeft:window.left,r=void 0!==window.screenTop?window.screenTop:window.top,n="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,o="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,h=i.offsetWidth+50,l=window.innerHeight,d=(n/2|0)-(h/2|0)+a,c=(o/2|0)-(l/2|0)+r;s.resizeTo(h,l),s.moveTo(d,c),s.focus();let u=new ls;u.core.scriptFile=this.settings.core.scriptFile,u.core.fontDirectory=this.settings.core.fontDirectory,u.core.enableLazyLoading=!1,u.core.useWorkers=!1,u.display.scale=.8,u.display.stretchForce=.8;let p=new Ks(i,u);p.renderer.postRenderFinished.on(()=>{p.canvasElement.height=-1,s.print()}),p.renderTracks(this.tracks)}downloadMidi(){if(!this.score)return;let e=new ts,t=new Ts(e);new Ms(this.score,this.settings,t).generate();let s=e.toBinary(),i=this.score.title?this.score.title+".mid":"File.mid",a=document.createElement("a");a.download=i;let r=new Blob([s],{type:"audio/midi"}),n=URL.createObjectURL(r);a.href=n,a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a)}changeTrackMute(e,t){let s=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackMute(s,t)}changeTrackSolo(e,t){let s=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackSolo(s,t)}changeTrackVolume(e,t){let s=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackVolume(s,t)}trackIndexesToTracks(e){if(!this.score)return[];let t=[];if(1===e.length&&-1===e[0])for(let e of this.score.tracks)t.push(e);else for(let s of e)s>=0&&s<this.score.tracks.length&&t.push(this.score.tracks[s]);return t}addSoundFontLoad(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)"),this.soundFontLoad.on(e)}removeSoundFontLoad(e){we.warning("API","Registering events via add<Name>/remove<Name> is deprecated, use <name>.on(..)/<name>.off(..)"),this.soundFontLoad.off(e)}loadSoundFontFromUrl(e){this.player&&this.player.loadSoundFontFromUrl(e,this.soundFontLoad.trigger.bind(this.soundFontLoad))}}class $s{constructor(){this._initListeners=[]}exec(e,t,s){if("string"!=typeof t&&(s=[t],t="init"),95===t.charCodeAt(0)||"exec"===t)return null;let i=new jQuery(e),a=i.data("alphaTab");if("destroy"===t&&!a)return null;if("init"!==t&&!a)throw new Error("alphaTab not initialized");let r=this[t];if(r){let e=[i,a].concat(s);return r.apply(this,e)}return we.error("Api","Method '"+t+"' does not exist on jQuery.alphaTab"),null}init(e,t,s){if(!t){t=new Ks(e[0],s),e.data("alphaTab",t);for(let i of this._initListeners)i(e,t,s)}}destroy(e,t){e.removeData("alphaTab"),t.destroy()}print(e,t,s){t.print(s)}load(e,t,s,i){return t.load(s,i)}render(e,t){t.render()}renderScore(e,t,s,i){t.renderScore(s,i)}renderTracks(e,t,s){t.renderTracks(s)}invalidate(e,t){t.render()}tex(e,t,s,i){t.tex(s,i)}muteTrack(e,t,s,i){t.changeTrackMute(s,i)}soloTrack(e,t,s,i){t.changeTrackSolo(s,i)}trackVolume(e,t,s,i){t.changeTrackVolume(s,i)}loadSoundFont(e,t,s){t.loadSoundFont(s)}pause(e,t){t.pause()}play(e,t){return t.play()}playPause(e,t){t.playPause()}stop(e,t){t.stop()}api(e,t){return t}player(e,t){return t.player}isReadyForPlayback(e,t){return t.isReadyForPlayback}playerState(e,t){return t.playerState}masterVolume(e,t,s){return"number"==typeof s&&(t.masterVolume=s),t.masterVolume}metronomeVolume(e,t,s){return"number"==typeof s&&(t.metronomeVolume=s),t.metronomeVolume}playbackSpeed(e,t,s){return"number"==typeof s&&(t.playbackSpeed=s),t.playbackSpeed}tickPosition(e,t,s){return"number"==typeof s&&(t.tickPosition=s),t.tickPosition}timePosition(e,t,s){return"number"==typeof s&&(t.timePosition=s),t.timePosition}loop(e,t,s){return"boolean"==typeof s&&(t.isLooping=s),t.isLooping}renderer(e,t){return t.renderer}score(e,t){return t.score}settings(e,t){return t.settings}tracks(e,t){return t.tracks}_oninit(e){this._initListeners.push(e)}static restore(e){new jQuery(e).empty().removeData("alphaTab")}}class Zs extends class{constructor(){this.buffer="",this._currentPath="",this._currentPathIsEmpty=!0,this.color=new a(255,255,255,255),this.lineWidth=1,this.font=new n("Arial",10,r.Plain),this.textAlign=$.Left,this.textBaseline=Z.Top}beginRender(e,t){this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|e}px" height="${0|t}px" class="at-surface-svg">\n`,this._currentPath="",this._currentPathIsEmpty=!0}beginGroup(e){this.buffer+=`<g class="${e}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(e,t,s,i){s>0&&(this.buffer+=`<rect x="${0|e}" y="${0|t}" width="${s}" height="${i}" fill="${this.color.rgba}" />\n`)}strokeRect(e,t,s,i){this.buffer+=`<rect x="${0|e}" y="${0|t}" width="${s}" height="${i}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth}"`),this.buffer+=' fill="transparent" />\n'}beginPath(){}closePath(){this._currentPath+=" z"}moveTo(e,t){this._currentPath+=` M${e},${t}`}lineTo(e,t){this._currentPathIsEmpty=!1,this._currentPath+=` L${e},${t}`}quadraticCurveTo(e,t,s,i){this._currentPathIsEmpty=!1,this._currentPath+=` Q${e},${t},${s},${i}`}bezierCurveTo(e,t,s,i,a,r){this._currentPathIsEmpty=!1,this._currentPath+=` C${e},${t},${s},${i},${a},${r}`}fillCircle(e,t,s){this._currentPathIsEmpty=!1,this._currentPath+=` M${e-s},${t} A1,1 0 0,0 ${e+s},${t} A1,1 0 0,0 ${e-s},${t} z`,this.fill()}fill(){this._currentPathIsEmpty||(this.buffer+=`<path d="${this._currentPath}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this._currentPath="",this._currentPathIsEmpty=!0}stroke(){if(!this._currentPathIsEmpty){let e=`<path d="${this._currentPath}" stroke="${this.color.rgba}"`;1!==this.lineWidth&&(e+=` stroke-width="${this.lineWidth}"`),e+=' style="fill: none" />',this.buffer+=e}this._currentPath="",this._currentPathIsEmpty=!0}fillText(e,t,s){if(""===e)return;let i=`<text x="${0|t}" y="${0|s}" style="stroke: none; font:${this.font.toCssString(this.settings.display.scale)}"  dominant-baseline="${this.getSvgBaseLine()}"`;"#000000"!==this.color.rgba&&(i+=` fill="${this.color.rgba}"`),this.textAlign!==$.Left&&(i+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),i+=`>${e}</text>`,this.buffer+=i}getSvgTextAlignment(e){switch(e){case $.Left:return"start";case $.Center:return"middle";case $.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case Z.Top:return"hanging";case Z.Middle:return"middle";case Z.Bottom:return"bottom";default:return""}}measureText(e){return e?ps.measureString(e,this.font.family,this.font.size,this.font.style):0}onRenderFinished(){return null}beginRotate(e,t,s){this.buffer+='<g transform="translate('+e+" ,"+t+") rotate( "+s+')">'}endRotate(){this.buffer+="</g>"}}{constructor(){super()}fillMusicFontSymbol(e,t,s,i,a=!1){i!==ee.None&&this.fillMusicFontSymbolText(e,t,s,`&#${i};`,a)}fillMusicFontSymbols(e,t,s,i,a=!1){let r="";for(let e of i)e!==ee.None&&(r+=`&#${e};`);this.fillMusicFontSymbolText(e,t,s,r,a)}fillMusicFontSymbolText(e,t,s,i,a=!1){this.buffer+=`<g transform="translate(${(0|e)-0} ${(0|t)-0})" class="at" ><text`,this.buffer+=1!==s?` style="font-size: ${100*s}%; stroke:none"`:' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),a&&(this.buffer+=' text-anchor="'+this.getSvgTextAlignment($.Center)+'"'),this.buffer+=`>${i}</text></g>`}}class ei{constructor(){this.isInAccolade=!0,this.isRelevantForBoundsLookup=!0,this.hideOnMultiTrack=!1,this.hideOnPercussionTrack=!1}canCreate(e,t){return!this.hideOnPercussionTrack||!t.isPercussion}}!function(e){e[e.PreNotes=0]="PreNotes",e[e.OnNotes=1]="OnNotes",e[e.MiddleNotes=2]="MiddleNotes",e[e.PostNotes=3]="PostNotes",e[e.EndBeat=4]="EndBeat"}(se||(se={}));class ti extends Ds{constructor(e,t){super(e,t),this.glyphs=null}get isEmpty(){return!this.glyphs||0===this.glyphs.length}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);let e=0;for(let t=0,s=this.glyphs.length;t<s;t++){let s=this.glyphs[t];s.renderer=this.renderer,s.doLayout(),e=Math.max(e,s.width)}this.width=e}addGlyph(e){this.glyphs||(this.glyphs=[]),this.glyphs.push(e)}paint(e,t,s){let i=this.glyphs;if(i&&0!==i.length)for(let a of i)a.paint(e+this.x,t+this.y,s)}}class si extends ti{constructor(){super(0,0),this.glyphs=[]}addGlyph(e){e.x=0===this.glyphs.length?0:this.glyphs[this.glyphs.length-1].x+this.glyphs[this.glyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.width=e.x+e.width,super.addGlyph(e)}}class ii extends ti{constructor(e,t,s){super(e,t),this.minWidth=0,this.voice=s,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(e){let t=this.renderer.layoutingInfo.spaceToForce(e);this.scaleToForce(t)}scaleToForce(e){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(e);let t=this.renderer.layoutingInfo.buildOnTimePositions(e),s=this.beatGlyphs;for(let e=0,i=s.length;e<i;e++){let a=s[e],r=a.beat.absoluteDisplayStart;if(a.x=t.get(r)-a.onTimeX,e>0){let t=a.x-s[e-1].x;s[e-1].scaleToWidth(t)}if(e===i-1){let e=this.width-s[s.length-1].x;a.scaleToWidth(e)}}}registerLayoutingInfo(e){e.updateVoiceSize(this.width);let t=this.beatGlyphs;for(let s of t)s.registerLayoutingInfo(e)}applyLayoutingInfo(e){let t=this.beatGlyphs;for(let s of t)s.applyLayoutingInfo(e);this.scaleToForce(Math.max(this.renderer.settings.display.stretchForce,e.minStretchForce))}addGlyph(e){let t=e;e.x=0===this.beatGlyphs.length?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.beatGlyphs.push(t),this.width=e.x+e.width,t.beat.hasTuplet&&t.beat.tupletGroup.beats[0].id===t.beat.id&&this.tupletGroups.push(t.beat.tupletGroup)}doLayout(){this.minWidth=this.width}paint(e,t,s){s.color=0===this.voice.index?this.renderer.resources.mainGlyphColor:this.renderer.resources.secondaryGlyphColor;for(let i=0,a=this.beatGlyphs.length;i<a;i++)this.beatGlyphs[i].paint(e+this.x,t+this.y,s)}}ii.KeySizeBeat="Beat",function(e){e[e.Up=0]="Up",e[e.Down=1]="Down"}(ie||(ie={}));class ai{constructor(){this.staffId="",this.up=0,this.down=0,this.minNoteValue=0,this.maxNoteValue=0}}class ri{constructor(e){this._beatLineXPositions=new Map,this.voice=null,this.beats=[],this.shortestDuration=b.QuadrupleWhole,this.fingeringCount=0,this.hasTuplet=!1,this.firstMinNoteValue=-1,this.firstMaxNoteValue=-1,this.lastMinNoteValue=-1,this.lastMaxNoteValue=-1,this.minNoteValue=-1,this.minNoteBeat=null,this.maxNoteValue=0,this.maxNoteBeat=null,this.invertBeamDirection=!1,this.isGrace=!1,this.direction=ie.Up,this._staff=e,this.beats=[]}getValue(e){return this._staff.isPercussion?Se.mapNoteForDisplay(e.displayValue):e.displayValue}getMaxValue(e){let t=this.getValue(e);return e.harmonicType!==B.None&&e.harmonicType!==B.Natural&&(t=e.realValue-this._staff.displayTranspositionPitch),t}getMinValue(e){return this.getValue(e)}getBeatLineX(e){return this.hasBeatLineX(e)?this.direction===ie.Up?this._beatLineXPositions.get(e.index).up:this._beatLineXPositions.get(e.index).down:0}hasBeatLineX(e){return this._beatLineXPositions.has(e.index)}registerBeatLineX(e,t,s,i){let a=this.getOrCreateBeatPositions(t);a.staffId=e,a.up=s,a.down=i}getOrCreateBeatPositions(e){return this._beatLineXPositions.has(e.index)||this._beatLineXPositions.set(e.index,new ai),this._beatLineXPositions.get(e.index)}finish(){this.direction=this.calculateDirection()}calculateDirection(){if(!this.voice)return ie.Up;if(this.voice.index>0)return this.invert(ie.Down);if(this.voice.bar.voices.length>1)for(let e=1;e<this.voice.bar.voices.length;e++)if(!this.voice.bar.voices[e].isEmpty)return this.invert(ie.Up);if(this.beats[0].graceType!==_.None)return this.invert(ie.Up);let e=(this.maxNoteValue+this.minNoteValue)/2|0;return this.invert(e<ri.ScoreMiddleKeys[this.beats[this.beats.length-1].voice.bar.clef]?ie.Up:ie.Down)}invert(e){if(!this.invertBeamDirection)return e;switch(e){case ie.Down:return ie.Up;case ie.Up:default:return ie.Down}}checkBeat(e){e.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=e.voice);let t=!1;if((0===this.beats.length||ri.canJoin(this.beats[this.beats.length-1],e))&&(t=!0),t){this.beats.push(e),e.graceType!==_.None&&(this.isGrace=!0);let t=this.getOrCreateBeatPositions(e);e.hasTuplet&&(this.hasTuplet=!0);let s=0;for(let t=0;t<e.notes.length;t++){let i=e.notes[t];i.leftHandFinger===w.Unknown&&i.rightHandFinger===w.Unknown||s++}s>this.fingeringCount&&(this.fingeringCount=s),this.lastMinNoteValue=-1,this.lastMaxNoteValue=-1,this.checkNote(e.minNote),this.checkNote(e.maxNote),t.minNoteValue=this.lastMinNoteValue,t.maxNoteValue=this.lastMaxNoteValue,this.shortestDuration<e.duration&&(this.shortestDuration=e.duration),e.hasTuplet&&(this.hasTuplet=!0)}return t}checkNote(e){if(!e)return;let t=this.getValue(e);1===this.beats.length&&this.beats[0]===e.beat&&((-1===this.firstMinNoteValue||t<this.firstMinNoteValue)&&(this.firstMinNoteValue=t),(-1===this.firstMaxNoteValue||t>this.firstMaxNoteValue)&&(this.firstMaxNoteValue=t)),(-1===this.lastMinNoteValue||t<this.lastMinNoteValue)&&(this.lastMinNoteValue=t),(-1===this.lastMaxNoteValue||t>this.lastMaxNoteValue)&&(this.lastMaxNoteValue=t);let s=this.getMinValue(e);(-1===this.minNoteValue||this.minNoteValue>s)&&(this.minNoteValue=s,this.minNoteBeat=e.beat);let i=this.getMaxValue(e);(-1===this.maxNoteValue||this.maxNoteValue<i)&&(this.maxNoteValue=i,this.maxNoteBeat=e.beat)}calculateBeamY(e,t,s,i,a){return this.calculateBeamYWithDirection(e,t,s,i,a,this.direction)}calculateBeamYWithDirection(e,t,s,i,a,r){if(1===this.beats.length)return r===ie.Up?a.getYPositionForNoteValue(this.maxNoteValue)-e:a.getYPositionForNoteValue(this.minNoteValue)+e;let n=10*i;if(r===ie.Down&&this.minNoteBeat!==this.beats[0]&&this.minNoteBeat!==this.beats[this.beats.length-1])return a.getYPositionForNoteValue(this.minNoteValue)+e;if(r===ie.Up&&this.maxNoteBeat!==this.beats[0]&&this.minNoteBeat!==this.beats[this.beats.length-1])return a.getYPositionForNoteValue(this.maxNoteValue)-e;let o=this.getBeatLineX(this.beats[0])+t,h=r===ie.Up?a.getYPositionForNoteValue(this.firstMaxNoteValue)-e:a.getYPositionForNoteValue(this.firstMinNoteValue)+e,l=this.getBeatLineX(this.beats[this.beats.length-1])+t,d=r===ie.Up?a.getYPositionForNoteValue(this.lastMaxNoteValue)-e:a.getYPositionForNoteValue(this.lastMinNoteValue)+e;return r===ie.Down&&h>d&&h-d>n&&(d=h-n),r===ie.Down&&d>h&&d-h>n&&(h=d-n),r===ie.Up&&h<d&&d-h>n&&(d=h+n),r===ie.Up&&d<h&&h-d>n&&(h=d+n),o===l?h:(d-h)/(l-o)*(s-o)+h}static canJoin(e,t){if(!e||!t||e.isRest||t.isRest||e.graceType!==t.graceType||e.graceType===_.BendGrace||t.graceType===_.BendGrace)return!1;if(e.graceType!==_.None&&t.graceType!==_.None)return!0;let s=e.voice.bar;if(s!==e.voice.bar)return!1;let i=e.playbackStart,a=t.playbackStart;if(!ri.canJoinDuration(e.duration)||!ri.canJoinDuration(t.duration))return i===a;if(e.tupletGroup!==t.tupletGroup)return!1;if(e.hasTuplet&&t.hasTuplet&&e.tupletGroup===t.tupletGroup&&e.tupletGroup.isFull)return!0;let r=me.QuarterTime;switch(s.masterBar.timeSignatureDenominator){case 8:s.masterBar.timeSignatureNumerator%3==0&&(r+=me.QuarterTime/2|0)}return(0|(r+i)/r)===(0|(r+a)/r)}static canJoinDuration(e){switch(e){case b.Whole:case b.Half:case b.Quarter:return!1;default:return!0}}static isFullBarJoin(e,t,s){return Ae.getIndex(e.duration)-2-s>0&&Ae.getIndex(t.duration)-2-s>0}isPositionFrom(e,t){return!this._beatLineXPositions.has(t.index)||(this._beatLineXPositions.get(t.index).staffId===e||!this._beatLineXPositions.get(t.index).staffId)}getBeatMinValue(e){return this._beatLineXPositions.has(e.index)?this._beatLineXPositions.get(e.index).minNoteValue:e.minNote.displayValue}getBeatMaxValue(e){return this._beatLineXPositions.has(e.index)?this._beatLineXPositions.get(e.index).maxNoteValue:e.maxNote.displayValue}}ri.ScoreMiddleKeys=[71,60,57,50,71];class ni{constructor(e){this.beamHelpers=[],this.beamHelperLookup=[];let t=null,s=null;if(e)for(let i=0,a=e.voices.length;i<a;i++){let a=e.voices[i];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let i=0,r=a.beats.length;i<r;i++){let r,n=a.beats[i];n.graceType!==_.None?r=s:(r=t,s=null),n.isRest||r&&r.checkBeat(n)||(r&&r.finish(),r=new ri(e.staff),r.checkBeat(n),n.graceType!==_.None?s=r:t=r,this.beamHelpers[a.index].push(r)),this.beamHelperLookup[a.index].set(n.index,r)}t&&t.finish(),s&&s.finish(),t=null,s=null}}getBeamingHelperForBeat(e){return this.beamHelperLookup[e.voice.index].get(e.index)}}class oi{constructor(e,t){this._preBeatGlyphs=new si,this._voiceContainers=new Map,this._postBeatGlyphs=new si,this.x=0,this.y=0,this.width=0,this.height=0,this.index=0,this.topOverflow=0,this.bottomOverflow=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this._wasFirstOfLine=!1,this._appliedLayoutingInfo=0,this.isFinalized=!1,this.topPadding=0,this.bottomPadding=0,this.scoreRenderer=e,this.bar=t,t&&(this.helpers=new ni(t))}get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staveId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staveId,this.bar.previousBar):null}registerOverflowTop(e){e>this.topOverflow&&(this.topOverflow=e)}registerOverflowBottom(e){e>this.bottomOverflow&&(this.bottomOverflow=e)}scaleToWidth(e){let t=e-this._preBeatGlyphs.width-this._postBeatGlyphs.width;for(let e of this._voiceContainers)e[1].scaleToWidth(t);this._postBeatGlyphs.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width+t,this.width=e}get resources(){return this.settings.display.resources}get settings(){return this.scoreRenderer.settings}get scale(){return this.settings.display.scale}get isFirstOfLine(){return 0===this.index}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){let e=this.layoutingInfo,t=this._preBeatGlyphs.width;e.preBeatSize<t&&(e.preBeatSize=t);for(let t of this._voiceContainers)t[1].registerLayoutingInfo(e);let s=this._postBeatGlyphs.width;e.postBeatSize<s&&(e.postBeatSize=s)}applyLayoutingInfo(){if(this._appliedLayoutingInfo>=this.layoutingInfo.version)return!1;this._appliedLayoutingInfo=this.layoutingInfo.version,this._preBeatGlyphs.width=this.layoutingInfo.preBeatSize;let e=this._preBeatGlyphs.x+this._preBeatGlyphs.width;for(let t of this._voiceContainers){let s=t[1];s.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,s.applyLayoutingInfo(this.layoutingInfo);let i=s.x+s.width;e<i&&(e=i)}return this._postBeatGlyphs.x=Math.floor(e),this._postBeatGlyphs.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),!0}finalizeRenderer(){this.isFinalized=!0}doLayout(){if(this.bar){this._preBeatGlyphs=new si,this._preBeatGlyphs.renderer=this,this._voiceContainers.clear(),this._postBeatGlyphs=new si,this._postBeatGlyphs.renderer=this;for(let e=0;e<this.bar.voices.length;e++){let t=this.bar.voices[e];if(this.hasVoiceContainer(t)){let s=new ii(0,0,t);s.renderer=this,this._voiceContainers.set(this.bar.voices[e].index,s)}}this.bar.simileMark===p.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.createBeatGlyphs(),this.createPostBeatGlyphs(),this.updateSizes()}}hasVoiceContainer(e){return!e.isEmpty||0===e.index}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);let e=this._voiceContainers,t=this.beatGlyphsStart,s=t;for(let i of e){let e=i[1];e.x=t,e.doLayout();let a=e.x+e.width;s<a&&(s=a)}this._postBeatGlyphs.x=Math.floor(s),this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width)}addPreBeatGlyph(e){this._preBeatGlyphs.addGlyph(e)}addBeatGlyph(e){e.renderer=this,e.preNotes.renderer=this,e.onNotes.renderer=this,e.onNotes.beamingHelper=this.helpers.beamHelperLookup[e.beat.voice.index].get(e.beat.index),this.getOrCreateVoiceContainer(e.beat.voice).addGlyph(e)}getOrCreateVoiceContainer(e){return this._voiceContainers.get(e.index)}getBeatContainer(e){return this.getOrCreateVoiceContainer(e.voice).beatGlyphs[e.index]}getPreNotesGlyphForBeat(e){return this.getBeatContainer(e).preNotes}getOnNotesGlyphForBeat(e){return this.getBeatContainer(e).onNotes}paint(e,t,s){this.paintBackground(e,t,s),s.color=this.resources.mainGlyphColor,this._preBeatGlyphs.paint(e+this.x,t+this.y,s);for(let i of this._voiceContainers){let a=i[1];s.color=0===a.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,a.paint(e+this.x,t+this.y,s)}s.color=this.resources.mainGlyphColor,this._postBeatGlyphs.paint(e+this.x,t+this.y,s)}paintBackground(e,t,s){}buildBoundingsLookup(e,t,s){let i=new fs;i.bar=this.bar,i.visualBounds=new Je,i.visualBounds.x=t+this.x,i.visualBounds.y=s+this.y+this.topPadding,i.visualBounds.w=this.width,i.visualBounds.h=this.height-this.topPadding-this.bottomPadding,i.realBounds=new Je,i.realBounds.x=t+this.x,i.realBounds.y=s+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,e.addBar(i);for(let e of this._voiceContainers){let s=e[1],a=this.bar.isEmpty&&0===e[0];if(!s.voice.isEmpty||a)for(let e=0,r=s.beatGlyphs.length;e<r;e++){let r=s.beatGlyphs[e],n=new ms;n.beat=r.beat,n.visualBounds=new Je,n.visualBounds.x=t+this.x+s.x+r.x+r.onNotes.x,n.visualBounds.y=i.visualBounds.y,n.visualBounds.w=r.onNotes.width,n.visualBounds.h=i.visualBounds.h,n.realBounds=new Je,n.realBounds.x=t+this.x+s.x+r.x,n.realBounds.y=i.realBounds.y,n.realBounds.w=r.width,n.realBounds.h=i.realBounds.h,a&&(n.visualBounds.x=t+this.x,n.realBounds.x=n.visualBounds.x),i.addBeat(n)}}}addPostBeatGlyph(e){this._postBeatGlyphs.addGlyph(e)}createPreBeatGlyphs(){this._wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this._preBeatGlyphs.x+this._preBeatGlyphs.width}get postBeatGlyphsStart(){return this._postBeatGlyphs.x}getNoteX(e,t=!0){return 0}getBeatX(e,t=se.PreNotes){let s=this.getBeatContainer(e);if(s)switch(t){case se.PreNotes:return s.voiceContainer.x+s.x;case se.OnNotes:return s.voiceContainer.x+s.x+s.onNotes.x;case se.MiddleNotes:return s.voiceContainer.x+s.x+s.onTimeX;case se.PostNotes:return s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.width;case se.EndBeat:return s.voiceContainer.x+s.x+s.width}return 0}getNoteY(e,t=!1){return 0}reLayout(){(this._wasFirstOfLine&&!this.isFirstOfLine||!this._wasFirstOfLine&&this.isFirstOfLine)&&(this._preBeatGlyphs=new si,this._preBeatGlyphs.renderer=this,this.createPreBeatGlyphs()),this.updateSizes(),this.registerLayoutingInfo()}paintSimileMark(e,t,s){switch(this.bar.simileMark){case p.Simple:s.fillMusicFontSymbol(e+this.x+(this.width-20*this.scale)/2,t+this.y+this.height/2,1,ee.SimileMarkSimple,!1);break;case p.SecondOfDouble:s.fillMusicFontSymbol(e+this.x-28*this.scale/2,t+this.y+this.height/2,1,ee.SimileMarkDouble,!1)}}}!function(e){e[e.SinglePreBeat=0]="SinglePreBeat",e[e.SingleOnBeat=1]="SingleOnBeat",e[e.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",e[e.GroupedOnBeat=3]="GroupedOnBeat",e[e.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",e[e.FullBar=5]="FullBar"}(ae||(ae={}));class hi extends Ds{constructor(e,t){super(0,0),this._uniqueEffectGlyphs=[],this._effectGlyphs=[],this.isEmpty=!0,this.previousBand=null,this.isLinkedToPrevious=!1,this.firstBeat=null,this.lastBeat=null,this.height=0,this.slot=null,this.voice=e,this.info=t}doLayout(){super.doLayout();for(let e=0;e<this.renderer.bar.voices.length;e++)this._effectGlyphs.push(new Map),this._uniqueEffectGlyphs.push([])}createGlyph(e){if(e.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,e)&&(!this.info.hideOnMultiTrack||0===this.renderer.staff.trackIndex)){if(this.isEmpty=!1,this.firstBeat&&!e.isBefore(this.firstBeat)||(this.firstBeat=e),!this.lastBeat||e.isAfter(this.lastBeat))switch(this.lastBeat=e,this.info.sizingMode){case ae.SingleOnBeatToEnd:case ae.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}let t=this.createOrResizeGlyph(this.info.sizingMode,e);t.height>this.height&&(this.height=t.height)}}createOrResizeGlyph(e,t){let s;switch(e){case ae.FullBar:return s=this.info.createNewGlyph(this.renderer,t),s.renderer=this.renderer,s.beat=t,s.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,s),this._uniqueEffectGlyphs[t.voice.index].push(s),s;case ae.SinglePreBeat:case ae.SingleOnBeat:case ae.SingleOnBeatToEnd:return s=this.info.createNewGlyph(this.renderer,t),s.renderer=this.renderer,s.beat=t,s.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,s),this._uniqueEffectGlyphs[t.voice.index].push(s),s;case ae.GroupedOnBeat:case ae.GroupedOnBeatToEnd:let i=e===ae.GroupedOnBeat?ae.SingleOnBeat:ae.SingleOnBeatToEnd;if(t.index>0||this.renderer.index>0){let e=t.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,e)){let s=null;if(t.index>0&&this._effectGlyphs[t.voice.index].has(e.index))s=this._effectGlyphs[t.voice.index].get(e.index);else if(this.renderer.index>0){let i=this.renderer.previousRenderer.getBand(this.voice,this.info.effectId)._effectGlyphs[t.voice.index];i.has(e.index)&&(s=i.get(e.index))}let a=this.createOrResizeGlyph(i,t);return s&&this.info.canExpand(e,t)&&(s.nextGlyph=a,a.previousGlyph=s,this.isLinkedToPrevious=!0),a}return this.createOrResizeGlyph(i,t)}return this.createOrResizeGlyph(i,t);default:return this.createOrResizeGlyph(ae.SingleOnBeat,t)}}paint(e,t,s){super.paint(e,t,s);for(let i=0,a=this._uniqueEffectGlyphs.length;i<a;i++){let a=this._uniqueEffectGlyphs[i];for(let i=0,r=a.length;i<r;i++){a[i].paint(e+this.x,t+this.y,s)}}}alignGlyphs(){for(let e=0;e<this._effectGlyphs.length;e++)for(let t of this._effectGlyphs[e])this.alignGlyph(this.info.sizingMode,this.renderer.bar.voices[e].beats[t[0]])}alignGlyph(e,t){let s,i=this._effectGlyphs[t.voice.index].get(t.index),a=this.renderer.getBeatContainer(t);switch(e){case ae.SinglePreBeat:s=a.preNotes,i.x=this.renderer.beatGlyphsStart+s.x+a.x,i.width=s.width;break;case ae.SingleOnBeat:case ae.GroupedOnBeat:s=a.onNotes,i.x=this.renderer.beatGlyphsStart+s.x+a.x,i.width=s.width;break;case ae.SingleOnBeatToEnd:case ae.GroupedOnBeatToEnd:s=a.onNotes,i.x=this.renderer.beatGlyphsStart+s.x+a.x,a.beat.isLastOfVoice?i.width=this.renderer.width-i.x:i.width=a.width-a.preNotes.width-a.preNotes.x;break;case ae.FullBar:i.width=this.renderer.width}}}class li{constructor(){this.uniqueEffectId=null,this.y=0,this.height=0,this.firstBeat=null,this.lastBeat=null}}class di{constructor(){this.bands=[],this.shared=new li}update(e){e.info.canShareBand||(this.shared.uniqueEffectId=e.info.effectId),e.slot=this,this.bands.push(e),e.height>this.shared.height&&(this.shared.height=e.height),this.shared.firstBeat&&!e.firstBeat.isBefore(this.shared.firstBeat)||(this.shared.firstBeat=e.firstBeat),this.shared.lastBeat&&!e.lastBeat.isAfter(this.shared.lastBeat)||(this.shared.lastBeat=e.lastBeat)}canBeUsed(e){return(!this.shared.uniqueEffectId&&e.info.canShareBand||e.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(e.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}}class ci{constructor(){this.slots=[],this._effectSlot=new Map}getOrCreateSlot(e){if(this._effectSlot.has(e.info.effectId)){let t=this._effectSlot.get(e.info.effectId);if(t.canBeUsed(e))return t}for(let t of this.slots)if(t.canBeUsed(e))return t;let t=new di;return this.slots.push(t),t}register(e){let t=this.getOrCreateSlot(e);t.update(e),this._effectSlot.set(e.info.effectId,t)}}class ui extends ti{constructor(){super(0,0)}doLayout(){let e=0;if(this.glyphs)for(let t=0,s=this.glyphs.length;t<s;t++){let s=this.glyphs[t];s.x=e,s.renderer=this.renderer,s.doLayout(),e+=s.width}this.width=e}noteLoop(e){for(let t=this.container.beat.notes.length-1;t>=0;t--)e(this.container.beat.notes[t])}}class pi extends ui{constructor(){super(...arguments),this.centerX=0}updateBeamingHelper(){}}class gi extends oi{constructor(e,t,s){super(e,t),this._bands=[],this._bandLookup=new Map,this.sizingInfo=null,this._infos=s}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this.updateHeight(),super.updateSizes()}finalizeRenderer(){super.finalizeRenderer(),this.updateHeight()}updateHeight(){if(!this.sizingInfo)return;let e=0;for(let t of this.sizingInfo.slots){t.shared.y=e;for(let s of t.bands)s.y=e,s.height=t.shared.height;e+=t.shared.height}this.height=e}applyLayoutingInfo(){if(!super.applyLayoutingInfo())return!1;if(this.index>0){let e=this.previousRenderer;this.sizingInfo=e.sizingInfo}else this.sizingInfo=new ci;for(let e of this._bands)e.alignGlyphs(),e.isEmpty||this.sizingInfo.register(e);return this.updateHeight(),!0}scaleToWidth(e){super.scaleToWidth(e);for(let e of this._bands)e.alignGlyphs()}createBeatGlyphs(){this._bands=[],this._bandLookup=new Map;for(let e of this.bar.voices)if(this.hasVoiceContainer(e))for(let t of this._infos){let s=new hi(e,t);s.renderer=this,s.doLayout(),this._bands.push(s),this._bandLookup.set(e.index+"."+t.effectId,s)}for(let e of this.bar.voices)this.hasVoiceContainer(e)&&this.createVoiceGlyphs(e);for(let e of this._bands)e.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(e){for(let t of e.beats){let s=new Is(t,this.getOrCreateVoiceContainer(e));s.preNotes=new ui,s.onNotes=new pi,this.addBeatGlyph(s);for(let e of this._bands)e.createGlyph(t)}}paint(e,t,s){this.paintBackground(e,t,s);for(let i of this._bands)s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isEmpty||i.paint(e+this.x,t+this.y,s)}getBand(e,t){let s=e.index+"."+t;return this._bandLookup.has(s)?this._bandLookup.get(s):null}}class fi extends ei{constructor(e,t){super(),this._infos=t,this._staffId=e,this.isInAccolade=!1,this.isRelevantForBoundsLookup=!1}get staffId(){return this._staffId}create(e,t){return new gi(e,t,this._infos)}}class mi extends Ds{constructor(e=0,t=0){super(e,t),this.nextGlyph=null,this.previousGlyph=null,this.height=0}}class yi extends mi{constructor(e,t,s){super(e,t),this._endingsString="",this._endings=[];for(let e=0;e<Ne.MaxAlternateEndings;e++)0!=(s&1<<e)&&this._endings.push(e)}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+(yi.Padding*this.scale+2);let e="";for(let t=0,s=this._endings.length;t<s;t++)e+=this._endings[t]+1,e+=". ";this._endingsString=e}paint(e,t,s){super.paint(e,t,s);let i=s.textBaseline;if(s.textBaseline=Z.Top,this._endings.length>0){let i=this.renderer.resources;s.font=i.wordsFont,s.moveTo(e+this.x,t+this.y+this.height),s.lineTo(e+this.x,t+this.y),s.lineTo(e+this.x+this.width,t+this.y),s.stroke(),s.fillText(this._endingsString,e+this.x+yi.Padding*this.scale,t+this.y*this.scale)}s.textBaseline=i}}yi.Padding=3;class bi{get effectId(){return"alternate-feel"}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ae.FullBar}shouldCreateGlyph(e,t){return 0===t.index&&0!==t.voice.bar.masterBar.alternateEndings}createNewGlyph(e,t){return new yi(0,0,t.voice.bar.masterBar.alternateEndings)}canExpand(e,t){return!0}}class Si extends mi{constructor(e,t,s,i,a=$.Left){super(e,t),this._lines=s.split("\n"),this.font=i,this.textAlign=a}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(e,t,s){s.font=this.font;let i=s.textAlign,a=t+this.y;for(let t of this._lines)s.textAlign=this.textAlign,s.fillText(t,e+this.x,a),s.textAlign=i,a+=this.font.size}}class _i{get effectId(){return"capo"}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return 0===t.index&&0===t.voice.bar.index&&0!==t.voice.bar.staff.capo}createNewGlyph(e,t){return new Si(0,0,"Capo. fret "+t.voice.bar.staff.capo,e.resources.effectFont,$.Left)}canExpand(e,t){return!1}}class wi{get effectId(){return"chords"}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.hasChord}createNewGlyph(e,t){return new Si(0,0,t.chord.name,e.resources.effectFont,$.Center)}canExpand(e,t){return!1}}class Bi extends mi{constructor(e){super(),this.forceGroupedRendering=!1,this.endOnBarLine=!1,this.endPosition=e}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.staveGroup===this.renderer.staff.staveGroup}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.staveGroup===this.renderer.staff.staveGroup}paint(e,t,s){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering)return void this.paintNonGrouped(e,t,s);let i;if(!this.isLinkedWithNext&&this.forceGroupedRendering)i=this;else for(i=this.nextGlyph;i.isLinkedWithNext;)i=i.nextGlyph;let a=i.renderer,r=i.beat,n=this.endPosition,o=e-this.renderer.x,h=this.calculateEndX(a,r,o,n);this.paintGrouped(e,t,h,s)}calculateEndX(e,t,s,i){return t?s+e.x+e.getBeatX(t,i):s+e.x+this.x+this.width}paintNonGrouped(e,t,s){let i=e-this.renderer.x,a=this.calculateEndX(this.renderer,this.beat,i,this.endPosition);this.paintGrouped(e,t,a,s)}}class vi extends mi{constructor(e,t,s,i){super(e,t),this.glyphScale=0,this.glyphScale=s,this.symbol=i}paint(e,t,s){s.fillMusicFontSymbol(e+this.x,t+this.y,this.glyphScale*this.scale,this.symbol,!1)}}class Ti extends vi{constructor(e,t,s,i){super(e,t,i?Ti.GraceScale:1,Ti.getSymbol(s)),this._isGrace=i,this._duration=s}paint(e,t,s){let i=this._isGrace?this.scale:0;s.fillMusicFontSymbol(e+this.x,t+this.y+i,this.glyphScale*this.scale,this.symbol,!1)}doLayout(){let e=(this._isGrace?Ti.GraceScale:1)*this.scale;switch(this._duration){case b.QuadrupleWhole:this.width=14*e,this.height=Ti.NoteHeadHeight*e;break;case b.DoubleWhole:case b.Whole:this.width=14*(this._isGrace?Ti.GraceScale:1)*this.scale,this.height=Ti.NoteHeadHeight*e;break;default:this.width=10*(this._isGrace?Ti.GraceScale:1)*this.scale,this.height=Ti.NoteHeadHeight*e}}static getSymbol(e){switch(e){case b.QuadrupleWhole:return ee.NoteQuadrupleWhole;case b.DoubleWhole:return ee.NoteDoubleWhole;case b.Whole:return ee.NoteWhole;case b.Half:return ee.NoteHalf;default:return ee.NoteQuarter}}}Ti.GraceScale=.75,Ti.NoteHeadHeight=9,Ti.QuarterNoteHeadWidth=10;class ki extends Bi{constructor(e,t,s){super(se.EndBeat),this._crescendo=y.None,this._crescendo=s,this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=17*this.scale}paintGrouped(e,t,s,i){let a=e+this.x,r=this.height*this.scale;i.beginPath(),this._crescendo===y.Crescendo?(s-=ki.Padding*this.scale,i.moveTo(s,t+this.y),i.lineTo(a,t+this.y+r/2),i.lineTo(s,t+this.y+r)):(s-=ki.Padding*this.scale,i.moveTo(a,t+this.y),i.lineTo(s,t+this.y+r/2),i.lineTo(a,t+this.y+r)),i.stroke()}}ki.Padding=Ti.QuarterNoteHeadWidth/2|0;class xi{get effectId(){return"crescendo"}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.crescendo!==y.None}createNewGlyph(e,t){return new ki(0,0,t.crescendo)}canExpand(e,t){return e.crescendo===t.crescendo}}class Ni extends vi{constructor(e,t,s){super(e,t,.6,Ni.getSymbol(s))}doLayout(){super.doLayout(),this.height=17*this.scale,this.y+=this.height/2}static getSymbol(e){switch(e){case S.PPP:return ee.DynamicPPP;case S.PP:return ee.DynamicPP;case S.P:return ee.DynamicP;case S.MP:return ee.DynamicMP;case S.MF:return ee.DynamicMF;case S.F:return ee.DynamicF;case S.FF:return ee.DynamicFF;case S.FFF:return ee.DynamicFFF;default:return ee.None}}}class Pi{get effectId(){return"dynamics"}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return this.internalShouldCreateGlyph(t)}internalShouldCreateGlyph(e){if(e.voice.bar.staff.track.score.stylesheet.hideDynamics||e.isEmpty||e.voice.isEmpty)return!1;let t=0===e.voice.index&&0===e.index&&0===e.voice.bar.index||!!e.previousBeat&&e.dynamics!==e.previousBeat.dynamics;if(t&&e.voice.index>0)for(let s of e.voice.bar.voices)if(s.index<e.voice.index){let i=s.getBeatAtDisplayStart(e.displayStart);i&&e.dynamics===i.dynamics&&this.internalShouldCreateGlyph(i)&&(t=!1)}return t}createNewGlyph(e,t){return new Ni(0,0,t.dynamics)}canExpand(e,t){return!0}}class Fi extends mi{doLayout(){super.doLayout(),this.height=17*this.scale}paint(e,t,s){let i=6*this.scale,a=Math.max(this.width,14*this.scale),r=this.height/2;s.beginPath(),s.moveTo(e+this.x,t+this.y+r),s.quadraticCurveTo(e+this.x+a/2,t+this.y+r,e+this.x+a,t+this.y+r-i),s.moveTo(e+this.x,t+this.y+r),s.quadraticCurveTo(e+this.x+a/2,t+this.y+r,e+this.x+a,t+this.y+r+i),s.stroke()}}class Ci{get effectId(){return"fade-in"}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.fadeIn}createNewGlyph(e,t){return new Fi}canExpand(e,t){return!0}}class Li extends vi{constructor(e,t,s){super(e,t,1,Li.getSymbol(s))}static getSymbol(e){switch(e){case G.Short:return ee.FermataShort;case G.Medium:return ee.FermataMedium;case G.Long:return ee.FermataLong;default:return ee.None}}doLayout(){this.width=23*this.scale,this.height=12*this.scale}paint(e,t,s){super.paint(e-this.width/2,t+this.height,s)}}class Mi{get effectId(){return"fermata"}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.fermata}createNewGlyph(e,t){return new Li(0,0,t.fermata.type)}canExpand(e,t){return!0}}class Ei{get effectId(){return"fingering"}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(t,s){return!(0!==s.voice.index||s.isRest||t.notation.fingeringMode!==e.FingeringMode.SingleNoteEffectBand&&t.notation.fingeringMode!==e.FingeringMode.SingleNoteEffectBandForcePiano)&&(1===s.notes.length&&s.notes[0].isFingering)}createNewGlyph(e,t){var s;let i=w.Unknown,a=!1,r=t.notes[0];r.leftHandFinger!==w.Unknown?(i=r.leftHandFinger,a=!0):r.rightHandFinger!==w.Unknown&&(i=r.rightHandFinger);let n=null!==(s=Ae.fingerToString(e.settings,t,i,a))&&void 0!==s?s:"";return new Si(0,0,n,e.resources.fingeringFont,$.Left)}canExpand(e,t){return!0}}class Di{constructor(){this.lastCreateInfo=null}shouldCreateGlyph(e,t){this.lastCreateInfo=[];for(let e=0,s=t.notes.length;e<s;e++){let s=t.notes[e];this.shouldCreateGlyphForNote(s)&&this.lastCreateInfo.push(s)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(e,t){return!0}}class Ii extends Bi{constructor(e){super(se.OnNotes),this._label=e}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=se.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.height=this.renderer.resources.effectFont.size}paintNonGrouped(e,t,s){let i=this.renderer.resources;s.font=i.effectFont;let a=s.textAlign;s.textAlign=$.Center,s.fillText(this._label,e+this.x,t+this.y),s.textAlign=a}paintGrouped(e,t,s,i){this.paintNonGrouped(e,t,i);let a=3*this.scale,r=i.measureText(this._label),n=e+this.x+r/2+a,o=t+this.y+4*this.scale,h=8*this.scale;if(s>n){let e=n;for(;e<s;)i.beginPath(),i.moveTo(e,0|o),i.lineTo(Math.min(e+h,s),0|o),e+=h+a,i.stroke();i.beginPath(),i.moveTo(s,o-5*this.scale|0),i.lineTo(s,o+5*this.scale|0),i.stroke()}}}Ii.LineSpacing=3,Ii.LineTopPadding=4,Ii.LineTopOffset=5,Ii.LineSize=8;class Ri extends Di{constructor(e){switch(super(),this._beat=null,this._harmonicType=B.None,this._harmonicType=e,e){case B.None:this._effectId="harmonics-none";break;case B.Natural:this._effectId="harmonics-natural";break;case B.Artificial:this._effectId="harmonics-artificial";break;case B.Pinch:this._effectId="harmonics-pinch";break;case B.Tap:this._effectId="harmonics-tap";break;case B.Semi:this._effectId="harmonics-semi";break;case B.Feedback:this._effectId="harmonics-feedback"}}get effectId(){return this._effectId}shouldCreateGlyphForNote(e){return!(!e.isHarmonic||e.harmonicType!==this._harmonicType)&&(e.beat!==this._beat&&(this._beat=e.beat),!0)}get sizingMode(){return ae.GroupedOnBeat}createNewGlyph(e,t){return new Ii(Ri.harmonicToString(this._harmonicType))}static harmonicToString(e){switch(e){case B.Natural:return"N.H.";case B.Artificial:return"A.H.";case B.Pinch:return"P.H.";case B.Tap:return"T.H.";case B.Semi:return"S.H.";case B.Feedback:return"Fdbk."}return""}}class Oi{get effectId(){return"let-ring"}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isLetRing}get sizingMode(){return ae.GroupedOnBeat}createNewGlyph(e,t){return new Ii("LetRing")}canExpand(e,t){return!0}}class Ai extends mi{constructor(e,t,s,i,a=$.Center){super(e,t),this._lines=s,this.font=i,this.textAlign=a}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(e,t,s){s.font=this.font;let i=s.textAlign;s.textAlign=this.textAlign;for(let i=0;i<this._lines.length;i++)this._lines[i]&&s.fillText(this._lines[i],e+this.x,t+this.y+i*this.font.size);s.textAlign=i}}class Gi{get effectId(){return"lyrics"}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.lyrics}createNewGlyph(e,t){return new Ai(0,0,t.lyrics,e.resources.effectFont,$.Center)}canExpand(e,t){return!0}}class Vi{get effectId(){return"marker"}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return ae.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&t.voice.bar.masterBar.isSectionStart}createNewGlyph(e,t){return new Si(0,0,t.voice.bar.masterBar.section.marker?"["+t.voice.bar.masterBar.section.marker+"] "+t.voice.bar.masterBar.section.text:t.voice.bar.masterBar.section.text,e.resources.markerFont,$.Left)}canExpand(e,t){return!0}}class Hi extends Bi{constructor(e,t){super(se.PostNotes),this._ottava=e,this._aboveStaff=t}doLayout(){super.doLayout(),this.height=13*this.scale}paintNonGrouped(e,t,s){this.paintOttava(e,t,s)}paintOttava(e,t,s){let i=0;switch(this._ottava){case u._15ma:i=37*this.scale,s.fillMusicFontSymbol(e+this.x-i/2,t+this.y+this.height,.8,ee.Ottava15ma,!1);break;case u._8va:i=26*this.scale,s.fillMusicFontSymbol(e+this.x-i/2,t+this.y+this.height,.8,ee.Ottava8va,!1);break;case u._8vb:i=23*this.scale,s.fillMusicFontSymbol(e+this.x-i/2,t+this.y+this.height,.8,ee.Ottava8vb,!1);break;case u._15mb:i=36*this.scale,s.fillMusicFontSymbols(e+this.x-i/2,t+this.y+this.height,.8,[ee.Ottava15,ee.OttavaMBaseline,ee.OttavaBBaseline],!1)}return i/2}paintGrouped(e,t,s,i){let a=this.paintOttava(e,t,i),r=3*this.scale,n=e+this.x+a+r,o=t+this.y;o+=this._aboveStaff?2*this.scale:this.height-2*this.scale;let h=8*this.scale;if(s>n){let e=n;for(;e<s;)i.beginPath(),i.moveTo(e,0|o),i.lineTo(Math.min(e+h,s),0|o),e+=h+r,i.stroke();i.beginPath(),this._aboveStaff?(i.moveTo(s,o),i.lineTo(s,t+this.y+this.height)):(i.moveTo(s,o),i.lineTo(s,t+this.y)),i.stroke()}}}class Wi{constructor(e){this._aboveStaff=e}get effectId(){return"ottavia-"+(this._aboveStaff?"above":"below")}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.GroupedOnBeat}shouldCreateGlyph(e,t){switch(t.ottava){case u._15ma:case u._8va:return this._aboveStaff;case u._8vb:case u._15mb:return!this._aboveStaff}return!1}createNewGlyph(e,t){return new Hi(t.ottava,this._aboveStaff)}canExpand(e,t){return e.ottava===t.ottava}}class zi extends Di{get effectId(){return"palm-mute"}shouldCreateGlyphForNote(e){return e.isPalmMute}get sizingMode(){return ae.GroupedOnBeat}createNewGlyph(e,t){return new Ii("P.M.")}constructor(){super()}}class Ui extends Di{get effectId(){return"pick-slide"}shouldCreateGlyphForNote(e){return e.slideOutType===k.PickSlideDown||e.slideOutType===k.PickSlideUp}get sizingMode(){return ae.GroupedOnBeat}createNewGlyph(e,t){return new Ii("P.S.")}constructor(){super()}}class Xi extends vi{constructor(e,t,s){super(e,t,Ti.GraceScale,Xi.getSymbol(s))}doLayout(){this.width=9*this.scale,this.height=10*this.scale}paint(e,t,s){super.paint(e,t+this.height,s)}static getSymbol(e){switch(e){case L.Up:return ee.PickStrokeUp;case L.Down:return ee.PickStrokeDown;default:return ee.None}}}class Yi{get effectId(){return"pick-stroke"}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.pickStroke!==L.None}createNewGlyph(e,t){return new Xi(0,0,t.pickStroke)}canExpand(e,t){return!0}}class Ji extends Bi{constructor(e){super(se.EndBeat),this._stepSize=0,this._type=e}doLayout(){switch(super.doLayout(),this._type){case x.Slight:this._stepSize=12*this.scale;break;case x.Wide:this._stepSize=23*this.scale}this.height=18*this.scale}paintGrouped(e,t,s,i){let a=e+this.x,r=s-a,n=Math.max(1,r/this._stepSize);i.beginPath(),i.moveTo(a,t+this.y);for(let e=0;e<n;e++)i.lineTo(a+this._stepSize/2,t+this.y+this.height),i.lineTo(a+this._stepSize,t+this.y),a+=this._stepSize;i.stroke()}}class Qi{get effectId(){return"slight-beat-vibrato"}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===x.Slight}createNewGlyph(e,t){return new Ji(x.Slight)}canExpand(e,t){return!0}}class qi extends Bi{constructor(e,t,s,i=1.2){super(se.EndBeat),this._scale=0,this._symbol=ee.None,this._symbolSize=0,this._symbolOffset=0,this._type=s,this._scale=i,this.x=e,this.y=t}doLayout(){super.doLayout();let e=0;switch(this._type){case x.Slight:this._symbol=ee.WaveHorizontalSlight,this._symbolSize=10*this._scale,this._symbolOffset=8.5*this._scale,e=6*this._scale;break;case x.Wide:this._symbol=ee.WaveHorizontalWide,this._symbolSize=10*this._scale,this._symbolOffset=7*this._scale,e=10*this._scale}this.height=e*this.scale}paintGrouped(e,t,s,i){let a=s-(e+this.x),r=this._symbolSize*this.scale,n=Math.max(1,a/r),o=0;for(let s=0;s<n;s++)i.fillMusicFontSymbol(e+this.x+o,t+this.y+this._symbolOffset,this._scale,this._symbol,!1),o+=r}}class ji extends Di{get effectId(){return"slight-note-vibrato"}shouldCreateGlyphForNote(e){return e.vibrato===x.Slight||e.isTieDestination&&e.tieOrigin.vibrato===x.Slight}get sizingMode(){return ae.GroupedOnBeatToEnd}createNewGlyph(e,t){return new qi(0,0,x.Slight,1.2)}constructor(){super()}}class Ki{get effectId(){return"tap"}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return t.slap||t.pop||t.tap}createNewGlyph(e,t){let s=e.resources;return t.slap?new Si(0,0,"S",s.effectFont,$.Left):t.pop?new Si(0,0,"P",s.effectFont,$.Left):new Si(0,0,"T",s.effectFont,$.Left)}canExpand(e,t){return!0}}class $i extends mi{constructor(e,t,s){super(e,t),this._tempo=0,this._tempo=s}doLayout(){super.doLayout(),this.height=25*this.scale}paint(e,t,s){let i=this.renderer.resources;s.font=i.markerFont,s.fillMusicFontSymbol(e+this.x,t+this.y+.8*this.height,this.scale*Ti.GraceScale,ee.Tempo,!1),s.fillText("= "+this._tempo,e+this.x+this.height/2,t+this.y+s.font.size/2)}}class Zi{get effectId(){return"tempo"}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ae.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&(!!t.voice.bar.masterBar.tempoAutomation||0===t.voice.bar.index)}createNewGlyph(e,t){let s=0;return s=t.voice.bar.masterBar.tempoAutomation?t.voice.bar.masterBar.tempoAutomation.value:t.voice.bar.staff.track.score.tempo,new $i(0,0,s)}canExpand(e,t){return!0}}class ea{get effectId(){return"text"}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.text}createNewGlyph(e,t){return new Si(0,0,t.text,e.resources.effectFont,$.Left)}canExpand(e,t){return!0}}class ta extends mi{constructor(e,t){super(e,t)}doLayout(){super.doLayout(),this.height=20*this.scale}paint(e,t,s){let i=this.renderer.resources;s.font=i.markerFont;let a=s.measureText("tr");s.fillText("tr",e+this.x,t+this.y+s.font.size/2);let r=a+3*this.scale,n=this.width-r,o=11*this.scale*1.2,h=Math.max(1,(n-r)/o),l=r,d=t+this.y+this.height;for(let t=0;t<h;t++)s.fillMusicFontSymbol(e+this.x+l,d,1.2,ee.WaveHorizontalSlight,!1),l+=o}}class sa extends Di{get effectId(){return"trill"}shouldCreateGlyphForNote(e){return e.isTrill}get sizingMode(){return ae.SingleOnBeat}createNewGlyph(e,t){return new ta(0,0)}}!function(e){e[e.Full=0]="Full",e[e.PartialLeft=1]="PartialLeft",e[e.PartialRight=2]="PartialRight"}(re||(re={}));class ia extends mi{constructor(e){super(0,0),this._tripletFeel=e}doLayout(){super.doLayout(),this.height=25*this.scale}paint(e,t,s){e+=this.x;let i=(t+=this.y)+this.height*Ti.GraceScale;s.font=this.renderer.resources.effectFont,s.fillText("(",e,t+.3*this.height);let a=e+10*this.scale,r=e+40*this.scale;switch(this._tripletFeel){case R.NoTripletFeel:this.renderBarNote(a,i,ia.NoteScale,s,[re.Full]),this.renderBarNote(r,i,ia.NoteScale,s,[re.Full]);break;case R.Triplet8th:this.renderBarNote(a,i,ia.NoteScale,s,[re.Full]),s.fillMusicFontSymbol(r,i,ia.NoteScale,ee.Tempo,!1),s.fillMusicFontSymbol(r+ia.NoteSeparation*this.scale,i,ia.NoteScale,ee.NoteEighth,!1),this.renderTriplet(r,t,s);break;case R.Triplet16th:this.renderBarNote(a,i,ia.NoteScale,s,[re.Full,re.Full]),this.renderBarNote(r,i,ia.NoteScale,s,[re.Full,re.PartialRight]),this.renderTriplet(r,t,s);break;case R.Dotted8th:this.renderBarNote(a,i,ia.NoteScale,s,[re.Full]),this.renderBarNote(r,i,ia.NoteScale,s,[re.Full,re.PartialRight]),s.fillCircle(r+9*this.scale,i,this.scale);break;case R.Dotted16th:this.renderBarNote(a,i,ia.NoteScale,s,[re.Full,re.Full]),this.renderBarNote(r,i,ia.NoteScale,s,[re.Full,re.Full,re.PartialRight]),s.fillCircle(r+9*this.scale,i,this.scale);break;case R.Scottish8th:this.renderBarNote(a,i,ia.NoteScale,s,[re.Full]),this.renderBarNote(r,i,ia.NoteScale,s,[re.Full,re.PartialLeft]),s.fillCircle(r+ia.NoteSeparation*this.scale+8*this.scale,i,this.scale);break;case R.Scottish16th:this.renderBarNote(a,i,ia.NoteScale,s,[re.Full,re.Full]),this.renderBarNote(r,i,ia.NoteScale,s,[re.Full,re.Full,re.PartialLeft]),s.fillCircle(r+ia.NoteSeparation*this.scale+8*this.scale,i,this.scale)}s.fillText("=",e+30*this.scale,t+5*this.scale),s.fillText(")",e+65*this.scale,t+.3*this.height)}renderBarNote(e,t,s,i,a){i.fillMusicFontSymbol(e,t,s,ee.Tempo,!1);let r=ia.NoteSeparation/2*this.scale;for(let s=0;s<a.length;s++)switch(a[s]){case re.Full:i.fillRect(e+4*this.scale,t-ia.NoteHeight*this.scale+ia.BarSeparation*this.scale*s,ia.NoteSeparation*this.scale,ia.BarHeight*this.scale);break;case re.PartialLeft:i.fillRect(e+4*this.scale,t-ia.NoteHeight*this.scale+ia.BarSeparation*this.scale*s,r,ia.BarHeight*this.scale);break;case re.PartialRight:i.fillRect(e+4*this.scale+r,t-ia.NoteHeight*this.scale+ia.BarSeparation*this.scale*s,r,ia.BarHeight*this.scale)}i.fillMusicFontSymbol(e+ia.NoteSeparation*this.scale,t,s,ee.Tempo,!1)}renderTriplet(e,t,s){t+=2*this.scale;let i=this.renderer.resources.effectFont;s.font=new n(i.family,.8*i.size,i.style);let a=e+ia.NoteSeparation*this.scale+3*this.scale;s.beginPath(),s.moveTo(e,t+3*this.scale),s.lineTo(e,t),s.lineTo(e+5*this.scale,t),s.moveTo(a+5*this.scale,t+3*this.scale),s.lineTo(a+5*this.scale,t),s.lineTo(a,t),s.stroke(),s.fillText("3",e+7*this.scale,t-10*this.scale),s.font=i}}ia.NoteScale=.4,ia.NoteHeight=12,ia.NoteSeparation=12,ia.BarHeight=2,ia.BarSeparation=3;class aa{get effectId(){return"triplet-feel"}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return ae.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.index&&(0===t.voice.bar.masterBar.index&&t.voice.bar.masterBar.tripletFeel!==R.NoTripletFeel||t.voice.bar.masterBar.index>0&&t.voice.bar.masterBar.tripletFeel!==t.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(e,t){return new ia(t.voice.bar.masterBar.tripletFeel)}canExpand(e,t){return!0}}class ra{get effectId(){return"whammy"}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return ae.GroupedOnBeat}shouldCreateGlyph(e,t){return t.hasWhammyBar}createNewGlyph(e,t){return new Ii("w/bar")}canExpand(e,t){return!0}}class na{get effectId(){return"wide-beat-vibrato"}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return ae.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===x.Wide}createNewGlyph(e,t){return new Ji(x.Wide)}canExpand(e,t){return!0}}class oa extends Di{get effectId(){return"wide-note-vibrato"}shouldCreateGlyphForNote(e){return e.vibrato===x.Wide||e.isTieDestination&&e.tieOrigin.vibrato===x.Wide}get sizingMode(){return ae.GroupedOnBeatToEnd}createNewGlyph(e,t){return new qi(0,0,x.Wide,1.2)}}class ha extends mi{constructor(e,t,s){super(e,t),this._textRow=0,this._fretRow=0,this._firstFretSpacing=0,this._chord=s}doLayout(){super.doLayout();let e=this.renderer.resources;this._textRow=1.5*e.effectFont.size,this._fretRow=1.5*e.effectFont.size,this._chord.firstFret>1?this._firstFretSpacing=ha.FretSpacing*this.scale:this._firstFretSpacing=0,this.height=this._textRow+this._fretRow+(ha.Frets-1)*ha.FretSpacing*this.scale+2*ha.Padding,this.width=this._firstFretSpacing+(this._chord.staff.tuning.length-1)*ha.StringSpacing*this.scale+2*ha.Padding}paint(e,t,s){e+=this.x+ha.Padding*this.scale+this._firstFretSpacing,t+=this.y;let i=this.width-2*ha.Padding*this.scale+this.scale-this._firstFretSpacing,a=ha.StringSpacing*this.scale,r=ha.FretSpacing*this.scale,n=this.renderer.resources,o=ha.CircleRadius*this.scale,h=s.textAlign,l=s.textBaseline;s.font=n.effectFont,s.textAlign=$.Center,s.textBaseline=Z.Top,this._chord.showName&&s.fillText(this._chord.name,e+this.width/2,t+n.effectFont.size/2),t+=this._textRow,e+=a/2,s.font=n.fretboardNumberFont,s.textBaseline=Z.Middle;for(let i=0;i<this._chord.staff.tuning.length;i++){let r=e+i*a,n=t+this._fretRow/2,o=this._chord.strings[this._chord.staff.tuning.length-i-1];o<0?s.fillMusicFontSymbol(r,n,this.scale,ee.FretboardX,!0):0===o?s.fillMusicFontSymbol(r,n,this.scale,ee.FretboardO,!0):(o-=this._chord.firstFret-1,s.fillText(o.toString(),r,n))}t+=this._fretRow;for(let i=0;i<this._chord.staff.tuning.length;i++){let n=e+i*a;s.fillRect(n,t,1,r*ha.Frets+this.scale)}this._chord.firstFret>1&&(s.textAlign=$.Left,s.fillText(this._chord.firstFret.toString(),e-this._firstFretSpacing,t+r/2)),s.fillRect(e,t-this.scale,i,2*this.scale);for(let a=0;a<=ha.Frets;a++){let n=t+a*r;s.fillRect(e,n,i,this.scale)}let d=new Map;for(let e of this._chord.barreFrets){let t=[-1,-1];d.set(e-this._chord.firstFret,t)}for(let i=0;i<this._chord.strings.length;i++){let n=this._chord.strings[i];if(n>0){if(n-=this._chord.firstFret,d.has(n)){let e=d.get(n);(-1===e[0]||i<e[0])&&(e[0]=i),(-1===e[1]||i>e[1])&&(e[1]=i)}let h=t+n*r+r/2+.5,l=e+(this._chord.strings.length-i-1)*a;s.fillCircle(l,h,o)}}for(let i of d){let n=i[1],h=t+i[0]*r+r/2+this.scale,l=e+(this._chord.strings.length-n[1]-1)*a,d=e+(this._chord.strings.length-n[0]-1)*a;s.fillRect(l,h-o,d-l,2*o)}s.textAlign=h,s.textBaseline=l}}ha.Padding=5,ha.Frets=5,ha.CircleRadius=2.5,ha.StringSpacing=10,ha.FretSpacing=12;class la extends ti{constructor(e,t){super(e,t),this._glyphWidth=0,this.height=0,this.glyphs=[]}doLayout(){let e=(this.width-this._glyphWidth)/2;for(let t of this.glyphs)t.x=e,e+=t.width}addChord(e){this.glyphs.push(e),this._glyphWidth+=e.width,e.height>this.height&&(this.height=e.height)}}class da extends ti{constructor(e,t){super(e,t),this._rows=[],this.height=0,this.height=0,this.glyphs=[]}addChord(e){if(e.strings.length>0){let t=new ha(0,0,e);t.renderer=this.renderer,t.doLayout(),this.glyphs.push(t)}}doLayout(){let e=0,t=0,s=2*da.Padding*this.scale;this._rows=[];let i=new la(e,t);i.width=this.width;for(let a of this.glyphs)e+a.width<this.width?(i.addChord(a),e+=a.width):(i.isEmpty||(i.doLayout(),this._rows.push(i),t+=i.height+s),e=0,i=new la(e,t),i.width=this.width,i.addChord(a),e+=a.width);i.isEmpty||(i.doLayout(),this._rows.push(i),t+=i.height+s),this.height=t+s}paint(e,t,s){for(let i of this._rows)i.paint(e+this.x,t+this.y+da.Padding*this.scale,s)}}da.Padding=3;class ca extends ti{constructor(e,t,s,i,a){super(e,t),this._scale=0,this.height=0,this._scale=s,this._resources=i,this.createGlyphs(a)}createGlyphs(e){if(this.addGlyph(new Si(0,0,e.name,this._resources.effectFont,$.Left)),this.height+=15*this._scale,!e.isStandard){let t=0|Math.ceil(e.tunings.length/2),s=0,i=this.height;for(let a=0,r=e.tunings.length;a<r;a++){let r="("+(a+1)+") = "+Ie.getTextForTuning(e.tunings[a],!1);this.addGlyph(new Si(s,i,r,this._resources.effectFont,$.Left)),i+=this.height,a===t-1&&(i=this.height,s+=43*this._scale)}this.height+=t*(15*this._scale)}}}!function(e){e[e.None=0]="None",e[e.Title=1]="Title",e[e.SubTitle=2]="SubTitle",e[e.Artist=4]="Artist",e[e.Album=8]="Album",e[e.Words=16]="Words",e[e.Music=32]="Music",e[e.WordsAndMusic=64]="WordsAndMusic",e[e.Copyright=128]="Copyright",e[e.PageNumber=256]="PageNumber",e[e.All=511]="All"}(ne||(ne={}));class ua{constructor(e,t,s){this._sharedLayoutData=new Map,this.barRenderers=[],this.x=0,this.y=0,this.height=0,this.index=0,this.staffIndex=0,this.trackIndex=0,this.staveTop=0,this.topSpacing=20,this.bottomSpacing=5,this.staveBottom=0,this.isFirstInAccolade=!1,this.isLastInAccolade=!1,this._factory=s,this.trackIndex=e,this.modelStaff=t}get staveId(){return this._factory.staffId}getSharedLayoutData(e,t){return this._sharedLayoutData.has(e)?this._sharedLayoutData.get(e):t}setSharedLayoutData(e,t){this._sharedLayoutData.set(e,t)}get isInAccolade(){return this._factory.isInAccolade}get isRelevantForBoundsLookup(){return this._factory.isRelevantForBoundsLookup}registerStaffTop(e){this.staveTop=e}registerStaffBottom(e){this.staveBottom=e}addBarRenderer(e){e.staff=this,e.index=this.barRenderers.length,e.reLayout(),this.barRenderers.push(e),this.staveGroup.layout.registerBarRenderer(this.staveId,e)}addBar(e,t){let s;s=e?this._factory.create(this.staveGroup.layout.renderer,e):new oi(this.staveGroup.layout.renderer,e),s.staff=this,s.index=this.barRenderers.length,s.layoutingInfo=t,s.doLayout(),s.registerLayoutingInfo(),this.barRenderers.push(s),e&&this.staveGroup.layout.registerBarRenderer(this.staveId,s)}revertLastBar(){let e=this.barRenderers[this.barRenderers.length-1];return this.barRenderers.splice(this.barRenderers.length-1,1),this.staveGroup.layout.unregisterBarRenderer(this.staveId,e),e}scaleToWidth(e){this._sharedLayoutData=new Map;let t=(e-this.staveGroup.width)/this.barRenderers.length;for(let e=0,s=this.barRenderers.length;e<s;e++)this.barRenderers[e].scaleToWidth(this.barRenderers[e].width+t)}get topOverflow(){let e=0;for(let t=0,s=this.barRenderers.length;t<s;t++){let s=this.barRenderers[t];s.topOverflow>e&&(e=s.topOverflow)}return e}get bottomOverflow(){let e=0;for(let t=0,s=this.barRenderers.length;t<s;t++){let s=this.barRenderers[t];s.bottomOverflow>e&&(e=s.bottomOverflow)}return e}finalizeStaff(){let e=0;this.height=0;let t=this.topOverflow,s=this.bottomOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].x=e,this.barRenderers[s].y=this.topSpacing+t,this.height=Math.max(this.height,this.barRenderers[s].height),this.barRenderers[s].finalizeRenderer(),e+=this.barRenderers[s].width;this.height>0&&(this.height+=this.topSpacing+t+s+this.bottomSpacing)}paint(e,t,s,i,a){if(0!==this.height&&0!==a)for(let r=i,n=Math.min(i+a,this.barRenderers.length);r<n;r++)this.barRenderers[r].paint(e+this.x,t+this.y,s)}}class pa{constructor(){this.timePosition=0,this.longestDuration=0,this.smallestDuration=0,this.force=0,this.springConstant=0,this.preSpringWidth=0,this.postSpringWidth=0,this.allDurations=[]}get springWidth(){return this.preSpringWidth+this.postSpringWidth}}class ga{constructor(){this._timeSortedSprings=[],this._xMin=0,this._minTime=-1,this._onTimePositionsForce=0,this._onTimePositions=new Map,this.version=0,this.preBeatSizes=new Map,this.onBeatSizes=new Map,this.onBeatCenterX=new Map,this.preBeatSize=0,this.postBeatSize=0,this.voiceSize=0,this.minStretchForce=0,this.totalSpringConstant=0,this.springs=new Map}updateVoiceSize(e){e>this.voiceSize&&(this.voiceSize=e,this.version++)}setPreBeatSize(e,t){(!this.preBeatSizes.has(e.index)||this.preBeatSizes.get(e.index)<t)&&(this.preBeatSizes.set(e.index,t),this.version++)}getPreBeatSize(e){return this.preBeatSizes.has(e.index)?this.preBeatSizes.get(e.index):0}setOnBeatSize(e,t){(!this.onBeatSizes.has(e.index)||this.onBeatSizes.get(e.index)<t)&&(this.onBeatSizes.set(e.index,t),this.version++)}getOnBeatSize(e){return this.onBeatSizes.has(e.index)?this.onBeatSizes.get(e.index):0}getBeatCenterX(e){return this.onBeatCenterX.has(e.index)?this.onBeatCenterX.get(e.index):0}setBeatCenterX(e,t){(!this.onBeatCenterX.has(e.index)||this.onBeatCenterX.get(e.index)<t)&&(this.onBeatCenterX.set(e.index,t),this.version++)}updateMinStretchForce(e){this.minStretchForce<e&&(this.minStretchForce=e,this.version++)}addSpring(e,t,s,i){let a;if(this.version++,this.springs.has(e))a=this.springs.get(e),a.postSpringWidth<i&&(a.postSpringWidth=i),a.preSpringWidth<s&&(a.preSpringWidth=s),t<a.smallestDuration&&(a.smallestDuration=t),t>a.longestDuration&&(a.longestDuration=t),a.allDurations.push(t);else{if(a=new pa,a.timePosition=e,a.allDurations.push(t),this._timeSortedSprings.length>0){let e=this._timeSortedSprings[this._timeSortedSprings.length-1];for(let t of e.allDurations){e.timePosition}}a.longestDuration=t,a.postSpringWidth=i,a.preSpringWidth=s,this.springs.set(e,a);let r=this._timeSortedSprings,n=r.length-1;for(;n>0&&r[n].timePosition>e;)n--;this._timeSortedSprings.splice(n+1,0,a)}return(-1===this._minTime||this._minTime>e)&&(this._minTime=e),a}addBeatSpring(e,t,s){let i=e.absoluteDisplayStart;return this.addSpring(i,e.displayDuration,t,s)}finish(){this.calculateSpringConstants(),this.version++}calculateSpringConstants(){this._xMin=0;let e=this.springs;for(let t of e){let e=t[1];e.springWidth<this._xMin&&(this._xMin=e.springWidth)}let t=0,s=this._timeSortedSprings;for(let e=0;e<s.length;e++){let i=s[e],a=0;if(e===s.length-1)a=i.longestDuration;else{let t=s[e+1];a=Math.abs(t.timePosition-i.timePosition)}i.springConstant=this.calculateSpringConstant(i,a),t+=1/i.springConstant}this.totalSpringConstant=1/t;for(let e=0;e<s.length;e++){let t=s[e].springWidth*s[e].springConstant;this.updateMinStretchForce(t)}}calculateSpringConstant(e,t){return t<=0&&(t=me.toTicks(b.SixtyFourth)),0===e.smallestDuration&&(e.smallestDuration=t),e.smallestDuration/t*(1/((1+.6*Math.log2(t/ga.MinDuration))*ga.MinDurationWidth))}spaceToForce(e){return e*this.totalSpringConstant}calculateVoiceWidth(e){return this.calculateWidth(e,this.totalSpringConstant)}calculateWidth(e,t){return e/t}buildOnTimePositions(e){if(i.isAlmostEqualTo(this._onTimePositionsForce,e)&&this._onTimePositions)return this._onTimePositions;this._onTimePositionsForce=e;let t=this._onTimePositions=new Map,s=this._timeSortedSprings;if(0===s.length)return t;let a=s[0].preSpringWidth;for(let i=0;i<s.length;i++)t.set(s[i].timePosition,a),a+=this.calculateWidth(e,s[i].springConstant);return t}}ga.MinDuration=30,ga.MinDurationWidth=10;class fa{constructor(){this.width=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.renderers=[]}}class ma{constructor(e,t){this.staves=[],this.stavesRelevantForBoundsLookup=[],this.firstStaffInAccolade=null,this.lastStaffInAccolade=null,this.staveGroup=e,this.track=t}addStaff(e){this.staves.push(e),e.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(e)}}class ya{constructor(){this._allStaves=[],this._firstStaffInAccolade=null,this._lastStaffInAccolade=null,this._accoladeSpacingCalculated=!1,this.x=0,this.y=0,this.index=0,this.accoladeSpacing=0,this.isFull=!1,this.width=0,this.isLast=!1,this.masterBarsRenderers=[],this.staves=[]}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].masterBar.index}addMasterBarRenderers(e,t){if(0===e.length)return null;this.masterBarsRenderers.push(t),this.calculateAccoladeSpacing(e),t.layoutingInfo.preBeatSize=0;let s=0;for(let e=0,i=this.staves.length;e<i;e++){let i=this.staves[e];for(let e=0,a=i.staves.length;e<a;e++){let a=i.staves[e],r=t.renderers[s++];a.addBarRenderer(r)}}return this.updateWidth(),t}addBars(e,t){if(0===e.length)return null;let s=new fa;s.layoutingInfo=new ga,s.masterBar=e[0].score.masterBars[t],this.masterBarsRenderers.push(s),this.calculateAccoladeSpacing(e);let i=s.layoutingInfo;for(let e of this.staves)for(let a of e.staves){let r=e.track.staves[a.modelStaff.index].bars[t];a.addBar(r,i);let n=a.barRenderers[a.barRenderers.length-1];s.renderers.push(n),n.isLinkedToPrevious&&(s.isLinkedToPrevious=!0),n.canWrap||(s.canWrap=!1)}return i.finish(),s.width=this.updateWidth(),s}revertLastBar(){if(this.masterBarsRenderers.length>1){let e=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let t=0;for(let e=0,s=this._allStaves.length;e<s;e++){let s=this._allStaves[e].revertLastBar();t=Math.max(t,s.width)}return this.width-=t,e}return null}updateWidth(){let e=0;for(let t=0,s=this._allStaves.length;t<s;t++){let s=this._allStaves[t];s.barRenderers[s.barRenderers.length-1].applyLayoutingInfo(),s.barRenderers[s.barRenderers.length-1].width>e&&(e=s.barRenderers[s.barRenderers.length-1].width)}return this.width+=e,e}calculateAccoladeSpacing(e){if(!this._accoladeSpacingCalculated&&0===this.index)if(this._accoladeSpacingCalculated=!0,this.layout.renderer.settings.notation.hideTrackNames)this.accoladeSpacing=0;else{let t=this.layout.renderer.canvas,s=this.layout.renderer.settings.display.resources.effectFont;t.font=s;for(let s of e)this.accoladeSpacing=Math.ceil(Math.max(this.accoladeSpacing,t.measureText(s.shortName)));this.accoladeSpacing*=this.layout.scale,this.accoladeSpacing+=2*ya.AccoladeLabelSpacing*this.layout.scale,this.width+=this.accoladeSpacing}}getStaveTrackGroup(e){for(let t=0,s=this.staves.length;t<s;t++){let s=this.staves[t];if(s.track===e)return s}return null}addStaff(e,t){let s=this.getStaveTrackGroup(e);s||(s=new ma(this,e),this.staves.push(s)),t.staveTrackGroup=s,t.staveGroup=this,t.index=this._allStaves.length,this._allStaves.push(t),s.addStaff(t),t.isInAccolade&&(this._firstStaffInAccolade||(this._firstStaffInAccolade=t,t.isFirstInAccolade=!0),s.firstStaffInAccolade||(s.firstStaffInAccolade=t),this._lastStaffInAccolade||(this._lastStaffInAccolade=t,t.isLastInAccolade=!0),this._lastStaffInAccolade&&(this._lastStaffInAccolade.isLastInAccolade=!1),this._lastStaffInAccolade=t,this._lastStaffInAccolade.isLastInAccolade=!0,s.lastStaffInAccolade=t)}get height(){return this._allStaves[this._allStaves.length-1].y+this._allStaves[this._allStaves.length-1].height}scaleToWidth(e){for(let t=0,s=this._allStaves.length;t<s;t++)this._allStaves[t].scaleToWidth(e);this.width=e}paint(e,t,s){this.paintPartial(e+this.x,t+this.y,s,0,this.masterBarsRenderers.length)}paintPartial(e,t,s,i,a){this.buildBoundingsLookup(e,t);for(let r=0,n=this._allStaves.length;r<n;r++)this._allStaves[r].paint(e,t,s,i,a);let r=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&0===i){if(s.color=r.barSeparatorColor,this._firstStaffInAccolade&&this._lastStaffInAccolade){let i=t+this._firstStaffInAccolade.y+this._firstStaffInAccolade.staveTop+this._firstStaffInAccolade.topSpacing+this._firstStaffInAccolade.topOverflow,a=t+this._lastStaffInAccolade.y+this._lastStaffInAccolade.topSpacing+this._lastStaffInAccolade.topOverflow+this._lastStaffInAccolade.staveBottom,r=e+this._firstStaffInAccolade.x;s.beginPath(),s.moveTo(r,i),s.lineTo(r,a),s.stroke()}s.font=r.effectFont;for(let i=0,a=this.staves.length;i<a;i++){let a=this.staves[i];if(a.firstStaffInAccolade&&a.lastStaffInAccolade){let i=t+a.firstStaffInAccolade.y+a.firstStaffInAccolade.staveTop+a.firstStaffInAccolade.topSpacing+a.firstStaffInAccolade.topOverflow,r=t+a.lastStaffInAccolade.y+a.lastStaffInAccolade.topSpacing+a.lastStaffInAccolade.topOverflow+a.lastStaffInAccolade.staveBottom,n=e+a.firstStaffInAccolade.x,o=3*this.layout.renderer.settings.display.scale,h=o,l=i-4*o,d=r+4*o;0!==this.index||this.layout.renderer.settings.notation.hideTrackNames||s.fillText(a.track.shortName,e+ya.AccoladeLabelSpacing*this.layout.scale,i),s.fillRect(n-h-o,l,o,d-l);let c=n-h-o,u=n+2*o;s.beginPath(),s.moveTo(c,l),s.bezierCurveTo(c,l,c,l,u,l-o),s.bezierCurveTo(n,l+o,c,l+o,c,l+o),s.closePath(),s.fill(),s.beginPath(),s.moveTo(c,d),s.bezierCurveTo(c,d,n,d,u,d+o),s.bezierCurveTo(n,d-o,c,d-o,c,d-o),s.closePath(),s.fill()}}}}finalizeGroup(){let e=0;for(let t of this._allStaves)t.x=this.accoladeSpacing,t.y=e,t.finalizeStaff(),e+=t.height}buildBoundingsLookup(e,t){if(this.layout.renderer.boundsLookup.isFinished)return;if(!this._firstStaffInAccolade||!this._lastStaffInAccolade)return;let s=this._allStaves[this._allStaves.length-1],i=t+this.y+this._firstStaffInAccolade.y,a=t+this.y+this._lastStaffInAccolade.y+this._lastStaffInAccolade.height,r=t+this.y+this._allStaves[0].y,n=t+this.y+s.y+s.height,o=t+this.y+this._firstStaffInAccolade.y+this._firstStaffInAccolade.topSpacing+this._firstStaffInAccolade.topOverflow+(this._firstStaffInAccolade.barRenderers.length>0?this._firstStaffInAccolade.barRenderers[0].topPadding:0),h=a-i,l=t+this.y+s.y+s.height-s.bottomSpacing-s.bottomOverflow-(s.barRenderers.length>0?s.barRenderers[0].bottomPadding:0)-o,d=n-r,c=this.x+this._firstStaffInAccolade.x,u=new Ss;u.visualBounds=new Je,u.visualBounds.x=e,u.visualBounds.y=t+this.y,u.visualBounds.w=this.width,u.visualBounds.h=this.height,u.realBounds=new Je,u.realBounds.x=e,u.realBounds.y=t+this.y,u.realBounds.w=this.width,u.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaveGroup(u);let p=new Map;for(let e=0;e<this.staves.length;e++)for(let s of this.staves[e].stavesRelevantForBoundsLookup)for(let e of s.barRenderers){let a;p.has(e.bar.masterBar.index)?a=p.get(e.bar.masterBar.index):(a=new ys,a.index=e.bar.masterBar.index,a.isFirstOfLine=e.isFirstOfLine,a.realBounds=new Je,a.realBounds.x=c+e.x,a.realBounds.y=r,a.realBounds.w=e.width,a.realBounds.h=d,a.visualBounds=new Je,a.visualBounds.x=c+e.x,a.visualBounds.y=i,a.visualBounds.w=e.width,a.visualBounds.h=h,a.lineAlignedBounds=new Je,a.lineAlignedBounds.x=c+e.x,a.lineAlignedBounds.y=o,a.lineAlignedBounds.w=e.width,a.lineAlignedBounds.h=l,this.layout.renderer.boundsLookup.addMasterBar(a),p.set(a.index,a)),e.buildBoundingsLookup(a,c,t+this.y+s.y)}}getBarX(e){if(!this._firstStaffInAccolade||0===this.layout.renderer.tracks.length)return 0;let t=this.layout.renderer.tracks[0].staves[0].bars[e];return this.layout.getRendererForBar(this._firstStaffInAccolade.staveId,t).x}}ya.AccoladeLabelSpacing=10;class ba{constructor(e){this._barRendererLookup=new Map,this.width=0,this.height=0,this.scoreInfoGlyphs=new Map,this.chordDiagrams=null,this.tuningGlyph=null,this.firstBarIndex=0,this.lastBarIndex=0,this.renderer=e}layoutAndRender(){let e=this.renderer.score,t=this.renderer.settings.display.startBar;t--,t=Math.min(e.masterBars.length-1,Math.max(0,t)),this.firstBarIndex=t;let s=this.renderer.settings.display.barCount;s<0&&(s=e.masterBars.length),s=t+s-1,s=Math.min(e.masterBars.length-1,Math.max(0,s)),this.lastBarIndex=s,this.createScoreInfoGlyphs(),this.doLayoutAndRender()}createScoreInfoGlyphs(){we.info("ScoreLayout","Creating score info glyphs");let e=this.renderer.settings.notation.hideInfo?ne.None:ne.All,t=this.renderer.score,s=this.renderer.settings.display.resources;if(this.scoreInfoGlyphs=new Map,t.title&&0!=(e&ne.Title)&&this.scoreInfoGlyphs.set(ne.Title,new Si(0,0,t.title,s.titleFont,$.Center)),t.subTitle&&0!=(e&ne.SubTitle)&&this.scoreInfoGlyphs.set(ne.SubTitle,new Si(0,0,t.subTitle,s.subTitleFont,$.Center)),t.artist&&0!=(e&ne.Artist)&&this.scoreInfoGlyphs.set(ne.Artist,new Si(0,0,t.artist,s.subTitleFont,$.Center)),t.album&&0!=(e&ne.Album)&&this.scoreInfoGlyphs.set(ne.Album,new Si(0,0,t.album,s.subTitleFont,$.Center)),t.music&&t.music===t.words&&0!=(e&ne.WordsAndMusic)?this.scoreInfoGlyphs.set(ne.WordsAndMusic,new Si(0,0,"Music and Words by "+t.words,s.wordsFont,$.Center)):(t.music&&0!=(e&ne.Music)&&this.scoreInfoGlyphs.set(ne.Music,new Si(0,0,"Music by "+t.music,s.wordsFont,$.Right)),t.words&&0!=(e&ne.Words)&&this.scoreInfoGlyphs.set(ne.Words,new Si(0,0,"Words by "+t.words,s.wordsFont,$.Left))),!this.renderer.settings.notation.hideTuning){let e=null;for(let t of this.renderer.tracks){for(let s of t.staves)if(!s.isPercussion&&s.isStringed&&s.tuning.length>0){e=s;break}if(e)break}if(e){let t=Ie.findTuning(e.tuning);t&&(this.tuningGlyph=new ca(0,0,this.scale,s,t))}}if(!this.renderer.settings.notation.hideChordDiagrams){this.chordDiagrams=new da(0,0),this.chordDiagrams.renderer=new oi(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);let e=new Map;for(let t of this.renderer.tracks)for(let s of t.staves)for(let t of s.chords){let s=t[0];if(!e.has(s)){let i=t[1];i.showDiagram&&(e.set(s,i),this.chordDiagrams.addChord(i))}}}}get scale(){return this.renderer.settings.display.scale}createEmptyStaveGroup(){let t=new ya;t.layout=this;for(let s=0;s<this.renderer.tracks.length;s++){let i=this.renderer.tracks[s],a=!1;for(let e of i.staves)if(e.showStandardNotation){a=!0;break}for(let r=0;r<i.staves.length;r++){let n,o=i.staves[r];if(o.isPercussion)n=e.StaveProfile.Score;else if(this.renderer.settings.display.staveProfile!==e.StaveProfile.Default)n=this.renderer.settings.display.staveProfile;else if(o.showTablature&&o.showStandardNotation)n=e.StaveProfile.ScoreTab;else if(o.showTablature)n=a?e.StaveProfile.TabMixed:e.StaveProfile.Tab;else{if(!o.showStandardNotation)continue;n=e.StaveProfile.Score}let h=Er.staveProfiles.get(n);for(let e of h)e.canCreate(i,o)&&t.addStaff(i,new ua(s,o,e))}}return t}registerBarRenderer(e,t){this._barRendererLookup.has(e)||this._barRendererLookup.set(e,new Map),this._barRendererLookup.get(e).set(t.bar.id,t)}unregisterBarRenderer(e,t){if(this._barRendererLookup.has(e)){this._barRendererLookup.get(e).delete(t.bar.id)}}getRendererForBar(e,t){let s=t.id;return this._barRendererLookup.has(e)&&this._barRendererLookup.get(e).has(s)?this._barRendererLookup.get(e).get(s):null}renderAnnotation(){let e=this.renderer.canvas,t=this.renderer.settings.display.resources,s=12*this.renderer.settings.display.scale,i=2*s;this.height+=i;let a=this.width/2;e.beginRender(this.width,i),e.color=t.mainGlyphColor,e.font=new n(t.copyrightFont.family,s,r.Bold),e.textAlign=$.Center,e.fillText("rendered by alphaTab (https://alphaTab.net)",a,s);let o=e.endRender(),h=new gs;h.width=this.width,h.height=i,h.renderResult=o,h.totalWidth=this.width,h.totalHeight=this.height,h.firstMasterBarIndex=-1,h.lastMasterBarIndex=-1,this.renderer.partialRenderFinished.trigger(h)}}class Sa{constructor(){this.width=0,this.masterBars=[]}}class _a extends ba{constructor(e){super(e),this._group=null,this._pagePadding=null}get name(){return"HorizontalScreen"}get supportsResize(){return!1}resize(){}doLayoutAndRender(){this._pagePadding=this.renderer.settings.display.padding,this._pagePadding||(this._pagePadding=_a.PagePadding),1===this._pagePadding.length?this._pagePadding=new Float32Array([this._pagePadding[0],this._pagePadding[0],this._pagePadding[0],this._pagePadding[0]]):2===this._pagePadding.length&&(this._pagePadding=new Float32Array([this._pagePadding[0],this._pagePadding[1],this._pagePadding[0],this._pagePadding[1]]));let e=this.renderer.score,t=this.renderer.canvas,s=this.renderer.settings.display.startBar;s--,s=Math.min(e.masterBars.length-1,Math.max(0,s));let i=s,a=this.renderer.settings.display.barCount;a<=0&&(a=e.masterBars.length),a=s+a-1,a=Math.min(e.masterBars.length-1,Math.max(0,a)),this._group=this.createEmptyStaveGroup(),this._group.isLast=!0,this._group.x=this._pagePadding[0],this._group.y=this._pagePadding[1];let r=this.renderer.settings.display.barCountPerPartial,n=[],o=new Sa;for(;i<=a;){let t=this._group.addBars(this.renderer.tracks,i);if(t)if(0===o.masterBars.length&&t.isLinkedToPrevious&&n.length>0){let s=n[n.length-1];s.masterBars.push(e.masterBars[i]),s.width+=t.width}else o.masterBars.push(e.masterBars[i]),o.width+=t.width,o.masterBars.length>=r&&(0===n.length&&(o.width+=this._group.x+this._group.accoladeSpacing),n.push(o),we.info(this.name,"Finished partial from bar "+o.masterBars[0].index+" to "+o.masterBars[o.masterBars.length-1].index,null),o=new Sa);i++}o.masterBars.length>0&&(0===n.length&&(o.width+=this._group.x+this._group.accoladeSpacing),n.push(o),we.info(this.name,"Finished partial from bar "+o.masterBars[0].index+" to "+o.masterBars[o.masterBars.length-1].index,null)),this._group.finalizeGroup(),this.height=this._group.y+this._group.height+this._pagePadding[3],this.width=this._group.x+this._group.width+this._pagePadding[2],i=0;for(let e=0;e<n.length;e++){let s=n[e];t.beginRender(s.width,this.height),t.color=this.renderer.settings.display.resources.mainGlyphColor,t.textAlign=$.Left;let a=this._group.getBarX(s.masterBars[0].index)+this._group.accoladeSpacing;0===e&&(a-=this._group.x+this._group.accoladeSpacing),we.info(this.name,"Rendering partial from bar "+s.masterBars[0].index+" to "+s.masterBars[s.masterBars.length-1].index,null),this._group.paintPartial(-a,this._group.y,this.renderer.canvas,i,s.masterBars.length);let r=t.endRender(),o=new gs;o.totalWidth=this.width,o.totalHeight=this.height,o.width=s.width,o.height=this.height,o.renderResult=r,o.firstMasterBarIndex=s.masterBars[0].index,o.lastMasterBarIndex=s.masterBars[s.masterBars.length-1].index,this.renderer.partialRenderFinished.trigger(o),i+=s.masterBars.length}}}_a.PagePadding=new Float32Array([20,20,20,20]),_a.GroupSpacing=20;class wa extends ba{constructor(e){super(e),this._groups=[],this._allMasterBarRenderers=[],this._barsFromPreviousGroup=[],this._pagePadding=null}get name(){return"PageView"}doLayoutAndRender(){this._pagePadding=this.renderer.settings.display.padding,this._pagePadding||(this._pagePadding=wa.PagePadding),1===this._pagePadding.length?this._pagePadding=new Float32Array([this._pagePadding[0],this._pagePadding[0],this._pagePadding[0],this._pagePadding[0]]):2===this._pagePadding.length&&(this._pagePadding=new Float32Array([this._pagePadding[0],this._pagePadding[1],this._pagePadding[0],this._pagePadding[1]]));let e=this._pagePadding[0],t=this._pagePadding[1];this.width=this.renderer.width,this._allMasterBarRenderers=[],t=this.layoutAndRenderScoreInfo(e,t,-1),t=this.layoutAndRenderChordDiagrams(t,-1),t=this.layoutAndRenderScore(e,t),this.height=t+this._pagePadding[3]}get supportsResize(){return!0}resize(){let e=this._pagePadding[0],t=this._pagePadding[1];this.width=this.renderer.width;let s=this.height;t=this.layoutAndRenderScoreInfo(e,t,s),t=this.layoutAndRenderChordDiagrams(t,s),t=this.resizeAndRenderScore(e,t,s),this.height=t+this._pagePadding[3]}layoutAndRenderChordDiagrams(e,t=-1){if(!this.chordDiagrams)return e;let s=this.renderer.settings.display.resources;this.chordDiagrams.width=this.width,this.chordDiagrams.doLayout();let i=this.renderer.canvas;i.beginRender(this.width,this.chordDiagrams.height),i.color=s.scoreInfoColor,i.textAlign=$.Center,this.chordDiagrams.paint(0,0,i);let a=i.endRender();e+=this.chordDiagrams.height;let r=new gs;return r.width=this.width,r.height=this.chordDiagrams.height,r.renderResult=a,r.totalWidth=this.width,r.totalHeight=t<0?e:t,r.firstMasterBarIndex=-1,r.lastMasterBarIndex=-1,this.renderer.partialRenderFinished.trigger(r),e}layoutAndRenderScoreInfo(e,t,s=-1){we.debug(this.name,"Layouting score info");let i=this.scale,a=this.renderer.settings.display.resources,r=[ne.Title,ne.SubTitle,ne.Artist,ne.Album,ne.WordsAndMusic];for(let e=0;e<r.length;e++)if(this.scoreInfoGlyphs.has(r[e])){let s=this.scoreInfoGlyphs.get(r[e]);s.x=this.width/2,s.y=t,s.textAlign=$.Center,t+=s.font.size}let n=!1,o=0;if(this.scoreInfoGlyphs.has(ne.Music)){let e=this.scoreInfoGlyphs.get(ne.Music);e.x=this.width-this._pagePadding[2],e.y=t,e.textAlign=$.Right,n=!0,o=e.font.size}if(this.scoreInfoGlyphs.has(ne.Words)){let s=this.scoreInfoGlyphs.get(ne.Words);s.x=e,s.y=t,s.textAlign=$.Left,n=!0,o=s.font.size}n&&(t+=o),this.tuningGlyph&&(t+=20*i,this.tuningGlyph.x=e,this.tuningGlyph.y=t,t+=this.tuningGlyph.height),t+=20*i;let h=this.renderer.canvas;h.beginRender(this.width,t),h.color=a.scoreInfoColor,h.textAlign=$.Center;for(let e of this.scoreInfoGlyphs)e[1].paint(0,0,h);this.tuningGlyph&&this.tuningGlyph.paint(0,0,h);let l=h.endRender(),d=new gs;return d.width=this.width,d.height=t,d.renderResult=l,d.totalWidth=this.width,d.totalHeight=s<0?t:s,d.firstMasterBarIndex=-1,d.lastMasterBarIndex=-1,this.renderer.partialRenderFinished.trigger(d),t}resizeAndRenderScore(e,t,s){let i=this.renderer.canvas;if(-1!==this.renderer.settings.display.barsPerRow)for(let e=0;e<this._groups.length;e++){let a=this._groups[e];this.fitGroup(a),a.finalizeGroup(),t+=this.paintGroup(a,s,i)}else{this._groups=[];let a=0,r=this.maxWidth,n=this.createEmptyStaveGroup();for(n.index=this._groups.length,n.x=e,n.y=t;a<this._allMasterBarRenderers.length;){let o=this._allMasterBarRenderers[a];if(n.width+o.width<=r||0===n.masterBarsRenderers.length)n.addMasterBarRenderers(this.renderer.tracks,o),a++;else{for(;o&&!o.canWrap&&n.masterBarsRenderers.length>1;)o=n.revertLastBar(),a--;n.isFull=!0,n.isLast=this.lastBarIndex===n.lastBarIndex,this._groups.push(n),this.fitGroup(n),n.finalizeGroup(),t+=this.paintGroup(n,s,i),n=this.createEmptyStaveGroup(),n.index=this._groups.length,n.x=e,n.y=t}}n.isLast=this.lastBarIndex===n.lastBarIndex,this.fitGroup(n),n.finalizeGroup(),t+=this.paintGroup(n,s,i)}return t}layoutAndRenderScore(e,t){let s=this.renderer.canvas,i=this.firstBarIndex,a=this.lastBarIndex;for(this._groups=[];i<=a;){let r=this.createStaveGroup(i,a);this._groups.push(r),r.x=e,r.y=t,i=r.lastBarIndex+1,this.fitGroup(r),r.finalizeGroup(),we.info(this.name,"Rendering partial from bar "+r.firstBarIndex+" to "+r.lastBarIndex,null),t+=this.paintGroup(r,t,s)}return t}paintGroup(e,t,s){let i=e.height+20*this.scale;s.beginRender(this.width,i),this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=$.Left,e.paint(0,-e.y,s),t+=i;let a=s.endRender(),r=new gs;return r.totalWidth=this.width,r.totalHeight=t,r.width=this.width,r.height=i,r.renderResult=a,r.firstMasterBarIndex=e.firstBarIndex,r.lastMasterBarIndex=e.lastBarIndex,this.renderer.partialRenderFinished.trigger(r),i}fitGroup(e){(e.isFull||e.width>this.maxWidth)&&e.scaleToWidth(this.maxWidth),this.width=Math.max(this.width,e.width)}createStaveGroup(e,t){let s=this.createEmptyStaveGroup();s.index=this._groups.length;let i=this.renderer.settings.display.barsPerRow,a=this.maxWidth,r=t+1;for(let t=e;t<r;t++){if(this._barsFromPreviousGroup.length>0)for(let e of this._barsFromPreviousGroup)s.addMasterBarRenderers(this.renderer.tracks,e),t=e.masterBar.index;else{let e=s.addBars(this.renderer.tracks,t);e&&this._allMasterBarRenderers.push(e)}this._barsFromPreviousGroup=[];let e=!1;if((-1===i&&s.width>=a&&0!==s.masterBarsRenderers.length||s.masterBarsRenderers.length===i+1)&&(e=!0),e){let e=s.revertLastBar();if(e)for(this._barsFromPreviousGroup.push(e);e&&!e.canWrap&&s.masterBarsRenderers.length>1;)e=s.revertLastBar(),e&&this._barsFromPreviousGroup.push(e);return s.isFull=!0,s.isLast=!1,this._barsFromPreviousGroup.reverse(),s}s.x=0}return s.isLast=t===s.lastBarIndex,s}get maxWidth(){return this.renderer.width-this._pagePadding[0]-this._pagePadding[2]}}wa.PagePadding=new Float32Array([40,40,40,40]),wa.GroupSpacing=20,function(e){e[e.None=0]="None",e[e.Natural=1]="Natural",e[e.Sharp=2]="Sharp",e[e.Flat=3]="Flat",e[e.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",e[e.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",e[e.FlatQuarterNoteUp=6]="FlatQuarterNoteUp"}(oe||(oe={}));class Ba extends vi{constructor(e,t,s,i=!1){super(e,t,i?Ti.GraceScale:1,Ba.getMusicSymbol(s)),this._isGrace=!1,this._isGrace=i}static getMusicSymbol(e){switch(e){case oe.Natural:return ee.AccidentalNatural;case oe.Sharp:return ee.AccidentalSharp;case oe.Flat:return ee.AccidentalFlat;case oe.NaturalQuarterNoteUp:return ee.AccidentalQuarterToneNaturalArrowUp;case oe.SharpQuarterNoteUp:return ee.AccidentalQuarterToneSharpArrowUp;case oe.FlatQuarterNoteUp:return ee.AccidentalQuarterToneFlatArrowUp}return ee.None}doLayout(){this.width=8*(this._isGrace?Ti.GraceScale:1)*this.scale}}class va extends Ds{constructor(e,t,s){super(e,t),this._number=0,this._number=s}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this._number.toString())+5*this.scale}paint(e,t,s){if(!this.renderer.staff.isFirstInAccolade)return;let i=this.renderer.resources,a=s.color;s.color=i.barNumberColor,s.font=i.barNumberFont,s.fillText(this._number.toString(),e+this.x,t+this.y),s.color=a}}class Ta extends Ds{constructor(e,t){super(e,t)}doLayout(){this.renderer.isLast?this.width=15*this.scale:this.renderer.nextRenderer&&this.renderer.nextRenderer.staff===this.renderer.staff&&this.renderer.nextRenderer.bar.masterBar.isRepeatStart?this.width=2*this.scale:(this.width=2*this.scale,this.renderer.bar.masterBar.isDoubleBar&&(this.width+=2*this.scale))}paint(e,t,s){let i=4*this.scale,a=t+this.y+this.renderer.topPadding,r=t+this.y+this.renderer.height-this.renderer.bottomPadding,n=e+this.x,o=r-a;this.renderer.isLast?(s.fillRect(n+this.width-i-i,a,this.scale,o),s.fillRect(n+this.width-i,a,i,o)):this.renderer.nextRenderer&&this.renderer.nextRenderer.staff===this.renderer.staff&&this.renderer.nextRenderer.bar.masterBar.isRepeatStart||(s.fillRect(n+this.width-this.scale,a,this.scale,o),this.renderer.bar.masterBar.isDoubleBar&&s.fillRect(n+this.width-5*this.scale,a,this.scale,o))}}class ka extends vi{constructor(e,t,s,i,a){super(e,t,a?Ti.GraceScale:1,ka.getSymbol(s,i,a))}doLayout(){this.width=0}static getSymbol(e,t,s){if(s&&(e=b.Eighth),t===ie.Up)switch(e){case b.Eighth:return ee.FooterUpEighth;case b.Sixteenth:return ee.FooterUpSixteenth;case b.ThirtySecond:return ee.FooterUpThirtySecond;case b.SixtyFourth:return ee.FooterUpSixtyFourth;case b.OneHundredTwentyEighth:return ee.FooterUpOneHundredTwentyEighth;case b.TwoHundredFiftySixth:return ee.FooterUpTwoHundredFiftySixth;default:return ee.FooterUpEighth}switch(e){case b.Eighth:return ee.FooterDownEighth;case b.Sixteenth:return ee.FooterDownSixteenth;case b.ThirtySecond:return ee.FooterDownThirtySecond;case b.SixtyFourth:return ee.FooterDownSixtyFourth;case b.OneHundredTwentyEighth:case b.TwoHundredFiftySixth:return ee.FooterDownOneHundredTwentyEighth;default:return ee.FooterDownEighth}}}class xa extends vi{constructor(e,t,s,i){super(e,t,1,xa.getSymbol(s)),this._clef=s,this._clefOttava=i}doLayout(){switch(this._clef){case c.Neutral:this.width=15*this.scale;break;case c.C3:case c.C4:case c.F4:case c.G2:this.width=28*this.scale}}static getSymbol(e){switch(e){case c.Neutral:return ee.ClefNeutral;case c.C3:case c.C4:return ee.ClefC;case c.F4:return ee.ClefF;case c.G2:return ee.ClefG;default:return ee.None}}paint(e,t,s){let i;super.paint(e,t,s);let a=!1;switch(this._clefOttava){case u._15ma:i=new vi(-4*this.scale,0,.5,ee.Ottava15),a=!0;break;case u._8va:i=new vi(-2*this.scale,0,.5,ee.Ottava8),a=!0;break;case u._8vb:i=new vi(-6*this.scale,0,.5,ee.Ottava8);break;case u._15mb:i=new vi(-8*this.scale,0,.5,ee.Ottava15);break;default:return}let r=0,n=0;switch(this._clef){case c.Neutral:r=a?-12:15,n=0;break;case c.C3:case c.C4:r=a?-19:27,n=0;break;case c.F4:r=a?-9:27,n=-4;break;case c.G2:r=a?-37:30,n=0;break;default:return}i.renderer=this.renderer,i.doLayout();let o=this.width/2;i.paint(e+this.x+o+n*this.scale,t+this.y+r*this.scale,s)}}class Na extends Ds{constructor(e,t){super(e,t)}doLayout(){this.width=11*this.scale}paint(e,t,s){let i=4*this.scale,a=t+this.y+this.renderer.topPadding,r=t+this.y+this.renderer.height-this.renderer.bottomPadding,n=e+this.x,o=r-a,h=1.5*this.scale,l=(a+r)/2;s.fillCircle(n,l-3*h,h),s.fillCircle(n,l+3*h,h),n+=4*this.scale,s.beginPath(),s.moveTo(n,a),s.lineTo(n,r),s.stroke(),n+=3*this.scale+.5,s.fillRect(n,a,i,o)}}class Pa extends Ds{constructor(e,t,s){super(e,t),this._count=0,this._count=0,this._count=s}doLayout(){this.width=0}paint(e,t,s){let i=this.renderer.resources,a=s.textAlign;s.font=i.barNumberFont,s.textAlign=$.Right;let r="x"+this._count,n=s.measureText(r)/1.5;s.fillText(r,e+this.x-n,t+this.y),s.textAlign=a}}class Fa extends Ds{constructor(e,t,s,i){super(e,t),this._dotOffset=0,this._circleSize=0,this._dotOffset=0,this._circleSize=0,this._dotOffset=i,this._circleSize=s}doLayout(){this.width=13*this.scale}paint(e,t,s){let i=4*this.scale,a=t+this.y+this.renderer.topPadding,r=t+this.y+this.renderer.height-this.renderer.bottomPadding,n=e+this.x+.5,o=r-a;s.fillRect(n,a,i,o),n+=2*i-.5,s.beginPath(),s.moveTo(n,a),s.lineTo(n,r),s.stroke(),n+=3*this.scale;let h=this._circleSize*this.scale,l=(a+r)/2;s.fillCircle(n,l-h*this._dotOffset,h),s.fillCircle(n,l+h*this._dotOffset,h)}}class Ca extends vi{constructor(e,t,s){super(e,t,1,Ca.getSymbol(s))}static getSymbol(e){switch(e){case l.None:return ee.None;case l.Normal:return ee.Accentuation;case l.Heavy:return ee.HeavyAccentuation;default:return ee.None}}doLayout(){this.width=9*this.scale}}class La extends vi{constructor(e,t,s){super(e,t,s?Ti.GraceScale:1,ee.NoteHarmonic),this._isGrace=s}doLayout(){this.width=9*(this._isGrace?Ti.GraceScale:1)*this.scale}}class Ma extends Ds{constructor(e,t,s){super(e,t),this._size=0,this._size=s}doLayout(){this.width=this._size+3*this.scale}paint(e,t,s){s.fillCircle(e+this.x,t+this.y,this._size)}}class Ea extends vi{constructor(e,t,s){super(e,t,s?Ti.GraceScale:1,ee.NoteDead),this._isGrace=s}doLayout(){this.width=9*(this._isGrace?Ti.GraceScale:1)*this.scale}}class Da extends vi{constructor(e,t,s,i){super(e,t,i?Ti.GraceScale:1,Da.getSymbol(s)),this._isGrace=i}static getSymbol(e){switch(e){case b.QuadrupleWhole:case b.DoubleWhole:case b.Whole:case b.Half:return ee.NoteHarmonicWhole;default:return ee.NoteHarmonic}}doLayout(){this.width=9*(this._isGrace?Ti.GraceScale:1)*this.scale}}class Ia extends vi{constructor(e,t,s){super(e,t,s?Ti.GraceScale:1,ee.NoteSideStick),this._isGrace=s}doLayout(){this.width=9*(this._isGrace?Ti.GraceScale:1)*this.scale}}class Ra extends Ds{constructor(e,t,s){super(0,0),this.yOffset=0,this.startBeat=e,this.endBeat=t,this.forEnd=s}doLayout(){this.width=0}paint(e,t,s){if(!this.endBeat)return;let i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this.startBeat.voice.bar),a=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this.endBeat.voice.bar),r=0,n=0,o=0,h=0,l=!1,d=i?this.getBeamDirection(this.startBeat,i):this.getBeamDirection(this.endBeat,a);!this.forEnd&&i?(i!==a?(r=e+i.x+this.getStartX(i),o=t+i.y+this.getStartY(i,d)+this.yOffset,a&&i.staff===a.staff?(n=e+a.x+this.getEndX(a),h=t+a.y+this.getEndY(a,d)+this.yOffset):(n=e+i.x+i.width,h=o)):(r=e+i.x+this.getStartX(i),n=e+a.x+this.getEndX(a),o=t+i.y+this.getStartY(i,d)+this.yOffset,h=t+a.y+this.getEndY(a,d)+this.yOffset),l=!0):i&&i.staff===a.staff||(r=e+a.x,n=e+a.x+this.getEndX(a),o=t+a.y+this.getEndY(a,d)+this.yOffset,h=o,l=!0),l&&(Ra.paintTie(s,this.scale,r,o,n,h,d===ie.Down,this.getTieHeight(r,o,n,h),4),s.fill())}getTieHeight(e,t,s,i){return 22}getBeamDirection(e,t){return ie.Down}getStartY(e,t){return 0}getEndY(e,t){return 0}getStartX(e){return 0}getEndX(e){return 0}static paintTie(e,t,s,i,a,r,n=!1,o=22,h=4){if(s===a&&i===r)return;if(a<s){let e=s;s=a,a=e,e=i,i=r,r=e}o*=t,h*=t;let l=r-i,d=a-s,c=Math.sqrt(l*l+d*d);n?l*=-1:d*=-1,l/=c,d/=c;let u=(a+s)/2,p=(r+i)/2,g=u+o*l,f=p+o*d,m=u+(o-h)*l,y=p+(o-h)*d;e.beginPath(),e.moveTo(s,i),e.quadraticCurveTo(g,f,a,r),e.quadraticCurveTo(m,y,s,i),e.closePath()}}class Oa extends Ds{constructor(e){super(0,0),this.height=0,this._isOpen=e}doLayout(){super.doLayout(),this.width=Oa.Size*this.scale}paint(e,t,s){this._isOpen?Ra.paintTie(s,this.scale,e+this.x+this.width,t+this.y+this.height,e+this.x+this.width,t+this.y,!1,6,3):Ra.paintTie(s,this.scale,e+this.x,t+this.y,e+this.x,t+this.y+this.height,!1,6,3),s.fill()}}Oa.Size=6;class Aa{constructor(e,t){this.line=0,this.line=e,this.isGhost=t}}class Ga extends Ds{constructor(e){super(0,0),this._infos=[],this._glyphs=[],this.isEmpty=!0,this._isOpen=e}addParenthesis(e){let t=this.renderer,s=t.getNoteLine(e),i=e.isGhost||this.isTiedBend(e)&&t.settings.notation.showParenthesisForTiedBends;this.addParenthesisOnLine(s,i)}addParenthesisOnLine(e,t){let s=new Aa(e,t);this._infos.push(s),t&&(this.isEmpty=!1)}isTiedBend(e){return!!e.isTieDestination&&(!!e.tieOrigin.hasBend||this.isTiedBend(e.tieOrigin))}doLayout(){let e=this.renderer;this._infos.sort((e,t)=>e.line-t.line);let t=null,s=e.getScoreY(1,0);for(let i=0,a=this._infos.length;i<a;i++){let a;if(this._infos[i].isGhost)if(t){let a=e.getScoreY(this._infos[i].line,0)+s;t.height=a-t.y}else a=new Oa(this._isOpen),a.renderer=this.renderer,a.y=e.getScoreY(this._infos[i].line,0)-s,a.height=2*s,a.doLayout(),this._glyphs.push(a),t=a;else t=null}this.width=this._glyphs.length>0?this._glyphs[0].width:0}paint(e,t,s){super.paint(e,t,s);for(let i of this._glyphs)i.paint(e+this.x,t+this.y,s)}}class Va extends vi{constructor(e,t,s){super(e,t,s?Ti.GraceScale:1,ee.NoteHiHat),this._isGrace=s}doLayout(){this.width=9*(this._isGrace?Ti.GraceScale:1)*this.scale}}class Ha extends vi{constructor(e,t,s){super(e,t,s?Ti.GraceScale:1,ee.NoteHarmonicWhole),this._isGrace=s}doLayout(){this.width=9*(this._isGrace?Ti.GraceScale:1)*this.scale}}class Wa{constructor(e,t){this.line=0,this.glyph=e,this.line=t}}class za extends Ds{constructor(){super(0,0),this._infos=[],this._noteHeadPadding=0,this.minNote=null,this.maxNote=null,this.spacingChanged=new Qt,this.upLineX=0,this.downLineX=0,this.displacedX=0,this.noteStartX=0}add(e,t){let s=new Wa(e,t);this._infos.push(s),(!this.minNote||this.minNote.line>s.line)&&(this.minNote=s),(!this.maxNote||this.maxNote.line<s.line)&&(this.maxNote=s)}get hasTopOverflow(){return!!this.minNote&&this.minNote.line<=0}get hasBottomOverflow(){return!!this.maxNote&&this.maxNote.line>8}doLayout(){this._infos.sort((e,t)=>t.line-e.line);let e=0,t=!1,s=0,i=!1,a=this.direction,r=1.5*this.scale,n=0;for(let o=0,h=this._infos.length;o<h;o++){let h=this._infos[o].glyph;h.renderer=this.renderer,h.doLayout();let l=!1;0===o?e=h.width-r:Math.abs(s-this._infos[o].line)<=1?t?t=!1:(l=!0,h.x=e,i=!0,t=!0):t=!1,a===ie.Down?h.x=l?0:e:h.x=l?e:0,h.x+=this.noteStartX,s=this._infos[o].line,n=Math.max(n,h.x+h.width-r)}i?(this._noteHeadPadding=0,this.upLineX=e,this.downLineX=e):(this._noteHeadPadding=a===ie.Down?-e:0,n+=this._noteHeadPadding,this.upLineX=n,this.downLineX=0),this.displacedX=e,this.width=n}paint(e,t,s){e+=this.x,t+=this.y;let i=this.renderer,a=3*this.scale,r=this.width-this.noteStartX+2*a;if(this.hasTopOverflow){let n=s.color;s.color=i.resources.staffLineColor;let o=0;for(;o>=this.minNote.line;){let n=t+i.getScoreY(o,0);s.fillRect(e-a+this.noteStartX,n,r,this.scale),o-=2}s.color=n}if(this.hasBottomOverflow){let n=s.color;s.color=i.resources.staffLineColor;let o=12;for(;o<=this.maxNote.line;){let n=t+i.getScoreY(o,0);s.fillRect(e-a+this.noteStartX,n,r,this.scale),o+=2}s.color=n}let n=this._infos,o=e+this._noteHeadPadding;for(let e of n)e.glyph.renderer=this.renderer,e.glyph.paint(o,t,s)}}class Ua extends vi{constructor(e,t,s){super(e,t,1,Ua.getSymbol(s))}doLayout(){this.width=12*this.scale}static getSymbol(e){switch(e){case b.ThirtySecond:return ee.TremoloPickingThirtySecond;case b.Sixteenth:return ee.TremoloPickingSixteenth;case b.Eighth:return ee.TremoloPickingEighth;default:return ee.None}}}class Xa extends za{constructor(){super(),this._noteGlyphLookup=new Map,this._notes=[],this._tremoloPicking=null,this.beatEffects=new Map}get direction(){return this.beamingHelper.direction}getNoteX(e,t=!0){if(this._noteGlyphLookup.has(e.id)){let s=this._noteGlyphLookup.get(e.id),i=this.x+s.x;return t&&(i+=s.width),i}return 0}getNoteY(e,t=!1){return this._noteGlyphLookup.has(e.id)?this.y+this._noteGlyphLookup.get(e.id).y+(t?-Ti.NoteHeadHeight*this.scale/2:0):0}addNoteGlyph(e,t,s){super.add(e,s),this._noteGlyphLookup.set(t.id,e),this._notes.push(t)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.upLineX,e+this.x+this.downLineX)}doLayout(){super.doLayout();let e=this.direction;for(let e of this.beatEffects){let t=e[1];t.renderer=this.renderer,t.doLayout()}if(this.beat.isTremolo){let t=0,s=e===ie.Up?this.minNote:this.maxNote,i=e===ie.Up?this.displacedX:0,a=this.beat.tremoloSpeed;switch(a){case b.ThirtySecond:t=e===ie.Up?-15:15;break;case b.Sixteenth:t=e===ie.Up?-12:15;break;case b.Eighth:t=e===ie.Up?-10:10;break;default:t=e===ie.Up?-10:15}this._tremoloPicking=new Ua(i,s.glyph.y+t*this.scale,a),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout()}}paint(e,t,s){let i=this.renderer,a=this.beamingHelper.direction===ie.Up?i.getScoreY(this.maxNote.line,1.5*Ti.NoteHeadHeight):i.getScoreY(this.minNote.line,-1*Ti.NoteHeadHeight),r=this.beamingHelper.direction===ie.Up?7*this.scale:-7*this.scale;for(let i of this.beatEffects){let n=i[1];n.y=a,n.x=this.width/2,n.paint(e+this.x,t+this.y,s),a+=r}if(this.renderer.settings.core.includeNoteBounds)for(let s of this._notes)if(this._noteGlyphLookup.has(s.id)){let i=this._noteGlyphLookup.get(s.id),a=new bs;a.note=s,a.noteHeadBounds=new Je,a.noteHeadBounds.x=e+this.x+i.x,a.noteHeadBounds.y=t+this.y+i.y,a.noteHeadBounds.w=i.width,a.noteHeadBounds.h=i.height,this.renderer.scoreRenderer.boundsLookup.addNote(a)}super.paint(e,t,s),this._tremoloPicking&&this._tremoloPicking.paint(e,t,s)}}class Ya extends vi{constructor(e,t,s){super(e,t,1,Ya.getSymbol(s)),this._duration=s}static getSymbol(e){switch(e){case b.QuadrupleWhole:return ee.RestQuadrupleWhole;case b.DoubleWhole:return ee.RestDoubleWhole;case b.Whole:return ee.RestWhole;case b.Half:return ee.RestHalf;case b.Quarter:return ee.RestQuarter;case b.Eighth:return ee.RestEighth;case b.Sixteenth:return ee.RestSixteenth;case b.ThirtySecond:return ee.RestThirtySecond;case b.SixtyFourth:return ee.RestSixtyFourth;case b.OneHundredTwentyEighth:return ee.RestOneHundredTwentyEighth;case b.TwoHundredFiftySixth:return ee.RestTwoHundredFiftySixth;default:return ee.None}}static getSize(e){switch(e){case b.QuadrupleWhole:case b.DoubleWhole:case b.Whole:case b.Half:case b.Quarter:case b.Eighth:case b.Sixteenth:return 9;case b.ThirtySecond:return 12;case b.SixtyFourth:return 14;case b.OneHundredTwentyEighth:case b.TwoHundredFiftySixth:return 20}return 10}doLayout(){this.width=Ya.getSize(this._duration)*this.scale}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}}class Ja extends ti{constructor(){super(0,0)}doLayout(){if(!this.glyphs)return void(this.width=0);this.glyphs.sort((e,t)=>e.y<t.y?-1:e.y>t.y?1:0);let e=[];e.push(Ja.NonReserved);let t=21*this.scale;for(let s=0,i=this.glyphs.length;s<i;s++){let i=this.glyphs[s];i.renderer=this.renderer,i.doLayout();let a=0;for(;e[a]>i.y;)a++,a===e.length&&e.push(Ja.NonReserved);i.x=a,e[a]=i.y+t}let s=8*this.scale,i=2*this.scale;0===this.glyphs.length?this.width=0:this.width=i+s*e.length;for(let e=0,t=this.glyphs.length;e<t;e++){let t=this.glyphs[e];t.x=i+(this.width-(t.x+1)*s)}}}Ja.NonReserved=-3e3;class Qa extends za{constructor(e,t=!1){super(),this._showParenthesis=!1,this._noteValueLookup=new Map,this._accidentals=new Ja,this._preNoteParenthesis=null,this._postNoteParenthesis=null,this.isEmpty=!0,this.noteHeadOffset=0,this._beat=e,this._showParenthesis=t,t&&(this._preNoteParenthesis=new Ga(!0),this._postNoteParenthesis=new Ga(!1))}get direction(){return ie.Up}getNoteValueY(e,t=!1){return this._noteValueLookup.has(e)?this.y+this._noteValueLookup.get(e).y+(t?-Ti.NoteHeadHeight*Ti.GraceScale*this.scale/2:0):0}containsNoteValue(e){return this._noteValueLookup.has(e)}getNoteX(e,t=!0){if(this._noteValueLookup.has(e)){let s=this._noteValueLookup.get(e),i=this.x+s.x;return t&&(i+=s.width/2),i}return 0}addGlyph(e,t=!1){let s=this.renderer,i=new Ti(0,0,b.Quarter,!0),a=s.accidentalHelper.applyAccidentalForValue(this._beat,e,t),r=s.accidentalHelper.getNoteLineForValue(e,!1);i.y=s.getScoreY(r,0),this._showParenthesis&&(this._preNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.addParenthesisOnLine(r,!0),this._postNoteParenthesis.addParenthesisOnLine(r,!0)),a!==oe.None&&this._accidentals.addGlyph(new Ba(0,i.y,a,!0)),this._noteValueLookup.set(e,i),this.add(i,r),this.isEmpty=!1}doLayout(){let e=0;this._showParenthesis&&(this._preNoteParenthesis.x=e,this._preNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.doLayout(),e+=this._preNoteParenthesis.width+Qa.ElementPadding*this.scale),this._accidentals.isEmpty||(this._accidentals.x=e,this._accidentals.renderer=this.renderer,this._accidentals.doLayout(),e+=this._accidentals.width+Qa.ElementPadding*this.scale),this.noteStartX=e,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this._showParenthesis&&(this._postNoteParenthesis.x=this.width+Qa.ElementPadding*this.scale,this._postNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.doLayout(),this.width+=this._postNoteParenthesis.width+Qa.ElementPadding*this.scale)}paint(e,t,s){this._accidentals.isEmpty||this._accidentals.paint(e+this.x,t+this.y,s),this._showParenthesis&&(this._preNoteParenthesis.paint(e+this.x,t+this.y,s),this._postNoteParenthesis.paint(e+this.x,t+this.y,s)),super.paint(e,t,s)}}Qa.ElementPadding=2;class qa extends Ds{constructor(){super(...arguments),this.BendNoteHeads=[]}drawBendSlur(e,t,s,i,a,r,n,o){let h=a-s,l=i-t,d=Math.sqrt(h*h+l*l);r?h*=-1:l*=-1,h/=d,l/=d;let c=(i+t)/2,u=(a+s)/2,p=qa.SlurHeight*n;i-t<20&&(p/=2);let g=c+p*h,f=u+p*l;if(e.beginPath(),e.moveTo(t,s),e.lineTo(g,f),e.lineTo(i,a),e.stroke(),o){let t=e.measureText(o),s=r?0:-e.font.size;e.fillText(o,g-t/2,f+s)}}doLayout(){super.doLayout(),this.width=0;for(let e of this.BendNoteHeads)e.doLayout(),this.width+=e.width+10*this.scale}getBeamDirection(e,t){switch(t.getBeatDirection(e)){case ie.Up:return ie.Down;default:return ie.Up}}}qa.SlurHeight=11,qa.EndPadding=8;class ja extends ye{constructor(e=0,t=0){super(e,t),this.lineValue=0,this.lineValue=t}}class Ka extends Ds{constructor(){super(...arguments),this._notes=[],this._renderPoints=new Map,this._preBendMinValue=-1,this._bendMiddleMinValue=-1,this._bendEndMinValue=-1,this._bendEndContinuedMinValue=-1,this._releaseMinValue=-1,this._releaseContinuedMinValue=-1,this._maxBendValue=-1}addBends(e){this._notes.push(e);let t=this.createRenderingPoints(e);this._renderPoints.set(e.id,t),(-1===this._maxBendValue||this._maxBendValue<e.maxBendPoint.value)&&(this._maxBendValue=e.maxBendPoint.value);let s=0;switch(e.bendType){case f.Bend:s=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||s<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=s):(-1===this._bendEndMinValue||s<this._bendEndMinValue)&&(this._bendEndMinValue=s);break;case f.Release:s=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s);break;case f.BendRelease:s=t[1].value,(-1===this._bendMiddleMinValue||s<this._bendMiddleMinValue)&&(this._bendMiddleMinValue=s),s=t[2].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s);break;case f.Prebend:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s);break;case f.PrebendBend:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s),s=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||s<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=s):(-1===this._bendEndMinValue||s<this._bendEndMinValue)&&(this._bendEndMinValue=s);break;case f.PrebendRelease:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s),s=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s)}}doLayout(){super.doLayout();let e=this._maxBendValue*Ka.BendValueHeight*this.scale;this.renderer.registerOverflowTop(e);let t=0;for(let e of this._notes){let s=this._renderPoints.get(e.id);switch(e.bendType){case f.Bend:s[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case f.Release:t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[1].lineValue=t);break;case f.BendRelease:s[1].lineValue=this._bendMiddleMinValue,t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[2].lineValue=t);break;case f.Prebend:s[0].lineValue=this._preBendMinValue;break;case f.PrebendBend:s[0].lineValue=this._preBendMinValue,s[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case f.PrebendRelease:s[0].lineValue=this._preBendMinValue,t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[1].lineValue=t)}}this.width=0,this._notes.sort((e,t)=>e.isStringed?e.string-t.string:e.realValue-t.realValue)}createRenderingPoints(e){let t=[];switch(e.bendType){case f.Custom:for(let s of e.bendPoints)t.push(new ja(s.offset,s.value));break;case f.BendRelease:t.push(new ja(0,e.bendPoints[0].value)),t.push(new ja(ye.MaxPosition/2|0,e.bendPoints[1].value)),t.push(new ja(ye.MaxPosition,e.bendPoints[3].value));break;case f.Bend:case f.Hold:case f.Prebend:case f.PrebendBend:case f.PrebendRelease:case f.Release:t.push(new ja(0,e.bendPoints[0].value)),t.push(new ja(ye.MaxPosition,e.bendPoints[1].value))}return t}paint(e,t,s){let i=s.color;this._notes.length>1&&(s.color=this.renderer.resources.secondaryGlyphColor);for(let a of this._notes){let r=this._renderPoints.get(a.id),n=this.renderer,o=a,h=!1,l=null,d=!1,c=a.bendStyle===g.Gradual?"grad.":"",u=null;for(;o.isTieOrigin;){let e=o.tieDestination;if(l=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,e.beat.voice.bar),!l||n.staff!==l.staff)break;if(o=e,h=!0,o.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes){d=!0;break}}u=o.beat,l=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,u.voice.bar),u.isLastOfVoice&&!o.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(u=null);let p=0,m=0,y=t+n.y;p=e+n.x,r[0].value>0||a.isContinuedBend?p+=n.getBeatX(a.beat,se.MiddleNotes):p+=n.getNoteX(a,!0),m=!u||u.isLastOfVoice&&!d?e+l.x+l.postBeatGlyphsStart:d||!u.nextBeat?e+l.x+l.getBeatX(u,se.MiddleNotes):a.bendType===f.Hold?e+l.x+l.getBeatX(u.nextBeat,se.OnNotes):e+l.x+l.getBeatX(u.nextBeat,se.PreNotes),h||(m-=Ka.ArrowSize*this.scale);let b=(m-p)/ye.MaxPosition;s.beginPath();for(let e=0,t=r.length-1;e<t;e++){let t=r[e],i=r[e+1];0!==e||0===t.value||a.isTieDestination||this.paintBend(a,new ja(0,0),t,p,y,b,c,s),a.bendType!==f.Prebend?this.paintBend(a,t,i,p,y,b,c,s):a.isTieOrigin&&a.tieDestination.hasBend&&(i=new ja(ye.MaxPosition,t.value),i.lineValue=t.lineValue,this.paintBend(a,t,i,p,y,b,c,s))}s.color=i}}paintBend(e,t,s,i,a,r,n,o){let h=this.renderer,l=this.renderer.resources,d=h.lineOffset/2,c=i+r*t.offset,u=Ka.BendValueHeight*this.scale,p=a-u*t.lineValue;0===t.value?s.offset===t.offset?p+=h.getNoteY(e.beat.maxStringNote,!0):p+=h.getNoteY(e,!1):p+=d;let g=i+r*s.offset,f=a-u*s.lineValue;0===s.lineValue?f+=h.getNoteY(e,!1):f+=d;let m=0,y=Ka.ArrowSize*this.scale;if(s.value>t.value?(f+y>p&&(f=p-y),o.beginPath(),o.moveTo(g,f),o.lineTo(g-.5*y,f+y),o.lineTo(g+.5*y,f+y),o.closePath(),o.fill(),m=y):s.value!==t.value&&(f<p&&(f=p+y),o.beginPath(),o.moveTo(g,f),o.lineTo(g-.5*y,f-y),o.lineTo(g+.5*y,f-y),o.closePath(),o.fill(),m=-y),o.stroke(),t.value===s.value){if(t.lineValue>0){let e=g,t=Ka.DashSize*this.scale,s=c+t;if((e-c)/(2*t)<1)o.moveTo(e,p),o.lineTo(c,p);else for(;e>s;)o.moveTo(e,p),o.lineTo(e-t,p),e-=2*t;o.stroke()}}else g>c?(o.moveTo(c,p),o.bezierCurveTo((c+g)/2,p,g,p,g,f+m),o.stroke()):(o.moveTo(c,p),o.lineTo(g,f),o.stroke());if(n&&t.offset<s.offset){o.font=l.graceFont;let e=o.measureText(n),t=0,s=0;if(p>f){let i=Math.abs(p-f);t=i>1.3*o.font.size?p-i/2:p,s=(c+g-e)/2}else t=p,s=g-e;o.fillText(n,s,t)}if(0!==s.value&&t.value!==s.value){let e=s.value,i=s.value>t.value;e=Math.abs(e);let r="";if(4===e)r="full",e-=4;else if(e>=4||e<=-4){let t=e/4|0;r+=t,e-=4*t}if(e>0&&(r+=Ka.getFractionSign(e)),""!==r){f=a-u*s.value;let e=f;i||(e=p+1*Math.abs(f-p)/3),o.font=l.tablatureFont;let t=o.measureText(r),n=e-.5*l.tablatureFont.size-2*this.scale,h=g-t/2;o.fillText(r,h,n)}}}static getFractionSign(e){switch(e){case 1:return"Â¼";case 2:return"Â½";case 3:return"Â¾";default:return e+"/ 4"}}}Ka.ArrowSize=6,Ka.DashSize=3,Ka.BendValueHeight=6;class $a extends Ds{constructor(e){super(0,0),this._isSimpleDip=!1,this._beat=e,this._renderPoints=this.createRenderingPoints(e)}createRenderingPoints(e){if(e.whammyBarType===M.Custom)return e.whammyBarPoints;let t=[];switch(e.whammyBarType){case M.Dive:case M.Hold:case M.PrediveDive:case M.Predive:t.push(new ye(0,e.whammyBarPoints[0].value)),t.push(new ye(ye.MaxPosition,e.whammyBarPoints[1].value));break;case M.Dip:t.push(new ye(0,e.whammyBarPoints[0].value)),t.push(new ye(ye.MaxPosition/2|0,e.whammyBarPoints[1].value)),t.push(new ye(ye.MaxPosition,e.whammyBarPoints[e.whammyBarPoints.length-1].value))}return t}doLayout(){super.doLayout(),this._isSimpleDip=this.renderer.settings.notation.notationMode===e.NotationMode.SongBook&&this._beat.whammyBarType===M.Dip;let t=null,s=null,i=this._beat;for(;i&&i.hasWhammyBar;)(!t||t.value>i.minWhammyPoint.value)&&(t=i.minWhammyPoint),(!s||s.value<i.maxWhammyPoint.value)&&(s=i.maxWhammyPoint),i=i.nextBeat;let a=s.value>0?Math.abs(this.getOffset(s.value)):0;(a>0||0!==this._beat.whammyBarPoints[0].value||this.renderer.settings.notation.showZeroOnDiveWhammy)&&(a+=2*this.renderer.resources.tablatureFont.size);let r=t.value<0?Math.abs(this.getOffset(t.value)):0;this.renderer.registerOverflowTop(a+r),a>this.renderer.staff.getSharedLayoutData($a.TopOffsetSharedDataKey,-1)&&this.renderer.staff.setSharedLayoutData($a.TopOffsetSharedDataKey,a)}getOffset(e){if(0===e)return 0;let t=$a.PerHalfSize*this.scale+Math.log2(Math.abs(e)/2)*$a.PerHalfSize*this.scale;return e<0&&(t=-t),t}paint(t,s,i){let a=this.renderer,r=this._beat.nextBeat,n=null,o=se.PreNotes;r&&(n=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,r.voice.bar),n&&n.staff===a.staff&&(n===a||r.hasWhammyBar)?o=!r.hasWhammyBar||a.settings.notation.notationMode===e.NotationMode.SongBook&&r.whammyBarType===M.Dip?se.PreNotes:se.MiddleNotes:(r=null,n=null));let h=0,l=0;this._isSimpleDip?(h=t+a.x+a.getBeatX(this._beat,se.OnNotes)-2*this.scale,l=t+a.x+a.getBeatX(this._beat,se.PostNotes)+2*this.scale):(h=t+a.x+a.getBeatX(this._beat,se.MiddleNotes),l=n?t+n.x+n.getBeatX(r,o):t+a.x+a.width-2*this.scale);let d=i.textAlign;if(i.textAlign=$.Center,this._renderPoints.length>=2){let e=(l-h)/ye.MaxPosition;i.beginPath();let t=s+this.renderer.staff.getSharedLayoutData($a.TopOffsetSharedDataKey,0),a=this._beat.whammyStyle===g.Gradual?"grad.":"";for(let s=0,r=this._renderPoints.length-1;s<r;s++){let n=this._renderPoints[s],o=this._renderPoints[s+1],l=s<r-2?this._renderPoints[s+2]:null,d=0===s;0!==s||0===n.value||this._beat.isContinuedWhammy||(this.paintWhammy(!1,new ye(0,0),n,o,h,t,e,i),d=!1),this.paintWhammy(d,n,o,l,h,t,e,i,a),a=""}i.stroke()}i.textAlign=d}paintWhammy(e,t,s,i,a,r,n,o,h){let l=a+n*t.offset,d=a+n*s.offset,c=r-this.getOffset(t.value),u=r-this.getOffset(s.value);if(t.offset===s.offset){let e=$a.DashSize*this.scale;if(Math.abs(u-c)/(2*e)<1)o.moveTo(l,c),o.lineTo(d,u);else{let t=Math.max(c,u),s=Math.min(c,u);for(;t>s;)o.moveTo(l,s),o.lineTo(l,s+e),s+=2*e}o.stroke()}else if(t.value===s.value){let e=$a.DashSize*this.scale;if(Math.abs(d-l)/(2*e)<1)o.moveTo(l,c),o.lineTo(d,u);else{let t=Math.max(l,d),s=Math.min(l,d);for(;t>s;)o.moveTo(t,c),o.lineTo(t-e,c),t-=2*e}o.stroke()}else o.moveTo(l,c),o.lineTo(d,u);let p=this.renderer.resources;if(e&&!this._beat.isContinuedWhammy&&!this._isSimpleDip){let e=c;e-=p.tablatureFont.size+2*this.scale,this.renderer.settings.notation.showZeroOnDiveWhammy&&o.fillText("0",l,e),h&&(e-=p.tablatureFont.size+2*this.scale,o.fillText(h,l,e))}let g=Math.abs(s.value);if((0!==g||this.renderer.settings.notation.showZeroOnDiveWhammy&&!this._isSimpleDip)&&t.value!==s.value){let e="";if(s.value<0&&(e+="-"),g>=4){let t=g/4|0;e+=t,g-=4*t}else 0===g&&(e+="0");g>0&&(e+=Ka.getFractionSign(g));let a=0;this._isSimpleDip?a=Math.min(c,u)-p.tablatureFont.size-2*this.scale:(a=t.offset===s.offset?Math.min(c,u):u,a-=p.tablatureFont.size+2*this.scale,i&&i.value>s.value&&(a-=2*this.scale));let r=d;o.fillText(e,r,a)}}}$a.TopOffsetSharedDataKey="tab.whammy.topoffset",$a.PerHalfSize=6,$a.DashSize=3;class Za extends qa{constructor(e){super(),this._beat=e}doLayout(){let t=this.renderer.settings.notation.notationMode;switch(this._beat.whammyBarType){case M.None:case M.Custom:case M.Hold:return;case M.Dive:case M.PrediveDive:{let e=new Qa(this._beat,!1);e.renderer=this.renderer;let t=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(let s of this._beat.notes)s.isTieOrigin||e.addGlyph(this.getBendNoteValue(s,t),t.value%2!=0);e.doLayout(),this.BendNoteHeads.push(e)}break;case M.Dip:if(t===e.NotationMode.SongBook){let e=this.renderer.resources;this.renderer.simpleWhammyOverflow=1.5*e.tablatureFont.size+Za.SimpleDipHeight*this.scale+Za.SimpleDipPadding*this.scale}else{let t=new Qa(this._beat,!1);if(t.renderer=this.renderer,this.renderer.settings.notation.notationMode===e.NotationMode.GuitarPro){let e=this._beat.whammyBarPoints[1];for(let s of this._beat.notes)t.addGlyph(this.getBendNoteValue(s,this._beat.whammyBarPoints[1]),e.value%2!=0)}t.doLayout(),this.BendNoteHeads.push(t);let s=new Qa(this._beat,!1);if(s.renderer=this.renderer,this.renderer.settings.notation.notationMode===e.NotationMode.GuitarPro){let e=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(let t of this._beat.notes)s.addGlyph(this.getBendNoteValue(t,e),e.value%2!=0)}s.doLayout(),this.BendNoteHeads.push(s)}break;case M.Predive:}super.doLayout()}paint(t,s,i){let a=this._beat;switch(a.whammyBarType){case M.None:case M.Custom:return}let r=this.renderer.settings.notation.notationMode,n=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,a.voice.bar),o=t+n.x+n.getBeatX(a,se.MiddleNotes),h=this.getBeamDirection(a,n),l=1===this._beat.notes.length?h:ie.Up,d=i.textAlign;for(let d=0;d<a.notes.length;d++){let c=a.notes[d],u=s+n.y+n.getNoteY(c,!0);l===ie.Down&&(u+=Ti.NoteHeadHeight*this.scale),d>0&&d>=(this._beat.notes.length/2|0)&&(l=ie.Down);let p=t+n.x;a.isLastOfVoice?p+=n.width:p+=n.getBeatX(a,se.EndBeat),p-=8*this.scale;let f=a.whammyStyle===g.Gradual&&0===d?"grad.":"",m=null;c.isTieOrigin&&(m=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,c.tieDestination.beat.voice.bar),m&&m.staff===n.staff?p=t+m.x+m.getBeatX(c.tieDestination.beat,se.MiddleNotes):m=null);let y=Ti.NoteHeadHeight*this.scale*Ti.GraceScale*.5;l===ie.Up&&(y=-y);let b=0,S=0;switch(a.whammyBarType){case M.Hold:c.isTieOrigin&&(S=m?s+m.y+m.getNoteY(c.tieDestination,!0):u,Ra.paintTie(i,this.scale,o,u,p,S,h===ie.Down,22,4),i.fill());break;case M.Dive:0===d&&(this.BendNoteHeads[0].x=p-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=s+n.y,this.BendNoteHeads[0].paint(0,0,i)),b=this.getBendNoteValue(c,a.whammyBarPoints[a.whammyBarPoints.length-1]),this.BendNoteHeads[0].containsNoteValue(b)?(S=this.BendNoteHeads[0].getNoteValueY(b,!1)+y,this.drawBendSlur(i,o,u,p,S,l===ie.Down,this.scale,f)):m&&(c.isTieOrigin&&c.tieDestination.beat.hasWhammyBar||c.beat.isContinuedWhammy)?(S=s+m.y+m.getNoteY(c.tieDestination,!0),this.drawBendSlur(i,o,u,p,S,l===ie.Down,this.scale,f)):c.isTieOrigin&&(S=m?s+m.y+m.getNoteY(c.tieDestination,!0):u,Ra.paintTie(i,this.scale,o,u,p,S,h===ie.Down,22,4),i.fill());break;case M.Dip:if(r===e.NotationMode.SongBook){if(0===d){let e=t+n.x+n.getBeatX(this._beat,se.OnNotes)-2*this.scale,a=t+n.x+n.getBeatX(this._beat,se.PostNotes)+2*this.scale,r=(e+a)/2,o=((this._beat.whammyBarPoints[1].value-this._beat.whammyBarPoints[0].value)/4|0).toString();i.font=this.renderer.resources.tablatureFont,i.fillText(o,r,s+this.y);let h=s+this.y+i.font.size+2*this.scale,l=h+Za.SimpleDipHeight*this.scale;this._beat.whammyBarPoints[1].value>this._beat.whammyBarPoints[0].value?(i.moveTo(e,l),i.lineTo(r,h),i.lineTo(a,l)):(i.moveTo(e,h),i.lineTo(r,l),i.lineTo(a,h)),i.stroke()}c.isTieOrigin&&(S=m?s+m.y+m.getNoteY(c.tieDestination,!0):u,Ra.paintTie(i,this.scale,o,u,p,S,h===ie.Down,22,4),i.fill())}else{let e=(o+p)/2;this.BendNoteHeads[0].x=e-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=s+n.y,this.BendNoteHeads[0].paint(0,0,i);let t=this.getBendNoteValue(c,a.whammyBarPoints[1]),r=this.BendNoteHeads[0].getNoteValueY(t,!1)+y;this.drawBendSlur(i,o,u,e,r,l===ie.Down,this.scale,f),this.BendNoteHeads[1].x=p-this.BendNoteHeads[1].noteHeadOffset,this.BendNoteHeads[1].y=s+n.y,this.BendNoteHeads[1].paint(0,0,i),b=this.getBendNoteValue(c,a.whammyBarPoints[a.whammyBarPoints.length-1]),S=this.BendNoteHeads[1].getNoteValueY(b,!1)+y,this.drawBendSlur(i,e,r,p,S,l===ie.Down,this.scale,f)}break;case M.PrediveDive:case M.Predive:let g=t+n.x+n.getBeatX(c.beat,se.PreNotes);g+=n.getBeatContainer(c.beat).preNotes.prebendNoteHeadOffset;let _=s+n.y+n.getScoreY(n.accidentalHelper.getNoteLineForValue(c.displayValue-(c.beat.whammyBarPoints[0].value/2|0),!1),0)+y;this.drawBendSlur(i,g,_,o,u,l===ie.Down,this.scale,f),this.BendNoteHeads.length>0&&(this.BendNoteHeads[0].x=p-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=s+n.y,this.BendNoteHeads[0].paint(0,0,i),b=this.getBendNoteValue(c,a.whammyBarPoints[a.whammyBarPoints.length-1]),S=this.BendNoteHeads[0].getNoteValueY(b,!1)+y,this.drawBendSlur(i,o,u,p,S,l===ie.Down,this.scale,f))}}i.textAlign=d}getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}Za.SimpleDipHeight=2*$a.PerHalfSize,Za.SimpleDipPadding=2;class er extends Ds{constructor(e,t,s){super(e,t),this.width=s}}class tr extends pi{constructor(){super(...arguments),this.noteHeads=null,this.restGlyph=null}updateBeamingHelper(){this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.restGlyph&&this.restGlyph.updateBeamingHelper(this.container.x+this.x)}doLayout(){let e=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let t=0,s=0,i=0;switch(this.container.beat.duration){case b.QuadrupleWhole:case b.DoubleWhole:s=6,t=5;break;case b.Whole:s=4,t=5;break;case b.Half:s=6,t=5;break;case b.Quarter:s=6,i=-2,t=5;break;case b.Eighth:case b.Sixteenth:s=6,t=5;break;case b.ThirtySecond:case b.SixtyFourth:case b.OneHundredTwentyEighth:case b.TwoHundredFiftySixth:s=6,t=3}let a=e.getScoreY(s,i);if(this.restGlyph=new Ya(0,a,this.container.beat.duration),this.restGlyph.beat=this.container.beat,this.restGlyph.beamingHelper=this.beamingHelper,this.addGlyph(this.restGlyph),this.container.beat.dots>0){this.addGlyph(new er(0,0,5*this.scale));for(let e=0;e<this.container.beat.dots;e++){let e=new ti(0,0);this.createBeatDot(t,e),this.addGlyph(e)}}}else{this.noteHeads=new Xa,this.noteHeads.beat=this.container.beat,this.noteHeads.beamingHelper=this.beamingHelper;let t=new Ga(!1);t.renderer=this.renderer;for(let e of this.container.beat.notes)e.isVisible&&(this.createNoteGlyph(e),t.addParenthesis(e));if(this.addGlyph(this.noteHeads),t.isEmpty||(this.addGlyph(new er(0,0,4*(this.container.beat.graceType!==_.None?Ti.GraceScale:1)*this.scale)),this.addGlyph(t)),this.container.beat.hasWhammyBar){let e=new Za(this.container.beat);e.renderer=this.renderer,e.doLayout(),this.container.ties.push(e)}if(this.container.beat.dots>0){this.addGlyph(new er(0,0,5*this.scale));for(let t=0;t<this.container.beat.dots;t++){let t=new ti(0,0);for(let s of this.container.beat.notes)this.createBeatDot(e.getNoteLine(s),t);this.addGlyph(t)}}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.container.beat.isRest?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.centerX=this.noteHeads.x+this.noteHeads.width/2}createBeatDot(e,t){let s=this.renderer;t.addGlyph(new Ma(0,s.getScoreY(e,0),1.5*this.scale))}createNoteHeadGlyph(e){let t=this.container.beat.graceType!==_.None;if(e.beat.voice.bar.staff.isPercussion){let s=e.realValue;return s<=30||s>=67||tr.NormalKeys.has(s)?new Ti(0,0,b.Quarter,t):tr.XKeys.has(s)?new Ia(0,0,t):46===s?new Va(0,0,t):49===s||57===s?new Da(0,0,e.beat.duration,t):52===s?new La(0,0,t):51===s||53===s||59===s?new Ha(0,0,t):new Ti(0,0,b.Quarter,t)}return e.isDead?new Ea(0,0,t):e.beat.graceType===_.BendGrace?new Ti(0,0,b.Quarter,!0):e.harmonicType===B.Natural?new Da(0,0,e.beat.duration,t):new Ti(0,0,e.beat.duration,t)}createNoteGlyph(e){if(e.beat.graceType===_.BendGrace&&!e.hasBend)return;let t=this.renderer,s=this.createNoteHeadGlyph(e),i=t.getNoteLine(e);if(s.y=t.getScoreY(i,0),this.noteHeads.addNoteGlyph(s,e,i),e.harmonicType!==B.None&&e.harmonicType!==B.Natural){let a=e.displayValue+e.harmonicPitch;s=new Da(0,0,e.beat.duration,this.container.beat.graceType!==_.None),i=t.accidentalHelper.getNoteLineForValue(a,!1),s.y=t.getScoreY(i,0),this.noteHeads.addNoteGlyph(s,e,i)}e.isStaccato&&!this.noteHeads.beatEffects.has("Staccato")&&this.noteHeads.beatEffects.set("Staccato",new Ma(0,0,1.5)),e.accentuated!==l.Normal||this.noteHeads.beatEffects.has("Accent")||this.noteHeads.beatEffects.set("Accent",new Ca(0,0,l.Normal)),e.accentuated!==l.Heavy||this.noteHeads.beatEffects.has("HAccent")||this.noteHeads.beatEffects.set("HAccent",new Ca(0,0,l.Heavy))}}tr.NormalKeys=new Map([[32,!0],[34,!0],[35,!0],[36,!0],[38,!0],[39,!0],[40,!0],[41,!0],[43,!0],[45,!0],[47,!0],[48,!0],[50,!0],[55,!0],[56,!0],[58,!0],[60,!0],[61,!0]]),tr.XKeys=new Map([[31,!0],[33,!0],[37,!0],[42,!0],[44,!0],[54,!0],[62,!0],[63,!0],[64,!0],[65,!0],[66,!0]]);class sr extends Ds{constructor(e){super(0,0),this._beat=e}doLayout(){this.width=10*this.scale}paint(e,t,s){let i=this.renderer,a=i.lineOffset,r=t+this.y+(i.getNoteY(this._beat.maxNote,!1)-a),n=t+this.y+i.getNoteY(this._beat.minNote,!1)+a,o=e+this.x+this.width/2,h=8*this.scale;if(this._beat.brushType!==m.None)if(this._beat.brushType===m.ArpeggioUp){let t=r-h,i=n-h;s.beginRotate(e+this.x+2*this.scale,i,-90);let a=new qi(0,0,x.Slight,1.2);a.renderer=this.renderer,a.doLayout(),a.width=Math.abs(i-t),a.paint(0,0,s),s.endRotate(),s.beginPath(),s.moveTo(o,n),s.lineTo(o+h/2,n-h),s.lineTo(o-h/2,n-h),s.closePath(),s.fill()}else if(this._beat.brushType===m.ArpeggioDown){let t=r+h,i=n+h;s.beginRotate(e+this.x+7*this.scale,t,90);let a=new qi(0,0,x.Slight,1.2);a.renderer=this.renderer,a.doLayout(),a.width=Math.abs(i-t),a.paint(0,0,s),s.endRotate(),s.beginPath(),s.moveTo(o,r),s.lineTo(o+h/2,r+h),s.lineTo(o-h/2,r+h),s.closePath(),s.fill()}}}class ir extends ui{constructor(){super(),this._prebends=null,this.accidentals=null}get prebendNoteHeadOffset(){return this._prebends?this._prebends.x+this._prebends.noteHeadOffset:0}doLayout(){if(!this.container.beat.isRest){let e=new Ja,t=new Ga(!0);t.renderer=this.renderer,this._prebends=new Qa(this.container.beat,!0),this._prebends.renderer=this.renderer;for(let s of this.container.beat.notes)if(s.isVisible){if(s.hasBend)switch(s.bendType){case f.PrebendBend:case f.Prebend:case f.PrebendRelease:this._prebends.addGlyph(s.displayValue-(s.bendPoints[0].value/2|0),!1)}else if(s.beat.hasWhammyBar)switch(s.beat.whammyBarType){case M.PrediveDive:case M.Predive:this._prebends.addGlyph(s.displayValue-(s.beat.whammyBarPoints[0].value/2|0),!1)}this.createAccidentalGlyph(s,e),t.addParenthesis(s)}this._prebends.isEmpty||(this.addGlyph(this._prebends),this.addGlyph(new er(0,0,4*(this.container.beat.graceType!==_.None?Ti.GraceScale:1)*this.scale))),this.container.beat.brushType!==m.None&&(this.addGlyph(new sr(this.container.beat)),this.addGlyph(new er(0,0,4*this.scale))),t.isEmpty||(this.addGlyph(t),this.addGlyph(new er(0,0,4*(this.container.beat.graceType!==_.None?Ti.GraceScale:1)*this.scale))),e.isEmpty||(this.accidentals=e,this.addGlyph(e),this.addGlyph(new er(0,0,4*(this.container.beat.graceType!==_.None?Ti.GraceScale:1)*this.scale)))}super.doLayout()}createAccidentalGlyph(e,t){let s=this.renderer,i=s.accidentalHelper.applyAccidental(e),a=s.getNoteLine(e),r=this.container.beat.graceType!==_.None;if(i!==oe.None&&t.addGlyph(new Ba(0,s.getScoreY(a,0),i,r)),e.harmonicType!==B.None&&e.harmonicType!==B.Natural){let n=e.displayValue+e.harmonicPitch;i=s.accidentalHelper.applyAccidentalForValue(e.beat,n,r),a=s.accidentalHelper.getNoteLineForValue(n,!1),t.addGlyph(new Ba(0,s.getScoreY(a,0),i,r))}}}class ar extends vi{constructor(e,t,s,i){super(e,t,i,ar.getSymbol(s)),this._digit=0,this._scale=0,this._digit=s,this._scale=i}doLayout(){this.y+=7*this.scale,this.width=this.getDigitWidth(this._digit)*this.scale*this._scale}getDigitWidth(e){switch(e){case 0:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:return 14;case 1:return 10;default:return 0}}static getSymbol(e){switch(e){case 0:return ee.Num0;case 1:return ee.Num1;case 2:return ee.Num2;case 3:return ee.Num3;case 4:return ee.Num4;case 5:return ee.Num5;case 6:return ee.Num6;case 7:return ee.Num7;case 8:return ee.Num8;case 9:return ee.Num9;default:return ee.None}}}class rr extends ti{constructor(e,t,s,i=1){super(e,t),this._number=0,this._scale=0,this._number=s,this._scale=i}doLayout(){let e=this._number;for(;e>0;){let t=new ar(0,0,e%10,this._scale);this.addGlyph(t),e=e/10|0}if(this.glyphs){this.glyphs.reverse();let e=0;for(let t=0,s=this.glyphs.length;t<s;t++){let s=this.glyphs[t];s.x=e,s.y=0,s.renderer=this.renderer,s.doLayout(),e+=s.width}this.width=e}}}class nr extends ti{constructor(e,t,s,i,a){super(e,t),this._numerator=0,this._denominator=0,this._numerator=s,this._denominator=i,this._isCommon=a}doLayout(){if(this._isCommon&&2===this._numerator&&2===this._denominator){let e=new vi(0,this.commonY,this.commonScale,ee.TimeSignatureCutCommon);e.width=14*this.scale,this.addGlyph(e),super.doLayout()}else if(this._isCommon&&4===this._numerator&&4===this._denominator){let e=new vi(0,this.commonY,this.commonScale,ee.TimeSignatureCommon);e.width=14*this.scale,this.addGlyph(e),super.doLayout()}else{let e=new rr(0,this.numeratorY,this._numerator,this.numberScale),t=new rr(0,this.denominatorY,this._denominator,this.numberScale);this.addGlyph(e),this.addGlyph(t),super.doLayout();for(let e=0,t=this.glyphs.length;e<t;e++){let t=this.glyphs[e];t.x=(this.width-t.width)/2}}}}class or extends nr{get commonY(){return this.renderer.getScoreY(4,0)}get numeratorY(){return 2*this.scale}get denominatorY(){return 20*this.scale}get commonScale(){return 1}get numberScale(){return 1}constructor(e,t,s,i,a){super(e,t,s,i,a)}}class hr extends qa{constructor(e){super(),this._notes=[],this._endNoteGlyph=null,this._middleNoteGlyph=null,this._beat=e}addBends(e){if(this._notes.push(e),!e.isTieOrigin)switch(e.bendType){case f.Bend:case f.PrebendRelease:case f.PrebendBend:{let t=this._endNoteGlyph;t||(t=this._endNoteGlyph=new Qa(e.beat,!1),t.renderer=this.renderer,this.BendNoteHeads.push(t));let s=e.bendPoints[e.bendPoints.length-1];t.addGlyph(this.getBendNoteValue(e,s),s.value%2!=0)}break;case f.Release:if(!e.isTieOrigin){let t=this._endNoteGlyph;t||(t=this._endNoteGlyph=new Qa(e.beat,!1),t.renderer=this.renderer,this.BendNoteHeads.push(t));let s=e.bendPoints[e.bendPoints.length-1];t.addGlyph(this.getBendNoteValue(e,s),s.value%2!=0)}break;case f.BendRelease:{let t=this._middleNoteGlyph;t||(t=this._middleNoteGlyph=new Qa(e.beat,!1),t.renderer=this.renderer,this.BendNoteHeads.push(t));let s=e.bendPoints[1];t.addGlyph(this.getBendNoteValue(e,e.bendPoints[1]),s.value%2!=0);let i=this._endNoteGlyph;i||(i=this._endNoteGlyph=new Qa(e.beat,!1),i.renderer=this.renderer,this.BendNoteHeads.push(i));let a=e.bendPoints[e.bendPoints.length-1];i.addGlyph(this.getBendNoteValue(e,a),a.value%2!=0)}}}paint(e,t,s){let i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this._beat.voice.bar),a=e+i.x+i.getBeatX(this._beat,se.MiddleNotes),r=e+i.x;this._beat.isLastOfVoice?r+=i.postBeatGlyphsStart:r+=i.getBeatX(this._beat.nextBeat,se.PreNotes),r-=8*this.scale;let n=(a+r)/2;this._middleNoteGlyph&&(this._middleNoteGlyph.x=n-this._middleNoteGlyph.noteHeadOffset,this._middleNoteGlyph.y=t+i.y,this._middleNoteGlyph.paint(0,0,s)),this._endNoteGlyph&&(this._endNoteGlyph.x=r-this._endNoteGlyph.noteHeadOffset,this._endNoteGlyph.y=t+i.y,this._endNoteGlyph.paint(0,0,s)),this._notes.sort((e,t)=>t.displayValue-e.displayValue);let o=this._beat.graceType===_.BendGrace?this._beat.nextBeat:this._beat,h=1===this._notes.length?this.getBeamDirection(o,i):ie.Up;for(let o=0;o<this._notes.length;o++){let l=this._notes[o];o>0&&o>=(this._notes.length/2|0)&&(h=ie.Down);let d=t+i.y+i.getNoteY(l,!0),c=Ti.NoteHeadHeight*this.scale*Ti.GraceScale*.5;h===ie.Down&&(d+=Ti.NoteHeadHeight*this.scale);let u=l.bendStyle===g.Gradual?"grad.":"";if(l.isTieOrigin){let r=l.tieDestination,n=r?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,r.beat.voice.bar):null;if(n&&n.staff===i.staff){let i=e+n.x+n.getBeatX(r.beat,se.MiddleNotes),o=t+n.y+n.getNoteY(r,!0);h===ie.Down&&(o+=Ti.NoteHeadHeight*this.scale),l.bendType===f.Hold||l.bendType===f.Prebend?(Ra.paintTie(s,this.scale,a,d,i,o,h===ie.Down,22,4),s.fill()):this.drawBendSlur(s,a,d,i,o,h===ie.Down,this.scale,u)}else{let r=e+i.x+i.width,n=l.tieDestination.realValue;i.accidentalHelper.applyAccidentalForValue(l.beat,n,!1);let o=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(n,!1),0);l.bendType===f.Hold||l.bendType===f.Prebend?(Ra.paintTie(s,this.scale,a,d,r,o,h===ie.Down,22,4),s.fill()):this.drawBendSlur(s,a,d,r,o,h===ie.Down,this.scale,u)}switch(l.bendType){case f.Prebend:case f.PrebendBend:case f.PrebendRelease:let r=e+i.x+i.getBeatX(l.beat,se.PreNotes);r+=i.getBeatContainer(l.beat).preNotes.prebendNoteHeadOffset;let n=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(l.displayValue-(l.bendPoints[0].value/2|0),!1),0)+c;this.drawBendSlur(s,r,n,a,d,h===ie.Down,this.scale)}}else{h===ie.Up&&(c=-c);let o=0,p=0;switch(l.bendType){case f.Bend:o=this.getBendNoteValue(l,l.bendPoints[l.bendPoints.length-1]),p=this._endNoteGlyph.getNoteValueY(o,!1)+c,this.drawBendSlur(s,a,d,r,p,h===ie.Down,this.scale,u);break;case f.BendRelease:let g=this.getBendNoteValue(l,l.bendPoints[1]),m=this._middleNoteGlyph.getNoteValueY(g,!1)+c;this.drawBendSlur(s,a,d,n,m,h===ie.Down,this.scale,u),o=this.getBendNoteValue(l,l.bendPoints[l.bendPoints.length-1]),p=this._endNoteGlyph.getNoteValueY(o,!1)+c,this.drawBendSlur(s,n,m,r,p,h===ie.Down,this.scale,u);break;case f.Release:this.BendNoteHeads.length>0&&(o=this.getBendNoteValue(l,l.bendPoints[l.bendPoints.length-1]),p=this.BendNoteHeads[0].getNoteValueY(o,!1)+c,this.drawBendSlur(s,a,d,r,p,h===ie.Down,this.scale,u));break;case f.Prebend:case f.PrebendBend:case f.PrebendRelease:let y=e+i.x+i.getBeatX(l.beat,se.PreNotes);y+=i.getBeatContainer(l.beat).preNotes.prebendNoteHeadOffset;let b=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(l.displayValue-(l.bendPoints[0].value/2|0),!1),0)+c;this.drawBendSlur(s,y,b,a,d,h===ie.Down,this.scale),this.BendNoteHeads.length>0&&(o=this.getBendNoteValue(l,l.bendPoints[l.bendPoints.length-1]),p=this.BendNoteHeads[0].getNoteValueY(o,!1)+c,this.drawBendSlur(s,a,d,r,p,h===ie.Down,this.scale,u))}}}}getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}class lr extends Ra{constructor(e,t,s=!1){super(e,t,s)}doLayout(){super.doLayout(),this.yOffset=Ti.NoteHeadHeight/2}getBeamDirection(e,t){if(e.isRest)return ie.Up;switch(t.getBeatDirection(e)){case ie.Up:return ie.Down;default:return ie.Up}}getStartY(e,t){if(this.startBeat.isRest)return e.getScoreY(9,0);switch(t){case ie.Up:return e.getNoteY(this.startBeat.minNote,!1);default:return e.getNoteY(this.startBeat.maxNote,!1)}}getEndY(e,t){if(this.endBeat.isRest)switch(t){case ie.Up:return e.getScoreY(9,0);default:return e.getScoreY(0,0)}switch(t){case ie.Up:return e.getNoteY(this.endBeat.minNote,!1);default:return e.getNoteY(this.endBeat.maxNote,!1)}}getStartX(e){return this.startBeat.isRest?e.getBeatX(this.startBeat,se.PreNotes):e.getNoteX(this.startBeat.minNote,!0)}getEndX(e){return this.endBeat.isRest?e.getBeatX(this.endBeat,se.PreNotes):e.getNoteX(this.endBeat.minNote,!1)}}class dr extends Ds{constructor(e,t,s,i){super(0,0),this._outType=t,this._inType=e,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(e,t,s){this.paintSlideIn(e,t,s),this.drawSlideOut(e,t,s)}paintSlideIn(e,t,s){let i=this.renderer,a=12*this.scale,r=1*this.scale,n=0,o=0,h=0,l=0;switch(this._inType){case T.IntoFromBelow:h=e+i.x+i.getNoteX(this._startNote,!1)-r,l=t+i.y+i.getNoteY(this._startNote,!0)+Ti.NoteHeadHeight/2,n=h-a,o=t+i.y+i.getNoteY(this._startNote,!0)+Ti.NoteHeadHeight;break;case T.IntoFromAbove:h=e+i.x+i.getNoteX(this._startNote,!1)-r,l=t+i.y+i.getNoteY(this._startNote,!0)+Ti.NoteHeadHeight/2,n=h-a,o=t+i.y+i.getNoteY(this._startNote,!0);break;default:return}let d=this.getAccidentalsWidth(i,this._startNote.beat);n-=d,h-=d,this.paintSlideLine(s,!1,n,h,o,l)}getAccidentalsWidth(e,t){let s=e.getPreNotesGlyphForBeat(t);return s&&s.accidentals?s.accidentals.width:0}drawSlideOut(e,t,s){let i=this.renderer,a=12*this.scale,r=1*this.scale,n=0,o=0,h=0,l=0,d=!1;switch(this._outType){case k.Shift:case k.Legato:n=e+i.x+i.getBeatX(this._startNote.beat,se.PostNotes)+r;let s=this._startNote.slideTarget.realValue>this._startNote.realValue;o=t+i.y+i.getNoteY(this._startNote,!1);let c=.25*Ti.NoteHeadHeight*this.scale;if(s?o+=c:o-=c,this._startNote.slideTarget){let a=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this._startNote.slideTarget.beat.voice.bar);a&&a.staff===i.staff?(h=e+a.x+a.getBeatX(this._startNote.slideTarget.beat,se.PreNotes)-r,l=t+a.y+a.getNoteY(this._startNote.slideTarget,!1),s?l-=c:l+=c):(h=e+i.x+this._parent.x,l=o)}else h=e+i.x+this._parent.x,l=o;break;case k.OutUp:n=e+i.x+i.getNoteX(this._startNote,!0)+2*r,o=t+i.y+i.getNoteY(this._startNote,!0)+Ti.NoteHeadHeight/2,h=n+a,l=t+i.y+i.getNoteY(this._startNote,!0);break;case k.OutDown:n=e+i.x+i.getNoteX(this._startNote,!0)+2*r,o=t+i.y+i.getNoteY(this._startNote,!0)+Ti.NoteHeadHeight/2,h=n+a,l=t+i.y+i.getNoteY(this._startNote,!0)+Ti.NoteHeadHeight;break;case k.PickSlideUp:n=e+i.x+i.getNoteX(this._startNote,!0)+2*r,o=t+i.y+i.getNoteY(this._startNote,!0)+Ti.NoteHeadHeight/2,l=t+i.y+i.getNoteY(this._startNote,!0)-Ti.NoteHeadHeight,h=e+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,se.PreNotes)),d=!0;break;case k.PickSlideDown:n=e+i.x+i.getNoteX(this._startNote,!0)+2*r,o=t+i.y+i.getNoteY(this._startNote,!0)-Ti.NoteHeadHeight/2,l=t+i.y+i.getNoteY(this._startNote,!0)+Ti.NoteHeadHeight,h=e+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,se.PreNotes)),d=!0;break;default:return}this.paintSlideLine(s,d,n,h,o,l)}paintSlideLine(e,t,s,i,a,r){if(t){let t=i-s,n=r-a,o=Math.sqrt(Math.pow(n,2)+Math.pow(t,2)),h=Math.asin(n/o)*(180/Math.PI);e.beginRotate(s,a,h);let l=new qi(0,0,x.Slight,1.2);l.renderer=this.renderer,l.doLayout(),l.width=t,l.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(s,a),e.lineTo(i,r),e.stroke()}}class cr extends Ra{constructor(e,t,s=!1){super(e?e.beat:null,t?t.beat:null,s),this.startNote=e,this.endNote=t}doLayout(){super.doLayout(),this.yOffset=Ti.NoteHeadHeight/2}getBeamDirection(e,t){switch(t.getBeatDirection(e)){case ie.Up:return ie.Down;default:return ie.Up}}getStartY(e,t){return e.getNoteY(this.startNote,!1)}getEndY(e,t){return e.getNoteY(this.endNote,!1)}getStartX(e){return e.getBeatX(this.startNote.beat,se.MiddleNotes)}getEndX(e){return e.getNoteX(this.endNote,!1)}}class ur extends cr{constructor(e,t,s=!1){super(e,t,s)}getTieHeight(e,t,s,i){return Math.log(s-e+1)*this.renderer.settings.notation.slurHeight}}class pr extends Is{constructor(e,t){super(e,t),this._bend=null,this._effectSlur=null,this._effectEndSlur=null}doLayout(){if(this._effectSlur=null,this._effectEndSlur=null,super.doLayout(),this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let e=this.beat.nextBeat;for(;e.nextBeat&&e.nextBeat.isLegatoDestination;)e=e.nextBeat;this.ties.push(new lr(this.beat,e,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let e=this.beat.previousBeat;for(;e.previousBeat&&e.previousBeat.isLegatoOrigin;)e=e.previousBeat;this.ties.push(new lr(e,this.beat,!0))}this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(e.isVisible){if(e.isTieOrigin&&!e.hasBend&&!e.beat.hasWhammyBar&&e.beat.graceType!==_.BendGrace&&e.tieDestination&&e.tieDestination.isVisible){let t=new cr(e,e.tieDestination,!1);this.ties.push(t)}if(e.isTieDestination&&!e.tieOrigin.hasBend&&!e.beat.hasWhammyBar){let t=new cr(e.tieOrigin,e,!0);this.ties.push(t)}if(e.slideInType!==T.None||e.slideOutType!==k.None){let t=new dr(e.slideInType,e.slideOutType,e,this);this.ties.push(t)}if(e.isSlurOrigin&&e.slurDestination&&e.slurDestination.isVisible){let t=new ur(e,e.slurDestination,!1);this.ties.push(t)}if(e.isSlurDestination){let t=new ur(e.slurOrigin,e,!0);this.ties.push(t)}if(!this._effectSlur&&e.beat.isEffectSlurOrigin&&e.beat.effectSlurDestination){let t=this.onNotes.beamingHelper.direction,s=t===ie.Up?e.beat.minNote:e.beat.maxNote,i=t===ie.Up?e.beat.effectSlurDestination.minNote:e.beat.effectSlurDestination.maxNote;this._effectSlur=new ur(s,i,!1),this.ties.push(this._effectSlur)}if(!this._effectEndSlur&&e.beat.isEffectSlurDestination&&e.beat.effectSlurOrigin){let t=this.onNotes.beamingHelper.direction,s=t===ie.Up?e.beat.effectSlurOrigin.minNote:e.beat.effectSlurOrigin.maxNote,i=t===ie.Up?e.beat.minNote:e.beat.maxNote;this._effectEndSlur=new ur(s,i,!0),this.ties.push(this._effectEndSlur)}e.hasBend&&(this._bend||(this._bend=new hr(e.beat),this._bend.renderer=this.renderer,this.ties.push(this._bend)),this._bend.addBends(e))}}}class gr{constructor(e){this._registeredAccidentals=new Map,this._appliedScoreLines=new Map,this._appliedScoreLinesByValue=new Map,this._notesByValue=new Map,this.maxNoteValueBeat=null,this.minNoteValueBeat=null,this.maxNoteValue=-1,this.minNoteValue=-1,this._bar=e}applyAccidental(e){let t=this._bar.staff.isPercussion?Se.mapNoteForDisplay(e.displayValue):e.displayValue,s=e.hasQuarterToneOffset,i=this.registerNoteLine(e,t);return(-1===this.minNoteValue||t<this.minNoteValue)&&(this.minNoteValue=t,this.minNoteValueBeat=e.beat),(-1===this.maxNoteValue||t>this.maxNoteValue)&&(this.maxNoteValue=t,this.maxNoteValueBeat=e.beat),this.getAccidental(i,t,s)}applyAccidentalForValue(e,t,s){this._bar.staff.isPercussion&&(t=Se.mapNoteForDisplay(t));let i=this.registerNoteValueLine(t);return(-1===this.minNoteValue||t<this.minNoteValue)&&(this.minNoteValue=t,this.minNoteValueBeat=e),(-1===this.maxNoteValue||t>this.maxNoteValue)&&(this.maxNoteValue=t,this.maxNoteValueBeat=e),this.getAccidental(i,t,s)}getAccidental(e,t,s){let i=oe.None;if(!this._bar.staff.isPercussion){let a=this._bar.masterBar.keySignature+7,r=t%12,n=a<7?oe.Flat:oe.Sharp,o=gr.KeySignatureLookup[a][r],h=gr.AccidentalNotes[r];if(s)i=h?n:oe.Natural;else{let t=this._registeredAccidentals.has(e);o===h||t?o===h&&t&&(this._registeredAccidentals.delete(e),i=h?n:oe.Natural):(this._registeredAccidentals.set(e,!0),i=h?n:oe.Natural)}}if(s)switch(i){case oe.Natural:return oe.NaturalQuarterNoteUp;case oe.Sharp:return oe.SharpQuarterNoteUp;case oe.Flat:return oe.FlatQuarterNoteUp}return i}registerNoteLine(e,t){let s=this.calculateNoteLine(t,e.accidentalMode);return this._appliedScoreLines.set(e.id,s),this._notesByValue.set(t,e),s}registerNoteValueLine(e){let t=this.calculateNoteLine(e,v.Default);return this._appliedScoreLinesByValue.set(e,t),t}calculateNoteLine(e,t){let s=e,i=this._bar.masterBar.keySignature,a=this._bar.clef,r=s%12,n=(s/12|0)-1,o=gr.OctaveSteps[a];return o-=n*gr.StepsPerOctave,o-=(Ae.keySignatureIsSharp(i)||Ae.keySignatureIsNatural(i)?gr.SharpNoteSteps:gr.FlatNoteSteps)[r],o}getNoteLine(e){return this._appliedScoreLines.get(e.id)}getNoteLineForValue(e,t=!1){return this._appliedScoreLinesByValue.has(e)?this._appliedScoreLinesByValue.get(e):t&&this._notesByValue.has(e)?this.getNoteLine(this._notesByValue.get(e)):0}}gr.KeySignatureLookup=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],gr.AccidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1],gr.StepsPerOctave=7,gr.OctaveSteps=[40,34,32,28,40],gr.SharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6],gr.FlatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6];class fr extends oi{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this._startSpacing=!1,this.accidentalHelper=new gr(t)}getBeatDirection(e){let t=this.getOnNotesGlyphForBeat(e);return t?t.noteHeads.direction:ie.Up}getNoteX(e,t=!0){let s=this.getOnNotesGlyphForBeat(e.beat);if(s){let e=s.container.voiceContainer.x+s.container.x+s.x;return t&&(e+=s.width),e}return 0}getNoteY(e,t=!1){let s=this.getOnNotesGlyphForBeat(e.beat);return s?s.noteHeads.getNoteY(e,t):0}get lineOffset(){return(fr.LineSpacing+1)*this.scale}updateSizes(){let e=this.resources,t=e.tablatureFont.size/2+.2*e.tablatureFont.size;this.topPadding=t,this.bottomPadding=t,this.height=4*this.lineOffset+this.topPadding+this.bottomPadding,super.updateSizes()}doLayout(){if(super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxNoteValueBeat){let e=this.getScoreY(0,0),t=this.getScoreY(8,0),s=this.simpleWhammyOverflow;this.registerOverflowTop(s);let i=this.getYPositionForNoteValue(this.accidentalHelper.maxNoteValue),a=this.helpers.getBeamingHelperForBeat(this.accidentalHelper.maxNoteValueBeat);a.direction===ie.Up&&(i-=this.getStemSize(a),i-=a.fingeringCount*this.resources.graceFont.size,a.hasTuplet&&(i-=2*this.resources.effectFont.size)),a.hasTuplet&&(i-=1.5*this.resources.effectFont.size),i<e&&this.registerOverflowTop(Math.abs(i)+s);let r=this.getYPositionForNoteValue(this.accidentalHelper.minNoteValue),n=this.helpers.getBeamingHelperForBeat(this.accidentalHelper.minNoteValueBeat);n.direction===ie.Down&&(r+=this.getStemSize(n),r+=n.fingeringCount*this.resources.graceFont.size),r>t&&this.registerOverflowBottom(Math.abs(r)-t)}}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s),this.paintTuplets(e,t,s)}paintTuplets(e,t,s){for(let i of this.bar.voices)if(this.hasVoiceContainer(i)){let a=this.getOrCreateVoiceContainer(i);for(let i of a.tupletGroups)this.paintTupletHelper(e+this.beatGlyphsStart,t,s,i)}}paintBeams(e,t,s){for(let i=0,a=this.helpers.beamHelpers.length;i<a;i++){let a=this.helpers.beamHelpers[i];for(let i=0,r=a.length;i<r;i++){let r=a[i];this.paintBeamHelper(e+this.beatGlyphsStart,t,s,r)}}}paintBeamHelper(e,t,s,i){s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,1===i.beats.length?this.paintFooter(e,t,s,i):this.paintBar(e,t,s,i)}paintTupletHelper(e,t,s,i){let a,r=this.resources,n=s.textAlign;s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.textAlign=$.Center;let o=i.beats[0].tupletNumerator,h=i.beats[0].tupletDenominator;if(a=2===o&&3===h?"2":3===o&&2===h?"3":4===o&&6===h?"4":5===o&&4===h?"5":6===o&&4===h?"6":7===o&&4===h?"7":9===o&&8===h?"9":10===o&&8===h?"10":11===o&&8===h?"11":12===o&&8===h?"12":13===o&&8===h?"13":o+":"+h,1!==i.beats.length&&i.isFull){let n=i.beats[0],o=i.beats[i.beats.length-1],h=this.helpers.beamHelperLookup[i.voice.index].get(n.index),l=this.helpers.beamHelperLookup[i.voice.index].get(o.index);if(h&&l){let i=h.direction,d=h.getBeatLineX(n)+this.scale,c=l.getBeatLineX(o)+this.scale;s.font=r.effectFont;let u=s.measureText(a),p=3*this.scale,g=(d+c)/2,f=g-u/2-p,m=g+u/2+p,y=this.calculateBeamYWithDirection(h,d,h.direction),b=this.calculateBeamYWithDirection(l,c,h.direction),S=(b-y)/(c-d),_=y-S*d,w=S*f+_,B=S*g+_,v=S*m+_,T=10*this.scale,k=5*this.scale;i===ie.Down&&(T*=-1,k*=-1),s.beginPath(),s.moveTo(e+this.x+d,t+this.y+y-T|0),s.lineTo(e+this.x+d,t+this.y+y-T-k|0),s.lineTo(e+this.x+f,t+this.y+w-T-k|0),s.stroke(),s.beginPath(),s.moveTo(e+this.x+m,t+this.y+v-T-k|0),s.lineTo(e+this.x+c,t+this.y+b-T-k|0),s.lineTo(e+this.x+c,t+this.y+b-T|0),s.stroke(),s.fillText(a,e+this.x+g,t+this.y+B-T-k-r.effectFont.size/2)}}else for(let n=0,o=i.beats.length;n<o;n++){let o=i.beats[n],h=this.helpers.beamHelperLookup[i.voice.index].get(o.index);if(!h)continue;let l=h.direction,d=h.getBeatLineX(o)+this.scale,c=t+this.y+this.calculateBeamY(h,d),u=l===ie.Up?1.5*r.effectFont.size:-3*this.scale;s.font=r.effectFont,s.fillText(a,e+this.x+d,c-u)}s.textAlign=n}getStemSize(e){let t=1===e.beats.length?this.getFooterStemSize(e.shortestDuration):this.getBarStemSize(e.shortestDuration);return e.isGrace&&(t*=Ti.GraceScale),t}getBarStemSize(e){let t=0;switch(e){case b.QuadrupleWhole:case b.Half:case b.Quarter:case b.Eighth:case b.Sixteenth:t=6;break;case b.ThirtySecond:case b.SixtyFourth:t=7;break;case b.OneHundredTwentyEighth:t=9;break;case b.TwoHundredFiftySixth:t=10;break;default:t=0}return this.getScoreY(t,0)}getFooterStemSize(e){let t=0;switch(e){case b.QuadrupleWhole:case b.Half:case b.Quarter:case b.Eighth:case b.Sixteenth:case b.ThirtySecond:case b.SixtyFourth:case b.OneHundredTwentyEighth:case b.TwoHundredFiftySixth:t=6;break;default:t=0}return this.getScoreY(t,0)}getYPositionForNoteValue(e){return this.getScoreY(this.accidentalHelper.getNoteLineForValue(e,!0),0)}calculateBeamY(e,t){let s=this.getStemSize(e);return e.calculateBeamY(s,this.scale,t,this.scale,this)}calculateBeamYWithDirection(e,t,s){let i=this.getStemSize(e);return e.calculateBeamYWithDirection(i,this.scale,t,this.scale,this,s)}paintBar(e,t,s,i){for(let a=0,r=i.beats.length;a<r;a++){let r=i.beats[a],n=r.graceType!==_.None?Ti.GraceScale:1,o=i.getBeatLineX(r)+this.scale,h=i.direction,l=t+this.y;l+=h===ie.Up?this.getYPositionForNoteValue(i.getBeatMinValue(r)):this.getYPositionForNoteValue(i.getBeatMaxValue(r));let d=t+this.y;d+=this.calculateBeamY(i,o),s.lineWidth=fr.StemWidth*this.scale,s.beginPath(),s.moveTo(e+this.x+o,l),s.lineTo(e+this.x+o,d),s.stroke(),s.lineWidth=this.scale;let c=d;h===ie.Down?c+=2*s.font.size:0!==a&&(c-=1.5*s.font.size),this.paintFingering(s,r,e+this.x+o,h,c);let u=6*this.scale*n,p=7*this.scale*n,g=fr.LineSpacing/2*this.scale*n,f=Ae.getIndex(r.duration)-2,m=t+this.y;h===ie.Down&&(p=-p,g=-g);for(let t=0;t<f;t++){let n=0,h=0,l=0,d=0,c=m+t*p;if(a<i.beats.length-1){if(ri.isFullBarJoin(r,i.beats[a+1],t))n=o,h=i.getBeatLineX(i.beats[a+1])+this.scale;else{if(0!==a&&ri.isFullBarJoin(i.beats[a-1],r,t))continue;n=o,h=n+u}l=c+this.calculateBeamY(i,n),d=c+this.calculateBeamY(i,h),fr.paintSingleBar(s,e+this.x+n,l,e+this.x+h,d,g)}else a>0&&!ri.isFullBarJoin(r,i.beats[a-1],t)&&(n=o-u,h=o,l=c+this.calculateBeamY(i,n),d=c+this.calculateBeamY(i,h),fr.paintSingleBar(s,e+this.x+n,l,e+this.x+h,d,g))}}}static paintSingleBar(e,t,s,i,a,r){e.beginPath(),e.moveTo(t,s),e.lineTo(i,a),e.lineTo(i,a+r),e.lineTo(t,s+r),e.closePath(),e.fill()}paintFooter(t,s,i,a){let r=a.beats[0];if(r.graceType===_.BendGrace||r.graceType!==_.None&&this.settings.notation.notationMode===e.NotationMode.SongBook)return;let n=r.graceType!==_.None,o=n?Ti.GraceScale:1,h=this.getFooterStemSize(a.shortestDuration),l=a.getBeatLineX(r)+this.scale,d=a.direction,c=this.getYPositionForNoteValue(a.maxNoteValue),u=this.getYPositionForNoteValue(a.minNoteValue),p=0,g=0;if(d===ie.Down?(u+=h*o,p=u,g=s+this.y+u):(c-=h*o,p=c,g=s+this.y+c),this.paintFingering(i,r,t+this.x+l,d,g),r.duration!==b.Whole&&r.duration!==b.DoubleWhole&&r.duration!==b.QuadrupleWhole){if(i.lineWidth=fr.StemWidth*this.scale,i.beginPath(),i.moveTo(t+this.x+l,s+this.y+c),i.lineTo(t+this.x+l,s+this.y+u),i.stroke(),i.lineWidth=this.scale,r.graceType===_.BeforeBeat){let e=15*this.scale,a=12*this.scale;i.beginPath(),d===ie.Down?(i.moveTo(t+this.x+l-a/2,s+this.y+u-e),i.lineTo(t+this.x+l+a/2,s+this.y+u)):(i.moveTo(t+this.x+l-a/2,s+this.y+c+e),i.lineTo(t+this.x+l+a/2,s+this.y+c)),i.stroke()}if(r.duration>b.Quarter||n){let e=new ka(l-this.scale/2,p,r.duration,d,n);e.renderer=this,e.doLayout(),e.paint(t+this.x,s+this.y,i)}}}paintFingering(t,s,i,a,r){let n=this.settings;if(n.notation.fingeringMode!==e.FingeringMode.ScoreDefault&&n.notation.fingeringMode!==e.FingeringMode.ScoreForcePiano)return;a===ie.Up?i-=10*this.scale:i+=3*this.scale;let o=s.notes.slice(0);o.sort((e,t)=>e.realValue-t.realValue);for(let e=0;e<o.length;e++){let a=o[e],h=null;a.leftHandFinger!==w.Unknown?h=Ae.fingerToString(n,s,a.leftHandFinger,!0):a.rightHandFinger!==w.Unknown&&(h=Ae.fingerToString(n,s,a.rightHandFinger,!1)),h&&(t.fillText(h,i,r),r-=0|t.font.size)}}createPreBeatGlyphs(){if(super.createPreBeatGlyphs(),this.bar.masterBar.isRepeatStart&&this.addPreBeatGlyph(new Fa(0,0,1.5,3)),this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let e=0,t=0;switch(this.bar.clef){case c.Neutral:e=6;break;case c.F4:e=4,t=-1;break;case c.C3:e=6;break;case c.C4:e=4;break;case c.G2:e=8}this.createStartSpacing(),this.addPreBeatGlyph(new xa(0,this.getScoreY(e,t),this.bar.clef,this.bar.clefOttava))}(0===this.index&&0!==this.bar.masterBar.keySignature||this.bar.previousBar&&this.bar.masterBar.keySignature!==this.bar.previousBar.masterBar.keySignature)&&(this.createStartSpacing(),this.createKeySignatureGlyphs()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs()),this.addPreBeatGlyph(new va(0,this.getScoreY(-.5,0),this.bar.index+1)),this.bar.isEmpty&&this.addPreBeatGlyph(new er(0,0,30*this.scale))}createBeatGlyphs(){for(let e=0;e<this.bar.voices.length;e++){let t=this.bar.voices[e];this.hasVoiceContainer(t)&&this.createVoiceGlyphs(t)}}createPostBeatGlyphs(){super.createPostBeatGlyphs(),this.bar.masterBar.isRepeatEnd?(this.addPostBeatGlyph(new Na(this.x,0)),this.bar.masterBar.repeatCount>2&&this.addPostBeatGlyph(new Pa(0,this.getScoreY(-1,-3),this.bar.masterBar.repeatCount))):this.addPostBeatGlyph(new Ta(0,0))}createStartSpacing(){this._startSpacing||(this.addPreBeatGlyph(new er(0,0,2*this.scale)),this._startSpacing=!0)}createKeySignatureGlyphs(){let e=0,t=this.bar.masterBar.keySignature,s=this.bar.previousBar?this.bar.previousBar.masterBar.keySignature:0;switch(this.bar.clef){case c.Neutral:e=0;break;case c.G2:e=1;break;case c.F4:e=2;break;case c.C3:e=-1;break;case c.C4:e=1}let i=new Map,a=[];if(Ae.keySignatureIsSharp(t))for(let s=0;s<Math.abs(t);s++){let t=fr.SharpKsSteps[s]+e;a.push(new Ba(0,this.getScoreY(t,0),oe.Sharp,!1)),i.set(t,!0)}else for(let s=0;s<Math.abs(t);s++){let t=fr.FlatKsSteps[s]+e;a.push(new Ba(0,this.getScoreY(t,0),oe.Flat,!1)),i.set(t,!0)}let r=Math.abs(s),n=Ae.keySignatureIsSharp(s)?fr.SharpKsSteps:fr.FlatKsSteps;for(let t=0;t<r;t++){let s=n[t]+e;i.has(s)||this.addPreBeatGlyph(new Ba(0,this.getScoreY(n[t]+e,0),oe.Natural,!1))}for(let e of a)this.addPreBeatGlyph(e)}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new er(0,0,5*this.scale)),this.addPreBeatGlyph(new or(0,this.getScoreY(2,0),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon))}createVoiceGlyphs(e){for(let t=0,s=e.beats.length;t<s;t++){let s=e.beats[t],i=new pr(s,this.getOrCreateVoiceContainer(e));i.preNotes=new ir,i.onNotes=new tr,this.addBeatGlyph(i)}}getNoteLine(e){return this.accidentalHelper.getNoteLine(e)}getScoreY(e,t=0){return this.lineOffset/2*e+t*this.scale}paintBackground(e,t,s){super.paintBackground(e,t,s);let i=this.resources;s.color=i.staffLineColor;let a=t+this.y+this.topPadding,r=this.lineOffset;for(let t=0;t<5;t++)t>0&&(a+=r),s.fillRect(e+this.x,0|a,this.width,this.scale);s.color=i.mainGlyphColor,this.paintSimileMark(e,t,s)}}fr.StaffId="score",fr.SharpKsSteps=[1,4,0,3,6,2,5],fr.FlatKsSteps=[5,2,6,3,7,4,8],fr.LineSpacing=8,fr.StemWidth=1.3;class mr extends ei{get staffId(){return fr.StaffId}create(e,t){return new fr(e,t)}constructor(){super()}}class yr extends Ds{constructor(e,t,s,i){super(0,0),this._inType=e,this._outType=t,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(e,t,s){this.paintSlideIn(e,t,s),this.paintSlideOut(e,t,s)}paintSlideIn(e,t,s){let i=this.renderer,a=12*this.scale,r=3*this.scale,n=0,o=0,h=0,l=0;switch(this._inType){case T.IntoFromBelow:h=e+i.x+i.getNoteX(this._startNote,!1),l=t+i.y+i.getNoteY(this._startNote,!1),n=h-a,o=t+i.y+i.getNoteY(this._startNote,!1)+r;break;case T.IntoFromAbove:h=e+i.x+i.getNoteX(this._startNote,!1),l=t+i.y+i.getNoteY(this._startNote,!1),n=h-a,o=t+i.y+i.getNoteY(this._startNote,!1)-r;break;default:return}this.paintSlideLine(s,!1,n,h,o,l)}paintSlideOut(e,t,s){let i=this.renderer,a=12*this.scale,r=3*this.scale,n=0,o=0,h=0,l=0,d=!1;switch(this._outType){case k.Shift:case k.Legato:let s=0,c=0;if(this._startNote.slideTarget?this._startNote.slideTarget.fret>this._startNote.fret?(s=r,c=-1*r):(s=-1*r,c=r):(s=0,c=0),n=e+i.x+i.getBeatX(this._startNote.beat,se.PostNotes),o=t+i.y+i.getNoteY(this._startNote,!1)+s,this._startNote.slideTarget){let s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this._startNote.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(h=e+s.x+s.getBeatX(this._startNote.slideTarget.beat,se.OnNotes),l=t+s.y+s.getNoteY(this._startNote.slideTarget,!1)+c):(h=e+i.x+this._parent.x,l=o)}else h=e+i.x+this._parent.x,l=o;break;case k.OutUp:n=e+i.x+i.getNoteX(this._startNote,!0),o=t+i.y+i.getNoteY(this._startNote,!1),h=n+a,l=t+i.y+i.getNoteY(this._startNote,!1)-r;break;case k.OutDown:n=e+i.x+i.getNoteX(this._startNote,!0),o=t+i.y+i.getNoteY(this._startNote,!1),h=n+a,l=t+i.y+i.getNoteY(this._startNote,!1)+r;break;case k.PickSlideDown:n=e+i.x+i.getNoteX(this._startNote,!0),o=t+i.y+i.getNoteY(this._startNote,!1)-2*r,h=e+i.x+i.getBeatX(this._startNote.beat,se.EndBeat),l=o+3*r,d=!0;break;case k.PickSlideUp:n=e+i.x+i.getNoteX(this._startNote,!0),o=t+i.y+i.getNoteY(this._startNote,!1)+r,h=e+i.x+i.getBeatX(this._startNote.beat,se.EndBeat),l=o-3*r,d=!0;break;default:return}this.paintSlideLine(s,d,n,h,o,l)}paintSlideLine(e,t,s,i,a,r){if(t){let t=i-s,n=r-a,o=Math.sqrt(Math.pow(n,2)+Math.pow(t,2)),h=Math.asin(n/o)*(180/Math.PI);e.beginRotate(s,a,h);let l=new qi(0,0,x.Slight,1.2);l.renderer=this.renderer,l.doLayout(),l.width=t,l.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(s,a),e.lineTo(i,r),e.stroke()}}class br extends Ra{constructor(e,t,s,i=!1){super(e.beat,t.beat,i),this.StartNote=e,this.EndNote=t,this.ForSlide=s}get offset(){return this.ForSlide?5*this.scale:0}getBeamDirection(e,t){return br.getBeamDirection_Note(this.StartNote)}static getBeamDirection_Note(e){return e.string>3?ie.Up:ie.Down}getStartY(e,t){return e.getNoteY(this.StartNote,!1)-this.offset}getEndY(e,t){return e.getNoteY(this.EndNote,!1)-this.offset}getStartX(e){return e.getNoteX(this.StartNote,!0)}getEndX(e){return e.getNoteX(this.EndNote,!1)}}class Sr extends br{constructor(e,t,s,i=!1){super(e,t,s,i),this._direction=br.getBeamDirection_Note(e)}getTieHeight(e,t,s,i){return Math.log(s-e+1)*this.renderer.settings.notation.slurHeight}tryExpand(e,t,s,i){if(this.ForSlide!==s)return!1;if(this.forEnd!==i)return!1;if(this.StartNote.beat.id!==e.beat.id)return!1;if(this.EndNote.beat.id!==t.beat.id)return!1;if(this._direction!==br.getBeamDirection_Note(e))return!1;switch(this._direction){case ie.Up:e.realValue>this.StartNote.realValue&&(this.StartNote=e,this.startBeat=e.beat),t.realValue>this.EndNote.realValue&&(this.EndNote=t,this.endBeat=t.beat);break;case ie.Down:e.realValue<this.StartNote.realValue&&(this.StartNote=e,this.startBeat=e.beat),t.realValue<this.EndNote.realValue&&(this.EndNote=t,this.endBeat=t.beat)}return!0}paint(e,t,s){let i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this.startBeat.voice.bar),a=this.getBeamDirection(this.startBeat,i),r="tab.slur."+this.StartNote.beat.id+"."+this.EndNote.beat.id+"."+a,n=this.renderer;n.staff.getSharedLayoutData(r,!1)||(n.staff.setSharedLayoutData(r,!0),super.paint(e,t,s))}}class _r extends Is{constructor(e,t){super(e,t),this._bend=null,this._effectSlurs=[]}doLayout(){this._effectSlurs=[],super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(!e.isVisible)return;let t=this.renderer;if(e.isTieOrigin&&t.showTiedNotes&&e.tieDestination.isVisible){let t=new br(e,e.tieDestination,!1,!1);this.ties.push(t)}if(e.isTieDestination&&t.showTiedNotes){let t=new br(e.tieOrigin,e,!1,!0);this.ties.push(t)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let t=!1;for(let s of this._effectSlurs)if(s.tryExpand(e,e.effectSlurDestination,!1,!1)){t=!0;break}if(!t){let t=new Sr(e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(t),this.ties.push(t)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let t=!1;for(let s of this._effectSlurs)if(s.tryExpand(e.effectSlurOrigin,e,!1,!0)){t=!0;break}if(!t){let t=new Sr(e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(t),this.ties.push(t)}}if(e.slideInType!==T.None||e.slideOutType!==k.None){let t=new yr(e.slideInType,e.slideOutType,e,this);this.ties.push(t)}e.hasBend&&(this._bend||(this._bend=new Ka,this._bend.renderer=this.renderer,this.ties.push(this._bend)),this._bend.addBends(e))}}class wr extends Ds{constructor(e,t,s){super(e,t),this._noteString=null,this._trillNoteString=null,this._trillNoteStringWidth=0,this.isEmpty=!1,this.height=0,this.noteStringWidth=0,this._note=s}doLayout(){let e=this._note,t=e.fret-e.beat.voice.bar.staff.transpositionPitch;if(e.harmonicType===B.Natural&&0!==e.harmonicValue&&(t=e.harmonicValue-e.beat.voice.bar.staff.transpositionPitch),e.isTieDestination)0===e.beat.index||(e.bendType===f.Bend||e.bendType===f.BendRelease)&&this.renderer.settings.notation.showTabNoteOnTiedBend?this._noteString="("+(e.tieOrigin.fret-e.beat.voice.bar.staff.transpositionPitch)+")":this._noteString="";else if(this._noteString=e.isDead?"x":t.toString(),e.isGhost)this._noteString="("+this._noteString+")";else if(e.harmonicType===B.Natural){let e=this._noteString.indexOf(String.fromCharCode(46));e>=0&&(this._noteString=this._noteString.substr(0,e+2)),this._noteString="<"+this._noteString+">"}if(e.isTrill)this._trillNoteString="("+(e.trillFret-e.beat.voice.bar.staff.transpositionPitch)+")";else if(i.isAlmostEqualTo(e.harmonicValue,0))this._trillNoteString="";else switch(e.harmonicType){case B.Artificial:case B.Pinch:case B.Tap:case B.Semi:case B.Feedback:let s=t+e.harmonicValue.toString(),i=s.indexOf(String.fromCharCode(46));i>=0&&(s=s.substr(0,i+2)),this._trillNoteString="<"+s+">";break;default:this._trillNoteString=""}if(this.isEmpty=!this._noteString,!this.isEmpty){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont,this.width=this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this._noteString),this.height=this.renderer.scoreRenderer.canvas.font.size,!!this._trillNoteString&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this._trillNoteStringWidth=3*this.scale+this.renderer.scoreRenderer.canvas.measureText(this._trillNoteString),this.width+=this._trillNoteStringWidth)}}paint(e,t,s){if(this.isEmpty)return;let i=this.noteStringWidth+this._trillNoteStringWidth,a=e+this.x+(this.width-i)/2,r=this.renderer.scoreRenderer.canvas.font;if(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,s.fillText(this._trillNoteString,a+this.noteStringWidth+3*this.scale,t+this.y),this.renderer.scoreRenderer.canvas.font=r,s.fillText(this._noteString,a,t+this.y),this.renderer.settings.core.includeNoteBounds){let s=new bs;s.note=this._note,s.noteHeadBounds=new Je,s.noteHeadBounds.x=e+this.x,s.noteHeadBounds.y=t+this.y,s.noteHeadBounds.w=this.width,s.noteHeadBounds.h=this.height,this.renderer.scoreRenderer.boundsLookup.addNote(s)}}}class Br extends Ds{constructor(e,t,s){super(e,t),this._notes=[],this.minStringNote=null,this.beatEffects=new Map,this.notesPerString=new Map,this.noteStringWidth=0,this._isGrace=s}getNoteX(e,t=!0){if(this.notesPerString.has(e.string)){let s=this.notesPerString.get(e.string),i=this.x+s.x;return t&&(i+=s.width),i}return 0}getNoteY(e,t=!1){return this.notesPerString.has(e.string)?this.y+this.notesPerString.get(e.string).y+(t?-this.notesPerString.get(e.string).height/2:0):0}doLayout(){let e=0,t=0;for(let s=0,i=this._notes.length;s<i;s++){let i=this._notes[s];i.renderer=this.renderer,i.doLayout(),i.width>e&&(e=i.width),i.noteStringWidth>t&&(t=i.noteStringWidth)}this.noteStringWidth=t;let s=this.renderer.resources.tablatureFont.size,i=this.getNoteY(this.minStringNote,!1)+s/2,a=7*this.scale;for(let e of this.beatEffects){let t=e[1];t.y+=i,t.x+=this.width/2,t.renderer=this.renderer,i+=a,t.doLayout()}this.width=e}addNoteGlyph(e,t){this._notes.push(e),this.notesPerString.set(t.string,e),(!this.minStringNote||t.string<this.minStringNote.string)&&(this.minStringNote=t)}paint(e,t,s){e+=this.x,t+=this.y;let i=this.renderer.resources,a=s.textBaseline;s.textBaseline=Z.Middle,s.font=this._isGrace?i.graceFont:i.tablatureFont;let r=this._notes,n=this.width;for(let i of r)i.renderer=this.renderer,i.width=n,i.paint(e,t,s);s.textBaseline=a;for(let i of this.beatEffects){i[1].paint(e,t,s)}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width,e+this.x)}}class vr extends vi{constructor(e,t,s,i){super(e,t,1,Ya.getSymbol(i)),this._isVisibleRest=s,this._duration=i}doLayout(){this._isVisibleRest?this.width=Ya.getSize(this._duration)*this.scale:this.width=10*this.scale}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width,e+this.x)}paint(e,t,s){this._isVisibleRest&&super.paint(e,t,s)}}class Tr extends pi{constructor(){super(...arguments),this.noteNumbers=null,this.restGlyph=null}doLayout(){let t=this.renderer;if(this.container.beat.isRest){let e=0,s=0;switch(this.container.beat.duration){case b.QuadrupleWhole:case b.DoubleWhole:e=3;break;case b.Whole:e=2;break;case b.Half:case b.Quarter:e=3;break;case b.Eighth:case b.Sixteenth:e=2,s=5;break;case b.ThirtySecond:case b.SixtyFourth:case b.OneHundredTwentyEighth:case b.TwoHundredFiftySixth:e=3}let i=t.getTabY(e,s);if(this.restGlyph=new vr(0,i,t.showRests,this.container.beat.duration),this.restGlyph.beat=this.container.beat,this.restGlyph.beamingHelper=this.beamingHelper,this.addGlyph(this.restGlyph),this.container.beat.dots>0&&t.showRests){this.addGlyph(new er(0,0,5*this.scale));for(let e=0;e<this.container.beat.dots;e++)this.addGlyph(new Ma(0,i,1.5*this.scale))}}else{let s=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==_.None;this.noteNumbers=new Br(0,0,s),this.noteNumbers.beat=this.container.beat,this.noteNumbers.beamingHelper=this.beamingHelper;for(let e of this.container.beat.notes)e.isVisible&&this.createNoteGlyph(e);if(this.addGlyph(this.noteNumbers),this.container.beat.hasWhammyBar){let e=new $a(this.container.beat);e.renderer=this.renderer,e.doLayout(),this.container.ties.push(e)}if(this.container.beat.isTremolo&&!this.noteNumbers.beatEffects.has("tremolo")){let e=0,t=this.container.beat.tremoloSpeed;switch(t){case b.ThirtySecond:e=10;break;case b.Sixteenth:e=5;break;case b.Eighth:e=0}this.noteNumbers.beatEffects.set("tremolo",new Ua(5*this.scale,e*this.scale,t))}if(this.container.beat.dots>0&&t.settings.notation.rhythmMode!==e.TabRhythmMode.Hidden){this.addGlyph(new er(0,0,5*this.scale));for(let e=0;e<this.container.beat.dots;e++)this.addGlyph(new Ma(0,t.lineOffset*t.bar.staff.tuning.length+t.settings.notation.rhythmHeight*t.scale,1.5*this.scale))}}if(!this.glyphs)return;let s=0;for(let e=0,t=this.glyphs.length;e<t;e++){let t=this.glyphs[e];t.x=s,t.renderer=this.renderer,t.doLayout(),s+=t.width}this.width=s,this.container.beat.isEmpty?this.centerX=this.width/2:this.container.beat.isRest?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2}updateBeamingHelper(){this.container.beat.isRest?this.restGlyph.updateBeamingHelper(this.container.x+this.x):this.noteNumbers.updateBeamingHelper(this.container.x+this.x)}createNoteGlyph(e){let t=this.renderer,s=new wr(0,0,e),i=e.beat.voice.bar.staff.tuning.length-e.string+1;s.y=t.getTabY(i,-2),s.renderer=this.renderer,s.doLayout(),this.noteNumbers.addNoteGlyph(s,e)}}class kr extends Ds{constructor(e){super(0,0),this._beat=e}doLayout(){this.width=10*this.scale}paint(e,t,s){let i=this.renderer,a=this.renderer.resources,r=t+this.x+(i.getNoteY(this._beat.maxNote,!1)-a.tablatureFont.size/2),n=t+this.y+i.getNoteY(this._beat.minNote,!1)+a.tablatureFont.size/2,o=e+this.x+this.width/2|0,h=8*this.scale;if(this._beat.brushType!==m.None){if(this._beat.brushType===m.BrushUp||this._beat.brushType===m.BrushDown)s.beginPath(),s.moveTo(o,r),s.lineTo(o,n),s.stroke();else if(this._beat.brushType===m.ArpeggioUp){let t=r-h,i=n-h;s.beginRotate(e+this.x+2*this.scale,i,-90);let a=new qi(0,0,x.Slight,1.2);a.renderer=this.renderer,a.doLayout(),a.width=Math.abs(i-t),a.paint(0,0,s),s.endRotate()}else if(this._beat.brushType===m.ArpeggioDown){let t=r+h,i=n+h;s.beginRotate(e+this.x+7*this.scale,t,90);let a=new qi(0,0,x.Slight,1.2);a.renderer=this.renderer,a.doLayout(),a.width=Math.abs(i-t),a.paint(0,0,s),s.endRotate()}this._beat.brushType===m.BrushUp||this._beat.brushType===m.ArpeggioUp?(s.beginPath(),s.moveTo(o,n),s.lineTo(o+h/2,n-h),s.lineTo(o-h/2,n-h),s.closePath(),s.fill()):(s.beginPath(),s.moveTo(o,r),s.lineTo(o+h/2,r+h),s.lineTo(o-h/2,r+h),s.closePath(),s.fill())}}}class xr extends ui{doLayout(){this.container.beat.brushType===m.None||this.container.beat.isRest||(this.addGlyph(new kr(this.container.beat)),this.addGlyph(new er(0,0,4*this.scale))),super.doLayout()}constructor(){super()}}class Nr extends Ds{constructor(e,t){super(e,t)}doLayout(){this.width=28*this.scale}paint(e,t,s){let i=this.renderer.bar.staff.tuning.length,a=i*this.scale*.5,r=i<=4?ee.ClefTabSmall:ee.ClefTab,n=i<=4?i/4.5:i/6.5;s.fillMusicFontSymbol(e+this.x+5*this.scale,t+this.y-a,n*this.scale,r,!1)}}class Pr extends nr{get commonY(){return this.renderer.getTabY(0,0)}get numeratorY(){let e=this.renderer,t=e.bar.staff.tuning.length<=4?1/4:1/3;return e.lineOffset*e.bar.staff.tuning.length*t*this.scale}get denominatorY(){let e=this.renderer;return e.lineOffset*e.bar.staff.tuning.length*.6*this.scale}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?Ti.GraceScale:1}}class Fr extends oi{constructor(e,t){super(e,t),this._tupletSize=0,this.showTimeSignature=!1,this.showRests=!1,this.showTiedNotes=!1,this._startSpacing=!1}get lineOffset(){return(Fr.LineSpacing+1)*this.scale}getNoteX(e,t=!0){let s=this.getOnNotesGlyphForBeat(e.beat);return s?s.container.x+s.container.voiceContainer.x+s.x+s.noteNumbers.getNoteX(e,t):0}getNoteY(e,t=!1){let s=this.getOnNotesGlyphForBeat(e.beat);return s?s.noteNumbers.getNoteY(e,t):0}updateSizes(){let t=this.resources,s=t.tablatureFont.size/2+.2*t.tablatureFont.size;this.topPadding=s,this.bottomPadding=s,this.height=this.lineOffset*(this.bar.staff.tuning.length-1)+2*s,this.settings.notation.rhythmMode!==e.TabRhythmMode.Hidden&&(this.height+=this.settings.notation.rhythmHeight*this.settings.display.scale,this.bottomPadding+=this.settings.notation.rhythmHeight*this.settings.display.scale),super.updateSizes()}doLayout(){if(super.doLayout(),this.settings.notation.rhythmMode!==e.TabRhythmMode.Hidden){let e=!1;for(let t of this.bar.voices)if(this.hasVoiceContainer(t)){if(this.getOrCreateVoiceContainer(t).tupletGroups.length>0){e=!0;break}}e&&(this._tupletSize=.8*this.resources.effectFont.size,this.registerOverflowBottom(this._tupletSize))}}createPreBeatGlyphs(){if(super.createPreBeatGlyphs(),this.bar.masterBar.isRepeatStart&&this.addPreBeatGlyph(new Fa(0,0,1.5,3)),this.isFirstOfLine){let e=(this.bar.staff.tuning.length+1)/2;this.addPreBeatGlyph(new Nr(5*this.scale,this.getTabY(e,0)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs()),this.addPreBeatGlyph(new va(0,this.getTabY(-.5,0),this.bar.index+1)),this.bar.isEmpty&&this.addPreBeatGlyph(new er(0,0,30*this.scale))}createStartSpacing(){this._startSpacing||(this.addPreBeatGlyph(new er(0,0,2*this.scale)),this._startSpacing=!0)}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new er(0,0,5*this.scale)),this.addPreBeatGlyph(new Pr(0,this.getTabY(0,0),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon))}createBeatGlyphs(){for(let e=0;e<this.bar.voices.length;e++){let t=this.bar.voices[e];this.hasVoiceContainer(t)&&this.createVoiceGlyphs(this.bar.voices[e])}}createVoiceGlyphs(e){for(let t=0,s=e.beats.length;t<s;t++){let s=e.beats[t],i=new _r(s,this.getOrCreateVoiceContainer(e));i.preNotes=new xr,i.onNotes=new Tr,this.addBeatGlyph(i)}}createPostBeatGlyphs(){super.createPostBeatGlyphs(),this.bar.masterBar.isRepeatEnd?(this.addPostBeatGlyph(new Na(this.x,0)),this.bar.masterBar.repeatCount>2&&this.addPostBeatGlyph(new Pa(0,this.getTabY(-.5,-3),this.bar.masterBar.repeatCount))):this.addPostBeatGlyph(new Ta(0,0))}getTabY(e,t=0){return this.lineOffset*e+t*this.scale}paintBackground(e,t,s){super.paintBackground(e,t,s);let i=this.resources;s.color=i.staffLineColor;let a=t+this.y+this.topPadding,r=this.scale,n=[];for(let e=0,t=this.bar.staff.tuning.length;e<t;e++)n.push([]);for(let e of this.bar.voices)if(this.hasVoiceContainer(e)){let t=this.getOrCreateVoiceContainer(e);for(let e of t.beatGlyphs){let s=e.onNotes,i=s.noteNumbers;if(i)for(let a of i.notesPerString){a[1].isEmpty||n[this.bar.staff.tuning.length-a[0]].push(new Float32Array([t.x+e.x+s.x+i.x,i.width+r]))}}}for(let e of n)e.sort((e,t)=>e[0]>t[0]?1:e[0]<t[0]?-1:0);let o=this.lineOffset;for(let t=0,i=this.bar.staff.tuning.length;t<i;t++){t>0&&(a+=o);let i=0;for(let r of n[t])s.fillRect(e+this.x+i,0|a,r[0]-i,this.scale),i=r[0]+r[1];s.fillRect(e+this.x+i,0|a,this.width-i,this.scale)}s.color=i.mainGlyphColor,this.paintSimileMark(e,t,s)}paint(t,s,i){super.paint(t,s,i),this.settings.notation.rhythmMode!==e.TabRhythmMode.Hidden&&(this.paintBeams(t,s,i),this.paintTuplets(t,s,i))}paintBeams(e,t,s){for(let i=0,a=this.helpers.beamHelpers.length;i<a;i++){let a=this.helpers.beamHelpers[i];for(let i=0,r=a.length;i<r;i++){let r=a[i];this.paintBeamHelper(e+this.beatGlyphsStart,t,s,r)}}}paintTuplets(e,t,s){for(let i of this.bar.voices)if(this.hasVoiceContainer(i)){let a=this.getOrCreateVoiceContainer(i);for(let i of a.tupletGroups)this.paintTupletHelper(e+this.beatGlyphsStart,t,s,i)}}paintBeamHelper(t,s,i,a){i.color=0===a.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,1===a.beats.length||this.settings.notation.rhythmMode===e.TabRhythmMode.ShowWithBeams?this.paintFooter(t,s,i,a):this.paintBar(t,s,i,a)}paintBar(e,t,s,i){for(let a=0,r=i.beats.length;a<r;a++){let r=i.beats[a];if(i.hasBeatLineX(r)){let n=i.getBeatLineX(r),o=t+this.y,h=t+this.y+this.height-this._tupletSize,l=this.getOnNotesGlyphForBeat(r);l.noteNumbers?o+=l.noteNumbers.getNoteY(l.noteNumbers.minStringNote,!1)+this.lineOffset/2:o+=this.height-this.settings.notation.rhythmHeight*this.settings.display.scale-this._tupletSize,i.direction===ie.Up?n-=l.width/2:n+=l.width/2,s.beginPath(),s.moveTo(e+this.x+n,o),s.lineTo(e+this.x+n,h),s.stroke();let d=6*this.scale,c=-6*this.scale,u=3*this.scale,p=Ae.getIndex(r.duration)-2,g=h;for(let t=0;t<p;t++){let o=0,h=0,l=0,p=0,f=g+t*c;if(1===i.beats.length)o=n,h=n+d,l=f,p=f,Fr.paintSingleBar(s,e+this.x+o,l,e+this.x+h,p,u);else if(a<i.beats.length-1){if(ri.isFullBarJoin(r,i.beats[a+1],t)){o=n,h=i.getBeatLineX(i.beats[a+1])+this.scale;let e=this.getOnNotesGlyphForBeat(i.beats[a+1]);i.direction===ie.Up?h-=e.width/2:h+=e.width/2}else{if(0!==a&&ri.isFullBarJoin(i.beats[a-1],r,t))continue;o=n,h=o+d}l=f,p=f,Fr.paintSingleBar(s,e+this.x+o,l,e+this.x+h,p,u)}else a>0&&!ri.isFullBarJoin(r,i.beats[a-1],t)&&(o=n-d,h=n,l=f,p=f,Fr.paintSingleBar(s,e+this.x+o,l,e+this.x+h,p,u))}}}}paintTupletHelper(e,t,s,i){let a,r=this.resources,n=s.textAlign;s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.textAlign=$.Center;let o=i.beats[0].tupletNumerator,h=i.beats[0].tupletDenominator;if(a=2===o&&3===h?"2":3===o&&2===h?"3":4===o&&6===h?"4":5===o&&4===h?"5":6===o&&4===h?"6":7===o&&4===h?"7":9===o&&8===h?"9":10===o&&8===h?"10":11===o&&8===h?"11":12===o&&8===h?"12":13===o&&8===h?"13":o+":"+h,1!==i.beats.length&&i.isFull){let n=i.beats[0],o=i.beats[i.beats.length-1],h=this.helpers.beamHelperLookup[i.voice.index].get(n.index),l=this.helpers.beamHelperLookup[i.voice.index].get(o.index);if(h&&l){let i=h.getBeatLineX(n),d=l.getBeatLineX(o),c=this.getOnNotesGlyphForBeat(n),u=this.getOnNotesGlyphForBeat(n);h.direction===ie.Up?(i-=c.width/2,d-=u.width/2):(i+=c.width/2,d+=u.width/2),s.font=r.effectFont;let p=s.measureText(a),g=3*this.scale,f=(i+d)/2,m=f-p/2-g,y=f+p/2+g,b=t+this.y+this.height-this._tupletSize+.5*r.effectFont.size,S=.25*-r.effectFont.size,_=-5*this.scale;s.beginPath(),s.moveTo(e+this.x+i,b-S|0),s.lineTo(e+this.x+i,b-S-_|0),s.lineTo(e+this.x+m,b-S-_|0),s.stroke(),s.beginPath(),s.moveTo(e+this.x+y,b-S-_|0),s.lineTo(e+this.x+d,b-S-_|0),s.lineTo(e+this.x+d,b-S|0),s.stroke(),s.fillText(a,e+this.x+f,b)}}else for(let n=0,o=i.beats.length;n<o;n++){let o=i.beats[n],h=this.helpers.beamHelperLookup[i.voice.index].get(o.index);if(!h)continue;let l=h.getBeatLineX(o),d=this.getOnNotesGlyphForBeat(o);h.direction===ie.Up?l-=d.width/2:l+=d.width/2;let c=t+this.y+this.height-this._tupletSize+.5*r.effectFont.size;s.font=r.effectFont,s.fillText(a,e+this.x+l,c)}s.textAlign=n}static paintSingleBar(e,t,s,i,a,r){e.beginPath(),e.moveTo(t,s),e.lineTo(i,a),e.lineTo(i,a-r),e.lineTo(t,s-r),e.closePath(),e.fill()}paintFooter(e,t,s,i){for(let a of i.beats){if(a.graceType!==_.None||a.duration===b.Whole||a.duration===b.DoubleWhole||a.duration===b.QuadrupleWhole)return;let r=i.getBeatLineX(a),n=t+this.y,o=t+this.y+this.height-this._tupletSize,h=this.getOnNotesGlyphForBeat(a);if(h.noteNumbers?n+=h.noteNumbers.getNoteY(h.noteNumbers.minStringNote,!1)+this.lineOffset/2:n+=this.height-this.settings.notation.rhythmHeight*this.settings.display.scale-this._tupletSize,i.direction===ie.Up?r-=h.width/2:r+=h.width/2,s.beginPath(),s.moveTo(e+this.x+r,n),s.lineTo(e+this.x+r,o),s.stroke(),a.duration>b.Quarter){let t=new ka(0,0,a.duration,ie.Down,!1);t.renderer=this,t.doLayout(),t.paint(e+this.x+r,o,s)}}}}Fr.StaffId="tab",Fr.LineSpacing=10;class Cr extends ei{constructor(e,t,s){super(),this._showTimeSignature=e,this._showRests=t,this._showTiedNotes=s,this.hideOnPercussionTrack=!0}get staffId(){return Fr.StaffId}canCreate(e,t){return t.tuning.length>0&&super.canCreate(e,t)}create(e,t){let s=new Fr(e,t);return s.showRests=this._showRests,s.showTimeSignature=this._showTimeSignature,s.showTiedNotes=this._showTiedNotes,s}}class Lr{constructor(e,t){this.vertical=e,this.createLayout=t}}class Mr{constructor(e,t){this.supportsWorkers=e,this.createCanvas=t}}class Er{static createStyleElement(e,t){let s=e.getElementById("alphaTabStyle");if(!s){if(!t)return void we.error("AlphaTab","Font directory could not be detected, cannot create style element");s=e.createElement("style"),s.id="alphaTabStyle";let i=`\n            @font-face {\n                font-family: 'alphaTab';\n                 src: url('${t}Bravura.eot');\n                 src: url('${t}Bravura.eot?#iefix') format('embedded-opentype')\n                      , url('${t}Bravura.woff') format('woff')\n                      , url('${t}Bravura.otf') format('opentype')\n                      , url('${t}Bravura.svg#Bravura') format('svg');\n                 font-weight: normal;\n                 font-style: normal;\n            }\n            .at-surface * {\n                cursor: default;\n                vertical-align: top;\n            }\n            .at {\n                 font-family: 'alphaTab';\n                 speak: none;\n                 font-style: normal;\n                 font-weight: normal;\n                 font-variant: normal;\n                 text-transform: none;\n                 line-height: 1;\n                 line-height: 1;\n                 -webkit-font-smoothing: antialiased;\n                 -moz-osx-font-smoothing: grayscale;\n                 font-size: 34px;\n                 overflow: visible !important;\n            }`;s.innerHTML=i,e.getElementsByTagName("head").item(0).appendChild(s),Er.bravuraFontChecker.checkForFontAvailability()}}static detectScriptFile(){if(i.isRunningInWorker)return null;let e=document.currentScript,t=null;if(!e)try{let e=new Error,s=e.stack;if(!s)throw e;t=Er.scriptFileFromStack(s)}catch(s){if(!(s instanceof Error))throw s;{let i=s.stack;i?t=Er.scriptFileFromStack(i):e=document.querySelector("script[data-alphatab]")}}return t||(e?t=e.src:we.warning("Environment","Could not automatically find alphaTab script file for worker, please add the data-alphatab attribute to the script tag that includes alphaTab or provide it when initializing alphaTab",null)),t}static registerJQueryPlugin(){if(!i.isRunningInWorker&&globalThis&&"jQuery"in globalThis){let e=globalThis.jQuery,t=new $s;e.fn.alphaTab=function(e){const s=Array.prototype.slice.call(arguments,1);return 1===this.length?t.exec(this[0],e,s):this.each((i,a)=>{t.exec(a,e,s)})},e.alphaTab={restore:$s.restore},e.fn.alphaTab.fn=t}}static scriptFileFromStack(e){let t=e.match("(data:text\\/javascript(?:;[^,]+)?,.+?|(?:|blob:)(?:http[s]?|file):\\/\\/[\\/]?.+?\\/[^:\\)]*?)(?::\\d+)(?::\\d+)?");return t||(t=e.match("^(?:|[^:@]*@|.+\\)@(?=data:text\\/javascript|blob|http[s]?|file)|.+?\\s+(?: at |@)(?:[^:\\(]+ )*[\\(]?)(data:text\\/javascript(?:;[^,]+)?,.+?|(?:|blob:)(?:http[s]?|file):\\/\\/[\\/]?.+?\\/[^:\\)]*?)(?::\\d+)(?::\\d+)?"),t||(t=e.match("\\)@(data:text\\/javascript(?:;[^,]+)?,.+?|(?:|blob:)(?:http[s]?|file):\\/\\/[\\/]?.+?\\/[^:\\)]*?)(?::\\d+)(?::\\d+)?"),t))?t[1]:null}static createScoreRenderer(e){return new ws(e)}static getRenderEngineFactory(e){return e.core.engine&&Er.renderEngines.has(e.core.engine)?Er.renderEngines.get(e.core.engine):Er.renderEngines.get("default")}static getLayoutEngineFactory(t){return t.display.layoutMode&&Er.layoutEngines.has(t.display.layoutMode)?Er.layoutEngines.get(t.display.layoutMode):Er.layoutEngines.get(e.LayoutMode.Page)}static buildImporters(){return[new ze,new St,new gt,new Ve,new _t]}static createDefaultRenderEngines(){const e=new Map;return e.set("svg",new Mr(!0,()=>new Zs)),Er.createPlatformSpecificRenderEngines(e),e.set("default",e.get("svg")),e}static createPlatformSpecificRenderEngines(e){e.set("html5",new Mr(!1,()=>new vs))}static createDefaultStaveProfiles(){const t=new Map;t.set(e.StaveProfile.ScoreTab,[new fi("score-effects",[new Zi,new aa,new Vi,new ea,new wi,new Mi,new ra,new sa,new Wi(!0),new na,new Qi,new oa,new ji,new bi]),new mr,new fi("tab-effects",[new xi,new Wi(!1),new Pi,new Gi,new sa,new na,new Qi,new oa,new ji,new Ki,new Ci,new Ri(B.Natural),new Ri(B.Artificial),new Ri(B.Pinch),new Ri(B.Tap),new Ri(B.Semi),new Ri(B.Feedback),new Oi,new _i,new Ei,new zi,new Yi,new Ui]),new Cr(!1,!1,!1)]),t.set(e.StaveProfile.Score,[new fi("score-effects",[new Zi,new aa,new Vi,new ea,new wi,new Mi,new ra,new sa,new Wi(!0),new na,new Qi,new oa,new ji,new Ci,new Oi,new zi,new Yi,new Ui,new bi]),new mr,new fi("score-bottom-effects",[new xi,new Wi(!1),new Pi,new Gi])]);let s=[new Zi,new aa,new Vi,new ea,new wi,new Mi,new sa,new na,new Qi,new oa,new ji,new Ki,new Ci,new Ri(B.Artificial),new Ri(B.Pinch),new Ri(B.Tap),new Ri(B.Semi),new Ri(B.Feedback),new Oi,new _i,new Ei,new zi,new Yi,new Ui,new bi];return t.set(e.StaveProfile.Tab,[new fi("tab-effects",s),new Cr(!0,!0,!0),new fi("tab-bottom-effects",[new Gi])]),t.set(e.StaveProfile.TabMixed,[new fi("tab-effects",s),new Cr(!1,!1,!1),new fi("tab-bottom-effects",[new Gi])]),t}static createDefaultLayoutEngines(){const t=new Map;return t.set(e.LayoutMode.Page,new Lr(!0,e=>new wa(e))),t.set(e.LayoutMode.Horizontal,new Lr(!1,e=>new _a(e))),t}static platformInit(){if(Er.registerJQueryPlugin(),Math.log2=Math.log2?Math.log2:function(e){return Math.log(e)*Math.LOG2E},i.isRunningInWorker)Bs.init(),us.init();else{let e="";e+="Function VbAjaxLoader(method, fileName)\r\n",e+="    Dim xhr\r\n",e+='    Set xhr = CreateObject("Microsoft.XMLHTTP")\r\n',e+="    xhr.Open method, fileName, False\r\n",e+='    xhr.setRequestHeader "Accept-Charset", "x-user-defined"\r\n',e+="    xhr.send\r\n",e+="    Dim byteArray()\r\n",e+="    if xhr.Status = 200 Then\r\n",e+="        Dim byteString\r\n",e+="        Dim i\r\n",e+="        byteString=xhr.responseBody\r\n",e+="        ReDim byteArray(LenB(byteString))\r\n",e+="        For i = 1 To LenB(byteString)\r\n",e+="            byteArray(i-1) = AscB(MidB(byteString, i, 1))\r\n",e+="        Next\r\n",e+="    End If\r\n",e+="    VbAjaxLoader=byteArray\r\n",e+="End Function\r\n";let t=document.createElement("script");t.setAttribute("type","text/vbscript");let s=document.createTextNode(e);t.appendChild(s),document.addEventListener("DOMContentLoaded",()=>{document.body.appendChild(t)},!1)}}}Er.scriptFile=Er.detectScriptFile(),Er.bravuraFontChecker=new zs("alphaTab",`&#${ee.ClefG};`),Er.renderEngines=Er.createDefaultRenderEngines(),Er.layoutEngines=Er.createDefaultLayoutEngines(),Er.staveProfiles=Er.createDefaultStaveProfiles(),Er.platformInit();class Dr{constructor(){if(this.scriptFile=null,this.fontDirectory=null,this.enableLazyLoading=!0,this.engine="default",this.logLevel=C.Info,this.useWorkers=!0,this.includeNoteBounds=!1,!i.isRunningInWorker&&globalThis.ALPHATAB_ROOT?(this.scriptFile=globalThis.ALPHATAB_ROOT,this.scriptFile=Dr.ensureFullUrl(this.scriptFile),this.scriptFile=Dr.appendScriptName(this.scriptFile)):this.scriptFile=Er.scriptFile,!i.isRunningInWorker&&globalThis.ALPHATAB_FONT)this.fontDirectory=globalThis.ALPHATAB_FONT,this.fontDirectory=Dr.ensureFullUrl(this.fontDirectory);else if(this.fontDirectory=this.scriptFile,this.fontDirectory){let e=this.fontDirectory.lastIndexOf(String.fromCharCode(47));e>=0&&(this.fontDirectory=this.fontDirectory.substr(0,e)+"/font/")}}static ensureFullUrl(e){var t,s,i;if(!e)return"";let a=globalThis;if(!e.startsWith("http")&&!e.startsWith("https")&&!e.startsWith("file")){let r="",n=a.location;if(r+=null===(t=n.protocol)||void 0===t?void 0:t.toString(),r+=null==="//"?void 0:"//".toString(),n.hostname&&(r+=null===(s=n.hostname)||void 0===s?void 0:s.toString()),n.port&&(r+=null===":"?void 0:":".toString(),r+=null===(i=n.port)||void 0===i?void 0:i.toString()),!e.startsWith("/")){let e=n.pathname.split("/").slice(0,-1).join("/");e.length>0&&(e.startsWith("/")||(r+=null==="/"?void 0:"/".toString()),r+=null==e?void 0:e.toString())}return e.startsWith("/")||(r+=null==="/"?void 0:"/".toString()),r+=null==e?void 0:e.toString(),r}return e}static appendScriptName(e){return e&&!e.endsWith(".js")&&(e.endsWith("/")||(e+="/"),e+="alphaTab.js"),e}static toJson(e){var t={};return e.fillToJson(t),t}fillToJson(e){e.scriptFile=this.scriptFile,e.fontDirectory=this.fontDirectory,e.enableLazyLoading=this.enableLazyLoading,e.engine=this.engine,e.logLevel=this.logLevel,e.useWorkers=this.useWorkers,e.includeNoteBounds=this.includeNoteBounds}static fromJson(e){if(!e)return null;var t=new Dr;return t.fillFromJson(e),t}fillFromJson(e){if(e)for(const t in e)this.setProperty(t.toLowerCase(),e[t])}setProperty(e,t){switch(e){case"scriptfile":return this.scriptFile=t,!0;case"fontdirectory":return this.fontDirectory=t,!0;case"enablelazyloading":return this.enableLazyLoading=t,!0;case"engine":return this.engine=t,!0;case"loglevel":return this.logLevel="string"==typeof t?C[Object.keys(C).find(e=>e.toLowerCase()===t.toLowerCase())]:t,!0;case"useworkers":return this.useWorkers=t,!0;case"includenotebounds":return this.includeNoteBounds=t,!0}return!1}}const Ir={midi:{MidiFile:ts,event:{ControllerType:te,MetaDataEvent:ss,MetaEvent:Bt,MetaNumberEvent:is,MidiEvent:wt,SystemCommonEvent:as,SystemExclusiveEvent:rs},generator:{MidiFileGenerator:Ms}},synth:{PlaybackRange:Es,PlayerStateChangedEventArgs:$t,PositionChangedEventArgs:Zt}},Rr={ScoreLoader:Vs},Or={AccentuationType:l,AccidentalType:oe,Automation:ge,AutomationType:d,Bar:fe,Beat:Te,BendPoint:ye,BendStyle:g,BendType:f,BrushType:m,Chord:ke,Clef:c,Color:a,CrescendoType:y,Duration:b,DynamicValue:S,Fermata:qe,FermataType:G,Fingers:w,Font:n,FontStyle:r,GraceType:_,HarmonicType:B,JsonConverter:ds,KeySignature:D,KeySignatureType:I,Lyrics:xe,MasterBar:Ne,Note:Be,NoteAccidentalMode:v,Ottavia:u,PickStroke:L,PlaybackInformation:Me,RenderStylesheet:Pe,RepeatGroup:Fe,Score:Ce,Section:Le,SimileMark:p,SlideInType:T,SlideOutType:k,Staff:Ee,Track:De,TripletFeel:R,Tuning:Ie,TupletGroup:ve,VibratoType:x,Voice:Re,WhammyType:M},Ar={javaScript:{AlphaTabApi:Ks}};e.ArgumentError=t,e.ArgumentNullError=class extends t{constructor(e,t){super(e,t)}},e.CoreSettings=Dr,e.DisplaySettings=de,e.Environment=Er,e.FileLoadError=As,e.FormatError=s,e.ImporterSettings=ns,e.NoImporterFoundError=Gs,e.NotationSettings=be,e.PlayerSettings=hs,e.ProgressEventArgs=Ys,e.RenderingResources=le,e.ResizeEventArgs=Rs,e.SelectionInfo=Os,e.Settings=ls,e.VibratoPlaybackSettings=os,e.audio=Ir,e.importer=Rr,e.model=Or,e.platform=Ar,Object.defineProperty(e,"__esModule",{value:!0})}));
